# .github/workflows/build-and-push.yml
# familyTraffic VPN ‚Äî Test Pipeline
#
# Triggers:
#   - push to `test` branch (with relevant file changes)
#   - Pull Request targeting the `test` branch (with relevant file changes)
#   - Manual via workflow_dispatch
#
# Pipeline:
#   1. build-and-push     ‚Äî build image ‚Üí push :test + :sha-<short> to GHCR
#   2. deploy-test        ‚Äî scp docker-compose.yml ‚Üí ssh pull & up
#   3. cleanup-registry   ‚Äî keep 3 latest sha-* tags, never delete :test
#   4. notify             ‚Äî Telegram notification (always, even on failure)
#
# Path filters ‚Äî what triggers CI/CD:
#   docker/familytraffic/**               ‚Äî files COPY'd into the Docker image
#   .dockerignore                          ‚Äî controls Docker build context
#   docker-compose.yml                     ‚Äî synced to test server via scp
#   .github/workflows/build-and-push.yml  ‚Äî the workflow itself
#
# NOT in paths (host-only scripts, not synced by CI/CD):
#   lib/nginx_stream_generator.sh ‚Äî generates nginx.conf on host (volume mount,
#     not baked into image). Changes to it require manual redeploy on test server.
#
# Secrets ‚Äî Environment (Settings ‚Üí Environments ‚Üí test):
#   TEST_SSH_HOST    ‚Äî IP or hostname of the test server
#   TEST_SSH_USER    ‚Äî SSH username (e.g. root)
#   TEST_SSH_KEY     ‚Äî SSH private key, PEM format (ED25519 or RSA)
#   TEST_GHCR_TOKEN  ‚Äî GitHub PAT with read:packages scope (for docker pull on server)
#
# Secrets ‚Äî Repository (Settings ‚Üí Secrets and variables ‚Üí Actions):
#   TELEGRAM_BOT_TOKEN ‚Äî token from @BotFather (format: 123456:ABC-xxx)
#   TELEGRAM_CHAT_ID   ‚Äî chat/channel ID (negative for channels, e.g. -1001234567890)

name: Test ‚Äî Build, Push and Deploy

on:
  push:
    branches:
      - test
    paths:
      - "docker/familytraffic/**"   # baked into image via COPY
      - ".dockerignore"              # affects Docker build context
      - "docker-compose.yml"         # synced to test server via scp
      - ".github/workflows/build-and-push.yml"
  pull_request:
    branches:
      - test
    paths:
      - "docker/familytraffic/**"
      - ".dockerignore"
      - "docker-compose.yml"
      - ".github/workflows/build-and-push.yml"
  workflow_dispatch:

env:
  REGISTRY:   ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/familytraffic

jobs:
  # ============================================================
  # Job 1: Build image and push :test + :sha-<short> to GHCR
  # ============================================================
  build-and-push:
    name: Build & Push [:test]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract image metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=test
            type=sha,prefix=sha-,format=short

      - name: Build and push image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/familytraffic/Dockerfile
          push: true
          tags:       ${{ steps.meta.outputs.tags }}
          labels:     ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to:   type=gha,mode=max
          platforms:  linux/amd64

  # ============================================================
  # Job 2: Sync compose + deploy :test image on test server
  # ============================================================
  deploy-test:
    name: Deploy to Test Server
    runs-on: ubuntu-latest
    needs: build-and-push
    environment: test

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Ensure /opt/familytraffic exists before scp-action tries to write into it.
      # scp-action runs mkdir via the SSH user, which may lack write access to /opt/.
      - name: Ensure /opt/familytraffic exists on test server
        uses: appleboy/ssh-action@v1
        with:
          host:     ${{ secrets.TEST_SSH_HOST }}
          username: ${{ secrets.TEST_SSH_USER }}
          key:      ${{ secrets.TEST_SSH_KEY }}
          script: sudo mkdir -p /opt/familytraffic

      # Sync the base service definition from the repo to the test server.
      # MTProxy block (if appended by familytraffic-mtproxy-setup) will be
      # overwritten ‚Äî re-run `familytraffic-mtproxy-setup` once if needed.
      - name: Sync docker-compose.yml to test server
        uses: appleboy/scp-action@v0.1.7
        with:
          host:      ${{ secrets.TEST_SSH_HOST }}
          username:  ${{ secrets.TEST_SSH_USER }}
          key:       ${{ secrets.TEST_SSH_KEY }}
          source:    "docker-compose.yml"
          target:    "/opt/familytraffic/"
          overwrite: true

      - name: Pull & restart familytraffic:test
        uses: appleboy/ssh-action@v1
        env:
          GHCR_TOKEN: ${{ secrets.TEST_GHCR_TOKEN }}
          GH_ACTOR:   ${{ github.actor }}
          # Pass GHCR_IMAGE explicitly so compose image ref is always correct
          # regardless of what GHCR_IMAGE is set to in the server's .env
          GHCR_IMAGE: ghcr.io/${{ github.repository_owner }}/familytraffic
          IMAGE:      ghcr.io/${{ github.repository_owner }}/familytraffic:test
        with:
          host:     ${{ secrets.TEST_SSH_HOST }}
          username: ${{ secrets.TEST_SSH_USER }}
          key:      ${{ secrets.TEST_SSH_KEY }}
          envs:     GHCR_TOKEN,GH_ACTOR,GHCR_IMAGE,IMAGE
          script: |
            set -e

            # Authenticate and pull the new :test image
            echo "${GHCR_TOKEN}" | docker login ghcr.io -u "${GH_ACTOR}" --password-stdin
            docker pull "${IMAGE}"

            # GHCR_IMAGE and VERSION override .env so the server file is never modified.
            # --remove-orphans cleans up containers from removed compose services.
            # Image already pulled above ‚Äî no second pull attempt after logout.
            cd /opt/familytraffic
            GHCR_IMAGE="${GHCR_IMAGE}" VERSION=test docker compose up -d --remove-orphans

            docker logout ghcr.io

            # Wait for container to initialise, then verify it is running
            sleep 10
            STATUS=$(docker inspect familytraffic --format '{{.State.Status}}' 2>/dev/null || echo "missing")
            if [ "${STATUS}" != "running" ]; then
              echo "ERROR: container status is '${STATUS}' after deploy"
              docker logs familytraffic --tail 50 || true
              exit 1
            fi

            echo "Deploy complete: ${IMAGE}"

  # ============================================================
  # Job 3: Clean up old GHCR versions (keep 3 latest sha-* tags)
  # ============================================================
  cleanup-registry:
    name: Cleanup Old Images (keep 3)
    runs-on: ubuntu-latest
    needs: build-and-push
    permissions:
      packages: write

    steps:
      - name: Delete old versions (keep 3 latest sha-* tags)
        uses: actions/delete-package-versions@v5
        with:
          package-name: familytraffic
          package-type: container
          min-versions-to-keep: 3
          ignore-versions: '^test$'

  # ============================================================
  # Job 4: Telegram notification (runs always, even on failure)
  # ============================================================
  notify:
    name: Notify Telegram
    runs-on: ubuntu-latest
    needs: [build-and-push, deploy-test]
    if: always()

    steps:
      - name: Send Telegram notification
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID:   ${{ secrets.TELEGRAM_CHAT_ID }}
          BUILD_RESULT:  ${{ needs.build-and-push.result }}
          DEPLOY_RESULT: ${{ needs.deploy-test.result }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          COMMIT_SHA: ${{ github.sha }}
          ACTOR: ${{ github.actor }}
          REF:   ${{ github.ref_name }}
          EVENT: ${{ github.event_name }}
        run: |
          # Map result to emoji
          result_icon() {
            case "$1" in
              success)   echo "‚úÖ" ;;
              failure)   echo "‚ùå" ;;
              skipped)   echo "‚è≠Ô∏è" ;;
              cancelled) echo "üö´" ;;
              *)         echo "‚ùì" ;;
            esac
          }

          BUILD_ICON=$(result_icon  "${BUILD_RESULT}")
          DEPLOY_ICON=$(result_icon "${DEPLOY_RESULT}")

          # Overall status: failed if any critical job did not succeed
          if [ "${BUILD_RESULT}" = "success" ] && [ "${DEPLOY_RESULT}" = "success" ]; then
            HEADER="‚úÖ Deploy OK"
          else
            HEADER="‚ùå Deploy FAILED"
          fi

          SHORT_SHA="${COMMIT_SHA:0:7}"

          TEXT=$(printf '%s\n\n%s Build: <b>%s</b>\n%s Deploy: <b>%s</b>\n\nBranch: <code>%s</code>\nCommit: <code>%s</code>\nActor: %s\nEvent: %s\n\n<a href="%s">View run #%s</a>' \
            "${HEADER}" \
            "${BUILD_ICON}"  "${BUILD_RESULT}" \
            "${DEPLOY_ICON}" "${DEPLOY_RESULT}" \
            "${REF}" "${SHORT_SHA}" "${ACTOR}" "${EVENT}" \
            "${RUN_URL}" "${{ github.run_number }}")

          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            --data-urlencode "chat_id=${CHAT_ID}" \
            --data-urlencode "parse_mode=HTML" \
            --data-urlencode "disable_web_page_preview=true" \
            --data-urlencode "text=${TEXT}" \
            -o /dev/null \
            -w "Telegram API: %{http_code}\n"
