# .github/workflows/release.yml
# familyTraffic VPN ‚Äî Release Pipeline (Semantic Versioning)
#
# Triggers:
#   - push of git tag matching v*.*.* (e.g. v0.1.0, v1.2.3)
#   - Manual via workflow_dispatch
#
# Pipeline:
#   1. build-and-push      ‚Äî build image ‚Üí push :M.N.P :M.N :M :latest to GHCR
#   2. deploy-production   ‚Äî scp docker-compose.yml ‚Üí ssh pull & up with semver tag
#   3. cleanup-registry    ‚Äî keep 3 latest sha-* tags, protect :latest :M :M.N :M.N.P
#   4. notify              ‚Äî Telegram notification (always, even on failure)
#
# Tag convention:
#   git tag v0.1.0       ‚Üí pushes :0.1.0 :0.1 :0 :latest
#   git tag v1.0.0       ‚Üí pushes :1.0.0 :1.0 :1 :latest
#
# How to release:
#   git tag v0.1.0 -m "Release v0.1.0"
#   git push origin v0.1.0
#
# Secrets ‚Äî Environment (Settings ‚Üí Environments ‚Üí production):
#   PROD_SSH_HOST    ‚Äî IP or hostname of the production server
#   PROD_SSH_USER    ‚Äî SSH username (e.g. root)
#   PROD_SSH_KEY     ‚Äî SSH private key, PEM format (ED25519 or RSA)
#   PROD_GHCR_TOKEN  ‚Äî GitHub PAT with read:packages scope (for docker pull on server)
#
# Secrets ‚Äî Repository (Settings ‚Üí Secrets and variables ‚Üí Actions):
#   TELEGRAM_BOT_TOKEN ‚Äî token from @BotFather (format: 123456:ABC-xxx)
#   TELEGRAM_CHAT_ID   ‚Äî chat/channel ID (negative for channels, e.g. -1001234567890)

name: Release ‚Äî Build, Push and Deploy

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to build and deploy (e.g. v0.1.0)"
        required: true

env:
  REGISTRY:   ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/familytraffic

jobs:
  # ============================================================
  # Job 1: Build image and push semver tags to GHCR
  # Tags: :M.N.P :M.N :M :latest
  # ============================================================
  build-and-push:
    name: Build & Push [:M.N.P :M.N :M :latest]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract image metadata (semver tags)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest,enable=${{ startsWith(github.ref, 'refs/tags/v') }}

      - name: Build and push image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/familytraffic/Dockerfile
          push: true
          tags:       ${{ steps.meta.outputs.tags }}
          labels:     ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to:   type=gha,mode=max
          platforms:  linux/amd64

  # ============================================================
  # Job 2: Sync compose + deploy semver image on production server
  # ============================================================
  deploy-production:
    name: Deploy to Production Server
    runs-on: ubuntu-latest
    needs: build-and-push
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Extract semver version from tag (strip leading v)
      - name: Compute image version
        id: version
        run: |
          TAG="${GITHUB_REF_NAME:-${{ inputs.tag }}}"
          VERSION="${TAG#v}"
          echo "version=${VERSION}" >> "${GITHUB_OUTPUT}"
          echo "Deploying version: ${VERSION}"

      - name: Ensure /opt/familytraffic exists on production server
        uses: appleboy/ssh-action@v1
        with:
          host:     ${{ secrets.PROD_SSH_HOST }}
          username: ${{ secrets.PROD_SSH_USER }}
          key:      ${{ secrets.PROD_SSH_KEY }}
          script: |
            sudo mkdir -p /opt/familytraffic
            sudo chown "$(whoami):$(whoami)" /opt/familytraffic

      - name: Sync docker-compose.yml to production server
        uses: appleboy/scp-action@v0.1.7
        with:
          host:      ${{ secrets.PROD_SSH_HOST }}
          username:  ${{ secrets.PROD_SSH_USER }}
          key:       ${{ secrets.PROD_SSH_KEY }}
          source:    "docker-compose.yml"
          target:    "/opt/familytraffic/"
          overwrite: true

      - name: Pull & restart familytraffic with semver tag
        uses: appleboy/ssh-action@v1
        env:
          GHCR_TOKEN: ${{ secrets.PROD_GHCR_TOKEN }}
          GH_ACTOR:   ${{ github.actor }}
          GHCR_IMAGE: ghcr.io/${{ github.repository_owner }}/familytraffic
          IMAGE:      ghcr.io/${{ github.repository_owner }}/familytraffic:${{ steps.version.outputs.version }}
          VERSION:    ${{ steps.version.outputs.version }}
        with:
          host:     ${{ secrets.PROD_SSH_HOST }}
          username: ${{ secrets.PROD_SSH_USER }}
          key:      ${{ secrets.PROD_SSH_KEY }}
          envs:     GHCR_TOKEN,GH_ACTOR,GHCR_IMAGE,IMAGE,VERSION
          script: |
            set -e

            # Authenticate and pull the semver-tagged image
            echo "${GHCR_TOKEN}" | docker login ghcr.io -u "${GH_ACTOR}" --password-stdin
            docker pull "${IMAGE}"

            # Deploy with explicit VERSION (semver, not 'test' or 'latest')
            # --remove-orphans cleans up containers from removed compose services.
            cd /opt/familytraffic
            GHCR_IMAGE="${GHCR_IMAGE}" VERSION="${VERSION}" docker compose up -d --remove-orphans

            docker logout ghcr.io

            # Wait for container to initialise, then verify it is running
            sleep 10
            STATUS=$(docker inspect familytraffic --format '{{.State.Status}}' 2>/dev/null || echo "missing")
            if [ "${STATUS}" != "running" ]; then
              echo "ERROR: container status is '${STATUS}' after deploy"
              docker logs familytraffic --tail 50 || true
              exit 1
            fi

            echo "Deploy complete: ${IMAGE} (VERSION=${VERSION})"

  # ============================================================
  # Job 3: Clean up old GHCR versions
  # Protects: :latest, :M, :M.N, :M.N.P semver tags
  # Deletes: old :sha-* tags beyond the 3 most recent
  # ============================================================
  cleanup-registry:
    name: Cleanup Old Images (keep 3 sha-* tags)
    runs-on: ubuntu-latest
    needs: build-and-push
    permissions:
      packages: write

    steps:
      - name: Delete old versions (keep 3 latest sha-* tags)
        uses: actions/delete-package-versions@v5
        with:
          package-name: familytraffic
          package-type: container
          min-versions-to-keep: 3
          ignore-versions: '^(test|latest|[0-9]+|[0-9]+\.[0-9]+|[0-9]+\.[0-9]+\.[0-9]+)$'

  # ============================================================
  # Job 4: Telegram notification (runs always, even on failure)
  # ============================================================
  notify:
    name: Notify Telegram
    runs-on: ubuntu-latest
    needs: [build-and-push, deploy-production]
    if: always()

    steps:
      - name: Send Telegram notification
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID:   ${{ secrets.TELEGRAM_CHAT_ID }}
          BUILD_RESULT:  ${{ needs.build-and-push.result }}
          DEPLOY_RESULT: ${{ needs.deploy-production.result }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          TAG_NAME: ${{ github.ref_name }}
          ACTOR: ${{ github.actor }}
          EVENT: ${{ github.event_name }}
        run: |
          # Map result to emoji
          result_icon() {
            case "$1" in
              success)   echo "‚úÖ" ;;
              failure)   echo "‚ùå" ;;
              skipped)   echo "‚è≠Ô∏è" ;;
              cancelled) echo "üö´" ;;
              *)         echo "‚ùì" ;;
            esac
          }

          BUILD_ICON=$(result_icon  "${BUILD_RESULT}")
          DEPLOY_ICON=$(result_icon "${DEPLOY_RESULT}")

          # Overall status: failed if any critical job did not succeed
          if [ "${BUILD_RESULT}" = "success" ] && [ "${DEPLOY_RESULT}" = "success" ]; then
            HEADER="‚úÖ Release OK"
          else
            HEADER="‚ùå Release FAILED"
          fi

          TEXT=$(printf '%s\n\n%s Build: <b>%s</b>\n%s Deploy: <b>%s</b>\n\nRelease: <code>%s</code>\nActor: %s\nEvent: %s\n\n<a href="%s">View run #%s</a>' \
            "${HEADER}" \
            "${BUILD_ICON}"  "${BUILD_RESULT}" \
            "${DEPLOY_ICON}" "${DEPLOY_RESULT}" \
            "${TAG_NAME}" "${ACTOR}" "${EVENT}" \
            "${RUN_URL}" "${{ github.run_number }}")

          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            --data-urlencode "chat_id=${CHAT_ID}" \
            --data-urlencode "parse_mode=HTML" \
            --data-urlencode "disable_web_page_preview=true" \
            --data-urlencode "text=${TEXT}" \
            -o /dev/null \
            -w "Telegram API: %{http_code}\n"
