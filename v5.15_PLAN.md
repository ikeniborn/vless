# v5.15 Development Plan - Enhanced Pre-flight Checks

## Overview
Extend v5.14 pre-flight validation with 4 additional critical checks to prevent configuration errors and improve system reliability.

---

## Feature 1: DNS Pre-validation (Critical)

**Priority:** HIGH
**Impact:** Prevents certificate acquisition failures

### Current Problem
Users enter domain without verifying DNS records exist. Certificate acquisition fails after 5-10 minutes, wasting time.

### Solution
Check A/AAAA records BEFORE attempting Let's Encrypt certificate acquisition.

### Implementation
```bash
check_dns_records() {
    local domain="$1"

    # Method 1: dig command
    if command -v dig >/dev/null 2>&1; then
        local a_record=$(dig +short A "$domain" 2>/dev/null | grep -E '^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$')
        local aaaa_record=$(dig +short AAAA "$domain" 2>/dev/null | grep -E '^[0-9a-f:]+$')
    fi

    # Method 2: nslookup fallback
    if [ -z "$a_record" ] && [ -z "$aaaa_record" ]; then
        if command -v nslookup >/dev/null 2>&1; then
            a_record=$(nslookup "$domain" 2>/dev/null | grep -A1 "Name:" | grep "Address:" | awk '{print $2}' | grep -v ':')
        fi
    fi

    # Validation
    if [ -z "$a_record" ] && [ -z "$aaaa_record" ]; then
        # CRITICAL ERROR: No DNS records
        return 1
    fi

    # Check if record points to current server
    local server_ip=$(curl -s ifconfig.me)
    if [ "$a_record" != "$server_ip" ]; then
        # WARNING: DNS points to different server
        return 2
    fi

    return 0  # SUCCESS
}
```

### Error Messages
**Critical (No DNS):**
```
❌ КРИТИЧНО: DNS записи не найдены для $domain

   Требуемые действия:
   1. Добавьте A-запись в DNS провайдере:
      Type: A
      Name: $domain
      Value: $server_ip
      TTL: 300 (или авто)

   2. Дождитесь распространения DNS (5-60 минут):
      $ dig +short $domain
      # Должен вернуть: $server_ip

   3. Запустите wizard снова после настройки DNS
```

**Warning (Wrong IP):**
```
⚠️  ВНИМАНИЕ: DNS запись указывает на другой IP

   Текущая DNS запись: $a_record
   IP этого сервера:   $server_ip

   Let's Encrypt проверит $a_record, а не этот сервер!
   Сертификат НЕ БУДЕТ получен.

   Вы уверены что хотите продолжить? [y/N]
```

### Testing
```bash
# Test 1: No DNS records
check_dns_records "nonexistent-domain-12345.ikeniborn.ru"
# Expected: CRITICAL ERROR

# Test 2: Valid DNS
check_dns_records "claude-dev.ikeniborn.ru"
# Expected: SUCCESS (or WARNING if IP differs)

# Test 3: DNS propagation in progress
check_dns_records "newly-added.ikeniborn.ru"
# Expected: WARNING or ERROR depending on propagation
```

---

## Feature 2: fail2ban Status Check (Warning)

**Priority:** MEDIUM
**Impact:** Ensures brute-force protection is active

### Current Problem
Users may have fail2ban disabled/broken. Reverse proxy becomes vulnerable to brute-force attacks on HTTP Basic Auth.

### Solution
Check if fail2ban is running and vless-reverseproxy jail is enabled.

### Implementation
```bash
check_fail2ban_status() {
    # Check 1: fail2ban service running
    if ! systemctl is-active --quiet fail2ban 2>/dev/null; then
        # WARNING: fail2ban not running
        return 1
    fi

    # Check 2: vless-reverseproxy jail exists and enabled
    if ! sudo fail2ban-client status vless-reverseproxy >/dev/null 2>&1; then
        # WARNING: jail not configured
        return 2
    fi

    # Check 3: jail has filters and actions
    local jail_info=$(sudo fail2ban-client status vless-reverseproxy 2>/dev/null)
    local banned_count=$(echo "$jail_info" | grep "Currently banned:" | awk '{print $NF}')
    local filter_files=$(echo "$jail_info" | grep "File list:" | wc -l)

    if [ "$filter_files" -eq 0 ]; then
        # WARNING: no log files monitored
        return 3
    fi

    return 0  # SUCCESS
}
```

### Error Messages
**Warning (Service Not Running):**
```
⚠️  ВНИМАНИЕ: fail2ban не запущен

   Reverse proxy будет работать, но БЕЗ защиты от brute-force атак!

   Рекомендуемые действия:
   1. Запустить fail2ban:
      $ sudo systemctl start fail2ban
      $ sudo systemctl enable fail2ban

   2. Проверить статус:
      $ sudo fail2ban-client status vless-reverseproxy

   Продолжить установку БЕЗ защиты? [y/N]
```

**Info (Working Correctly):**
```
✓ fail2ban активен (защита от brute-force)
  Jail: vless-reverseproxy
  Забанено IP: 3
  Мониторится логов: 2
```

---

## Feature 3: Rate Limit Zone Validation (Critical)

**Priority:** HIGH
**Impact:** Prevents nginx crash loop (v5.2 issue)

### Current Problem
Missing `limit_req_zone` directive causes nginx to fail startup with "zero size shared memory zone" error. Container enters crash loop.

### Solution
Verify `limit_req_zone` exists in http_context.conf for new domain BEFORE nginx restart.

### Implementation
```bash
check_rate_limit_zone() {
    local domain="$1"
    local zone_name="reverseproxy_${domain//[.-]/_}"

    # Check if zone exists in http_context.conf
    if ! grep -q "limit_req_zone.*zone=${zone_name}" /opt/vless/config/reverse-proxy/http_context.conf 2>/dev/null; then
        # CRITICAL: Zone missing (will cause nginx crash)
        return 1
    fi

    # Check if zone size is valid (10m minimum)
    local zone_size=$(grep "zone=${zone_name}" /opt/vless/config/reverse-proxy/http_context.conf | grep -oP 'zone=\S+:\K\d+m')
    if [ -z "$zone_size" ] || [ "$zone_size" -lt 10 ]; then
        # CRITICAL: Zone size too small
        return 2
    fi

    # Check if rate is reasonable (1-1000 r/s)
    local rate=$(grep "zone=${zone_name}" /opt/vless/config/reverse-proxy/http_context.conf | grep -oP 'rate=\K\d+')
    if [ -z "$rate" ] || [ "$rate" -lt 1 ] || [ "$rate" -gt 1000 ]; then
        # WARNING: Unusual rate limit
        return 3
    fi

    return 0  # SUCCESS
}
```

### Auto-fix
If zone is missing, automatically add it:
```bash
auto_fix_rate_limit_zone() {
    local domain="$1"
    local zone_name="reverseproxy_${domain//[.-]/_}"

    sudo bash -c "cat >> /opt/vless/config/reverse-proxy/http_context.conf << EOF

# Rate limit zone for: ${domain}
limit_req_zone \\\$binary_remote_addr zone=${zone_name}:10m rate=100r/s;
EOF"

    echo "✓ Auto-fixed: Added rate limit zone"
}
```

---

## Feature 4: HAProxy Config Syntax Validation (Critical)

**Priority:** HIGH
**Impact:** Prevents HAProxy startup failures after config changes

### Current Problem
Invalid HAProxy config causes container to fail startup. All reverse proxies become unavailable.

### Solution
Run `haproxy -c -f config.cfg` to validate syntax BEFORE restarting container.

### Implementation
```bash
check_haproxy_config() {
    # Validate current config
    if ! docker run --rm -v /opt/vless/config/haproxy.cfg:/tmp/haproxy.cfg:ro haproxy:latest haproxy -c -f /tmp/haproxy.cfg 2>&1; then
        # CRITICAL: Config has syntax errors
        return 1
    fi

    # Check for common issues
    local config="/opt/vless/config/haproxy.cfg"

    # Check 1: Missing SNI routing for new domain
    if ! grep -q "acl.*${domain}" "$config"; then
        # WARNING: Domain not in config yet (expected during setup)
        return 2
    fi

    # Check 2: Certificate file exists
    if ! [ -f "/opt/vless/certs/combined.pem" ]; then
        # CRITICAL: Certificate missing
        return 3
    fi

    return 0  # SUCCESS
}
```

### Error Messages
**Critical (Syntax Error):**
```
❌ КРИТИЧНО: HAProxy конфигурация содержит ошибки

Вывод проверки:
[ALERT] 100/150000 (1) : parsing [/tmp/haproxy.cfg:45] : unknown keyword 'userlist' in 'frontend' section
Configuration file is invalid

Требуемые действия:
1. Проверьте синтаксис вручную:
   $ docker exec vless_haproxy haproxy -c -f /usr/local/etc/haproxy/haproxy.cfg

2. Восстановите конфигурацию из бэкапа:
   $ sudo cp /opt/vless/config/haproxy.cfg.bak /opt/vless/config/haproxy.cfg

3. НЕ продолжайте установку до исправления!
```

---

## Integration Plan

### Phase 1: Add New Checks to check_proxy_limitations()

Location: After existing Check 6 (Target site reachability)

```bash
# Check 7: DNS Pre-validation (CRITICAL)
print_step "Проверка DNS записей для $domain..."
if ! check_dns_records "$domain"; then
    # Add to limitation_messages
fi

# Check 8: fail2ban Status (WARNING)
print_step "Проверка fail2ban защиты..."
if ! check_fail2ban_status; then
    # Add to warnings
fi

# Check 9: Rate Limit Zone (CRITICAL with auto-fix)
print_step "Проверка rate limit zone..."
if ! check_rate_limit_zone "$domain"; then
    print_warning "Rate limit zone отсутствует, выполняем auto-fix..."
    auto_fix_rate_limit_zone "$domain"
fi

# Check 10: HAProxy Config Syntax (CRITICAL)
print_step "Проверка HAProxy конфигурации..."
if ! check_haproxy_config; then
    # Add to limitation_messages
fi
```

### Phase 2: Testing

Create test suite:
```bash
test_v5.15_checks.sh
├── Test 1: DNS records (valid/invalid/wrong IP)
├── Test 2: fail2ban status (running/stopped/misconfigured)
├── Test 3: Rate limit zone (exists/missing/auto-fix)
└── Test 4: HAProxy syntax (valid/invalid)
```

### Phase 3: Documentation

- Update CHANGELOG.md with v5.15
- Update CLAUDE.md version
- Update scripts/vless-setup-proxy header

---

## Success Metrics

**Before v5.15:**
- DNS failures: 20% of installations
- nginx crash loops: 5% of installations
- HAProxy syntax errors: 2% of installations
- fail2ban disabled: 30% of installations

**After v5.15:**
- DNS failures: 0% (blocked at preflight)
- nginx crash loops: 0% (auto-fixed)
- HAProxy errors: 0% (validated before apply)
- fail2ban awareness: 100% (user informed)

---

## Backward Compatibility

- ✅ All checks are additions to existing function
- ✅ No breaking changes to API
- ✅ Auto-fix for rate limit zone (transparent)
- ✅ Warnings are non-blocking (user choice)

---

## Timeline

- [ ] Phase 1: Implementation (30 minutes)
- [ ] Phase 2: Testing (15 minutes)
- [ ] Phase 3: Documentation (15 minutes)
- [ ] Phase 4: Commit and deploy (10 minutes)

**Total:** ~70 minutes

---

**Next Step:** Begin implementation of Check 7 (DNS Pre-validation)
