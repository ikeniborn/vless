<?xml version="1.0" encoding="UTF-8"?>
<plan>
    <tasks>
        <task id="1" description="Update docker-compose.yml.tpl to use host network mode">
            <actions>
                <action>Remove ports mapping (not needed with host mode)</action>
                <action>Remove custom network definition</action>
                <action>Add network_mode: host to service</action>
                <action>Update healthcheck to use host network</action>
            </actions>
            <validation>Template has network_mode: host and no port mapping</validation>
        </task>

        <task id="2" description="Create UFW firewall utility functions">
            <actions>
                <action>Add check_ufw_status function to lib/utils.sh</action>
                <action>Add ensure_ufw_rule function to lib/utils.sh</action>
                <action>Add port 443 rule management</action>
            </actions>
            <validation>Functions exist and handle UFW correctly</validation>
        </task>

        <task id="3" description="Update install.sh script">
            <actions>
                <action>Add UFW check before installation</action>
                <action>Configure UFW rules for port 443</action>
                <action>Update port conflict check for host mode</action>
                <action>Update docker-compose template application</action>
            </actions>
            <validation>Installation script properly handles host network and UFW</validation>
        </task>

        <task id="4" description="Update restart_xray_service function">
            <actions>
                <action>Verify service restart works with host network</action>
                <action>Update any network-specific checks</action>
            </actions>
            <validation>Service restarts correctly with host network</validation>
        </task>

        <task id="5" description="Update other affected scripts">
            <actions>
                <action>Update backup.sh if needed</action>
                <action>Update reinstall.sh if needed</action>
                <action>Update update.sh if needed</action>
            </actions>
            <validation>All scripts work with host network mode</validation>
        </task>

        <task id="6" description="Create validation tests">
            <actions>
                <action>Test template generation</action>
                <action>Test UFW rule management</action>
                <action>Test service startup with host mode</action>
            </actions>
            <validation>All tests pass successfully</validation>
        </task>

        <task id="7" description="Update documentation">
            <actions>
                <action>Update CLAUDE.md with network changes</action>
                <action>Add UFW requirements to documentation</action>
                <action>Document security implications</action>
            </actions>
            <validation>Documentation reflects all changes</validation>
        </task>
    </tasks>

    <execution_order>
        <step order="1" task_id="1" />
        <step order="2" task_id="2" />
        <step order="3" task_id="3" />
        <step order="4" task_id="4" />
        <step order="5" task_id="5" />
        <step order="6" task_id="6" />
        <step order="7" task_id="7" />
    </execution_order>

    <dependencies>
        <dependency task="3" requires="1,2" />
        <dependency task="4" requires="1" />
        <dependency task="5" requires="1,2,3" />
        <dependency task="6" requires="1,2,3,4,5" />
        <dependency task="7" requires="6" />
    </dependencies>
</plan>