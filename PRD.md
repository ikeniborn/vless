# Product Requirements Document (PRD)
## VLESS + REALITY VPN Service

### 1. Обзор проекта

**Название проекта:** VLESS + REALITY VPN Service
**Версия документа:** 1.0
**Дата:** 2025-09-26
**Тип проекта:** Личное использование
**Масштаб:** До 50 пользователей

### 2. Цель и задачи

#### 2.1 Цель проекта
Создание защищенного VPN сервиса на базе протокола VLESS с расширением REALITY для обхода DPI и блокировок, с простым CLI управлением и автоматизацией основных процессов.

#### 2.2 Основные задачи
- Развертывание Xray-core с поддержкой VLESS + REALITY в Docker
- Реализация CLI интерфейса для управления пользователями
- Автоматизация процессов установки и обновления
- Обеспечение простого администрирования через bash скрипты

### 3. Целевая аудитория

- **Основные пользователи:** Личное использование
- **Количество пользователей:** До 50
- **Технический уровень:** Средний опыт работы с Linux и Docker
- **Требования к интерфейсу:** CLI интерфейс

### 4. Функциональные требования

#### 4.1 Основные функции

##### 4.1.1 Установка и настройка
- Автоматическая установка через единый скрипт `install.sh`
- Интерактивное заполнение параметров окружения (.env)
- Валидация введенных данных с подтверждением
- Генерация X25519 ключей для REALITY
- Создание базовой конфигурации Xray
- Проверка работоспособности после установки

##### 4.1.2 Управление пользователями
- Добавление новых пользователей (генерация UUID)
- Удаление существующих пользователей
- Просмотр списка активных пользователей
- Генерация клиентских конфигураций:
  - vless:// ссылки для быстрого импорта
  - JSON конфигурации для различных клиентов
  - QR-коды 640x640 пикселей для мобильных устройств

##### 4.1.3 Обслуживание системы
- Автоматическое обновление Xray-core
- Резервное копирование конфигурации
- Просмотр и анализ логов через Docker
- Перезапуск сервиса при необходимости

#### 4.2 Ограничения (что НЕ входит в проект)
- Веб-интерфейс управления
- REST API
- Детальная статистика трафика по пользователям
- Графические дашборды и метрики
- Автоматическая ротация ключей
- Интеграция с внешними системами

### 5. Технические требования

#### 5.1 Системные требования
- **ОС:** Linux (Ubuntu 20.04+ / Debian 11+)
- **RAM:** Минимум 512 MB, рекомендуется 1 GB
- **CPU:** 1 vCPU
- **Диск:** 10 GB свободного места
- **Сеть:** Статический IP адрес, открытый порт 443
- **Базовая директория:** `/opt/vless/` (расположение всех файлов проекта)

#### 5.2 Технологический стек
- **Контейнеризация:** Docker 24.x, Docker Compose 2.x
- **VPN движок:** Xray-core (последняя версия)
- **Скрипты:** Bash
- **Утилиты:** qrencode, jq, curl, openssl

#### 5.3 Структура проекта

##### Структура Git репозитория:
```
vless/                          # Корневая директория репозитория
├── scripts/
│   ├── install.sh              # Установщик системы
│   ├── user-manager.sh         # Управление пользователями
│   ├── update.sh               # Обновление Xray-core
│   ├── backup.sh               # Резервное копирование
│   ├── logs.sh                 # Работа с логами
│   └── lib/
│       ├── colors.sh           # Цветной вывод в терминал
│       ├── utils.sh            # Вспомогательные функции
│       └── config.sh           # Работа с конфигурацией
├── templates/
│   ├── docker-compose.yml.tpl  # Шаблон Docker Compose
│   ├── config.json.tpl         # Шаблон конфигурации Xray
│   └── .env.example            # Пример переменных окружения
├── docs/
│   ├── README.md               # Быстрый старт
│   ├── ADMIN_GUIDE.md          # Руководство администратора
│   └── TROUBLESHOOTING.md      # Решение проблем
└── .gitignore                  # Исключения Git

##### Структура рабочего каталога (создается при установке):
/opt/vless/                     # Рабочий каталог (НЕ в репозитории)
├── docker-compose.yml          # Конфигурация Docker Compose
├── config/
│   └── config.json             # Рабочая конфигурация Xray
├── data/
│   ├── users.json              # База данных пользователей
│   └── keys/                   # Криптографические ключи
│       ├── private.key         # Приватный ключ X25519
│       └── public.key          # Публичный ключ X25519
├── backups/                    # Резервные копии
│   └── [timestamp]/            # Директории с датой/временем
├── logs/                       # Логи приложения
│   ├── xray.log               # Основной лог Xray
│   └── access.log             # Лог доступа
└── .env                        # Переменные окружения (создается интерактивно)
```

##### Важное разделение:
- **Репозиторий** содержит только скрипты, шаблоны и документацию
- **Рабочий каталог** `/opt/vless/` создается при установке и содержит:
  - Конфигурационные файлы
  - Пользовательские данные
  - Логи и резервные копии
  - Криптографические ключи
- **Рабочий каталог НЕ должен быть под контролем версий**

#### 5.4 Требования к правам доступа

##### Владелец файлов и директорий:
- **Пользователь:** root или выделенный системный пользователь (например, vless)
- **Группа:** docker (для доступа к Docker daemon)

##### Права доступа к директориям:
```bash
/opt/vless/                     # 755 (rwxr-xr-x)
├── config/                     # 750 (rwxr-x---)
├── scripts/                    # 750 (rwxr-x---)
│   └── lib/                    # 750 (rwxr-x---)
├── data/                       # 700 (rwx------)
│   └── keys/                   # 700 (rwx------)
├── backups/                    # 700 (rwx------)
├── logs/                       # 755 (rwxr-xr-x)
└── docs/                       # 755 (rwxr-xr-x)
```

##### Права доступа к файлам:
```bash
# Конфигурационные файлы
config/config.json              # 600 (rw-------)
config/config.json.template     # 644 (rw-r--r--)
.env                           # 600 (rw-------)

# Скрипты
scripts/*.sh                    # 750 (rwxr-x---)
scripts/lib/*.sh               # 640 (rw-r-----)

# Данные и ключи
data/users.json                # 600 (rw-------)
data/keys/*                    # 600 (rw-------)

# Документация
docs/*.md                      # 644 (rw-r--r--)

# Docker файлы
docker-compose.yml             # 640 (rw-r-----)
```

##### Требования для Docker:
- Docker daemon должен работать от root
- Пользователь, запускающий скрипты, должен быть в группе docker
- Контейнер xray-server работает с UID 1000 внутри контейнера
- Монтируемые volumes наследуют права от хост-системы

##### Команды для установки прав:
```bash
# Создание структуры и установка прав при инсталляции
sudo mkdir -p /opt/vless/{config,scripts/lib,data/keys,backups,logs}
sudo chown -R root:docker /opt/vless
sudo chmod 755 /opt/vless
sudo chmod 750 /opt/vless/{config,scripts}
sudo chmod 700 /opt/vless/{data,data/keys,backups}
sudo chmod 755 /opt/vless/logs

# Установка прав на конфиденциальные файлы
sudo chmod 600 /opt/vless/config/config.json
sudo chmod 600 /opt/vless/data/users.json
sudo chmod 600 /opt/vless/data/keys/*
sudo chmod 600 /opt/vless/.env
```

##### Работа скриптов с рабочим каталогом:
Все скрипты управления используют переменную окружения для определения рабочего каталога:
```bash
# В начале каждого скрипта
VLESS_HOME="${VLESS_HOME:-/opt/vless}"
cd "$VLESS_HOME" || exit 1

# Пути к важным файлам и директориям
CONFIG_FILE="$VLESS_HOME/config/config.json"
USERS_FILE="$VLESS_HOME/data/users.json"
KEYS_DIR="$VLESS_HOME/data/keys"
BACKUP_DIR="$VLESS_HOME/backups"
LOGS_DIR="$VLESS_HOME/logs"
```

Это позволяет:
- Корректно работать из любого места в системе
- При необходимости переопределить рабочий каталог через переменную окружения
- Обеспечить консистентность путей во всех скриптах

### 6. Архитектура решения

#### 6.1 Компоненты системы

##### Docker контейнеры:
- **xray-server:** Основной контейнер с Xray-core
  - Image: teddysun/xray:latest
  - Порт: 443
  - Volumes:
    - /opt/vless/config:/etc/xray:ro
    - /opt/vless/logs:/var/log/xray
    - /opt/vless/data:/data:ro

##### Bash скрипты:
1. **install.sh** - Мастер установки
   - Проверка системных требований
   - Установка Docker и Docker Compose
   - Интерактивный ввод параметров конфигурации:
     * SERVER_IP - автоопределение внешнего IP с подтверждением/ручным вводом
     * SERVER_NAME - целевой домен для REALITY (по умолчанию speed.cloudflare.com)
     * SHORT_ID - автоматическая генерация уникального идентификатора администратора
     * ADMIN_EMAIL - email администратора (опционально)
   - Валидация введенных данных:
     * Проверка формата IP адреса (если введен вручную)
     * Проверка доступности целевого домена
     * Автоматическая генерация SHORT_ID (8 hex символов)
     * Валидация email (если указан)
   - Подтверждение введенных данных перед продолжением
   - Копирование скриптов из репозитория в /opt/vless/scripts/
   - Создание рабочих каталогов в /opt/vless/
   - Генерация X25519 ключей
   - Создание конфигурации из шаблонов с подстановкой параметров
   - Сохранение параметров в /opt/vless/.env
   - Установка корректных прав доступа (600 для .env)
   - Создание символических ссылок в /usr/local/bin/

2. **user-manager.sh** - Интерактивное меню управления
   - Работает с данными в /opt/vless/data/
   - Добавление пользователя:
     * Автоматическая генерация UUID
     * Автоматическая генерация уникального Short ID (8 hex символов)
   - Удаление пользователя
   - Показать список пользователей
   - Экспорт конфигурации пользователя:
     * vless:// ссылка
     * JSON конфигурация
     * QR-код 640x640 пикселей (PNG формат)
   - Автоматическое обновление config.json

3. **update.sh** - Обновление Xray
   - Работает с /opt/vless/ как базовой директорией
   - Проверка новой версии
   - Безопасное обновление контейнера
   - Сохранение конфигурации перед обновлением
   - Автоматический перезапуск с проверкой

4. **backup.sh** - Резервное копирование
   - Создание timestamped директории в /opt/vless/backups/
   - Сохранение конфигурации из /opt/vless/config/
   - Экспорт списка пользователей из /opt/vless/data/
   - Архивация ключей из /opt/vless/data/keys/
   - Ротация старых бэкапов (хранение последних 30)

5. **logs.sh** - Мониторинг
   - Чтение логов из /opt/vless/logs/
   - Просмотр логов в реальном времени
   - Фильтрация по уровню важности
   - Экспорт логов с архивацией
   - Интеграция с docker logs для контейнера

#### 6.2 Конфигурация REALITY

##### Серверная конфигурация (config.json):
```json
{
  "log": {
    "loglevel": "warning"
  },
  "inbounds": [
    {
      "port": 443,
      "protocol": "vless",
      "settings": {
        "clients": [
          {
            "id": "{{ UUID }}",
            "flow": "xtls-rprx-vision"
          }
        ],
        "decryption": "none"
      },
      "streamSettings": {
        "network": "tcp",
        "security": "reality",
        "realitySettings": {
          "dest": "{{ REALITY_DEST }}",
          "serverNames": [
            "{{ REALITY_SERVER_NAME }}"
          ],
          "privateKey": "{{ PRIVATE_KEY }}",
          "shortIds": [
            "",
            "{{ SHORT_ID }}"
          ]
        }
      },
      "sniffing": {
        "enabled": true,
        "destOverride": [
          "http",
          "tls"
        ]
      }
    }
  ],
  "outbounds": [
    {
      "protocol": "freedom",
      "tag": "direct"
    },
    {
      "protocol": "blackhole",
      "tag": "block"
    }
  ]
}
```

##### Клиентская конфигурация (пример для v2rayNG/Nekobox):
```json
{
  "log": {
    "loglevel": "warning"
  },
  "inbounds": [
    {
      "port": 10808,
      "listen": "127.0.0.1",
      "protocol": "socks",
      "settings": {
        "udp": true
      }
    }
  ],
  "outbounds": [
    {
      "protocol": "vless",
      "settings": {
        "vnext": [
          {
            "address": "{{ SERVER_IP }}",
            "port": 443,
            "users": [
              {
                "id": "{{ UUID }}",
                "encryption": "none",
                "flow": "xtls-rprx-vision"
              }
            ]
          }
        ]
      },
      "streamSettings": {
        "network": "tcp",
        "security": "reality",
        "realitySettings": {
          "fingerprint": "chrome",
          "serverName": "{{ REALITY_SERVER_NAME }}",
          "publicKey": "{{ PUBLIC_KEY }}",
          "shortId": "{{ SHORT_ID }}",
          "spiderX": ""
        }
      }
    }
  ]
}
```

##### Ключевые параметры:
- **flow: "xtls-rprx-vision"** - обязательный параметр для REALITY, обеспечивает оптимальную производительность
- **decryption: "none"** - для VLESS всегда должно быть "none"
- **sniffing** - включено для определения типа трафика и правильной маршрутизации
- **fingerprint: "chrome"** - эмуляция TLS отпечатка браузера Chrome (можно также firefox, safari, ios, android)
- **shortIds** - массив идентификаторов, пустая строка "" означает возможность подключения без shortId
- **spiderX** - дополнительный параметр безопасности (опционально)

##### Формат vless:// ссылки для клиентов:
```
vless://{{ UUID }}@{{ SERVER_IP }}:443?encryption=none&flow=xtls-rprx-vision&security=reality&sni={{ REALITY_SERVER_NAME }}&fp=chrome&pbk={{ PUBLIC_KEY }}&sid={{ SHORT_ID }}&type=tcp&headerType=none#VLESS-REALITY
```

Параметры ссылки:
- **encryption=none** - без шифрования (обязательно для VLESS)
- **flow=xtls-rprx-vision** - тип потока данных
- **security=reality** - использование REALITY
- **sni** - имя сервера для SNI
- **fp** - fingerprint браузера
- **pbk** - публичный ключ сервера (base64)
- **sid** - short ID пользователя
- **type=tcp** - тип транспорта
- **#VLESS-REALITY** - имя конфигурации для отображения в клиенте

#### 6.3 Параметры окружения (.env)

##### Обязательные параметры:
```bash
# Основные настройки сервера
SERVER_IP=          # Внешний IP адрес сервера (автоопределение с подтверждением)
SERVER_PORT=443     # Порт для входящих соединений (по умолчанию 443)

# REALITY настройки
REALITY_DEST=speed.cloudflare.com:443    # Целевой сайт для маскировки
REALITY_SERVER_NAME=speed.cloudflare.com # Имя сервера из сертификата

# Администратор
ADMIN_SHORT_ID=     # Идентификатор администратора (генерируется автоматически)
ADMIN_EMAIL=        # Email для уведомлений (опционально)

# Системные настройки
COMPOSE_PROJECT_NAME=vless-reality
TZ=UTC              # Временная зона
```

##### Процесс валидации при установке:
1. **SERVER_IP** - автоопределение через curl ifconfig.me, затем подтверждение или ручной ввод
2. **SERVER_PORT** - проверка диапазона (1-65535) и доступности
3. **REALITY_DEST** - проверка доступности целевого сайта через curl
4. **ADMIN_SHORT_ID** - автоматическая генерация 8 hex символов через openssl rand -hex 4
5. **ADMIN_EMAIL** - валидация формата email через regex (если указан)

##### Интерактивный ввод:
```bash
# Пример диалога установщика
========================================
VLESS + REALITY Configuration
========================================

[1/4] Detecting server IP address...
→ Detected IP: 192.168.1.100
Is this correct? [Y/n]: Y
✓ IP address confirmed

[2/4] Enter target domain for REALITY [speed.cloudflare.com]:
> (нажатие Enter для значения по умолчанию)
✓ Using default: speed.cloudflare.com
✓ Domain is accessible

[3/4] Generating admin Short ID...
→ Generated ID: a1b2c3d4
✓ Admin Short ID created

[4/4] Enter admin email (optional, press Enter to skip):
> admin@example.com
✓ Valid email format

Confirm configuration:
----------------------------------------
Server IP:        192.168.1.100
Server Port:      443
REALITY Target:   speed.cloudflare.com
Admin Short ID:   a1b2c3d4 (автогенерирован)
Admin Email:      admin@example.com
----------------------------------------
Is this correct? [Y/n]: Y

✓ Configuration saved to /opt/vless/.env
✓ File permissions set to 600
```

### 7. План реализации

#### Этап 1: Базовая инфраструктура (2-3 дня) ✅ **ВЫПОЛНЕН**
- [x] Создание структуры репозитория
- [x] Написание шаблонов (docker-compose.yml.tpl, config.json.tpl, .env.example)
- [x] Скрипт install.sh с интерактивным вводом параметров
- [x] Реализация валидации вводимых данных
- [x] Создание рабочих каталогов в /opt/vless/
- [x] Копирование файлов из репозитория в /opt/vless/
- [x] Генерация .env файла с введенными параметрами
- [x] Генерация X25519 ключей
- [x] Установка корректных прав доступа
- [x] Тестирование базового функционала

#### Этап 2: Управление пользователями (2-3 дня) ✅ **ВЫПОЛНЕН**
- [x] Скрипт user-manager.sh
- [x] Функции CRUD для пользователей
- [x] Генерация UUID
- [x] Создание vless:// ссылок
- [x] Генерация QR-кодов 640x640 пикселей
- [x] Система хранения в users.json

#### Этап 3: Автоматизация (2 дня) ✅ **ВЫПОЛНЕН**
- [x] Скрипт update.sh
- [x] Скрипт backup.sh
- [x] Скрипт logs.sh
- [ ] Настройка cron задач (опционально, по желанию администратора)
- [x] Библиотеки вспомогательных функций

#### Этап 4: Документация (1-2 дня) ✅ **ВЫПОЛНЕН**
- [x] README.md с быстрым стартом
- [x] ADMIN_GUIDE.md
- [x] TROUBLESHOOTING.md
- [x] Примеры использования (включены в документацию)
- [x] FAQ (включен в TROUBLESHOOTING.md)

### 8. Безопасность

#### 8.1 Меры безопасности
- Использование REALITY для маскировки трафика
- Хранение ключей с ограниченными правами (600)
- Изоляция Docker контейнера
- Отсутствие открытых портов кроме 443
- Регулярное обновление Xray-core
- Монтирование конфигурационных volumes в режиме read-only (:ro)
- Разделение прав доступа между пользователями и процессами
- Все конфиденциальные данные в /opt/vless с ограниченным доступом

#### 8.2 Рекомендации по использованию
- Выбор целевого сайта вне юрисдикции страны
- Использование сложных shortIds
- Регулярное резервное копирование
- Мониторинг логов на предмет аномалий

### 9. Критерии успеха

1. **Функциональность:**
   - Успешная установка за один запуск скрипта
   - Работающее подключение клиентов
   - Стабильная работа при 50 пользователях

2. **Удобство использования:**
   - Интуитивное CLI меню
   - Время добавления пользователя < 1 минуты
   - Автоматическая генерация всех форматов конфигураций

3. **Надежность:**
   - Автоматическое восстановление после сбоев
   - Успешное обновление без потери конфигурации
   - Работоспособные резервные копии

### 10. Риски и митигация

| Риск | Вероятность | Влияние | Митигация |
|------|-------------|---------|-----------|
| Блокировка целевого сайта | Средняя | Высокое | Список альтернативных сайтов |
| Обнаружение VPN трафика | Низкая | Высокое | Регулярное обновление Xray |
| Потеря конфигурации | Низкая | Среднее | Автоматические бэкапы |
| Сложность для пользователя | Средняя | Низкое | Подробная документация |

### 11. Поддержка и обслуживание

#### 11.1 Регулярное обслуживание
- Еженедельная проверка обновлений Xray-core
- Ежемесячное резервное копирование
- Мониторинг логов на ошибки

#### 11.2 Документация для администратора
- Пошаговая инструкция установки
- Руководство по управлению пользователями
- Часто встречающиеся проблемы и решения
- Процедуры восстановления

### 12. Будущие улучшения (вне текущего scope)

Возможные расширения функциональности в будущем:
- Веб-интерфейс управления
- REST API для автоматизации
- Интеграция с Telegram ботом
- Детальная статистика использования
- Поддержка множественных серверов
- Автоматический failover

---

## Заключение

Данный PRD описывает создание функционального VPN сервиса на базе VLESS + REALITY с фокусом на простоту управления через CLI, надежность работы и легкость администрирования. Решение оптимизировано для личного использования с поддержкой до 50 пользователей и не требует глубоких технических знаний для повседневного управления.

**Статус документа:** Утвержден
**Готовность к реализации:** Да
**Ориентировочные сроки:** 7-10 дней