# Product Requirements Document (PRD)
## VLESS + REALITY VPN Service

### 1. Обзор проекта

**Название проекта:** VLESS + REALITY VPN Service
**Версия документа:** 1.4
**Дата:** 2025-10-01
**Тип проекта:** Личное использование
**Масштаб:** До 50 пользователей

#### История изменений:
- **v1.4 (2025-10-01):** Реализована полная интеграция UFW с Docker bridge networking. Добавлены функции автоматической настройки UFW FORWARD правил, диагностика конфликтов UFW, функция удаления UFW правил. Решена критическая проблема отсутствия интернета в контейнере при активном UFW.
- **v1.3 (2025-09-30):** Переход с host на bridge network mode, автоматическая настройка IP forwarding и NAT, динамическое определение свободной Docker подсети
- **v1.2 (2025-09-29):** Внедрение комплексных требований безопасности (мониторинг, ротация ключей, управление квотами, расширенная фильтрация трафика)
- **v1.1 (2025-09-29):** Добавлен host network mode для Docker, интеграция с UFW firewall
- **v1.0 (2025-09-26):** Начальная версия документа

### 2. Цель и задачи

#### 2.1 Цель проекта
Создание защищенного VPN сервиса на базе протокола VLESS с расширением REALITY для обхода DPI и блокировок, с простым CLI управлением и автоматизацией основных процессов.

#### 2.2 Основные задачи
- Развертывание Xray-core с поддержкой VLESS + REALITY в Docker
- Реализация CLI интерфейса для управления пользователями
- Автоматизация процессов установки и обновления
- Обеспечение простого администрирования через bash скрипты

### 3. Целевая аудитория

- **Основные пользователи:** Личное использование
- **Количество пользователей:** До 50
- **Технический уровень:** Средний опыт работы с Linux и Docker
- **Требования к интерфейсу:** CLI интерфейс

### 4. Функциональные требования

#### 4.1 Основные функции

##### 4.1.1 Установка и настройка
- Автоматическая установка через единый скрипт `install.sh`
- Интерактивное заполнение параметров окружения (.env)
- Валидация введенных данных с подтверждением
- Генерация X25519 ключей для REALITY
- Создание базовой конфигурации Xray
- Автоматическая настройка UFW firewall (если установлен):
  - Настройка DEFAULT_FORWARD_POLICY
  - Добавление явных FORWARD правил для Docker subnet
  - Автоматическое определение и настройка правил для bridge network
- Проверка конфликтов с другими VPN сервисами (pre-installation check)
- Проверка работоспособности после установки

##### 4.1.2 Управление пользователями
- Добавление новых пользователей (генерация UUID)
- Удаление существующих пользователей
- Просмотр списка активных пользователей
- Генерация клиентских конфигураций:
  - vless:// ссылки для быстрого импорта
  - JSON конфигурации для различных клиентов
  - QR-коды 640x640 пикселей для мобильных устройств

##### 4.1.3 Обслуживание системы
- Автоматическое обновление Xray-core
- Резервное копирование конфигурации
- Просмотр и анализ логов через Docker
- Перезапуск сервиса при необходимости

##### 4.1.4 Мониторинг и безопасность
- Система обнаружения аномалий в трафике
- Автоматическая блокировка подозрительных IP при превышении порога
- Генерация ежедневных security отчетов
- Мониторинг попыток неавторизованного доступа
- Проверка целостности конфигурационных файлов
- Логирование всех критических событий безопасности

##### 4.1.5 Ротация ключей и секретов
- Автоматическая генерация новых X25519 ключей
- Ротация shortIds для пользователей
- Резервное копирование перед ротацией
- Уведомление пользователей о необходимости обновления конфигурации
- Настройка периодичности ротации (рекомендуется ежемесячно)
- Логирование всех операций ротации

##### 4.1.6 Управление квотами пользователей
- Установка лимитов bandwidth для каждого пользователя
- Настройка срока действия аккаунтов (expiry date)
- Автоматическая блокировка при превышении квот
- Проверка статуса пользователей (активен/заблокирован/просрочен)
- Отслеживание использованного трафика через API
- Многоуровневые права доступа (admin, moderator, user)

#### 4.2 Ограничения (что НЕ входит в проект)
- Веб-интерфейс управления
- REST API
- Графические дашборды и метрики в режиме реального времени
- Telegram бот для управления
- Полная интеграция с SIEM системами

### 5. Технические требования

#### 5.1 Системные требования
- **ОС:** Linux (Ubuntu 20.04+ / Debian 11+)
- **RAM:** Минимум 512 MB, рекомендуется 1 GB
- **CPU:** 1 vCPU
- **Диск:** 10 GB свободного места
- **Сеть:** Статический IP адрес, открытый порт 443
- **Базовая директория:** `/opt/vless/` (расположение всех файлов проекта)

#### 5.2 Технологический стек
- **Контейнеризация:** Docker 24.x, Docker Compose 2.x
- **VPN движок:** Xray-core (последняя версия)
- **Сетевой режим:** Bridge network mode с автоматической настройкой NAT и IP forwarding
- **Сетевая конфигурация:** Автоматическое определение свободной Docker подсети (172.16-254.x.x/16)
- **Маршрутизация:** Автоматическая настройка IP forwarding, iptables NAT MASQUERADE, UFW FORWARD правил для Docker bridge
- **UFW Интеграция:** Автоматическая настройка UFW FORWARD правил (`ufw route allow`), совместимость с Docker автоматическим NAT
- **Скрипты:** Bash
- **Базовые утилиты:** qrencode, jq, curl, openssl, ufw (опционально)
- **Дополнительные утилиты для security:** iptables, netfilter-persistent (для сохранения правил), tcpdump (для диагностики), netstat

#### 5.3 Структура проекта

##### Структура Git репозитория:
```
vless/                          # Корневая директория репозитория
├── scripts/
│   ├── install.sh              # Установщик системы
│   ├── user-manager.sh         # Управление пользователями
│   ├── update.sh               # Обновление Xray-core
│   ├── backup.sh               # Резервное копирование
│   ├── logs.sh                 # Работа с логами
│   ├── lib/
│   │   ├── colors.sh           # Цветной вывод в терминал
│   │   ├── utils.sh            # Вспомогательные функции
│   │   ├── config.sh           # Работа с конфигурацию
│   │   ├── network.sh          # Сетевые настройки (IP forwarding, NAT, UFW FORWARD правила, определение свободной подсети, диагностика конфликтов)
│   │   └── security.sh         # Функции безопасности (генерация shortIds, проверка квот)
│   ├── monitoring/
│   │   ├── monitor-security.sh # Мониторинг безопасности в реальном времени
│   │   └── security-metrics.sh # Генерация отчетов безопасности
│   └── security/
│       ├── rotate-keys.sh      # Ротация X25519 ключей
│       ├── rotate-shortids.sh  # Ротация shortIds пользователей
│       ├── check-user-limits.sh # Проверка квот пользователей
│       └── security-check.sh   # Комплексная проверка безопасности
├── templates/
│   ├── docker-compose.yml.tpl  # Шаблон Docker Compose
│   ├── config.json.tpl         # Шаблон конфигурации Xray
│   ├── config_with_dns.json.tpl # Шаблон с кастомным DNS
│   ├── routing_rules.json      # Правила маршрутизации трафика
│   ├── dns_config.json         # Конфигурация DNS с защитой от утечек
│   └── .env.example            # Пример переменных окружения
├── docs/
│   ├── README.md               # Быстрый старт
│   ├── ADMIN_GUIDE.md          # Руководство администратора
│   ├── TROUBLESHOOTING.md      # Решение проблем
│   └── SECURITY_GUIDE.md       # Руководство по безопасности
└── .gitignore                  # Исключения Git

##### Структура рабочего каталога (создается при установке):
/opt/vless/                     # Рабочий каталог (НЕ в репозитории)
├── docker-compose.yml          # Конфигурация Docker Compose
├── config/
│   └── config.json             # Рабочая конфигурация Xray
├── data/
│   ├── users.json              # База данных пользователей (расширенная с квотами)
│   ├── qr_codes/               # QR коды для пользователей
│   └── keys/                   # Криптографические ключи
│       ├── private.key         # Приватный ключ X25519
│       └── public.key          # Публичный ключ X25519
├── backups/                    # Резервные копии
│   └── [timestamp]/            # Директории с датой/временем
├── logs/                       # Логи приложения
│   ├── xray.log               # Основной лог Xray
│   ├── access.log             # Лог доступа
│   ├── security/               # Логи безопасности
│   │   ├── anomalies.log      # Обнаруженные аномалии
│   │   ├── security-report-*.txt # Ежедневные отчеты
│   │   └── key-rotation.log   # История ротаций ключей
│   └── monitoring/             # Логи мониторинга
├── scripts/                    # Копия скриптов из репозитория
└── .env                        # Переменные окружения (создается интерактивно)
```

##### Важное разделение:
- **Репозиторий** содержит только скрипты, шаблоны и документацию
- **Рабочий каталог** `/opt/vless/` создается при установке и содержит:
  - Конфигурационные файлы
  - Пользовательские данные
  - Логи и резервные копии
  - Криптографические ключи
- **Рабочий каталог НЕ должен быть под контролем версий**

#### 5.4 Требования к правам доступа

##### Владелец файлов и директорий:
- **Пользователь:** root или выделенный системный пользователь (например, vless)
- **Группа:** docker (для доступа к Docker daemon)

##### Права доступа к директориям:
```bash
/opt/vless/                     # 755 (rwxr-xr-x)
├── config/                     # 750 (rwxr-x---)
├── scripts/                    # 750 (rwxr-x---)
│   └── lib/                    # 750 (rwxr-x---)
├── data/                       # 700 (rwx------)
│   └── keys/                   # 700 (rwx------)
├── backups/                    # 700 (rwx------)
├── logs/                       # 755 (rwxr-xr-x)
└── docs/                       # 755 (rwxr-xr-x)
```

##### Права доступа к файлам:
```bash
# Конфигурационные файлы
config/config.json              # 600 (rw-------)
config/config.json.template     # 644 (rw-r--r--)
.env                           # 600 (rw-------)

# Скрипты
scripts/*.sh                    # 750 (rwxr-x---)
scripts/lib/*.sh               # 640 (rw-r-----)

# Данные и ключи
data/users.json                # 600 (rw-------)
data/keys/*                    # 600 (rw-------)

# Документация
docs/*.md                      # 644 (rw-r--r--)

# Docker файлы
docker-compose.yml             # 640 (rw-r-----)
```

##### Требования для Docker:
- Docker daemon должен работать от root
- Пользователь, запускающий скрипты, должен быть в группе docker
- Контейнер xray-server работает с UID 1000 внутри контейнера
- Монтируемые volumes наследуют права от хост-системы
- Используется bridge network mode с автоматическим port mapping
- IP forwarding и NAT автоматически настраиваются при установке
- UFW автоматически конфигурируется для работы с Docker bridge network:
  - Explicit FORWARD правила для Docker subnet
  - Автоматическое определение и настройка при активном UFW
  - Graceful degradation если UFW не установлен/не активен
  - Поддержка cleanup через функцию remove_ufw_docker_rules()

##### Команды для установки прав:
```bash
# Создание структуры и установка прав при инсталляции
sudo mkdir -p /opt/vless/{config,scripts/lib,data/keys,backups,logs}
sudo chown -R root:docker /opt/vless
sudo chmod 755 /opt/vless
sudo chmod 750 /opt/vless/{config,scripts}
sudo chmod 700 /opt/vless/{data,data/keys,backups}
sudo chmod 755 /opt/vless/logs

# Установка прав на конфиденциальные файлы
sudo chmod 600 /opt/vless/config/config.json
sudo chmod 600 /opt/vless/data/users.json
sudo chmod 600 /opt/vless/data/keys/*
sudo chmod 600 /opt/vless/.env
```

##### Работа скриптов с рабочим каталогом:
Все скрипты управления используют переменную окружения для определения рабочего каталога:
```bash
# В начале каждого скрипта
VLESS_HOME="${VLESS_HOME:-/opt/vless}"
cd "$VLESS_HOME" || exit 1

# Пути к важным файлам и директориям
CONFIG_FILE="$VLESS_HOME/config/config.json"
USERS_FILE="$VLESS_HOME/data/users.json"
KEYS_DIR="$VLESS_HOME/data/keys"
BACKUP_DIR="$VLESS_HOME/backups"
LOGS_DIR="$VLESS_HOME/logs"
```

Это позволяет:
- Корректно работать из любого места в системе
- При необходимости переопределить рабочий каталог через переменную окружения
- Обеспечить консистентность путей во всех скриптах

### 6. Архитектура решения

#### 6.1 Компоненты системы

##### Docker контейнеры:
- **xray-server:** Основной контейнер с Xray-core
  - Image: teddysun/xray:latest
  - Порт: 443 (внутренний), настраиваемый внешний порт через SERVER_PORT
  - Network mode: bridge (vless-network)
  - Subnet: Автоматически определяется из свободного диапазона 172.16-254.x.x/16
  - Port mapping: {{SERVER_PORT}}:443
  - Volumes:
    - /opt/vless/config:/etc/xray:ro
    - /opt/vless/logs:/var/log/xray
    - /opt/vless/data:/data:ro

##### Bash скрипты:
1. **install.sh** - Мастер установки
   - Проверка системных требований
   - Установка Docker и Docker Compose
   - Интерактивный ввод параметров конфигурации:
     * SERVER_IP - автоопределение внешнего IP с подтверждением/ручным вводом
     * SERVER_NAME - целевой домен для REALITY (по умолчанию speed.cloudflare.com)
     * SHORT_ID - автоматическая генерация уникального идентификатора администратора
     * ADMIN_EMAIL - email администратора (опционально)
   - Валидация введенных данных:
     * Проверка формата IP адреса (если введен вручную)
     * Проверка доступности целевого домена
     * Автоматическая генерация SHORT_ID (8 hex символов)
     * Валидация email (если указан)
   - Конфигурация firewall:
     * Проверка статуса UFW
     * Автоматическое добавление правила для порта 443
     * Настройка DEFAULT_FORWARD_POLICY="ACCEPT"
     * Добавление UFW FORWARD правил для Docker subnet (ufw route allow)
     * Автоматическая диагностика конфликтов с другими VPN сервисами
     * Graceful degradation если UFW не установлен
   - Подтверждение введенных данных перед продолжением
   - Копирование скриптов из репозитория в /opt/vless/scripts/
   - Создание рабочих каталогов в /opt/vless/
   - Генерация X25519 ключей
   - Создание конфигурации из шаблонов с подстановкой параметров
   - Сохранение параметров в /opt/vless/.env
   - Установка корректных прав доступа (600 для .env)
   - Создание символических ссылок в /usr/local/bin/

2. **user-manager.sh** - Интерактивное меню управления
   - Работает с данными в /opt/vless/data/
   - Добавление пользователя:
     * Автоматическая генерация UUID
     * Автоматическая генерация уникального Short ID (8 hex символов)
   - Удаление пользователя
   - Показать список пользователей
   - Экспорт конфигурации пользователя:
     * vless:// ссылка
     * JSON конфигурация
     * QR-код 640x640 пикселей (PNG формат)
   - Автоматическое обновление config.json

3. **update.sh** - Обновление Xray
   - Работает с /opt/vless/ как базовой директорией
   - Проверка новой версии
   - Безопасное обновление контейнера
   - Сохранение конфигурации перед обновлением
   - Автоматический перезапуск с проверкой

4. **backup.sh** - Резервное копирование
   - Создание timestamped директории в /opt/vless/backups/
   - Сохранение конфигурации из /opt/vless/config/
   - Экспорт списка пользователей из /opt/vless/data/
   - Архивация ключей из /opt/vless/data/keys/
   - Ротация старых бэкапов (хранение последних 30)

5. **logs.sh** - Мониторинг
   - Чтение логов из /opt/vless/logs/
   - Просмотр логов в реальном времени
   - Фильтрация по уровню важности
   - Экспорт логов с архивацией
   - Интеграция с docker logs для контейнера

6. **monitor-security.sh** - Мониторинг безопасности
   - Обнаружение аномалий в трафике в реальном времени
   - Автоматическая блокировка подозрительных IP через UFW
   - Отслеживание множественных попыток подключения
   - Обнаружение brute-force атак
   - Логирование всех security событий

7. **security-metrics.sh** - Отчеты безопасности
   - Генерация ежедневных security отчетов
   - Статистика подключений и уникальных IP
   - Анализ заблокированных соединений
   - Проверка целостности конфигурационных файлов
   - Интеграция с cron для автоматического запуска

8. **rotate-keys.sh** - Ротация ключей
   - Автоматическая генерация новых X25519 ключей
   - Резервное копирование текущей конфигурации
   - Обновление config.json и .env файлов
   - Безопасный перезапуск сервиса
   - Логирование всех операций ротации
   - Поддержка планового запуска через cron

9. **check-user-limits.sh** - Управление квотами
   - Проверка bandwidth квот для каждого пользователя
   - Контроль сроков действия аккаунтов (expiry date)
   - Автоматическая блокировка при превышении лимитов
   - Обновление статистики использования через Xray API
   - Уведомление о приближении к лимитам

#### 6.2 Конфигурация REALITY

##### Серверная конфигурация (config.json):
```json
{
  "log": {
    "loglevel": "warning"
  },
  "inbounds": [
    {
      "port": 443,
      "protocol": "vless",
      "settings": {
        "clients": [
          {
            "id": "{{ UUID }}",
            "flow": "xtls-rprx-vision"
          }
        ],
        "decryption": "none"
      },
      "streamSettings": {
        "network": "tcp",
        "security": "reality",
        "realitySettings": {
          "dest": "{{ REALITY_DEST }}",
          "serverNames": [
            "{{ REALITY_SERVER_NAME }}",
            "www.microsoft.com",
            "www.apple.com",
            "www.cloudflare.com"
          ],
          "privateKey": "{{ PRIVATE_KEY }}",
          "shortIds": [
            "",
            "{{ SHORT_ID }}"
          ],
          "minClientVer": "1.8.0",
          "maxTimeDiff": 90
        }
      },
      "sniffing": {
        "enabled": true,
        "destOverride": [
          "http",
          "tls"
        ]
      }
    }
  ],
  "outbounds": [
    {
      "protocol": "freedom",
      "tag": "direct"
    },
    {
      "protocol": "blackhole",
      "tag": "block"
    }
  ]
}
```

##### Клиентская конфигурация (пример для v2rayNG/Nekobox):
```json
{
  "log": {
    "loglevel": "warning"
  },
  "inbounds": [
    {
      "port": 10808,
      "listen": "127.0.0.1",
      "protocol": "socks",
      "settings": {
        "udp": true
      }
    }
  ],
  "outbounds": [
    {
      "protocol": "vless",
      "settings": {
        "vnext": [
          {
            "address": "{{ SERVER_IP }}",
            "port": 443,
            "users": [
              {
                "id": "{{ UUID }}",
                "encryption": "none",
                "flow": "xtls-rprx-vision"
              }
            ]
          }
        ]
      },
      "streamSettings": {
        "network": "tcp",
        "security": "reality",
        "realitySettings": {
          "fingerprint": "chrome",
          "serverName": "{{ REALITY_SERVER_NAME }}",
          "publicKey": "{{ PUBLIC_KEY }}",
          "shortId": "{{ SHORT_ID }}",
          "spiderX": ""
        }
      }
    }
  ]
}
```

##### Ключевые параметры:
- **flow: "xtls-rprx-vision"** - обязательный параметр для REALITY, обеспечивает оптимальную производительность
- **decryption: "none"** - для VLESS всегда должно быть "none"
- **sniffing** - включено для определения типа трафика и правильной маршрутизации
- **fingerprint: "chrome"** - эмуляция TLS отпечатка браузера Chrome (можно также firefox, safari, ios, android)
- **shortIds** - массив идентификаторов, пустая строка "" означает возможность подключения без shortId
- **spiderX** - дополнительный параметр безопасности (опционально)

##### Формат vless:// ссылки для клиентов:
```
vless://{{ UUID }}@{{ SERVER_IP }}:443?encryption=none&flow=xtls-rprx-vision&security=reality&sni={{ REALITY_SERVER_NAME }}&fp=chrome&pbk={{ PUBLIC_KEY }}&sid={{ SHORT_ID }}&type=tcp&headerType=none#VLESS-REALITY
```

Параметры ссылки:
- **encryption=none** - без шифрования (обязательно для VLESS)
- **flow=xtls-rprx-vision** - тип потока данных
- **security=reality** - использование REALITY
- **sni** - имя сервера для SNI
- **fp** - fingerprint браузера
- **pbk** - публичный ключ сервера (base64)
- **sid** - short ID пользователя
- **type=tcp** - тип транспорта
- **#VLESS-REALITY** - имя конфигурации для отображения в клиенте

#### 6.3 Параметры окружения (.env)

##### Обязательные параметры:
```bash
# Основные настройки сервера
SERVER_IP=          # Внешний IP адрес сервера (автоопределение с подтверждением)
SERVER_PORT=443     # Порт для входящих соединений (по умолчанию 443)

# REALITY настройки
REALITY_DEST=speed.cloudflare.com:443    # Целевой сайт для маскировки
REALITY_SERVER_NAME=speed.cloudflare.com # Имя сервера из сертификата

# Администратор
ADMIN_SHORT_ID=     # Идентификатор администратора (генерируется автоматически)
ADMIN_EMAIL=        # Email для уведомлений (опционально)

# Системные настройки
COMPOSE_PROJECT_NAME=vless-reality
TZ=UTC              # Временная зона
```

##### Процесс валидации при установке:
1. **SERVER_IP** - автоопределение через curl ifconfig.me, затем подтверждение или ручной ввод
2. **SERVER_PORT** - проверка диапазона (1-65535) и доступности
3. **REALITY_DEST** - проверка доступности целевого сайта через curl
4. **ADMIN_SHORT_ID** - автоматическая генерация 8 hex символов через openssl rand -hex 4
5. **ADMIN_EMAIL** - валидация формата email через regex (если указан)

##### Интерактивный ввод:
```bash
# Пример диалога установщика
========================================
VLESS + REALITY Configuration
========================================

[1/4] Detecting server IP address...
→ Detected IP: 192.168.1.100
Is this correct? [Y/n]: Y
✓ IP address confirmed

[2/4] Enter target domain for REALITY [speed.cloudflare.com]:
> (нажатие Enter для значения по умолчанию)
✓ Using default: speed.cloudflare.com
✓ Domain is accessible

[3/4] Generating admin Short ID...
→ Generated ID: a1b2c3d4
✓ Admin Short ID created

[4/4] Enter admin email (optional, press Enter to skip):
> admin@example.com
✓ Valid email format

Confirm configuration:
----------------------------------------
Server IP:        192.168.1.100
Server Port:      443
REALITY Target:   speed.cloudflare.com
Admin Short ID:   a1b2c3d4 (автогенерирован)
Admin Email:      admin@example.com
----------------------------------------
Is this correct? [Y/n]: Y

✓ Configuration saved to /opt/vless/.env
✓ File permissions set to 600
```

### 7. План реализации

#### Этап 1: Базовая инфраструктура (2-3 дня) ✅ **ВЫПОЛНЕН**
- [x] Создание структуры репозитория
- [x] Написание шаблонов (docker-compose.yml.tpl, config.json.tpl, .env.example)
- [x] Скрипт install.sh с интерактивным вводом параметров
- [x] Реализация валидации вводимых данных
- [x] Создание рабочих каталогов в /opt/vless/
- [x] Копирование файлов из репозитория в /opt/vless/
- [x] Генерация .env файла с введенными параметрами
- [x] Генерация X25519 ключей
- [x] Установка корректных прав доступа
- [x] Тестирование базового функционала

#### Этап 2: Управление пользователями (2-3 дня) ✅ **ВЫПОЛНЕН**
- [x] Скрипт user-manager.sh
- [x] Функции CRUD для пользователей
- [x] Генерация UUID
- [x] Создание vless:// ссылок
- [x] Генерация QR-кодов 640x640 пикселей
- [x] Система хранения в users.json

#### Этап 3: Автоматизация (2 дня) ✅ **ВЫПОЛНЕН**
- [x] Скрипт update.sh
- [x] Скрипт backup.sh
- [x] Скрипт logs.sh
- [ ] Настройка cron задач (опционально, по желанию администратора)
- [x] Библиотеки вспомогательных функций

#### Этап 4: Документация (1-2 дня) ✅ **ВЫПОЛНЕН**
- [x] README.md с быстрым стартом
- [x] ADMIN_GUIDE.md
- [x] TROUBLESHOOTING.md
- [x] Примеры использования (включены в документацию)
- [x] FAQ (включен в TROUBLESHOOTING.md)

#### Этап 5: Критические улучшения безопасности (3-5 дней) 🟡 **ПЛАНИРУЕТСЯ**
- [ ] Усиление параметров REALITY:
  - [ ] Добавление множественных serverNames в конфигурацию
  - [ ] Реализация динамической генерации shortIds для пользователей
  - [ ] Добавление minClientVer и maxTimeDiff в realitySettings
  - [ ] Скрипт проверки destination серверов (check-destination.sh)
- [ ] Расширенная фильтрация трафика:
  - [ ] Создание шаблона routing_rules.json с комплексными правилами
  - [ ] Блокировка BitTorrent, рекламы, Win telemetry
  - [ ] Геоблокировка опасных стран и private сетей
  - [ ] Блокировка опасных портов (25, 110, 135, 139, 445)
- [ ] Защита от DNS утечек:
  - [ ] Создание шаблона dns_config.json
  - [ ] Настройка DNS с expectIPs для валидации
  - [ ] Интеграция в config_with_dns.json.tpl
- [ ] Fallback механизмы:
  - [ ] Настройка многоуровневых fallbacks в конфигурации
  - [ ] Скрипт setup-fake-site.sh для fake веб-сервера
  - [ ] Docker Compose конфигурация для nginx fake-site

#### Этап 6: Важные улучшения безопасности (3-4 дня) 🟡 **ПЛАНИРУЕТСЯ**
- [ ] Продвинутый мониторинг:
  - [ ] Скрипт anomaly-detection.sh для обнаружения аномалий
  - [ ] Автоматическая блокировка через UFW при превышении порога
  - [ ] Обнаружение port scanning и brute-force
  - [ ] Скрипт security-metrics.sh для ежедневных отчетов
  - [ ] Статистика подключений, топ IP, заблокированные соединения
- [ ] Автоматическая ротация секретов:
  - [ ] Скрипт rotate-all-keys.sh для полной ротации X25519
  - [ ] Функция rotate_shortids() для ротации пользовательских shortIds
  - [ ] Безопасное backup перед ротацией
  - [ ] Настройка cron для автоматической ежемесячной ротации
- [ ] Управление квотами пользователей:
  - [ ] Расширение users.json с полями bandwidth_limit_gb, expiry_date, blocked
  - [ ] Функция create_user_advanced() с параметрами квот
  - [ ] Скрипт check-user-limits.sh для проверки и блокировки
  - [ ] Интеграция с Xray Stats API для отслеживания трафика
  - [ ] Функция block_user() для безопасной блокировки

#### Этап 7: Желательные улучшения безопасности (опционально, 2-3 дня) 🟢 **ОПЦИОНАЛЬНО**
- [ ] Оптимизация производительности:
  - [ ] Настройка sockopt (tcpFastOpen, tcpNoDelay, tcpKeepAlive)
  - [ ] Конфигурация policy с buffer размерами и лимитами
  - [ ] Включение statsUser для отслеживания трафика
- [ ] Интеграция с внешними системами:
  - [ ] Скрипт webhook-notifications.sh для уведомлений
  - [ ] Поддержка отправки security alerts
  - [ ] Настройка WEBHOOK_URL в .env файле
- [ ] Дополнительная документация:
  - [ ] Создание SECURITY_GUIDE.md с руководством по безопасности
  - [ ] Чек-лист внедрения по фазам
  - [ ] Процедуры мониторинга и реагирования на инциденты

### 8. Безопасность

#### 8.1 Базовые меры безопасности
- Использование REALITY для маскировки трафика
- Хранение ключей с ограниченными правами (600)
- Docker контейнер в host network mode (для надежности сети)
- Автоматическая настройка firewall правил
- Отсутствие открытых портов кроме 443
- Регулярное обновление Xray-core
- Монтирование конфигурационных volumes в режиме read-only (:ro)
- Разделение прав доступа между пользователями и процессами
- Все конфиденциальные данные в /opt/vless с ограниченным доступом

#### 8.2 Критические улучшения безопасности 🔴

##### 8.2.1 Усиление параметров REALITY
**Множественные destination серверы:**
- Использование нескольких serverNames для снижения предсказуемости трафика
- Рекомендуемые домены: microsoft.com, apple.com, cloudflare.com, github.com
- Критерии выбора: TLSv1.3, HTTP/2, отсутствие редиректов, стабильная доступность 24/7

**Динамическое управление shortIds:**
- Автоматическая генерация уникальных shortIds для каждого пользователя
- Периодическая ротация shortIds (рекомендуется ежемесячно)
- Функция `generate_user_shortid()` в scripts/lib/security.sh
- Создание вариаций shortIds разной длины (2, 4, 6, 8 символов)

**Контроль версий клиентов:**
- Параметр `minClientVer: "1.8.0"` - минимальная версия Xray клиента
- Параметр `maxTimeDiff: 90` - максимальная разница времени в секундах
- Предотвращение подключения устаревших клиентов с известными уязвимостями

##### 8.2.2 Расширенная фильтрация трафика
**Комплексные правила маршрутизации:**
- Блокировка протокола BitTorrent
- Фильтрация рекламы (geosite:category-ads-all)
- Блокировка Windows telemetry (geosite:win-spy, win-update)
- Геоблокировка опасных IP диапазонов (geoip:private, geoip:cn, geoip:ru, и др.)
- Блокировка опасных портов: 25 (SMTP), 110 (POP3), 135 (RPC), 139/445 (SMB)

**Защита от DNS утечек:**
- Конфигурация DNS с валидацией через expectIPs
- Использование надежных DNS: Cloudflare (1.1.1.1), Google (8.8.8.8)
- Параметр `queryStrategy: "UseIPv4"` для предотвращения IPv6 утечек
- Отключение fallback на системный DNS

##### 8.2.3 Fallback механизмы защиты
**Многоуровневый fallback:**
- Fallback на целевой REALITY домен при некорректных запросах
- Альтернативный fallback на локальный fake веб-сервер
- WebSocket fallback для обхода дополнительных фильтров

**Fake веб-сервер:**
- Nginx контейнер на порту 127.0.0.1:8080
- Минималистичная статическая страница "Under Construction"
- Имитация реальных endpoints (/api/, /static/)
- Автоматический запуск через docker-compose.fake.yml

#### 8.3 Важные улучшения безопасности 🟡

##### 8.3.1 Продвинутый мониторинг
**Система обнаружения аномалий:**
- Мониторинг логов Xray в реальном времени (tail -F)
- Обнаружение port scanning при превышении порога попыток (>10 за 5 минут)
- Автоматическая блокировка подозрительных IP через UFW
- Обнаружение brute-force атак по authentication failures
- Фильтрация подозрительных user-agents (bot, crawler, scanner, nmap, nikto)

**Метрики безопасности:**
- Ежедневные security отчеты (security-report-YYYYMMDD.txt)
- Статистика подключений: общее количество, уникальные IP, топ-10 IP адресов
- Анализ заблокированных соединений (rejected connections)
- Статистика UFW firewall правил
- Проверка целостности конфигурационных файлов (md5sum)

##### 8.3.2 Автоматическая ротация секретов
**Полная ротация ключей:**
- Автоматическая генерация новых X25519 ключей
- Резервное копирование перед ротацией (backup с timestamp)
- Обновление config.json и .env файлов
- Безопасный перезапуск сервиса через docker-compose
- Логирование всех операций ротации

**Настройка автоматической ротации:**
- Cron job для ежемесячной ротации: `0 3 1 * *`
- Функция `setup_auto_rotation()` для настройки
- Опциональные уведомления пользователей через notify-users.sh

##### 8.3.3 Управление доступом и квотами
**Расширенное управление пользователями:**
- Многоуровневые права доступа: admin, moderator, user
- Установка bandwidth лимитов в GB на пользователя
- Настройка срока действия аккаунтов (expiry_date)
- Отслеживание использованного трафика через Xray Stats API

**Проверка квот и ограничений:**
- Автоматическая блокировка при превышении bandwidth_limit_gb
- Блокировка истекших аккаунтов (проверка expiry_date)
- Обновление статистики: bandwidth_used_gb, last_seen, total_connections
- Периодическая проверка через cron (каждые 6 часов)

**Структура данных пользователя с квотами:**
```json
{
  "name": "username",
  "uuid": "uuid-here",
  "short_ids": ["a1b2c3d4", "a1b2c3", "a1b2"],
  "access_level": "user",
  "bandwidth_limit_gb": 100,
  "bandwidth_used_gb": 0,
  "expiry_date": "2025-10-29",
  "created_at": "2025-09-29T12:00:00Z",
  "last_seen": null,
  "total_connections": 0,
  "blocked": false
}
```

#### 8.4 Желательные улучшения безопасности 🟢

##### 8.4.1 Оптимизация производительности
**Настройки сокетов:**
- `tcpFastOpen: true` - ускорение установки TCP соединений
- `tcpNoDelay: true` - отключение алгоритма Nagle для снижения задержек
- `tcpKeepAliveInterval: 30` - интервал проверки активности соединения
- `tcpKeepAliveIdle: 30` - время до начала keepalive проверок

**Буферы и лимиты политик:**
- `handshake: 4` секунды - таймаут рукопожатия
- `connIdle: 300` секунд - таймаут idle соединений
- `bufferSize: 512` KB - размер буфера для повышения производительности
- Включение статистики: `statsUserUplink/Downlink: true`

##### 8.4.2 Интеграция с внешними системами
**Webhook уведомления:**
- Отправка security alerts на внешний webhook (Discord, Slack, Telegram)
- Типы событий: security_alert, user_blocked, key_rotation
- Настройка WEBHOOK_URL в .env файле
- Скрипт webhook-notifications.sh для отправки

**Формат уведомлений:**
```json
{
  "event": "security_alert",
  "message": "Multiple failed authentication attempts detected",
  "timestamp": "2025-09-29T12:00:00Z",
  "server": "hostname",
  "service": "vless-reality"
}
```

#### 8.5 Чек-лист внедрения

**Фаза 1: Критические улучшения (День 1)**
- [ ] Резервное копирование текущей конфигурации
- [ ] Добавление множественных serverNames в config.json
- [ ] Настройка minClientVer и maxTimeDiff в realitySettings
- [ ] Добавление базовых правил блокировки (BitTorrent, ads)
- [ ] Тестирование подключения клиентов после изменений

**Фаза 2: Важные улучшения (День 2-3)**
- [ ] Настройка расширенной маршрутизации (routing_rules.json)
- [ ] Внедрение DNS защиты (dns_config.json)
- [ ] Настройка fallback механизмов
- [ ] Запуск мониторинга безопасности (anomaly-detection.sh в фоне)
- [ ] Настройка ежедневных security отчетов

**Фаза 3: Автоматизация (День 4-5)**
- [ ] Настройка автоматической ротации ключей (cron)
- [ ] Внедрение системы квот (расширение users.json)
- [ ] Настройка уведомлений (webhook если требуется)
- [ ] Создание скриптов резервного копирования
- [ ] Тестирование всех автоматизаций

**Фаза 4: Оптимизация (День 6-7)**
- [ ] Настройка TCP оптимизаций (sockopt)
- [ ] Тюнинг производительности (policy buffers)
- [ ] Финальное тестирование всех компонентов
- [ ] Документирование изменений
- [ ] Обучение администраторов

#### 8.6 Рекомендации по использованию
- Выбор целевого сайта вне юрисдикции страны
- Использование сложных shortIds с ротацией
- Регулярное резервное копирование (автоматическое через cron)
- Мониторинг логов на предмет аномалий (ежедневная проверка отчетов)
- Обновление Xray-core при выходе новых версий
- Регулярная проверка правил firewall и заблокированных IP
- Аудит пользователей на превышение квот (автоматический каждые 6 часов)

### 9. Критерии успеха

1. **Функциональность:**
   - Успешная установка за один запуск скрипта
   - Работающее подключение клиентов
   - Стабильная работа при 50 пользователях

2. **Удобство использования:**
   - Интуитивное CLI меню
   - Время добавления пользователя < 1 минуты
   - Автоматическая генерация всех форматов конфигураций

3. **Надежность:**
   - Автоматическое восстановление после сбоев
   - Успешное обновление без потери конфигурации
   - Работоспособные резервные копии

4. **Безопасность (новое):**
   - Успешная ротация ключей без потери соединений существующих пользователей
   - Обнаружение и блокировка аномального трафика (>90% точность detection)
   - Корректная работа системы квот (проверка лимитов и автоблокировка)
   - Ежедневные security отчеты генерируются без ошибок
   - Логирование всех критических событий безопасности

5. **Мониторинг (новое):**
   - Anomaly detection система работает в фоне без сбоев
   - Security metrics генерируются ежедневно в 00:00 UTC
   - Webhook уведомления доставляются < 5 секунд (если настроены)
   - Отчеты содержат полную статистику (connections, IPs, blocks)

### 10. Риски и митигация

| Риск | Вероятность | Влияние | Митигация |
|------|-------------|---------|-----------|
| Блокировка целевого сайта | Средняя | Высокое | Список альтернативных сайтов, множественные serverNames |
| Обнаружение VPN трафика | Низкая | Высокое | Регулярное обновление Xray, REALITY маскировка, ротация параметров |
| Потеря конфигурации | Низкая | Среднее | Автоматические бэкапы, backup перед ротацией ключей |
| Сложность для пользователя | Средняя | Низкое | Подробная документация, SECURITY_GUIDE.md |
| Ложные срабатывания anomaly detection | Средняя | Среднее | Настройка порогов (threshold), whitelist для известных IP |
| Высокая нагрузка от мониторинга | Низкая | Среднее | Оптимизация скриптов, tail -F вместо polling, логротация |
| Потеря доступа после ротации ключей | Низкая | Высокое | Тестирование на staging, уведомления пользователей, rollback процедура |
| Блокировка легитимных пользователей по квотам | Низкая | Среднее | Уведомления о приближении к лимитам, ручной override для админа |

### 11. Поддержка и обслуживание

#### 11.1 Регулярное обслуживание
- Еженедельная проверка обновлений Xray-core
- Ежемесячное резервное копирование (автоматическое через cron)
- Ежемесячная ротация ключей (автоматическая через cron: 0 3 1 * *)
- Мониторинг логов на ошибки и аномалии
- Ежедневная проверка security отчетов
- Еженедельный аудит заблокированных IP через UFW
- Проверка квот пользователей (автоматическая каждые 6 часов через cron)

#### 11.2 Документация для администратора
- Пошаговая инструкция установки
- Руководство по управлению пользователями
- Руководство по безопасности (SECURITY_GUIDE.md)
- Часто встречающиеся проблемы и решения
- Процедуры восстановления
- Процедуры реагирования на security инциденты
- Руководство по интерпретации security отчетов

### 12. Будущие улучшения (вне текущего scope)

Возможные расширения функциональности в будущем:
- Веб-интерфейс управления с dashboard метриками
- REST API для автоматизации управления
- Интеграция с Telegram ботом для уведомлений и управления
- Детальная статистика использования в реальном времени с графиками
- Поддержка множественных серверов с load balancing
- Автоматический failover между серверами
- Полная интеграция с SIEM системами (Splunk, ELK)
- Machine learning для улучшения anomaly detection
- Поддержка дополнительных протоколов (VMess, Trojan)
- Географическая статистика подключений

---

## Заключение

Данный PRD описывает создание функционального и безопасного VPN сервиса на базе VLESS + REALITY с фокусом на:
- **Простоту управления** через CLI интерфейс
- **Надежность работы** с автоматическим мониторингом и восстановлением
- **Безопасность** с комплексными улучшениями (мониторинг, ротация ключей, управление квотами)
- **Легкость администрирования** с автоматизацией критических процессов

Решение оптимизировано для личного использования с поддержкой до 50 пользователей. Базовые функции не требуют глубоких технических знаний, в то время как расширенные security features предоставляют профессиональный уровень защиты.

**Статус документа:** Утвержден
**Версия:** 1.4
**Готовность к реализации:** Да
**Ориентировочные сроки:**
- Базовый функционал (Этапы 1-4): 7-10 дней ✅ ВЫПОЛНЕНО
- Критические security улучшения (Этап 5): 3-5 дней 🟡 ПЛАНИРУЕТСЯ
- Важные security улучшения (Этап 6): 3-4 дня 🟡 ПЛАНИРУЕТСЯ
- Желательные улучшения (Этап 7): 2-3 дня 🟢 ОПЦИОНАЛЬНО
**Общий срок с security improvements:** 15-22 дня

### 13. Известные проблемы и решения

#### 13.1 Проблема: "REALITY: processed invalid connection" - отсутствие доступа к интернету

**Симптомы:**
- Клиент показывает "Connected", но сайты не открываются
- В логах сервера постоянные ошибки: `REALITY: processed invalid connection`
- Access log пустой (нет успешных подключений)

**Root Cause:**
Несоответствие или повреждение X25519 ключей (privateKey на сервере / publicKey на клиенте). REALITY protocol требует точного соответствия cryptographic key pair.

**Диагностика:**
```bash
# 1. Проверить логи на ошибки REALITY
sudo tail -50 /opt/vless/logs/error.log | grep "invalid connection"

# 2. Проверить privateKey в конфигурации
docker exec xray-server cat /etc/xray/config.json | jq '.inbounds[0].streamSettings.realitySettings.privateKey'

# 3. Вычислить правильный publicKey
docker run --rm teddysun/xray:24.11.30 xray x25519 -i <PRIVATE_KEY>

# 4. Проверить соответствие ключей в .env
cat /opt/vless/.env | grep -E "(PRIVATE_KEY|PUBLIC_KEY)"
```

**Решение:**
1. Регенерировать пару X25519 ключей:
```bash
docker run --rm teddysun/xray:24.11.30 xray x25519
# Output: Private key: xxx
#         Public key: yyy
```

2. Обновить серверную конфигурацию:
```bash
# Обновить privateKey в config.json
sudo jq '.inbounds[0].streamSettings.realitySettings.privateKey = "NEW_PRIVATE_KEY"' \
  /opt/vless/config/config.json > /tmp/config_new.json
sudo mv /tmp/config_new.json /opt/vless/config/config.json
sudo chmod 600 /opt/vless/config/config.json

# Обновить .env файл
sudo sed -i 's/^PRIVATE_KEY=.*/PRIVATE_KEY=NEW_PRIVATE_KEY/' /opt/vless/.env
sudo sed -i 's/^PUBLIC_KEY=.*/PUBLIC_KEY=NEW_PUBLIC_KEY/' /opt/vless/.env
```

3. Перезапустить сервер:
```bash
cd /opt/vless && sudo docker-compose restart xray-server
```

4. Обновить клиентские конфигурации с **новым PUBLIC_KEY**

**Превентивные меры:**
- Использовать скрипт `rotate-keys.sh` для безопасной ротации ключей
- Автоматически backup ключей перед изменениями
- Хранить резервные копии в `/opt/vless/backups/`
- Валидация ключей после генерации

**Ссылки:**
- TROUBLESHOOTING.md: Раздел "REALITY Connection Issues"
- Документация Xray REALITY: https://xtls.github.io/

#### 13.2 Проблема: Несовместимость версий Xray клиента и сервера

**Симптомы:**
- После обновления сервера клиенты не могут подключиться
- Или после обновления клиента соединение не устанавливается
- Ошибки о неподдерживаемых параметрах конфигурации

**Root Cause:**
Breaking changes между major versions Xray-core (особенно при переходе с v1.x на v24.x+).

**Решение:**
Использовать фиксированную совместимую версию в docker-compose.yml:
```yaml
services:
  xray-server:
    image: teddysun/xray:24.11.30  # Не использовать :latest
```

**Рекомендуемые версии:**
- **Сервер:** teddysun/xray:24.11.30
- **Клиент iOS (v2RayTun):** Xray 24.11.30+
- **Клиент Android:** v2rayNG с Xray-core 24.11+

**Превентивные меры:**
- Закрепить версию в templates/docker-compose.yml.tpl
- Тестировать обновления на staging окружении
- Обновлять сервер и клиенты синхронно
- Использовать параметр `minClientVer` в realitySettings

#### 13.3 Проблема: Geosite правила не поддерживаются в старых версиях

**Симптомы:**
- Контейнер не запускается с ошибкой:
```
failed to load geosite: WIN-SPY
list not found in geosite.dat: WIN-SPY
```

**Root Cause:**
Версия Xray 24.11.30 не содержит некоторые geosite категории (win-spy, win-update), которые добавлены в более новых версиях.

**Решение:**
Убрать несовместимые routing rules из config templates:
```bash
# Удалить правила из конфигурации
sudo jq 'del(.routing.rules[] | select(.domain[]? | contains("win-spy") or contains("win-update")))' \
  /opt/vless/config/config.json > /tmp/config_fixed.json
sudo mv /tmp/config_fixed.json /opt/vless/config/config.json
```

**Список безопасных geosite правил для v24.11:**
- ✅ `geosite:category-ads-all` - блокировка рекламы
- ✅ `geosite:cn` - китайские сайты
- ✅ `geosite:geolocation-!cn` - не китайские сайты
- ❌ `geosite:win-spy` - не поддерживается в 24.11
- ❌ `geosite:win-update` - не поддерживается в 24.11

#### 13.4 Проблема: Destination сайт заблокирован или недоступен

**Симптомы:**
- Периодические обрывы соединения
- Медленная скорость подключения
- Ошибки в логах о недоступности destination

**Root Cause:**
Целевой REALITY сайт (dest) заблокирован, перегружен или временно недоступен.

**Решение:**
Использовать надежные destination серверы:

**Рекомендуемые (протестированные):**
- ✅ `www.microsoft.com:443` - стабильный, TLS 1.3, HTTP/2
- ✅ `www.apple.com:443` - высокая доступность
- ✅ `github.com:443` - отличная производительность
- ⚠️ `speed.cloudflare.com:443` - иногда перегружен

**Проверка доступности:**
```bash
# Тест destination
openssl s_client -connect www.microsoft.com:443 -servername www.microsoft.com < /dev/null

# Проверка TLS версии (должна быть 1.3)
openssl s_client -connect www.microsoft.com:443 -servername www.microsoft.com < /dev/null 2>&1 | grep "Protocol"
```

**Смена destination:**
```bash
sudo jq '.inbounds[0].streamSettings.realitySettings.dest = "www.microsoft.com:443"' \
  /opt/vless/config/config.json > /tmp/config_new.json
sudo mv /tmp/config_new.json /opt/vless/config/config.json
cd /opt/vless && sudo docker-compose restart xray-server
```

**Превентивные меры:**
- Использовать несколько serverNames для fallback
- Мониторить доступность destination через cron
- Скрипт `check-destination.sh` для автоматической проверки