# üîí –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —É—Å–∏–ª–µ–Ω–∏—é –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ VLESS+Reality

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ
1. [–û–±–∑–æ—Ä](#–æ–±–∑–æ—Ä)
2. [–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É–ª—É—á—à–µ–Ω–∏—è](#–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ-—É–ª—É—á—à–µ–Ω–∏—è)
3. [–í–∞–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è](#–≤–∞–∂–Ω—ã–µ-—É–ª—É—á—à–µ–Ω–∏—è)
4. [–ñ–µ–ª–∞—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è](#–∂–µ–ª–∞—Ç–µ–ª—å–Ω—ã–µ-—É–ª—É—á—à–µ–Ω–∏—è)
5. [–ü—Ä–∏–º–µ—Ä—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π](#–ø—Ä–∏–º–µ—Ä—ã-–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π)
6. [–°–∫—Ä–∏–ø—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏](#—Å–∫—Ä–∏–ø—Ç—ã-–∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏)
7. [–ß–µ–∫-–ª–∏—Å—Ç –≤–Ω–µ–¥—Ä–µ–Ω–∏—è](#—á–µ–∫-–ª–∏—Å—Ç-–≤–Ω–µ–¥—Ä–µ–Ω–∏—è)

## –û–±–∑–æ—Ä

–î–∞–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É—Å–∏–ª–µ–Ω–∏—é –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ VLESS+Reality VPN —Å–µ—Ä–≤–µ—Ä–∞. –í—Å–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –æ—Å–Ω–æ–≤–∞–Ω—ã –Ω–∞ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ XTLS/Xray-core –∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –ø—Ä–∞–∫—Ç–∏–∫–∞—Ö.

### –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ REALITY –ø—Ä–æ—Ç–æ–∫–æ–ª–∞:
- **–£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ TLS fingerprint** - –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å VPN –ø–æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞–º TLS
- **Forward secrecy** - –∑–∞—â–∏—Ç–∞ –ø—Ä–æ—à–ª—ã—Ö —Å–µ—Å—Å–∏–π –ø—Ä–∏ –∫–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü–∏–∏ –∫–ª—é—á–µ–π
- **–ú–∞—Å–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–¥ –ª–µ–≥–∏—Ç–∏–º–Ω—ã–π —Ç—Ä–∞—Ñ–∏–∫** - –∏–º–∏—Ç–∞—Ü–∏—è –æ–±—ã—á–Ω–æ–≥–æ HTTPS —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
- **–ó–∞—â–∏—Ç–∞ –æ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∑–æ–Ω–¥–∏—Ä–æ–≤–∞–Ω–∏—è** - fallback –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ —Å–∞–π—Ç—ã

## üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

### 1. –£—Å–∏–ª–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ REALITY

#### 1.1 –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ destination —Å–µ—Ä–≤–µ—Ä—ã

**–ü—Ä–æ–±–ª–µ–º–∞:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –æ–¥–Ω–æ–≥–æ destination —Å–µ—Ä–≤–µ—Ä–∞ —Å–æ–∑–¥–∞–µ—Ç –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω —Ç—Ä–∞—Ñ–∏–∫–∞.

**–†–µ—à–µ–Ω–∏–µ:**
```json
"realitySettings": {
  "dest": "www.microsoft.com:443",
  "serverNames": [
    "www.microsoft.com",
    "www.apple.com",
    "www.amazon.com",
    "www.cloudflare.com",
    "cdn.jsdelivr.net",
    "update.googleapis.com",
    "www.bing.com",
    "www.github.com"
  ],
  "privateKey": "{{PRIVATE_KEY}}",
  "shortIds": ["", "a1", "b2c3", "d4e5f6", "789abc"]
}
```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–±–æ—Ä–∞ destination:**
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ TLSv1.3 –∏ HTTP/2
- ‚úÖ –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç–æ–≤ (–∫–æ–¥ 200)
- ‚úÖ –°–µ—Ä–≤–µ—Ä—ã –≤ –¥—Ä—É–≥–∏—Ö —é—Ä–∏—Å–¥–∏–∫—Ü–∏—è—Ö
- ‚úÖ –°—Ç–∞–±–∏–ª—å–Ω–∞—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å 24/7
- ‚úÖ –°—Ö–æ–∂–∞—è –≥–µ–æ–≥—Ä–∞—Ñ–∏—è —Å VPN —Å–µ—Ä–≤–µ—Ä–æ–º

**Bash —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ destination:**
```bash
#!/bin/bash
# scripts/check-destination.sh

check_destination() {
    local domain="$1"
    echo "Checking $domain..."

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ TLS –≤–µ—Ä—Å–∏–∏
    echo | openssl s_client -connect "$domain:443" -tls1_3 2>/dev/null | grep "Protocol" | grep -q "TLSv1.3"
    if [ $? -eq 0 ]; then
        echo "‚úÖ TLSv1.3 supported"
    else
        echo "‚ùå TLSv1.3 not supported"
        return 1
    fi

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ HTTP/2
    curl -I --http2 "https://$domain" 2>/dev/null | grep -q "HTTP/2"
    if [ $? -eq 0 ]; then
        echo "‚úÖ HTTP/2 supported"
    else
        echo "‚ùå HTTP/2 not supported"
        return 1
    fi

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–¥–∏—Ä–µ–∫—Ç–æ–≤
    response=$(curl -s -o /dev/null -w "%{http_code}" "https://$domain")
    if [ "$response" = "200" ]; then
        echo "‚úÖ No redirects (200 OK)"
    else
        echo "‚ö†Ô∏è HTTP response: $response"
    fi
}
```

#### 1.2 –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ shortIds

**–ü—Ä–æ–±–ª–µ–º–∞:** –°—Ç–∞—Ç–∏—á–Ω—ã–µ shortIds –ø–æ–∑–≤–æ–ª—è—é—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

**–†–µ—à–µ–Ω–∏–µ:**
```bash
#!/bin/bash
# scripts/lib/security.sh

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö shortIds –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
generate_user_shortid() {
    local username="$1"
    local base_shortid=$(openssl rand -hex 4)

    # –°–æ–∑–¥–∞–µ–º –≤–∞—Ä–∏–∞—Ü–∏–∏ –¥–ª—è —Ä–æ—Ç–∞—Ü–∏–∏
    local shortids=(
        "$base_shortid"
        "${base_shortid:0:6}"
        "${base_shortid:0:4}"
        "${base_shortid:0:2}"
    )

    echo "${shortids[@]}"
}

# –†–æ—Ç–∞—Ü–∏—è shortIds –∫–∞–∂–¥—ã–µ N –¥–Ω–µ–π
rotate_shortids() {
    local config_file="/opt/vless/config/config.json"
    local users_file="/opt/vless/data/users.json"

    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–µ shortIds –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    jq '.users[]' "$users_file" | while read -r user; do
        local username=$(echo "$user" | jq -r '.name')
        local new_shortids=($(generate_user_shortid "$username"))

        # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
        jq ".inbounds[0].streamSettings.realitySettings.shortIds += [\"${new_shortids[0]}\"]" \
           "$config_file" > "$config_file.tmp"
        mv "$config_file.tmp" "$config_file"
    done

    # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å
    docker-compose -f /opt/vless/docker-compose.yml restart
}
```

#### 1.3 –ö–æ–Ω—Ç—Ä–æ–ª—å –≤–µ—Ä—Å–∏–π –∫–ª–∏–µ–Ω—Ç–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞:** –£—Å—Ç–∞—Ä–µ–≤—à–∏–µ –∫–ª–∏–µ–Ω—Ç—ã –º–æ–≥—É—Ç –∏–º–µ—Ç—å —É—è–∑–≤–∏–º–æ—Å—Ç–∏.

**–†–µ—à–µ–Ω–∏–µ:**
```json
"realitySettings": {
  "minClientVer": "1.8.0",
  "maxClientVer": "",
  "maxTimeDiff": 90
}
```

### 2. –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç—Ä–∞—Ñ–∏–∫–∞

#### 2.1 –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏

**–§–∞–π–ª:** `templates/routing_rules.json`
```json
{
  "routing": {
    "domainStrategy": "IPIfNonMatch",
    "domainMatcher": "hybrid",
    "rules": [
      {
        "type": "field",
        "inboundTag": ["api"],
        "outboundTag": "api"
      },
      {
        "type": "field",
        "protocol": ["bittorrent"],
        "outboundTag": "block"
      },
      {
        "type": "field",
        "domain": [
          "geosite:category-ads-all",
          "geosite:win-spy",
          "geosite:win-update",
          "geosite:win-extra"
        ],
        "outboundTag": "block"
      },
      {
        "type": "field",
        "ip": [
          "geoip:private",
          "geoip:cn",
          "geoip:ru",
          "geoip:ir",
          "geoip:cu",
          "geoip:kp",
          "geoip:sy"
        ],
        "outboundTag": "block"
      },
      {
        "type": "field",
        "port": "25,110,135,139,445,465,587",
        "network": "tcp,udp",
        "outboundTag": "block"
      },
      {
        "type": "field",
        "sourcePort": "25,110,135,139,445",
        "outboundTag": "block"
      }
    ]
  }
}
```

#### 2.2 –ó–∞—â–∏—Ç–∞ –æ—Ç DNS —É—Ç–µ—á–µ–∫

**–§–∞–π–ª:** `templates/dns_config.json`
```json
{
  "dns": {
    "hosts": {
      "domain:googleapis.cn": "googleapis.com",
      "domain:gstatic.cn": "gstatic.com"
    },
    "servers": [
      {
        "address": "1.1.1.1",
        "port": 53,
        "domains": [
          "geosite:geolocation-!cn"
        ],
        "expectIPs": [
          "geoip:!cn"
        ]
      },
      {
        "address": "8.8.8.8",
        "port": 53,
        "domains": [
          "geosite:google"
        ]
      },
      "localhost"
    ],
    "queryStrategy": "UseIPv4",
    "disableCache": false,
    "disableFallback": false
  }
}
```

### 3. Fallback –º–µ—Ö–∞–Ω–∏–∑–º—ã –∑–∞—â–∏—Ç—ã

#### 3.1 –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤—ã–π fallback

```json
"fallbacks": [
  {
    "name": "www.microsoft.com",
    "alpn": "h2",
    "dest": "www.microsoft.com:443"
  },
  {
    "alpn": "http/1.1",
    "dest": "127.0.0.1:8080"
  },
  {
    "path": "/ws",
    "dest": "@vless-ws",
    "xver": 1
  },
  {
    "dest": "www.cloudflare.com:443"
  }
]
```

#### 3.2 –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ fake –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞

```bash
#!/bin/bash
# scripts/setup-fake-site.sh

setup_fake_website() {
    # –°–æ–∑–¥–∞–µ–º docker-compose –¥–ª—è fake —Å–∞–π—Ç–∞
    cat > /opt/vless/docker-compose.fake.yml << 'EOF'
version: '3.8'
services:
  fake-site:
    image: nginx:alpine
    container_name: vless-fake-site
    ports:
      - "127.0.0.1:8080:80"
    volumes:
      - ./fake-site:/usr/share/nginx/html:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
EOF

    # –°–æ–∑–¥–∞–µ–º –º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π —Å–∞–π—Ç
    mkdir -p /opt/vless/fake-site
    cat > /opt/vless/fake-site/index.html << 'HTML'
<!DOCTYPE html>
<html>
<head>
    <title>Welcome</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 50px;
        }
    </style>
</head>
<body>
    <h1>Under Construction</h1>
    <p>This site is currently under maintenance.</p>
</body>
</html>
HTML

    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ nginx
    mkdir -p /opt/vless/nginx/conf.d
    cat > /opt/vless/nginx/conf.d/default.conf << 'NGINX'
server {
    listen 80;
    server_name _;

    location / {
        root /usr/share/nginx/html;
        index index.html;
    }

    # –ò–º–∏—Ç–∞—Ü–∏—è —Ä–µ–∞–ª—å–Ω—ã—Ö endpoints
    location /api/ {
        return 404;
    }

    location /static/ {
        return 404;
    }
}
NGINX

    docker-compose -f /opt/vless/docker-compose.fake.yml up -d
}
```

## üü° –í–∞–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### 4. –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

#### 4.1 –°–∏—Å—Ç–µ–º–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –∞–Ω–æ–º–∞–ª–∏–π

```bash
#!/bin/bash
# scripts/anomaly-detection.sh

detect_anomalies() {
    local LOG_FILE="/var/log/xray/access.log"
    local ALERT_FILE="/opt/vless/logs/anomalies.log"
    local THRESHOLD=10

    # –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
    tail -F "$LOG_FILE" | while read line; do
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Ä—Ç–æ–≤
        if echo "$line" | grep -qE "rejected.*from.*[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}"; then
            ip=$(echo "$line" | grep -oE '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' | head -1)

            # –ü–æ–¥—Å—á–µ—Ç –ø–æ–ø—ã—Ç–æ–∫ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 –º–∏–Ω—É—Ç
            recent_attempts=$(grep "$ip" "$LOG_FILE" | \
                             grep "$(date '+%Y-%m-%d %H:%M' -d '5 minutes ago')" | \
                             wc -l)

            if [ "$recent_attempts" -gt "$THRESHOLD" ]; then
                echo "[$(date '+%Y-%m-%d %H:%M:%S')] ALERT: Potential scan from $ip ($recent_attempts attempts)" >> "$ALERT_FILE"

                # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞
                if command -v ufw &> /dev/null; then
                    ufw insert 1 deny from "$ip" to any comment "Auto-blocked: suspicious activity"
                fi
            fi
        fi

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ brute-force
        if echo "$line" | grep -q "authentication failed"; then
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] AUTH_FAIL: $line" >> "$ALERT_FILE"
        fi

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–µ–æ–±—ã—á–Ω—ã–µ user-agents
        if echo "$line" | grep -qE "(bot|crawler|scanner|nmap|nikto)"; then
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] SUSPICIOUS_UA: $line" >> "$ALERT_FILE"
        fi
    done
}

# –ó–∞–ø—É—Å–∫ –≤ —Ñ–æ–Ω–µ
detect_anomalies &
```

#### 4.2 –ú–µ—Ç—Ä–∏–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

```bash
#!/bin/bash
# scripts/security-metrics.sh

generate_security_report() {
    local REPORT_FILE="/opt/vless/logs/security-report-$(date +%Y%m%d).txt"

    echo "=== Security Report $(date '+%Y-%m-%d %H:%M:%S') ===" > "$REPORT_FILE"

    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
    echo -e "\n## Connection Statistics" >> "$REPORT_FILE"
    echo "Total connections today: $(grep "$(date +%Y-%m-%d)" /var/log/xray/access.log | wc -l)" >> "$REPORT_FILE"
    echo "Unique IPs: $(grep "$(date +%Y-%m-%d)" /var/log/xray/access.log | grep -oE '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' | sort -u | wc -l)" >> "$REPORT_FILE"

    # –¢–æ–ø IP –∞–¥—Ä–µ—Å–æ–≤
    echo -e "\n## Top 10 IPs" >> "$REPORT_FILE"
    grep "$(date +%Y-%m-%d)" /var/log/xray/access.log | \
        grep -oE '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' | \
        sort | uniq -c | sort -rn | head -10 >> "$REPORT_FILE"

    # –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    echo -e "\n## Blocked Connections" >> "$REPORT_FILE"
    echo "Rejected today: $(grep "$(date +%Y-%m-%d)" /var/log/xray/access.log | grep -c "rejected")" >> "$REPORT_FILE"

    # UFW —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    if command -v ufw &> /dev/null; then
        echo -e "\n## Firewall Statistics" >> "$REPORT_FILE"
        ufw status numbered | grep -c DENY >> "$REPORT_FILE"
    fi

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏
    echo -e "\n## Integrity Check" >> "$REPORT_FILE"
    md5sum /opt/vless/config/config.json >> "$REPORT_FILE"

    echo "Report saved to: $REPORT_FILE"
}

# –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ cron –∫–∞–∂–¥—ã–π –¥–µ–Ω—å
(crontab -l 2>/dev/null; echo "0 0 * * * /opt/vless/scripts/security-metrics.sh") | crontab -
```

### 5. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–æ—Ç–∞—Ü–∏—è —Å–µ–∫—Ä–µ—Ç–æ–≤

#### 5.1 –ü–æ–ª–Ω–∞—è —Ä–æ—Ç–∞—Ü–∏—è –∫–ª—é—á–µ–π

```bash
#!/bin/bash
# scripts/rotate-all-keys.sh

rotate_all_keys() {
    source /opt/vless/scripts/lib/colors.sh
    source /opt/vless/scripts/lib/config.sh

    print_header "Starting Complete Key Rotation"

    # Backup —Ç–µ–∫—É—â–µ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    backup_dir="/opt/vless/backups/$(date +%Y%m%d_%H%M%S)"
    mkdir -p "$backup_dir"
    cp -r /opt/vless/config "$backup_dir/"
    cp /opt/vless/.env "$backup_dir/"
    cp /opt/vless/data/users.json "$backup_dir/"

    print_info "Backup created in $backup_dir"

    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤—ã—Ö X25519 –∫–ª—é—á–µ–π
    new_keys=$(docker run --rm teddysun/xray:latest xray x25519)
    new_private=$(echo "$new_keys" | grep "Private key:" | awk '{print $3}')
    new_public=$(echo "$new_keys" | grep "Public key:" | awk '{print $3}')

    # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    jq ".inbounds[0].streamSettings.realitySettings.privateKey = \"$new_private\"" \
       /opt/vless/config/config.json > /opt/vless/config/config.json.tmp
    mv /opt/vless/config/config.json.tmp /opt/vless/config/config.json

    # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ .env
    sed -i "s/^PRIVATE_KEY=.*/PRIVATE_KEY=$new_private/" /opt/vless/.env
    sed -i "s/^PUBLIC_KEY=.*/PUBLIC_KEY=$new_public/" /opt/vless/.env

    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤—ã—Ö shortIds –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    print_info "Rotating shortIds..."
    rotate_shortids

    # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞
    docker-compose -f /opt/vless/docker-compose.yml down
    docker-compose -f /opt/vless/docker-compose.yml up -d

    # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    print_success "Key rotation completed!"
    print_warning "New public key: $new_public"

    # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] Key rotation completed. New public key: $new_public" \
         >> /opt/vless/logs/key-rotation.log

    # –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ)
    if [ -f "/opt/vless/scripts/notify-users.sh" ]; then
        /opt/vless/scripts/notify-users.sh "Keys rotated. Please update your client configuration."
    fi
}

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Ä–æ—Ç–∞—Ü–∏–∏
setup_auto_rotation() {
    # –†–æ—Ç–∞—Ü–∏—è –∫–∞–∂–¥—ã–µ 30 –¥–Ω–µ–π –≤ 3:00 AM
    (crontab -l 2>/dev/null; echo "0 3 1 * * /opt/vless/scripts/rotate-all-keys.sh") | crontab -
    print_success "Auto-rotation scheduled for monthly execution"
}
```

### 6. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–æ–º –∏ –∫–≤–æ—Ç–∞–º–∏

#### 6.1 –†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏

```bash
#!/bin/bash
# scripts/user-management-advanced.sh

# –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º–∏ –ø–æ–ª—è–º–∏
create_user_advanced() {
    local username="$1"
    local access_level="${2:-user}"  # admin, moderator, user
    local bandwidth_limit_gb="${3:-100}"
    local expiry_days="${4:-30}"

    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è credentials
    local uuid=$(uuidgen)
    local shortids=($(generate_user_shortid "$username"))
    local expiry_date=$(date -d "+$expiry_days days" '+%Y-%m-%d')

    # –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    local user_data=$(cat <<JSON
{
    "name": "$username",
    "uuid": "$uuid",
    "short_ids": $(printf '"%s",' "${shortids[@]}" | sed 's/,$//' | sed 's/^/[/' | sed 's/$/]/'),
    "access_level": "$access_level",
    "bandwidth_limit_gb": $bandwidth_limit_gb,
    "bandwidth_used_gb": 0,
    "expiry_date": "$expiry_date",
    "created_at": "$(date -Iseconds)",
    "last_seen": null,
    "total_connections": 0,
    "blocked": false
}
JSON
    )

    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –±–∞–∑—É
    jq ".users += [$user_data]" /opt/vless/data/users.json > /opt/vless/data/users.json.tmp
    mv /opt/vless/data/users.json.tmp /opt/vless/data/users.json

    # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Xray
    update_xray_config "$uuid" "${shortids[0]}"

    print_success "User $username created with advanced settings"
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–≤–æ—Ç –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
check_user_limits() {
    local username="$1"

    # –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    local user_data=$(jq ".users[] | select(.name == \"$username\")" /opt/vless/data/users.json)

    if [ -z "$user_data" ]; then
        print_error "User $username not found"
        return 1
    fi

    local uuid=$(echo "$user_data" | jq -r '.uuid')
    local bandwidth_limit=$(echo "$user_data" | jq -r '.bandwidth_limit_gb')
    local expiry_date=$(echo "$user_data" | jq -r '.expiry_date')
    local blocked=$(echo "$user_data" | jq -r '.blocked')

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
    if [ "$blocked" = "true" ]; then
        print_warning "User $username is blocked"
        return 1
    fi

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è
    if [[ $(date +%s) -gt $(date -d "$expiry_date" +%s) ]]; then
        print_warning "User $username account expired"
        block_user "$username"
        return 1
    fi

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ bandwidth —á–µ—Ä–µ–∑ API
    local stats=$(curl -s "http://127.0.0.1:62789/v1/stats/user/$uuid")
    local bytes_used=$(echo "$stats" | jq '.stat.value // 0')
    local gb_used=$((bytes_used / 1073741824))

    if [ "$gb_used" -gt "$bandwidth_limit" ]; then
        print_warning "User $username exceeded bandwidth limit ($gb_used GB / $bandwidth_limit GB)"
        block_user "$username"
        return 1
    fi

    # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    jq ".users |= map(if .name == \"$username\" then .bandwidth_used_gb = $gb_used | .last_seen = \"$(date -Iseconds)\" else . end)" \
       /opt/vless/data/users.json > /opt/vless/data/users.json.tmp
    mv /opt/vless/data/users.json.tmp /opt/vless/data/users.json

    print_info "User $username: $gb_used GB / $bandwidth_limit GB used, expires: $expiry_date"
}

# –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
block_user() {
    local username="$1"

    # –û—Ç–º–µ—Ç–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –≤ –±–∞–∑–µ
    jq ".users |= map(if .name == \"$username\" then .blocked = true else . end)" \
       /opt/vless/data/users.json > /opt/vless/data/users.json.tmp
    mv /opt/vless/data/users.json.tmp /opt/vless/data/users.json

    # –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Xray
    local uuid=$(jq -r ".users[] | select(.name == \"$username\") | .uuid" /opt/vless/data/users.json)

    jq ".inbounds[0].settings.clients |= map(select(.id != \"$uuid\"))" \
       /opt/vless/config/config.json > /opt/vless/config/config.json.tmp
    mv /opt/vless/config/config.json.tmp /opt/vless/config/config.json

    # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞
    docker-compose -f /opt/vless/docker-compose.yml restart

    print_warning "User $username has been blocked"
}
```

## üü¢ –ñ–µ–ª–∞—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### 7. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

#### 7.1 –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ–∫–µ—Ç–æ–≤

```json
"streamSettings": {
  "sockopt": {
    "mark": 255,
    "tcpFastOpen": true,
    "tcpNoDelay": true,
    "tcpKeepAliveInterval": 30,
    "tcpKeepAliveIdle": 30
  }
}
```

#### 7.2 –ë—É—Ñ–µ—Ä—ã –∏ –ª–∏–º–∏—Ç—ã

```json
"policy": {
  "levels": {
    "0": {
      "handshake": 4,
      "connIdle": 300,
      "uplinkOnly": 2,
      "downlinkOnly": 5,
      "statsUserUplink": true,
      "statsUserDownlink": true,
      "bufferSize": 512
    }
  },
  "system": {
    "statsInboundUplink": true,
    "statsInboundDownlink": true,
    "statsOutboundUplink": true,
    "statsOutboundDownlink": true
  }
}
```

### 8. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –≤–Ω–µ—à–Ω–∏–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏

#### 8.1 Webhook —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

```bash
#!/bin/bash
# scripts/webhook-notifications.sh

send_webhook_notification() {
    local event_type="$1"
    local message="$2"
    local webhook_url="${WEBHOOK_URL:-}"

    if [ -z "$webhook_url" ]; then
        return
    fi

    local payload=$(cat <<JSON
{
    "event": "$event_type",
    "message": "$message",
    "timestamp": "$(date -Iseconds)",
    "server": "$(hostname)",
    "service": "vless-reality"
}
JSON
    )

    curl -s -X POST "$webhook_url" \
         -H "Content-Type: application/json" \
         -d "$payload"
}

# –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
send_webhook_notification "security_alert" "Multiple failed authentication attempts detected"
send_webhook_notification "user_blocked" "User exceeded bandwidth limit"
send_webhook_notification "key_rotation" "Security keys have been rotated"
```

## –ü—Ä–∏–º–µ—Ä—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π

### –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

```json
{
  "log": {
    "loglevel": "warning",
    "access": "/var/log/xray/access.log",
    "error": "/var/log/xray/error.log"
  },
  "inbounds": [
    {
      "port": 443,
      "protocol": "vless",
      "settings": {
        "clients": [],
        "decryption": "none"
      },
      "streamSettings": {
        "network": "tcp",
        "security": "reality",
        "realitySettings": {
          "dest": "www.microsoft.com:443",
          "serverNames": ["www.microsoft.com"],
          "privateKey": "",
          "shortIds": [""],
          "minClientVer": "1.8.0",
          "maxTimeDiff": 90
        }
      }
    }
  ],
  "outbounds": [
    {
      "protocol": "freedom",
      "tag": "direct"
    },
    {
      "protocol": "blackhole",
      "tag": "block"
    }
  ],
  "routing": {
    "rules": [
      {
        "type": "field",
        "protocol": ["bittorrent"],
        "outboundTag": "block"
      }
    ]
  }
}
```

### –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–°–º. –ø–æ–ª–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –≤ —Ñ–∞–π–ª–µ `templates/config_secure_maximum.json`

## –°–∫—Ä–∏–ø—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏

### –£—Å—Ç–∞–Ω–æ–≤—â–∏–∫ —É–ª—É—á—à–µ–Ω–∏–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

```bash
#!/bin/bash
# scripts/install-security-improvements.sh

install_security_improvements() {
    print_header "Installing Security Improvements"

    # –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
    mkdir -p /opt/vless/scripts/{lib,monitoring,security}
    mkdir -p /opt/vless/templates/security
    mkdir -p /opt/vless/logs/security

    # –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–æ–≤
    cp scripts/lib/security.sh /opt/vless/scripts/lib/
    cp scripts/monitor-security.sh /opt/vless/scripts/monitoring/
    cp scripts/rotate-keys.sh /opt/vless/scripts/security/
    cp scripts/security-check.sh /opt/vless/scripts/security/

    # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∞–≤
    chmod 750 /opt/vless/scripts/{lib,monitoring,security}/*.sh

    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ cron –∑–∞–¥–∞—á
    setup_cron_jobs

    # –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –±–∞–∑–æ–≤—ã—Ö —É–ª—É—á—à–µ–Ω–∏–π
    apply_basic_improvements

    print_success "Security improvements installed successfully"
}

setup_cron_jobs() {
    # –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
    (crontab -l 2>/dev/null; echo "*/5 * * * * /opt/vless/scripts/monitoring/monitor-security.sh") | crontab -

    # –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –æ—Ç—á–µ—Ç
    (crontab -l 2>/dev/null; echo "0 1 * * * /opt/vless/scripts/security/security-metrics.sh") | crontab -

    # –ï–∂–µ–º–µ—Å—è—á–Ω–∞—è —Ä–æ—Ç–∞—Ü–∏—è –∫–ª—é—á–µ–π
    (crontab -l 2>/dev/null; echo "0 3 1 * * /opt/vless/scripts/security/rotate-all-keys.sh") | crontab -

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–≤–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    (crontab -l 2>/dev/null; echo "0 */6 * * * /opt/vless/scripts/check-all-user-limits.sh") | crontab -
}

apply_basic_improvements() {
    # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å –±–∞–∑–æ–≤—ã–º–∏ —É–ª—É—á—à–µ–Ω–∏—è–º–∏
    local config_file="/opt/vless/config/config.json"

    # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ minClientVer
    jq '.inbounds[0].streamSettings.realitySettings.minClientVer = "1.8.0"' "$config_file" > "$config_file.tmp"
    mv "$config_file.tmp" "$config_file"

    # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ maxTimeDiff
    jq '.inbounds[0].streamSettings.realitySettings.maxTimeDiff = 90' "$config_file" > "$config_file.tmp"
    mv "$config_file.tmp" "$config_file"

    # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
    jq '.routing.rules += [{"type": "field", "protocol": ["bittorrent"], "outboundTag": "block"}]' "$config_file" > "$config_file.tmp"
    mv "$config_file.tmp" "$config_file"

    # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞
    docker-compose -f /opt/vless/docker-compose.yml restart
}

# –ó–∞–ø—É—Å–∫ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
install_security_improvements
```

## –ß–µ–∫-–ª–∏—Å—Ç –≤–Ω–µ–¥—Ä–µ–Ω–∏—è

### –§–∞–∑–∞ 1: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É–ª—É—á—à–µ–Ω–∏—è (–î–µ–Ω—å 1)
- [ ] –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- [ ] –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö serverNames
- [ ] –ù–∞—Å—Ç—Ä–æ–π–∫–∞ minClientVer –∏ maxTimeDiff
- [ ] –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –±–∞–∑–æ–≤—ã—Ö –ø—Ä–∞–≤–∏–ª –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤

### –§–∞–∑–∞ 2: –í–∞–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (–î–µ–Ω—å 2-3)
- [ ] –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏
- [ ] –í–Ω–µ–¥—Ä–µ–Ω–∏–µ DNS –∑–∞—â–∏—Ç—ã
- [ ] –ù–∞—Å—Ç—Ä–æ–π–∫–∞ fallback –º–µ—Ö–∞–Ω–∏–∑–º–æ–≤
- [ ] –ó–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- [ ] –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

### –§–∞–∑–∞ 3: –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è (–î–µ–Ω—å 4-5)
- [ ] –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Ä–æ—Ç–∞—Ü–∏–∏ –∫–ª—é—á–µ–π
- [ ] –í–Ω–µ–¥—Ä–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –∫–≤–æ—Ç
- [ ] –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- [ ] –°–æ–∑–¥–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–æ–≤ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–π

### –§–∞–∑–∞ 4: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è (–î–µ–Ω—å 6-7)
- [ ] –ù–∞—Å—Ç—Ä–æ–π–∫–∞ TCP –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π
- [ ] –¢—é–Ω–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- [ ] –§–∏–Ω–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- [ ] –û–±—É—á–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ—Å–ª–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è

### –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–∏—Å–∞
docker-compose -f /opt/vless/docker-compose.yml ps

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ –Ω–∞ –æ—à–∏–±–∫–∏
grep ERROR /var/log/xray/error.log | tail -20

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
grep rejected /var/log/xray/access.log | wc -l

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
/opt/vless/scripts/list-active-users.sh
```

### –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–µ –∑–∞–¥–∞—á–∏
```bash
# –ê—É–¥–∏—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
/opt/vless/scripts/security/security-check.sh

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–≤–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
/opt/vless/scripts/check-all-user-limits.sh

# –ê–Ω–∞–ª–∏–∑ –∞–Ω–æ–º–∞–ª–∏–π
/opt/vless/scripts/analyze-anomalies.sh

# –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ª–æ–≥–æ–≤
/opt/vless/scripts/rotate-logs.sh
```

## –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### –ü—Ä–æ–±–ª–µ–º–∞: –ö–ª–∏–µ–Ω—Ç—ã –Ω–µ –º–æ–≥—É—Ç –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
docker run --rm -v /opt/vless/config:/etc/xray teddysun/xray:latest xray -test -config /etc/xray/config.json

# –û—Ç–∫–∞—Ç –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
cp /opt/vless/backups/latest/config.json /opt/vless/config/config.json
docker-compose -f /opt/vless/docker-compose.yml restart
```

### –ü—Ä–æ–±–ª–µ–º–∞: –í—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–ø IP –∞–¥—Ä–µ—Å–æ–≤
netstat -tn | awk '{print $5}' | cut -d: -f1 | sort | uniq -c | sort -rn | head

# –í—Ä–µ–º–µ–Ω–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö IP
ufw deny from <IP> to any
```

### –ü—Ä–æ–±–ª–µ–º–∞: DNS —É—Ç–µ—á–∫–∏
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ DNS –∑–∞–ø—Ä–æ—Å–æ–≤
tcpdump -i any -n port 53

# –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ DNS
iptables -t nat -A OUTPUT -p udp --dport 53 -j DNAT --to-destination 1.1.1.1:53
```

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–î–∞–Ω–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –∫ —É—Å–∏–ª–µ–Ω–∏—é –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ VLESS+Reality —Å–µ—Ä–≤–µ—Ä–∞. –í–Ω–µ–¥—Ä–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å –ø–æ—ç—Ç–∞–ø–Ω–æ —Å —Ç—â–∞—Ç–µ–ª—å–Ω—ã–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ.

### –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã:
1. **–ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ** - –Ω–µ –ø—Ä–∏–º–µ–Ω—è–π—Ç–µ –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ä–∞–∑—É
2. **–†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ** - –≤—Å–µ–≥–¥–∞ —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ backup –ø–µ—Ä–µ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏
3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ –≤–ª–∏—è–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
4. **–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** - —Ñ–∏–∫—Å–∏—Ä—É–π—Ç–µ –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ –∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
5. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** - –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- –†–µ–≥—É–ª—è—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è Xray-core
- –°–ª–µ–¥–∏—Ç–µ –∑–∞ –Ω–æ–≤–æ—Å—Ç—è–º–∏ –≤ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ XTLS
- –û–±–Ω–æ–≤–ª—è–π—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ –≥–µ–æ–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –µ–∂–µ–º–µ—Å—è—á–Ω–æ
- –ü—Ä–æ–≤–æ–¥–∏—Ç–µ –∞—É–¥–∏—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –µ–∂–µ–∫–≤–∞—Ä—Ç–∞–ª—å–Ω–æ

---
*–î–æ–∫—É–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ XTLS/Xray-core –∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –ø—Ä–∞–∫—Ç–∏–∫ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞.*