# Детальный план реализации проекта VLESS+Reality VPN

## Общая информация
- **Проект:** VLESS+Reality VPN Service
- **Версия плана:** 1.0
- **Дата создания:** 2025-09-26
- **Общий срок реализации:** 7-10 дней
- **Подход:** Модульная архитектура с поэтапной реализацией

## Архитектура решения

### Выбранный вариант реализации
**Модульная архитектура с поэтапной разработкой:**
- Отдельные bash-скрипты для каждой функции
- Библиотеки общих функций для переиспользования кода
- Шаблоны конфигураций с подстановкой переменных
- Xray-core в Docker контейнере
- Скрипты управления на хосте в /opt/vless/scripts/
- Интерактивный CLI интерфейс с меню

### Структура проекта

```
vless/                          # Git репозиторий
├── scripts/
│   ├── install.sh              # Установщик системы
│   ├── user-manager.sh         # Управление пользователями
│   ├── update.sh               # Обновление Xray-core
│   ├── backup.sh               # Резервное копирование
│   ├── logs.sh                 # Работа с логами
│   └── lib/
│       ├── colors.sh           # Цветной вывод
│       ├── utils.sh            # Общие функции
│       ├── config.sh           # Работа с конфигурацией
│       └── domains.sh          # Список целевых доменов
├── templates/
│   ├── docker-compose.yml.tpl  # Шаблон Docker Compose
│   ├── config.json.tpl         # Шаблон конфигурации Xray
│   └── .env.example            # Пример переменных окружения
├── docs/
│   ├── README.md               # Быстрый старт
│   ├── ADMIN_GUIDE.md          # Руководство администратора
│   └── TROUBLESHOOTING.md      # Решение проблем
└── .gitignore                  # Исключения Git
```

## Поэтапный план реализации

### ЭТАП 1: Базовая инфраструктура (2-3 дня)
**Приоритет:** ВЫСОКИЙ
**Зависимости:** Нет

#### День 1: Структура и библиотеки

**Задача 1.1: Создание структуры репозитория**
- Создать директории scripts/, templates/, docs/
- Создать поддиректорию scripts/lib/
- Настроить .gitignore для исключения рабочих файлов

**Задача 1.2: Разработка библиотек функций**

*lib/colors.sh - Цветной вывод в терминал:*
```bash
# Определение цветов
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Функции вывода
print_success() { echo -e "${GREEN}✓${NC} $1"; }
print_error() { echo -e "${RED}✗${NC} $1"; }
print_warning() { echo -e "${YELLOW}⚠${NC} $1"; }
print_info() { echo -e "${BLUE}ℹ${NC} $1"; }
```

*lib/utils.sh - Общие функции:*
```bash
# Проверка запуска от root
check_root() {
    if [[ $EUID -ne 0 ]]; then
        print_error "Скрипт должен быть запущен от root"
        exit 1
    fi
}

# Проверка команды
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Валидация IP адреса
validate_ip() {
    local ip=$1
    if [[ $ip =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
        return 0
    fi
    return 1
}

# Генерация UUID
generate_uuid() {
    cat /proc/sys/kernel/random/uuid
}

# Генерация Short ID (8 hex символов)
generate_short_id() {
    openssl rand -hex 4
}
```

*lib/domains.sh - Список проверенных доменов для REALITY:*
```bash
# Массив проверенных доменов
TRUSTED_DOMAINS=(
    "speed.cloudflare.com:443"
    "www.google.com:443"
    "www.microsoft.com:443"
    "www.apple.com:443"
    "www.amazon.com:443"
    "www.bing.com:443"
    "www.yahoo.com:443"
    "www.wikipedia.org:443"
)

# Функция выбора домена
select_reality_domain() {
    echo "Выберите целевой домен для REALITY:"
    echo "0) Ввести свой домен"

    for i in "${!TRUSTED_DOMAINS[@]}"; do
        echo "$((i+1))) ${TRUSTED_DOMAINS[$i]}"
    done

    read -p "Выбор (0-${#TRUSTED_DOMAINS[@]}): " choice

    if [[ $choice -eq 0 ]]; then
        read -p "Введите домен (формат: domain.com:443): " custom_domain
        echo "$custom_domain"
    else
        echo "${TRUSTED_DOMAINS[$((choice-1))]}"
    fi
}
```

**Задача 1.3: Создание шаблонов**

*templates/.env.example:*
```bash
# Основные настройки
SERVER_IP=
SERVER_PORT=443

# REALITY настройки
REALITY_DEST=
REALITY_SERVER_NAME=

# Администратор
ADMIN_SHORT_ID=
ADMIN_EMAIL=

# Системные настройки
COMPOSE_PROJECT_NAME=vless-reality
TZ=UTC
```

*templates/docker-compose.yml.tpl:*
```yaml
version: '3.8'

services:
  xray:
    image: teddysun/xray:latest
    container_name: xray-server
    restart: unless-stopped
    ports:
      - "{{SERVER_PORT}}:443"
    volumes:
      - ./config:/etc/xray:ro
      - ./logs:/var/log/xray
      - ./data:/data:ro
    environment:
      - TZ={{TZ}}
    networks:
      - vless-network

networks:
  vless-network:
    driver: bridge
```

#### День 2: Скрипт установки

**Задача 1.4: Разработка install.sh**

Функциональность:
1. Проверка системных требований
2. Установка зависимостей (Docker, Docker Compose, qrencode, jq)
3. Интерактивный ввод параметров:
   - Автоопределение IP с подтверждением
   - Выбор целевого домена из списка
   - Генерация Short ID администратора
   - Опциональный ввод email
4. Генерация X25519 ключей
5. Создание структуры /opt/vless/
6. Генерация конфигурации из шаблонов
7. Установка прав доступа
8. Запуск контейнера
9. Проверка работоспособности

Структура скрипта:
```bash
#!/bin/bash

# Загрузка библиотек
source "$(dirname "$0")/lib/colors.sh"
source "$(dirname "$0")/lib/utils.sh"
source "$(dirname "$0")/lib/domains.sh"

# Переменные
VLESS_HOME="/opt/vless"
REPO_DIR="$(cd "$(dirname "$0")/.." && pwd)"

# Основная логика
main() {
    print_info "VLESS + REALITY Installer v1.0"

    # Проверки
    check_root
    check_system_requirements

    # Интерактивный ввод
    collect_parameters

    # Подтверждение
    confirm_installation

    # Установка
    install_dependencies
    create_directories
    generate_keys
    create_configs
    set_permissions
    start_service

    # Проверка
    verify_installation

    print_success "Установка завершена успешно!"
}
```

**Задача 1.5: Базовое тестирование**
- Тестирование на чистой системе Ubuntu 20.04
- Проверка генерации ключей
- Проверка создания конфигураций
- Проверка запуска контейнера

### ЭТАП 2: Управление пользователями (2-3 дня)
**Приоритет:** ВЫСОКИЙ
**Зависимости:** Этап 1

#### День 3-4: Скрипт управления пользователями

**Задача 2.1: Разработка user-manager.sh**

Интерактивное меню:
```
========================================
    VLESS User Manager
========================================
1) Показать список пользователей
2) Добавить пользователя
3) Удалить пользователя
4) Экспортировать конфигурацию пользователя
5) Выход

Выберите действие:
```

**Задача 2.2: Функция добавления пользователя**
- Ввод имени пользователя
- Генерация UUID
- Генерация Short ID
- Добавление в config.json
- Сохранение в users.json
- Перезапуск контейнера

**Задача 2.3: Функция удаления пользователя**
- Выбор из списка
- Подтверждение удаления
- Удаление из config.json
- Обновление users.json
- Перезапуск контейнера

**Задача 2.4: Экспорт конфигураций**

Подменю экспорта:
```
Экспорт конфигурации для: username
1) Показать vless:// ссылку
2) Сохранить JSON конфигурацию
3) Показать QR-код в терминале
4) Сохранить QR-код в PNG
5) Все варианты
```

Реализация QR-кодов:
```bash
# ASCII QR-код в терминале
show_qr_terminal() {
    local vless_link=$1
    qrencode -t ansiutf8 "$vless_link"
}

# PNG QR-код 640x640
save_qr_png() {
    local vless_link=$1
    local username=$2
    local output_dir="$VLESS_HOME/data/qr_codes"
    mkdir -p "$output_dir"
    qrencode -o "$output_dir/${username}.png" -s 10 "$vless_link"
    print_success "QR-код сохранен: $output_dir/${username}.png"
}
```

**Задача 2.5: Система хранения данных**

Формат users.json:
```json
{
  "users": [
    {
      "name": "user1",
      "uuid": "550e8400-e29b-41d4-a716-446655440000",
      "short_id": "a1b2c3d4",
      "created_at": "2025-09-26T10:00:00Z"
    }
  ]
}
```

#### День 5: Тестирование управления пользователями

**Задача 2.6: Комплексное тестирование**
- Добавление нескольких пользователей
- Удаление пользователей
- Генерация всех типов конфигураций
- Проверка QR-кодов
- Тестирование подключения клиентов

### ЭТАП 3: Скрипты обслуживания (2 дня)
**Приоритет:** СРЕДНИЙ
**Зависимости:** Этап 1, 2

#### День 6: Скрипты обслуживания

**Задача 3.1: update.sh - Обновление Xray**
```bash
#!/bin/bash

# Проверка новой версии
check_new_version() {
    docker pull teddysun/xray:latest
}

# Обновление с сохранением конфигурации
update_xray() {
    print_info "Создание резервной копии..."
    $VLESS_HOME/scripts/backup.sh

    print_info "Останавливаем контейнер..."
    docker-compose -f $VLESS_HOME/docker-compose.yml down

    print_info "Обновляем образ..."
    docker-compose -f $VLESS_HOME/docker-compose.yml pull

    print_info "Запускаем контейнер..."
    docker-compose -f $VLESS_HOME/docker-compose.yml up -d

    print_success "Обновление завершено!"
}
```

**Задача 3.2: backup.sh - Резервное копирование**
```bash
#!/bin/bash

# Создание timestamped backup
create_backup() {
    local timestamp=$(date +%Y%m%d_%H%M%S)
    local backup_dir="$VLESS_HOME/backups/$timestamp"

    mkdir -p "$backup_dir"

    # Копирование важных файлов
    cp -r $VLESS_HOME/config "$backup_dir/"
    cp -r $VLESS_HOME/data "$backup_dir/"
    cp $VLESS_HOME/.env "$backup_dir/"

    # Архивация
    tar -czf "$backup_dir.tar.gz" -C "$VLESS_HOME/backups" "$timestamp"
    rm -rf "$backup_dir"

    # Ротация (хранить последние 30)
    rotate_backups

    print_success "Бэкап создан: $backup_dir.tar.gz"
}
```

**Задача 3.3: logs.sh - Работа с логами**

Интерактивное меню:
```
Управление логами:
1) Показать последние 100 строк
2) Следить за логами в реальном времени
3) Экспортировать логи
4) Очистить логи
```

#### День 7: Финализация

**Задача 3.4: lib/config.sh - Работа с конфигурацией**
- Функции чтения/записи config.json
- Валидация конфигурации
- Атомарное обновление файлов

### ЭТАП 4: Документация (1-2 дня)
**Приоритет:** НИЗКИЙ
**Зависимости:** Этап 1, 2, 3

#### День 8-9: Создание документации

**Задача 4.1: README.md**
- Описание проекта
- Системные требования
- Быстрый старт
- Основные команды

**Задача 4.2: ADMIN_GUIDE.md**
- Детальная инструкция по установке
- Управление пользователями
- Резервное копирование
- Обновление системы

**Задача 4.3: TROUBLESHOOTING.md**
- Частые проблемы и решения
- Проверка работоспособности
- Восстановление из бэкапа
- FAQ

## Технические решения

### Обработка ошибок
- Базовая проверка с выходом при критических ошибках
- Использование `set -e` для автоматического выхода при ошибках
- Проверка кодов возврата для важных операций
- Информативные сообщения об ошибках

### Валидация данных
- Проверка формата IP адресов
- Проверка доступности портов
- Проверка доступности целевых доменов
- Валидация email (если указан)

### Интерактивный интерфейс
- Все скрипты работают в интерактивном режиме с меню
- Подтверждение критических операций
- Значения по умолчанию где возможно
- Цветной вывод для улучшения читаемости

### Безопасность
- Права доступа 600 для конфиденциальных файлов
- Монтирование volumes в read-only режиме
- Генерация криптографически стойких ключей и ID
- Изоляция через Docker

## Критерии завершения

### Для каждого этапа:
- [ ] Код написан и протестирован
- [ ] Обработка основных ошибок реализована
- [ ] Интерактивные меню работают корректно
- [ ] Права доступа установлены правильно

### Для всего проекта:
- [ ] Установка проходит за один запуск
- [ ] Добавление пользователя занимает < 1 минуты
- [ ] QR-коды генерируются в PNG и ASCII
- [ ] Список целевых доменов доступен с возможностью своего
- [ ] Все скрипты работают в интерактивном режиме
- [ ] Документация написана

## Итоговая оценка

**Общее время реализации:** 7-9 дней
**Сложность:** Средняя
**Готовность к реализации:** Полная

Проект готов к поэтапной реализации начиная с базовой инфраструктуры и установщика.