# Filesystem Layout Diagram

**Purpose:** Visualize the complete directory structure at `/opt/familytraffic/`

**Scope:** All configuration files, data files, scripts, libraries, logs

**Important:** `/opt/familytraffic/` is HARDCODED and cannot be changed

---

## Complete Filesystem Tree

### /opt/familytraffic/ Directory Structure

```mermaid
graph TB
    Root["/opt/familytraffic/<br/>(Installation Root)"]

    Config["config/<br/>(Configuration Files)"]
    Data["data/<br/>(User Data & Client Configs)"]
    Scripts["scripts/<br/>(Executable CLI Tools)"]
    Lib["lib/<br/>(Shell Module Library)"]
    Logs["logs/<br/>(Service Logs)"]
    CertbotWebroot["certbot-webroot/<br/>(ACME Challenge Files)"]
    FakeSite["fake-site/<br/>(Generic Website HTML)"]
    Docker["docker/<br/>(Docker Build Contexts)"]

    Root --> Config
    Root --> Data
    Root --> Scripts
    Root --> Lib
    Root --> Logs
    Root --> CertbotWebroot
    Root --> FakeSite
    Root --> Docker

    style Root fill:#e1f5ff,stroke:#0066cc,stroke-width:3px
    style Config fill:#ffe1f5,stroke:#cc0099,stroke-width:2px
    style Data fill:#e1ffe1,stroke:#00cc00,stroke-width:2px
    style Scripts fill:#fff9e1,stroke:#cc9900,stroke-width:2px
    style Lib fill:#e1e1f5,stroke:#0000cc,stroke-width:2px
```

---

## Detailed Directory Breakdown

### 1. config/ - Configuration Files

```mermaid
graph TB
    ConfigDir["/opt/familytraffic/config/"]

    NginxDir["nginx/<br/>(nginx Configuration)"]
    XrayConf["xray_config.json<br/>(Xray Main Config)"]
    ExtProxyJSON["external_proxy.json<br/>(External Proxies Database)"]
    KeysDir["keys/<br/>(Reality Keys)"]
    MTProxyDir["mtproxy/<br/>(MTProxy Configs - v6.0+)"]

    ConfigDir --> NginxDir
    ConfigDir --> XrayConf
    ConfigDir --> ExtProxyJSON
    ConfigDir --> KeysDir
    ConfigDir --> MTProxyDir

    NginxDir --> NginxConf["nginx.conf<br/>(stream + http blocks)"]

    KeysDir --> PrivKey["private.key<br/>(Reality private key)"]
    KeysDir --> PubKey["public.key<br/>(Reality public key)"]

    MTProxyDir --> MTProxyConfig["mtproxy_config.json<br/>(MTProxy Settings)"]
    MTProxyDir --> ProxySecret["proxy-secret<br/>(MTProxy Secrets)"]
    MTProxyDir --> ProxyMultiConf["proxy-multi.conf<br/>(Telegram DC Addresses)"]

    style ConfigDir fill:#ffe1f5,stroke:#cc0099,stroke-width:3px
```

**Key Files:**

| File | Purpose | Generated By | Format |
|------|---------|--------------|--------|
| `nginx/nginx.conf` | nginx stream+http config (SNI routing + TLS termination) | `orchestrator.sh` | nginx config |
| `xray_config.json` | Xray configuration | `orchestrator.sh`, `user_management.sh` | JSON |
| `external_proxy.json` | External proxies database | `external_proxy_manager.sh` | JSON |
| `keys/private.key` | Reality private key | `orchestrator.sh` | PEM |
| `keys/public.key` | Reality public key | `orchestrator.sh` | PEM |
| `mtproxy/mtproxy_config.json` | MTProxy configuration (v6.0+) | `mtproxy_manager.sh` | JSON |
| `mtproxy/proxy-secret` | MTProxy secrets (v6.0+) | `mtproxy_secret_manager.sh` | Text (hex) |
| `mtproxy/proxy-multi.conf` | Telegram DC addresses (v6.0+) | Official repo | Text |

**Note:** `haproxy.cfg` and `reverse-proxy/` configs were removed in v5.33 with the removal of HAProxy and the reverse proxy feature.

---

### 2. data/ - User Data & Client Configurations

```mermaid
graph TB
    DataDir["/opt/familytraffic/data/"]

    UsersJSON["users.json<br/>(User Database)"]
    ClientsDir["clients/<br/>(Per-User Client Configs)"]

    DataDir --> UsersJSON
    DataDir --> ClientsDir

    ClientsDir --> Alice["alice/<br/>(User alice configs)"]
    ClientsDir --> Bob["bob/<br/>(User bob configs)"]
    ClientsDir --> Archived["archived/<br/>(Removed users)"]

    Alice --> VLESSUri["vless_uri.txt<br/>(VLESS Connection URI)"]
    Alice --> VLESSQR["vless_qr.png<br/>(VLESS QR Code)"]
    Alice --> SOCKS5Uri["socks5_uri.txt<br/>(SOCKS5 URI)"]
    Alice --> HTTPUri["http_uri.txt<br/>(HTTP Proxy URI)"]
    Alice --> ClientConfig["client_config.json<br/>(Xray Client Config)"]
    Alice --> Subscription["subscription.json<br/>(Subscription URL)"]

    style DataDir fill:#e1ffe1,stroke:#00cc00,stroke-width:3px
```

**users.json Structure:**
```json
{
  "users": [
    {
      "username": "alice",
      "uuid": "a1b2c3d4-e5f6-7890-1234-567890abcdef",
      "email": "alice@vless.local",
      "flow": "xtls-rprx-vision",
      "socks_password": "hashed_password",
      "http_password": "hashed_password",
      "external_proxy_id": null,
      "mtproxy_secret": null,
      "created_at": "2026-01-07T14:30:00Z"
    }
  ]
}
```

**clients/<username>/ Directory:**

| File | Content | Used By |
|------|---------|---------|
| `vless_uri.txt` | `vless://uuid@domain:443?...` | VLESS clients (v2rayN, Qv2ray) |
| `vless_qr.png` | QR code of VLESS URI | Mobile clients |
| `socks5_uri.txt` | `socks5s://user:pass@server:1080` | SOCKS5 clients (Firefox, proxychains) |
| `http_uri.txt` | `https://user:pass@server:8118` | HTTP proxy clients (Chrome, cURL) |
| `client_config.json` | Complete Xray client configuration | Xray client |
| `subscription.json` | Subscription URL for auto-update | Subscription-aware clients |

---

### 3. scripts/ - Executable CLI Tools

```mermaid
graph TB
    ScriptsDir["/opt/familytraffic/scripts/"]

    VLESSmain["vless / familytraffic<br/>(Main CLI)"]
    VLESSExtProxy["familytraffic-external-proxy<br/>(External Proxy Management)"]
    MTProxyCLI["mtproxy<br/>(MTProxy Management - v6.0+)"]
    RenewHook["familytraffic-cert-renew<br/>(Certbot Deploy Hook)"]
    InitScript["install.sh<br/>(Installation Script)"]

    ScriptsDir --> VLESSmain
    ScriptsDir --> VLESSExtProxy
    ScriptsDir --> MTProxyCLI
    ScriptsDir --> RenewHook
    ScriptsDir --> InitScript

    style ScriptsDir fill:#fff9e1,stroke:#cc9900,stroke-width:3px
```

**Symlinks to /usr/local/bin/:**
```bash
/usr/local/bin/familytraffic → /opt/familytraffic/scripts/vless
/usr/local/bin/familytraffic-external-proxy → /opt/familytraffic/scripts/familytraffic-external-proxy
/usr/local/bin/familytraffic-cert-renew → /opt/familytraffic/scripts/familytraffic-cert-renew
/usr/local/bin/mtproxy → /opt/familytraffic/scripts/mtproxy
```

**Note:** `familytraffic-proxy` (reverse proxy management) was removed in v5.33.

---

### 4. lib/ - Shell Module Library (44 Modules)

```mermaid
graph TB
    LibDir["/opt/familytraffic/lib/"]

    Core["Core Modules:<br/>- orchestrator.sh (1881 lines)<br/>- user_management.sh (3000 lines)<br/>- external_proxy_manager.sh (1100 lines)"]

    Config["Config Generators:<br/>- nginx_config_generator.sh<br/>- xray_routing_manager.sh"]

    Utilities["Utilities:<br/>- qr_generator.sh<br/>- certificate_manager.sh<br/>- security_hardening.sh"]

    MTProxy["MTProxy Modules (v6.0+):<br/>- mtproxy_manager.sh<br/>- mtproxy_secret_manager.sh"]

    LibDir --> Core
    LibDir --> Config
    LibDir --> Utilities
    LibDir --> MTProxy

    style LibDir fill:#e1e1f5,stroke:#0000cc,stroke-width:3px
```

**Module Categories:**

| Category | Modules | Total Lines | Purpose |
|----------|---------|-------------|---------|
| **Core** | orchestrator.sh, user_management.sh, external_proxy_manager.sh | ~5,981 | Main logic |
| **Config Generators** | haproxy_config_manager.sh, xray_routing_manager.sh, docker_compose_generator.sh | ~2,100 | Generate configs |
| **Utilities** | qr_generator.sh, certificate_manager.sh, security_hardening.sh, interactive_params.sh | ~1,500 | Helper functions |
| **MTProxy (v6.0+)** | mtproxy_manager.sh, mtproxy_secret_manager.sh | ~800 | MTProxy support |
| **Other** | 35 additional modules | ~16,000 | Various utilities |
| **Total** | 44 modules | ~26,500 | Complete library |

---

### 5. logs/ - Service Logs

```mermaid
graph TB
    LogsDir["/opt/familytraffic/logs/"]

    XrayLogs["xray/<br/>(Xray Logs)"]
    NginxLogs["nginx/<br/>(nginx Logs)"]
    MTProxyLogs["mtproxy/<br/>(MTProxy Logs - v6.0+)"]
    CertLogs["certbot-renew.log<br/>certbot-renew-metrics.json"]

    LogsDir --> XrayLogs
    LogsDir --> NginxLogs
    LogsDir --> MTProxyLogs
    LogsDir --> CertLogs

    XrayLogs --> XrayAccess["access.log"]
    XrayLogs --> XrayError["error.log"]

    NginxLogs --> NginxAccess["access.log"]
    NginxLogs --> NginxError["error.log"]

    MTProxyLogs --> MTProxyAccess["access.log"]
    MTProxyLogs --> MTProxyError["error.log"]
```

**Log Rotation:**
```bash
# /etc/logrotate.d/familytraffic
/opt/familytraffic/logs/*/*.log {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
    create 0640 root root
    sharedscripts
    postrotate
        docker exec familytraffic kill -HUP $(pgrep xray) >/dev/null 2>&1 || true
        docker exec familytraffic nginx -s reopen >/dev/null 2>&1 || true
        docker exec familytraffic-mtproxy kill -HUP $(pgrep mtproxy) >/dev/null 2>&1 || true
    endscript
}
```

---

### 6. certbot-webroot/ - ACME Challenge Files

```mermaid
graph TB
    CertbotDir["/opt/familytraffic/certbot-webroot/"]

    WellKnown[".well-known/"]

    CertbotDir --> WellKnown

    WellKnown --> ACMEChallenge["acme-challenge/<br/>(Challenge Files)"]

    ACMEChallenge --> Token1["random_token_xyz<br/>(Challenge Response)"]
    ACMEChallenge --> Token2["random_token_abc<br/>(Challenge Response)"]
```

**Purpose:** Served by nginx (inside `familytraffic` container) on port 80 for certbot webroot HTTP-01 challenge

**URL Pattern:** `http://example.com/.well-known/acme-challenge/random_token_xyz`

---

### 7. fake-site/ - Generic Website HTML

```mermaid
graph TB
    FakeSiteDir["/opt/familytraffic/fake-site/"]

    IndexHTML["index.html<br/>(Generic Homepage)"]
    Style["style.css<br/>(Basic Styling)"]
    Favicon["favicon.ico"]

    FakeSiteDir --> IndexHTML
    FakeSiteDir --> Style
    FakeSiteDir --> Favicon
```

**Purpose:** Served for invalid SNI or invalid UUID to appear as normal website

**index.html Example:**
```html
<!DOCTYPE html>
<html>
<head>
    <title>Welcome</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1>Welcome to Our Website</h1>
    <p>This is a generic placeholder page.</p>
</body>
</html>
```

---

### 8. docker/ - Docker Build Contexts

```mermaid
graph TB
    DockerDir["/opt/familytraffic/docker/"]

    MTProxyContext["mtproxy/<br/>(MTProxy Build Context - v6.0+)"]

    DockerDir --> MTProxyContext

    MTProxyContext --> Dockerfile["Dockerfile"]
    MTProxyContext --> EntryScript["entrypoint.sh"]
    MTProxyContext --> BuildScripts["build-scripts/"]
```

**docker/mtproxy/Dockerfile (v6.0+):**
```dockerfile
FROM alpine:latest

RUN apk add --no-cache \
    git \
    make \
    gcc \
    g++ \
    openssl-dev \
    zlib-dev

# Clone MTProxy official repo
RUN git clone https://github.com/TelegramMessenger/MTProxy.git /opt/MTProxy

WORKDIR /opt/MTProxy
RUN make

COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

EXPOSE 8443

ENTRYPOINT ["/entrypoint.sh"]
```

---

## External Filesystem Locations

### /etc/letsencrypt/ - TLS Certificates

```mermaid
graph TB
    LetsEncrypt["/etc/letsencrypt/"]

    Live["live/<br/>(Current Certificates)"]
    Archive["archive/<br/>(Certificate History)"]
    Renewal["renewal/<br/>(Renewal Configs)"]

    LetsEncrypt --> Live
    LetsEncrypt --> Archive
    LetsEncrypt --> Renewal

    Live --> Domain["example.com/<br/>(Domain Certificates)"]

    Domain --> Cert["cert.pem<br/>(Certificate)"]
    Domain --> Chain["chain.pem<br/>(Intermediate Chain)"]
    Domain --> Fullchain["fullchain.pem<br/>(Full Chain)"]
    Domain --> Privkey["privkey.pem<br/>(Private Key)"]
    Domain --> Combined["combined.pem<br/>(HAProxy Combined)"]

    style LetsEncrypt fill:#ffe1f5,stroke:#cc0099,stroke-width:3px
```

**combined.pem Generation:**
```bash
cat /etc/letsencrypt/live/example.com/fullchain.pem \
    /etc/letsencrypt/live/example.com/privkey.pem \
    > /etc/letsencrypt/live/example.com/combined.pem
```

**Used By:**
- nginx (inside `familytraffic`): `fullchain.pem` + `privkey.pem` for TLS termination on ports 1080/8118
- certbot-cron: automatic renewal with `--deploy-hook nginx -s reload`

---

## Permissions and Ownership

### Critical Files Security

| File/Directory | Owner | Group | Permissions | Reason |
|----------------|-------|-------|-------------|--------|
| `/opt/familytraffic/` | root | root | 755 | Root-owned installation |
| `/opt/familytraffic/config/` | root | root | 755 | Config directory |
| `/opt/familytraffic/config/*.json` | root | root | 600 | Contains sensitive data |
| `/opt/familytraffic/config/*.cfg` | root | root | 644 | HAProxy config (read-only) |
| `/opt/familytraffic/data/` | root | root | 755 | Data directory |
| `/opt/familytraffic/data/users.json` | root | root | 600 | Contains UUIDs, passwords |
| `/opt/familytraffic/data/clients/` | root | root | 755 | Client configs directory |
| `/opt/familytraffic/data/clients/*/*.txt` | root | root | 644 | Client config files (shareable) |
| `/opt/familytraffic/scripts/` | root | root | 755 | Scripts directory |
| `/opt/familytraffic/scripts/*` | root | root | 755 | Executable scripts |
| `/opt/familytraffic/lib/` | root | root | 755 | Library directory |
| `/opt/familytraffic/lib/*.sh` | root | root | 644 | Library modules (sourced, not executed) |
| `/opt/familytraffic/logs/` | root | root | 755 | Logs directory |
| `/opt/familytraffic/logs/*/*.log` | root | root | 640 | Log files |
| `/etc/letsencrypt/` | root | root | 755 | Certificate directory |
| `/etc/letsencrypt/live/` | root | root | 755 | Live certificates |
| `/etc/letsencrypt/live/*/privkey.pem` | root | root | 600 | Private keys (sensitive) |

---

## Disk Usage Estimates

| Directory | Typical Size | Maximum Size | Notes |
|-----------|-------------|--------------|-------|
| `/opt/familytraffic/config/` | ~100 KB | ~1 MB | Grows with reverse proxy domains |
| `/opt/familytraffic/data/` | ~10 MB | ~100 MB | Grows with number of users |
| `/opt/familytraffic/scripts/` | ~500 KB | ~1 MB | Static (CLI tools) |
| `/opt/familytraffic/lib/` | ~1 MB | ~2 MB | Static (44 modules, ~26,500 lines) |
| `/opt/familytraffic/logs/` | ~100 MB | ~1 GB | With log rotation (7 days) |
| `/opt/familytraffic/certbot-webroot/` | ~1 KB | ~10 KB | Temporary challenge files |
| `/opt/familytraffic/fake-site/` | ~10 KB | ~100 KB | Static HTML |
| `/opt/familytraffic/docker/` | ~100 KB | ~1 MB | Build contexts |
| **Total /opt/familytraffic/** | **~111 MB** | **~1.2 GB** | With active logs |
| `/etc/letsencrypt/` | ~10 KB | ~100 KB | Per domain |

---

## Backup Strategy

### Critical Files to Backup

**Priority 1 (Daily):**
- `/opt/familytraffic/data/users.json` - User database
- `/opt/familytraffic/config/external_proxy.json` - External proxies
- `/etc/letsencrypt/` - TLS certificates

**Priority 2 (Weekly):**
- `/opt/familytraffic/config/` - All configuration files
- `/opt/familytraffic/data/clients/` - Client configurations

**Priority 3 (Monthly):**
- `/opt/familytraffic/scripts/` - CLI tools (rarely change)
- `/opt/familytraffic/lib/` - Library modules (rarely change)

**Do NOT Backup:**
- `/opt/familytraffic/logs/` - Can be regenerated
- `/opt/familytraffic/certbot-webroot/` - Temporary files
- `/opt/familytraffic/fake-site/` - Static HTML (can be recreated)

**Backup Script Example:**
```bash
#!/bin/bash
BACKUP_DIR="/backup/vless/$(date +%Y%m%d)"
mkdir -p "$BACKUP_DIR"

# Priority 1: Critical data
tar -czf "$BACKUP_DIR/vless-data.tar.gz" /opt/familytraffic/data/
tar -czf "$BACKUP_DIR/letsencrypt.tar.gz" /etc/letsencrypt/

# Priority 2: Configuration
tar -czf "$BACKUP_DIR/vless-config.tar.gz" /opt/familytraffic/config/

# Keep 30 days of backups
find /backup/vless/ -type d -mtime +30 -exec rm -rf {} +
```

---

## Related Documentation

- [Docker Topology](docker-topology.md) - Container volume mounts
- [Port Mapping](port-mapping.md) - Network ports
- [docker.yaml](../../yaml/docker.yaml) - Complete specifications
- [config.yaml](../../yaml/config.yaml) - Configuration relationships
- [lib-modules.yaml](../../yaml/lib-modules.yaml) - Library module details

---

**Created:** 2026-01-07
**Updated:** 2026-02-26
**Version:** v5.33
**Status:** UPDATED — reflects single-container architecture
