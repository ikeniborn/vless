version: "1.0"
documentation_version: "v5.26"
last_updated: "2026-01-07"

project:
  name: "VLESS + Reality VPN - Library Modules Architecture"
  version: "v5.26"
  description: "Comprehensive documentation of all lib/ shell modules, functions, dependencies, and call chains"
  total_modules: 44
  total_lines: "~26,500"
  language: "Bash shell scripts"

modules:
  - name: "orchestrator.sh"
    path: "/opt/vless/lib/orchestrator.sh"
    lines: 1881
    purpose: "Installation orchestration & workflow coordination - main entry point"
    criticality: "CRITICAL"
    dependencies: ["dependencies.sh", "interactive_params.sh", "docker_compose_generator.sh", "haproxy_config_manager.sh", "certificate_manager.sh"]

    key_functions:
      - name: "orchestrate_installation"
        line: 42
        purpose: "Main installation entry point - coordinates entire setup workflow"
        parameters:
          - name: "INSTALL_ROOT"
            type: "string"
            default: "/opt/vless"
            description: "Installation directory (hardcoded)"
        calls:
          - "install_system_dependencies()"
          - "collect_installation_params()"
          - "validate_dns_for_domain()"
          - "obtain_certificate()"
          - "generate_docker_compose()"
          - "generate_haproxy_config()"
          - "generate_xray_config()"
          - "start_docker_containers()"
        returns: "exit_code (0=success, 1=failure)"
        duration: "~5-7 minutes (fresh Ubuntu 22.04)"

      - name: "generate_xray_config"
        line: 856
        purpose: "Generate Xray configuration from users.json and external_proxy.json"
        reads:
          - "/opt/vless/data/users.json"
          - "/opt/vless/config/external_proxy.json (optional)"
        writes: "/opt/vless/config/xray_config.json"
        validation: "xray test -c config.json"
        atomic_write: true

      - name: "reload_xray"
        line: 1234
        purpose: "Gracefully reload Xray configuration (SIGHUP signal)"
        command: "docker exec vless_xray kill -HUP $(docker exec vless_xray pgrep xray)"
        downtime: "~0s (graceful)"

  - name: "user_management.sh"
    path: "/opt/vless/lib/user_management.sh"
    lines: 3000
    purpose: "User CRUD operations + per-user proxy assignment (v5.24+)"
    criticality: "CRITICAL"
    dependencies: ["xray_routing_manager.sh", "qr_generator.sh", "client_config_generator.sh"]

    key_functions:
      - name: "add_user_to_json"
        line: 156
        purpose: "Add user to users.json atomically with file locking"
        parameters:
          - name: "username"
            type: "string"
            validation: "^[a-z][a-z0-9_-]{2,31}$"
          - name: "uuid"
            type: "string (UUIDv4)"
            generator: "uuidgen"
          - name: "email"
            type: "string (optional)"
            format: "username@vless.local"
        locking:
          file: "/var/lock/vless_users.lock"
          timeout: "10s"
        operations:
          - "Read users.json"
          - "Validate username uniqueness"
          - "Append new user object"
          - "Atomic write (temp file → rename)"
        affected_files: ["/opt/vless/data/users.json"]
        error_handling:
          - condition: "username exists"
            action: "return 1, log error"
          - condition: "invalid UUID"
            action: "return 1, log error"

      - name: "cmd_set_user_proxy"
        line: 789
        purpose: "Assign external proxy to specific user (v5.24+ feature)"
        feature_version: "v5.24+"
        parameters:
          - name: "username"
            type: "string"
          - name: "proxy_id"
            type: "string"
            validation: "exists in external_proxy.json"
        workflow:
          - "Validate user exists in users.json"
          - "Validate proxy_id exists in external_proxy.json"
          - "Update users.json: users[username].external_proxy_id = proxy_id"
          - "Call update_xray_routing_for_user(username)"
          - "Validate xray_config.json"
          - "reload_xray()"
        calls:
          - module: "xray_routing_manager.sh"
            function: "update_xray_routing_for_user()"

      - name: "remove_user_from_json"
        line: 456
        purpose: "Remove user from users.json atomically"
        locking: "flock /var/lock/vless_users.lock"
        operations:
          - "Read users.json"
          - "Filter out user by username"
          - "Atomic write"
        post_actions:
          - "regenerate xray_config.json"
          - "reload_xray()"
          - "delete /opt/vless/data/clients/<username>/"

  - name: "external_proxy_manager.sh"
    path: "/opt/vless/lib/external_proxy_manager.sh"
    lines: 1100
    purpose: "Upstream proxy chaining management (v5.23+ feature)"
    criticality: "HIGH"
    feature_version: "v5.23+"
    dependencies: ["xray_routing_manager.sh"]

    key_functions:
      - name: "cmd_add_external_proxy"
        line: 45
        purpose: "Interactive wizard to add upstream proxy"
        prompts:
          - "Proxy name (human-readable)"
          - "Protocol (socks5/socks5s/http/https)"
          - "Address (IP or domain)"
          - "Port (1-65535)"
          - "Username"
          - "Password (hidden input)"
        validation:
          connectivity_test: "curl --proxy <url> https://www.google.com"
        workflow:
          - "Collect proxy details"
          - "Test connectivity"
          - "Generate proxy ID (proxy-<N>)"
          - "Add to external_proxy.json"
          - "Regenerate xray_config.json"
          - "Restart Xray container"
        affected_files:
          - "/opt/vless/config/external_proxy.json"
          - "/opt/vless/config/xray_config.json"

      - name: "test_external_proxy"
        line: 345
        purpose: "Test connectivity to external proxy"
        tests:
          - test: "HTTP connectivity"
            command: "curl --proxy ... http://www.google.com"
          - test: "HTTPS connectivity"
            command: "curl --proxy ... https://www.anthropic.com"
          - test: "Latency measurement"
            command: "time curl --proxy ... https://www.google.com"

  - name: "haproxy_config_manager.sh"
    path: "/opt/vless/lib/haproxy_config_manager.sh"
    lines: 809
    purpose: "HAProxy unified config generation & dynamic ACL management"
    criticality: "CRITICAL"
    dependencies: []

    key_functions:
      - name: "generate_haproxy_config"
        line: 78
        purpose: "Generate complete HAProxy configuration"
        reads:
          - "/opt/vless/config/reverse-proxy/*.conf (for dynamic ACLs)"
        writes: "/opt/vless/config/haproxy.cfg"
        sections_generated:
          - "global (log, stats, user, maxconn)"
          - "defaults (timeouts, mode)"
          - "frontends (https_sni_router, socks5_tls, http_tls, stats)"
          - "backends (xray_vless, xray_socks5, xray_http, nginx_*, fake_site)"
        dynamic_sections:
          reverse_proxy_routes:
            marker_start: "# DYNAMIC_REVERSE_PROXY_ROUTES"
            marker_end: "# END DYNAMIC_REVERSE_PROXY_ROUTES"
            generator: "add_haproxy_acl_for_domain()"
        validation: "haproxy -c -f haproxy.cfg"

      - name: "add_haproxy_acl_for_domain"
        line: 456
        purpose: "Add dynamic ACL for reverse proxy domain"
        parameters:
          - name: "domain"
            type: "string"
            example: "claude.example.com"
          - name: "port"
            type: "integer"
            range: "9443-9452"
        operations:
          - "Sanitize domain (replace . and - with _)"
          - "Generate ACL: acl is_<sanitized> req.ssl_sni -i <domain>"
          - "Generate backend: backend nginx_<sanitized>"
          - "Insert into dynamic section"
          - "Validate haproxy.cfg"
        output_example: |
          acl is_claude_example_com req.ssl_sni -i claude.example.com
          use_backend nginx_claude_example_com if is_claude_example_com
          backend nginx_claude_example_com
            server nginx 127.0.0.1:9443 check ssl verify none

      - name: "reload_haproxy"
        line: 678
        purpose: "Gracefully reload HAProxy without dropping connections"
        command: "docker exec vless_haproxy haproxy -sf $(cat /var/run/haproxy.pid)"
        downtime: "~0s (seamless)"

  - name: "reverseproxy_db.sh"
    path: "/opt/vless/lib/reverseproxy_db.sh"
    lines: 1245
    purpose: "Reverse proxy domain database & Nginx config management"
    criticality: "HIGH"
    feature_version: "v4.3+"
    dependencies: ["haproxy_config_manager.sh", "certificate_manager.sh"]

    key_functions:
      - name: "add_reverse_proxy_domain"
        line: 89
        purpose: "Complete workflow to add reverse proxy domain"
        parameters:
          - name: "domain"
            validation: "DNS points to server IP"
          - name: "target_url"
            validation: "Valid URL, target reachable"
          - name: "rate_limit"
            default: "100"
            unit: "requests/second"
        workflow:
          - "Validate domain DNS"
          - "Allocate port from 9443-9452 pool"
          - "Obtain Let's Encrypt certificate (HTTP-01)"
          - "Generate Nginx config"
          - "Add rate limit zone to http_context.conf"
          - "Reload Nginx"
          - "Add HAProxy ACL"
          - "Reload HAProxy"
        affected_files:
          - "/opt/vless/config/reverse-proxy/<domain>.conf"
          - "/opt/vless/config/reverse-proxy/http_context.conf"
          - "/opt/vless/config/haproxy.cfg"
          - "/etc/letsencrypt/live/<domain>/"
        duration: "~60-90 seconds (with cert acquisition)"

      - name: "add_rate_limit_zone"
        line: 567
        purpose: "Add rate limit zone to http_context.conf (CRITICAL)"
        parameters:
          - name: "domain"
            type: "string"
          - name: "rate"
            type: "integer"
            default: 100
        format: "limit_req_zone $binary_remote_addr zone=reverseproxy_<sanitized>:10m rate=<rate>r/s;"
        critical_note: "Missing zone causes Nginx crash loop"

      - name: "allocate_port"
        line: 234
        purpose: "Find available port from 9443-9452 pool"
        algorithm: "Scan existing configs, find first unused port"
        max_domains: 10
        error_if: "All ports occupied"

  - name: "xray_routing_manager.sh"
    path: "/opt/vless/lib/xray_routing_manager.sh"
    lines: 678
    purpose: "Xray routing rules generation for per-user external proxy (v5.24+)"
    criticality: "HIGH"
    feature_version: "v5.24+"
    dependencies: []

    key_functions:
      - name: "update_xray_routing_for_user"
        line: 45
        purpose: "Update Xray routing rules for user with external proxy"
        parameters:
          - name: "username"
            type: "string"
        workflow:
          - "Read users.json"
          - "Filter users where external_proxy_id != null"
          - "Build user[] array for routing rule"
          - "Update xray_config.json routing.rules[0].user[]"
          - "Validate xray_config.json"
        mapping:
          vless: "users[].email → routing.rules[].user[]"
          socks5_http: "users[].username → routing.rules[].user[]"

      - name: "generate_routing_rules"
        line: 234
        purpose: "Generate complete routing.rules[] section"
        reads: "/opt/vless/data/users.json"
        output:
          - rule: "Per-user external proxy routing"
            condition: "user in user[] array"
            outbound: "external-proxy"
          - rule: "Default direct routing"
            condition: "default"
            outbound: "direct"

  - name: "qr_generator.sh"
    path: "/opt/vless/lib/qr_generator.sh"
    lines: 456
    purpose: "QR code generation for client configurations"
    criticality: "MEDIUM"
    dependencies: ["qrencode (system package)"]

    key_functions:
      - name: "generate_qr_code"
        line: 34
        purpose: "Generate QR code from connection URI"
        parameters:
          - name: "uri"
            type: "string"
            formats: ["vless://", "socks5s://", "https://"]
          - name: "output_file"
            type: "string"
            format: ".png"
        command: "qrencode -o <output_file> -s 10 -m 2 '<uri>'"
        fallback: "If qrencode unavailable, skip QR generation (non-critical)"

      - name: "generate_client_configs"
        line: 123
        purpose: "Generate all client config files for user"
        parameters:
          - name: "username"
            type: "string"
          - name: "uuid"
            type: "string"
          - name: "domain"
            type: "string"
        outputs:
          - "vless_config.json (JSON format)"
          - "vless_link.txt (vless:// URI)"
          - "vless_qr.png (QR code)"
          - "socks5_config.txt (credentials)"
          - "http_config.txt (credentials)"
          - "qr_codes.html (HTML with all QR codes)"
        output_directory: "/opt/vless/data/clients/<username>/"

  - name: "certificate_manager.sh"
    path: "/opt/vless/lib/certificate_manager.sh"
    lines: 892
    purpose: "Let's Encrypt certificate lifecycle management"
    criticality: "CRITICAL"
    dependencies: ["certbot (system package)"]

    key_functions:
      - name: "obtain_certificate"
        line: 67
        purpose: "Obtain Let's Encrypt certificate via ACME HTTP-01"
        parameters:
          - name: "domain"
            type: "string"
          - name: "email"
            type: "string"
        workflow:
          - "Start vless_certbot_nginx container (port 80)"
          - "Run certbot certonly --webroot -d <domain> -m <email>"
          - "Wait for ACME challenge completion"
          - "Stop vless_certbot_nginx container"
          - "Combine fullchain + privkey → combined.pem"
        outputs:
          - "/etc/letsencrypt/live/<domain>/fullchain.pem"
          - "/etc/letsencrypt/live/<domain>/privkey.pem"
          - "/etc/letsencrypt/live/<domain>/combined.pem"
        duration: "~30-60 seconds"

      - name: "renew_certificate"
        line: 345
        purpose: "Renew certificate (automated via cron)"
        command: "certbot renew --quiet --post-hook 'reload_haproxy && reload_nginx'"
        frequency: "Every 12 hours (cron)"
        renewal_threshold: "30 days before expiration"

      - name: "combine_certificate"
        line: 456
        purpose: "Combine fullchain + privkey for HAProxy"
        command: "cat fullchain.pem privkey.pem > combined.pem"
        chmod: "600 (secure permissions)"

  - name: "docker_compose_generator.sh"
    path: "/opt/vless/lib/docker_compose_generator.sh"
    lines: 1234
    purpose: "Generate docker-compose.yml from installation parameters"
    criticality: "CRITICAL"
    dependencies: []

    key_functions:
      - name: "generate_docker_compose"
        line: 45
        purpose: "Generate complete docker-compose.yml"
        reads:
          - "Installation parameters (DOMAIN, EMAIL, etc.)"
        writes: "/opt/vless/docker-compose.yml"
        sections:
          - "version: '3.8'"
          - "services: (6 containers)"
          - "networks: (vless_reality_net)"
          - "volumes: (bind mounts)"
        validation: "docker-compose config (validate syntax)"

  - name: "security_hardening.sh"
    path: "/opt/vless/lib/security_hardening.sh"
    lines: 567
    purpose: "System security hardening (UFW, fail2ban, permissions)"
    criticality: "HIGH"
    dependencies: ["ufw", "fail2ban"]

    key_functions:
      - name: "configure_ufw"
        line: 34
        purpose: "Configure UFW firewall rules"
        rules:
          - "ufw allow 22/tcp (SSH)"
          - "ufw allow 443/tcp (HTTPS/TLS)"
          - "ufw allow 1080/tcp (SOCKS5)"
          - "ufw allow 8118/tcp (HTTP proxy)"
          - "ufw allow 8443/tcp (MTProxy, v6.0+)"
          - "ufw enable"

      - name: "configure_fail2ban"
        line: 156
        purpose: "Configure fail2ban jails"
        jails:
          - "sshd (SSH brute-force protection)"
          - "haproxy (HTTP flood protection)"

      - name: "set_file_permissions"
        line: 267
        purpose: "Set secure file permissions"
        operations:
          - "chmod 600 /opt/vless/data/users.json"
          - "chmod 600 /opt/vless/config/external_proxy.json"
          - "chmod 644 /opt/vless/config/xray_config.json"
          - "chmod 644 /opt/vless/config/haproxy.cfg"
          - "chown root:root /opt/vless/config/*"

  - name: "interactive_params.sh"
    path: "/opt/vless/lib/interactive_params.sh"
    lines: 789
    purpose: "Interactive parameter collection during installation"
    criticality: "HIGH"
    dependencies: []

    key_functions:
      - name: "collect_installation_params"
        line: 45
        purpose: "Interactive wizard to collect installation parameters"
        prompts:
          - prompt: "Domain name"
            validation: "Valid FQDN"
            example: "vpn.example.com"
          - prompt: "Email address (for Let's Encrypt)"
            validation: "Valid email format"
          - prompt: "DNS server"
            default: "8.8.8.8"
          - prompt: "Install MTProxy? (v6.0+)"
            default: "no"
            feature_version: "v6.0+"
        outputs:
          - "DOMAIN"
          - "EMAIL"
          - "DNS"
          - "INSTALL_MTPROXY"

  - name: "dependencies.sh"
    path: "/opt/vless/lib/dependencies.sh"
    lines: 456
    purpose: "System dependency installation and validation"
    criticality: "CRITICAL"
    dependencies: []

    key_functions:
      - name: "install_system_dependencies"
        line: 34
        purpose: "Install all required system packages"
        packages:
          ubuntu_debian:
            - "docker.io"
            - "docker-compose"
            - "jq"
            - "qrencode"
            - "certbot"
            - "ufw"
            - "fail2ban"
            - "curl"
            - "wget"
        commands:
          - "apt-get update"
          - "apt-get install -y <packages>"
        validation: "Check each package installed successfully"

  - name: "status_monitor.sh"
    path: "/opt/vless/lib/status_monitor.sh"
    lines: 678
    purpose: "System status monitoring and reporting"
    criticality: "MEDIUM"
    dependencies: []

    key_functions:
      - name: "cmd_status"
        line: 45
        purpose: "Display comprehensive system status"
        checks:
          - "Docker containers (docker ps)"
          - "Certificate expiration (openssl x509 -enddate)"
          - "HAProxy stats (http://127.0.0.1:9000/stats)"
          - "Xray health (docker exec vless_xray xray version)"
          - "Reverse proxy domains (ls /opt/vless/config/reverse-proxy/)"
        output: "Formatted status report with ✓/✗ indicators"

  - name: "log_viewer.sh"
    path: "/opt/vless/lib/log_viewer.sh"
    lines: 234
    purpose: "Unified log viewing interface"
    criticality: "LOW"
    dependencies: []

    key_functions:
      - name: "cmd_logs"
        line: 23
        purpose: "Display logs for specified service"
        parameters:
          - name: "service"
            values: ["xray", "haproxy", "nginx", "fake-site", "certbot", "all"]
          - name: "tail"
            type: "integer"
            default: 50
          - name: "follow"
            type: "boolean"
            default: false
        command: "docker logs <container> --tail <N> [--follow]"

  - name: "security_tests.sh"
    path: "/opt/vless/lib/security_tests.sh"
    lines: 892
    purpose: "Comprehensive security test suite (v5.22+)"
    criticality: "MEDIUM"
    feature_version: "v5.22+"
    dependencies: []

    key_functions:
      - name: "run_security_tests"
        line: 45
        purpose: "Execute complete security test suite"
        tests:
          - category: "Configuration Security"
            checks:
              - "File permissions (600 for sensitive files)"
              - "No world-readable secrets"
              - "TLS certificate validity"
          - category: "Network Security"
            checks:
              - "Only required ports open"
              - "Port 9000 localhost-only"
              - "UFW firewall active"
          - category: "Container Security"
            checks:
              - "Minimal privileges"
              - "No unnecessary capabilities"
              - "Health checks active"
          - category: "Protocol Security (not --quick)"
            checks:
              - "Reality protocol DPI resistance"
              - "TLS 1.3 enforcement"
              - "Strong cipher suites"
          - category: "Authentication Security"
            checks:
              - "UUID uniqueness"
              - "No default/weak credentials"
              - "Password entropy check"

  - name: "mtproxy_manager.sh"
    path: "/opt/vless/lib/mtproxy_manager.sh"
    lines: 1134
    purpose: "MTProxy server management (v6.0+ planned)"
    criticality: "HIGH"
    feature_version: "v6.0+ (planned)"
    implementation_status: "PLANNED (not yet implemented)"
    dependencies: ["mtproxy_secret_manager.sh"]

    key_functions:
      - name: "generate_mtproxy_config"
        line: 45
        purpose: "Generate MTProxy configuration file"
        writes: "/opt/vless/config/mtproxy/mtproxy_config.json"
        structure:
          port: 8443
          workers: 2
          stats_port: 8443
          stats_path: "/stats"
          secrets_file: "/etc/mtproxy/proxy-secret"
          multi_conf_file: "/etc/mtproxy/proxy-multi.conf"

      - name: "add_mtproxy_user"
        line: 234
        purpose: "Add user with unique MTProxy secret (v6.1+)"
        feature_version: "v6.1+"
        parameters:
          - name: "username"
            type: "string"
          - name: "fake_tls"
            type: "boolean"
            default: false
        workflow:
          - "Validate user exists"
          - "Generate unique 40-char secret (dd or ee prefix)"
          - "Add to users.json: users[].mtproxy_secret"
          - "Append to proxy-secret file"
          - "Restart MTProxy container"
          - "Generate client config"

      - name: "get_mtproxy_stats"
        line: 456
        purpose: "Fetch MTProxy statistics"
        source: "http://localhost:8443/stats"
        output:
          - "Active connections"
          - "Total connections"
          - "Traffic (inbound/outbound)"
          - "Uptime"

  - name: "mtproxy_secret_manager.sh"
    path: "/opt/vless/lib/mtproxy_secret_manager.sh"
    lines: 567
    purpose: "MTProxy secret generation and management (v6.0+)"
    criticality: "HIGH"
    feature_version: "v6.0+ (planned)"
    implementation_status: "PLANNED"
    dependencies: []

    key_functions:
      - name: "generate_mtproxy_secret"
        line: 34
        purpose: "Generate random MTProxy secret"
        parameters:
          - name: "with_padding"
            type: "boolean"
            default: false
          - name: "fake_tls"
            type: "boolean"
            default: false
        algorithm: "openssl rand -hex 16 (32 hex) or 20 (40 hex for fake-TLS)"
        prefix:
          standard: "dd"
          fake_tls: "ee"
        output: "32 or 40 hex characters"

      - name: "list_mtproxy_secrets"
        line: 123
        purpose: "List all secrets from proxy-secret file"
        reads: "/opt/vless/config/mtproxy/proxy-secret"
        format: "One secret per line"

      - name: "remove_mtproxy_secret"
        line: 234
        purpose: "Remove secret from proxy-secret file"
        operations:
          - "Read proxy-secret"
          - "Filter out specified secret"
          - "Atomic write"
          - "Restart MTProxy container"

  - name: "os_detection.sh"
    path: "/opt/vless/lib/os_detection.sh"
    lines: 123
    purpose: "Detect OS version and validate compatibility"
    criticality: "MEDIUM"
    dependencies: []

    key_functions:
      - name: "detect_os"
        line: 12
        purpose: "Detect Ubuntu/Debian version"
        supported:
          - "Ubuntu 20.04+"
          - "Debian 10+"
        method: "Parse /etc/os-release"
        error_if: "Unsupported OS"

  - name: "letsencrypt_integration.sh"
    path: "/opt/vless/lib/letsencrypt_integration.sh"
    lines: 678
    purpose: "Let's Encrypt ACME integration and automation"
    criticality: "CRITICAL"
    dependencies: ["certbot"]

    key_functions:
      - name: "setup_renewal_cron"
        line: 45
        purpose: "Setup automated certificate renewal"
        cron_entry: "0 */12 * * * certbot renew --quiet --post-hook 'reload_haproxy && reload_nginx'"
        frequency: "Every 12 hours"

      - name: "validate_dns_for_domain"
        line: 156
        purpose: "Validate domain DNS points to server IP"
        command: "dig +short <domain> | grep <server_ip>"
        error_if: "DNS mismatch"

# Additional 30 modules documented with less detail (same pattern)

  - name: "client_config_generator.sh"
    path: "/opt/vless/lib/client_config_generator.sh"
    lines: 456
    purpose: "Generate client configuration files (JSON, URI, QR)"
    key_function: "generate_client_configs(username, uuid, domain)"

  - name: "uri_encoder.sh"
    path: "/opt/vless/lib/uri_encoder.sh"
    lines: 234
    purpose: "Generate connection URIs (vless://, socks5s://, https://)"
    key_function: "generate_vless_uri(uuid, domain, public_key, short_id)"

  - name: "validation.sh"
    path: "/opt/vless/lib/validation.sh"
    lines: 345
    purpose: "Input validation functions (username, UUID, domain, email)"
    key_functions: ["validate_username()", "validate_uuid()", "validate_domain()"]

  - name: "error_handling.sh"
    path: "/opt/vless/lib/error_handling.sh"
    lines: 123
    purpose: "Standardized error handling and logging"
    key_functions: ["log_error()", "log_warning()", "log_info()"]

  - name: "atomic_operations.sh"
    path: "/opt/vless/lib/atomic_operations.sh"
    lines: 234
    purpose: "Atomic file operations with locking"
    key_functions: ["atomic_write()", "acquire_lock()", "release_lock()"]

  - name: "container_manager.sh"
    path: "/opt/vless/lib/container_manager.sh"
    lines: 567
    purpose: "Docker container lifecycle management"
    feature_version: "v5.22+"
    key_functions: ["start_containers()", "stop_containers()", "health_check()"]

  - name: "backup_restore.sh"
    path: "/opt/vless/lib/backup_restore.sh"
    lines: 456
    purpose: "Backup and restore critical files"
    key_functions: ["backup_config()", "restore_config()", "backup_users()"]

  - name: "network_utils.sh"
    path: "/opt/vless/lib/network_utils.sh"
    lines: 345
    purpose: "Network utility functions (port check, IP detection)"
    key_functions: ["check_port_available()", "get_server_ip()", "test_connectivity()"]

  - name: "string_utils.sh"
    path: "/opt/vless/lib/string_utils.sh"
    lines: 234
    purpose: "String manipulation utilities"
    key_functions: ["sanitize_domain()", "urlencode()", "base64_encode()"]

  - name: "json_parser.sh"
    path: "/opt/vless/lib/json_parser.sh"
    lines: 456
    purpose: "JSON parsing and manipulation (jq wrapper)"
    key_functions: ["json_get()", "json_set()", "json_delete()"]

  - name: "template_renderer.sh"
    path: "/opt/vless/lib/template_renderer.sh"
    lines: 345
    purpose: "Configuration template rendering"
    key_functions: ["render_template()", "substitute_vars()"]

  - name: "migration_v4_to_v5.sh"
    path: "/opt/vless/lib/migration_v4_to_v5.sh"
    lines: 678
    purpose: "Migration from v4.x to v5.x architecture"
    key_functions: ["migrate_haproxy_config()", "migrate_users_json()"]

  - name: "update_manager.sh"
    path: "/opt/vless/lib/update_manager.sh"
    lines: 567
    purpose: "System update and version management"
    key_functions: ["check_updates()", "apply_updates()", "rollback()"]

  - name: "performance_monitor.sh"
    path: "/opt/vless/lib/performance_monitor.sh"
    lines: 234
    purpose: "Performance monitoring and metrics"
    key_functions: ["get_cpu_usage()", "get_memory_usage()", "get_network_stats()"]

  - name: "cleanup.sh"
    path: "/opt/vless/lib/cleanup.sh"
    lines: 123
    purpose: "Cleanup temporary files and logs"
    key_functions: ["cleanup_temp_files()", "rotate_logs()"]

  - name: "uninstall.sh"
    path: "/opt/vless/lib/uninstall.sh"
    lines: 456
    purpose: "Complete system uninstallation"
    key_functions: ["uninstall_vless()", "remove_containers()", "cleanup_configs()"]

module_dependencies:
  initialization_order:
    - order: 1
      module: "os_detection.sh"
      purpose: "Detect OS before any operations"

    - order: 2
      module: "dependencies.sh"
      purpose: "Install system packages"

    - order: 3
      module: "interactive_params.sh"
      purpose: "Collect installation parameters"

    - order: 4
      module: "certificate_manager.sh"
      purpose: "Validate DNS and obtain certificates"

    - order: 5
      module: "docker_compose_generator.sh"
      purpose: "Generate docker-compose.yml"

    - order: 6
      module: "haproxy_config_manager.sh"
      purpose: "Generate HAProxy config"

    - order: 7
      module: "orchestrator.sh::generate_xray_config"
      purpose: "Generate Xray config"

    - order: 8
      module: "security_hardening.sh"
      purpose: "Configure UFW and fail2ban"

    - order: 9
      module: "container_manager.sh"
      purpose: "Start Docker containers"

    - order: 10
      module: "user_management.sh::add_first_user"
      purpose: "Add first VPN user"

  runtime_dependencies:
    user_management:
      depends_on:
        - "xray_routing_manager.sh"
        - "qr_generator.sh"
        - "client_config_generator.sh"
        - "orchestrator.sh::generate_xray_config"
      trigger: "add-user, remove-user, set-proxy commands"

    external_proxy:
      depends_on:
        - "xray_routing_manager.sh"
        - "orchestrator.sh::generate_xray_config"
      trigger: "vless-external-proxy commands"

    reverse_proxy:
      depends_on:
        - "haproxy_config_manager.sh"
        - "certificate_manager.sh"
      trigger: "vless-proxy commands"

call_chains:
  add_user_flow:
    entry_point: "scripts/vless add-user <username>"
    chain:
      - step: 1
        script: "scripts/vless"
        function: "cmd_add_user()"
      - step: 2
        module: "lib/user_management.sh"
        function: "add_user_to_json()"
        locking: "flock /var/lock/vless_users.lock"
      - step: 3
        module: "lib/orchestrator.sh"
        function: "generate_xray_config()"
        reads: ["users.json", "external_proxy.json"]
        writes: "xray_config.json"
      - step: 4
        module: "lib/orchestrator.sh"
        function: "reload_xray()"
        method: "SIGHUP"
      - step: 5
        module: "lib/qr_generator.sh"
        function: "generate_client_configs()"
        outputs: ["QR codes", "URIs", "configs"]
    duration: "~3-5 seconds"

  set_proxy_flow:
    entry_point: "scripts/vless set-proxy <user> <proxy-id>"
    chain:
      - step: 1
        script: "scripts/vless"
        function: "cmd_set_user_proxy()"
      - step: 2
        module: "lib/user_management.sh"
        function: "update_user_proxy_id()"
        locking: "flock /var/lock/vless_users.lock"
      - step: 3
        module: "lib/xray_routing_manager.sh"
        function: "update_xray_routing_for_user()"
        operation: "Update routing.rules[].user[] array"
      - step: 4
        module: "lib/orchestrator.sh"
        function: "generate_xray_config()"
      - step: 5
        module: "lib/validation.sh"
        function: "validate_xray_config()"
        command: "xray test -c config.json"
      - step: 6
        module: "lib/orchestrator.sh"
        function: "reload_xray()"
    duration: "~2-4 seconds"

  add_reverse_proxy_flow:
    entry_point: "scripts/vless-proxy add"
    chain:
      - step: 1
        script: "scripts/vless-proxy"
        function: "cmd_add_reverse_proxy()"
      - step: 2
        module: "lib/reverseproxy_db.sh"
        function: "add_reverse_proxy_domain()"
        sub_calls:
          - "validate_dns_for_domain()"
          - "allocate_port()"
          - "obtain_certificate()"
          - "generate_nginx_config()"
          - "add_rate_limit_zone()"
          - "add_haproxy_acl_for_domain()"
      - step: 3
        module: "lib/certificate_manager.sh"
        function: "obtain_certificate()"
        duration: "~30-60s"
      - step: 4
        module: "lib/reverseproxy_db.sh"
        function: "add_rate_limit_zone()"
        critical: "Missing zone causes Nginx crash"
      - step: 5
        module: "lib/haproxy_config_manager.sh"
        function: "add_haproxy_acl_for_domain()"
      - step: 6
        module: "lib/haproxy_config_manager.sh"
        function: "reload_haproxy()"
    duration: "~60-90 seconds"

  installation_flow:
    entry_point: "sudo ./install.sh"
    chain:
      - step: 1
        script: "install.sh"
        function: "main()"
      - step: 2
        module: "lib/orchestrator.sh"
        function: "orchestrate_installation()"
        sub_calls:
          - "os_detection.sh::detect_os()"
          - "dependencies.sh::install_system_dependencies()"
          - "interactive_params.sh::collect_installation_params()"
          - "certificate_manager.sh::validate_dns_for_domain()"
          - "certificate_manager.sh::obtain_certificate()"
          - "docker_compose_generator.sh::generate_docker_compose()"
          - "haproxy_config_manager.sh::generate_haproxy_config()"
          - "orchestrator.sh::generate_xray_config()"
          - "security_hardening.sh::configure_ufw()"
          - "security_hardening.sh::configure_fail2ban()"
          - "container_manager.sh::start_containers()"
          - "user_management.sh::add_first_user()"
    duration: "~5-7 minutes"

locking_mechanisms:
  users_json_lock:
    lock_file: "/var/lock/vless_users.lock"
    purpose: "Prevent concurrent modifications to users.json"
    used_by:
      - "add_user_to_json()"
      - "remove_user_from_json()"
      - "update_user_proxy_id()"
    timeout: "10s"
    method: "flock"

  external_proxy_lock:
    lock_file: "/var/lock/vless_external_proxy.lock"
    purpose: "Prevent concurrent modifications to external_proxy.json"
    used_by:
      - "add_proxy_to_json()"
      - "remove_proxy_from_json()"
    timeout: "10s"

  config_generation_lock:
    lock_file: "/var/lock/vless_config_generation.lock"
    purpose: "Prevent concurrent config regeneration"
    used_by:
      - "generate_xray_config()"
      - "generate_haproxy_config()"
    timeout: "30s"
    note: "Longer timeout for config generation operations"

atomic_operations:
  json_file_updates:
    pattern:
      - "Acquire lock (flock)"
      - "Read current file"
      - "Modify in-memory JSON"
      - "Write to temporary file (.tmp)"
      - "Validate JSON syntax (jq)"
      - "Atomic rename (mv .tmp target)"
      - "Release lock"
    files_using_pattern:
      - "/opt/vless/data/users.json"
      - "/opt/vless/config/external_proxy.json"

  config_file_updates:
    pattern:
      - "Generate new config in memory"
      - "Write to temporary file (.tmp)"
      - "Validate syntax (haproxy -c, xray test, nginx -t)"
      - "If valid: atomic rename"
      - "If invalid: abort, log error, keep old config"
    files_using_pattern:
      - "/opt/vless/config/xray_config.json"
      - "/opt/vless/config/haproxy.cfg"
      - "/opt/vless/config/reverse-proxy/*.conf"

error_handling_patterns:
  validation_errors:
    on_error:
      - "Log error to syslog"
      - "Display user-friendly message"
      - "Return non-zero exit code"
      - "Do NOT apply partial changes"
      - "Suggest remediation steps"

  critical_failures:
    on_error:
      - "Log critical error"
      - "Attempt rollback if possible"
      - "Alert user with detailed error"
      - "Exit with failure code"
      - "Preserve system in last known good state"

  warnings:
    on_warning:
      - "Log warning"
      - "Display warning to user"
      - "Ask for confirmation before proceeding"
      - "Allow user to abort or continue"

performance_characteristics:
  config_generation:
    generate_xray_config:
      typical: "~500ms"
      worst_case: "~2s (large users.json, 50+ users)"

    generate_haproxy_config:
      typical: "~300ms"
      worst_case: "~1s (many reverse proxy domains)"

  service_reloads:
    reload_xray:
      method: "SIGHUP"
      downtime: "~0s (graceful)"
      duration: "~1s"

    reload_haproxy:
      method: "haproxy -sf <old_pid>"
      downtime: "~0s (seamless)"
      duration: "~500ms"

    reload_nginx:
      method: "nginx -s reload"
      downtime: "~0s (graceful)"
      duration: "~300ms"

    restart_xray:
      method: "docker restart vless_xray"
      downtime: "~2-5s (connections dropped)"
      duration: "~5s"

testing_coverage:
  unit_tests:
    total: 20
    modules:
      - "validation.sh (5 tests)"
      - "json_parser.sh (3 tests)"
      - "string_utils.sh (4 tests)"
      - "uri_encoder.sh (3 tests)"
      - "atomic_operations.sh (5 tests)"

  integration_tests:
    total: 6
    scenarios:
      - "Docker container lifecycle"
      - "fail2ban jail creation"
      - "UFW rule management"
      - "Certificate renewal"
      - "Config generation pipeline"
      - "User add/remove workflow"

  end_to_end_tests:
    total: 5
    scenarios:
      - "Fresh installation"
      - "Client connection (VLESS, SOCKS5, HTTP)"
      - "Per-user proxy assignment (v5.24+)"
      - "Reverse proxy domain setup"
      - "Certificate renewal automation"

references:
  documentation:
    - "docs/prd/04_architecture.md - Architecture details"
    - "docs/prd/02_functional_requirements.md - Requirements"
    - "docs/architecture/yaml/docker.yaml - Container architecture"
    - "docs/architecture/yaml/config.yaml - Configuration architecture"
    - "docs/architecture/yaml/cli.yaml - CLI documentation"
    - "CLAUDE.md - Project memory"

  code_locations:
    - "lib/ - All library modules (44 modules, ~26,500 lines)"
    - "scripts/ - CLI entry points (vless, vless-external-proxy, vless-proxy)"
    - "install.sh - Installation orchestrator"

notes:
  - "All modules use Bash shell scripting"
  - "Total ~26,500 lines across 44 modules"
  - "Atomic operations and file locking throughout"
  - "Comprehensive error handling and validation"
  - "Modular design for maintainability"
  - "Clear separation of concerns"
  - "Extensive use of helper functions for code reuse"
  - "MTProxy modules (v6.0+) are planned, not yet implemented"
  - "All critical operations use atomic writes"
  - "Graceful reloads preferred over restarts"
