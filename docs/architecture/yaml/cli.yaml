version: "1.0"
documentation_version: "v5.26"
last_updated: "2026-01-07"

project:
  name: "VLESS + Reality VPN - CLI Architecture"
  version: "v5.26"
  description: "Comprehensive documentation of all CLI tools, commands, parameters, and usage patterns"

cli_tools:
  - name: "vless"
    path: "/usr/local/bin/vless"
    symlink_target: "/opt/vless/scripts/vless"
    purpose: "Main CLI interface for VPN user management and system operations"
    installation_method: "Symlink created during install.sh"
    permission_required: "sudo (root access)"

    commands:
      - name: "add-user"
        syntax: "vless add-user <username>"
        description: "Create new VPN user with VLESS, SOCKS5, and HTTP proxy access"
        category: "User Management"

        parameters:
          - name: "username"
            type: "string"
            required: true
            format: "^[a-z][a-z0-9_-]{2,31}$"
            description: "Unique username (3-32 chars, lowercase, alphanumeric + underscore/hyphen)"
            example: "alice"

        implementation:
          module: "lib/user_management.sh"
          function: "cmd_add_user()"
          line_number: "~150"

        workflow:
          - step: "Validate username format and uniqueness"
            validation: "check_username_format(), check_username_exists()"

          - step: "Generate UUID for user"
            generator: "uuidgen"
            purpose: "Unique client ID for VLESS and password for SOCKS5/HTTP"

          - step: "Add user to users.json"
            function: "add_user_to_json()"
            locking: "flock /var/lock/vless_users.lock"
            atomic_write: true

          - step: "Regenerate Xray configuration"
            function: "generate_xray_config()"
            output: "/opt/vless/config/xray_config.json"

          - step: "Reload Xray service"
            function: "reload_xray()"
            method: "SIGHUP signal"
            downtime: "~0s"

          - step: "Generate client configurations"
            function: "generate_client_configs()"
            outputs:
              - "vless_config.json"
              - "vless_link.txt"
              - "vless_qr.png"
              - "socks5_config.txt"
              - "http_config.txt"
              - "qr_codes.html"

          - step: "Display QR codes and connection info"
            output: "Terminal display with QR codes and URIs"

        affected_files:
          - path: "/opt/vless/data/users.json"
            operation: "append user object"
            fields_added:
              - "username"
              - "uuid"
              - "email"
              - "flow"
              - "created_at"
              - "external_proxy_id (null)"

          - path: "/opt/vless/config/xray_config.json"
            operation: "regenerate from users.json"
            sections_updated:
              - "inbounds[vless].settings.clients[]"
              - "inbounds[socks].settings.accounts[]"
              - "inbounds[http].settings.accounts[]"

          - path: "/opt/vless/data/clients/<username>/"
            operation: "create directory with configs"
            files_created: 6

        side_effects:
          - action: "reload_xray()"
            method: "docker exec vless_xray kill -HUP <pid>"
            impact: "User immediately has VPN access"
            downtime: "~0s"

        validation:
          pre_execution:
            - check: "Username format valid"
              error: "Username must be 3-32 chars, lowercase, alphanumeric"

            - check: "Username unique"
              error: "User already exists"

            - check: "users.json exists and readable"
              error: "Cannot access user database"

          post_execution:
            - check: "xray_config.json valid"
              method: "xray test -c config.json"
              error: "Configuration validation failed"

            - check: "Xray reload successful"
              method: "docker ps | grep vless_xray | grep healthy"
              error: "Xray container unhealthy after reload"

        output_format: |
          ✓ User 'alice' created successfully

          VLESS Configuration:
          vless://<uuid>@<domain>:443?encryption=none&security=reality&sni=<domain>&fp=chrome&pbk=<public_key>&sid=<short_id>&type=tcp&flow=xtls-rprx-vision#alice

          SOCKS5 Configuration:
          socks5s://alice:<uuid>@<domain>:1080

          HTTP Proxy Configuration:
          https://alice:<uuid>@<domain>:8118

          Client configs saved to: /opt/vless/data/clients/alice/

        duration: "~3-5 seconds"

        example_usage: |
          sudo vless add-user alice
          sudo vless add-user bob_smith
          sudo vless add-user user123

      - name: "remove-user"
        syntax: "vless remove-user <username>"
        description: "Delete VPN user and revoke all access immediately"
        category: "User Management"

        parameters:
          - name: "username"
            type: "string"
            required: true
            description: "Existing username to delete"
            example: "alice"

        implementation:
          module: "lib/user_management.sh"
          function: "cmd_remove_user()"

        workflow:
          - step: "Confirm user exists"
            validation: "check_user_exists()"

          - step: "Remove user from users.json"
            function: "remove_user_from_json()"
            locking: "flock /var/lock/vless_users.lock"

          - step: "Regenerate Xray configuration"
            function: "generate_xray_config()"

          - step: "Reload Xray service"
            function: "reload_xray()"
            effect: "User access revoked immediately"

          - step: "Delete client configuration directory"
            command: "rm -rf /opt/vless/data/clients/<username>"

        affected_files:
          - path: "/opt/vless/data/users.json"
            operation: "remove user object by username"

          - path: "/opt/vless/config/xray_config.json"
            operation: "regenerate without deleted user"

          - path: "/opt/vless/data/clients/<username>/"
            operation: "delete directory"

        side_effects:
          - action: "reload_xray()"
            impact: "User connections terminated, UUID invalidated"
            downtime: "~0s"

        validation:
          pre_execution:
            - check: "User exists"
              error: "User not found"

            - check: "Not deleting last user"
              error: "Cannot delete last user (keep at least one)"
              note: "Safety check to prevent lockout"

        output_format: |
          ✓ User 'alice' removed successfully
          Access revoked immediately
          Client configs deleted from: /opt/vless/data/clients/alice/

        duration: "~2-3 seconds"

        example_usage: |
          sudo vless remove-user alice
          sudo vless remove-user bob_smith

      - name: "list-users"
        syntax: "vless list-users [--format=table|json]"
        description: "List all VPN users with their status and configuration"
        category: "User Management"

        options:
          - flag: "--format"
            type: "string"
            values: ["table", "json"]
            default: "table"
            description: "Output format (table or JSON)"

        implementation:
          module: "lib/user_management.sh"
          function: "cmd_list_users()"

        workflow:
          - step: "Read users.json"
            source: "/opt/vless/data/users.json"

          - step: "Format output"
            formats:
              table: "Pretty-printed table with columns"
              json: "Raw JSON array of user objects"

        affected_files:
          - path: "/opt/vless/data/users.json"
            operation: "read-only"

        output_format_table: |
          USERNAME    UUID                                  EMAIL               PROXY    CREATED
          alice       a1b2c3d4-e5f6-7890-1234-567890abcdef  alice@vless.local   none     2025-11-23
          bob         b2c3d4e5-f6a7-8901-2345-678901bcdef0  bob@vless.local     proxy-1  2025-11-24

        output_format_json: |
          [
            {
              "username": "alice",
              "uuid": "a1b2c3d4-e5f6-7890-1234-567890abcdef",
              "email": "alice@vless.local",
              "flow": "xtls-rprx-vision",
              "external_proxy_id": null,
              "created_at": "2025-11-23T15:30:45Z"
            }
          ]

        duration: "< 1 second"

        example_usage: |
          sudo vless list-users
          sudo vless list-users --format=json
          sudo vless list-users | grep alice

      - name: "show-user"
        syntax: "vless show-user <username>"
        description: "Display detailed information and client configs for a specific user"
        category: "User Management"

        parameters:
          - name: "username"
            type: "string"
            required: true
            description: "Username to display"

        implementation:
          module: "lib/user_management.sh"
          function: "cmd_show_user()"

        workflow:
          - step: "Validate user exists"
            validation: "check_user_exists()"

          - step: "Read user data from users.json"
            source: "/opt/vless/data/users.json"

          - step: "Read client configs"
            source: "/opt/vless/data/clients/<username>/"

          - step: "Display all information and QR codes"
            output: "Terminal with formatted data and QR codes"

        affected_files:
          - path: "/opt/vless/data/users.json"
            operation: "read-only"

          - path: "/opt/vless/data/clients/<username>/"
            operation: "read configs"

        output_format: |
          User: alice
          UUID: a1b2c3d4-e5f6-7890-1234-567890abcdef
          Email: alice@vless.local
          Flow: xtls-rprx-vision
          External Proxy: none
          Created: 2025-11-23T15:30:45Z

          VLESS Configuration:
          vless://<uuid>@<domain>:443?...
          [QR CODE]

          SOCKS5 Configuration:
          socks5s://alice:<uuid>@<domain>:1080
          [QR CODE]

          HTTP Proxy Configuration:
          https://alice:<uuid>@<domain>:8118
          [QR CODE]

          Config files: /opt/vless/data/clients/alice/

        example_usage: |
          sudo vless show-user alice
          sudo vless show-user bob

      - name: "set-proxy"
        syntax: "vless set-proxy <username> <proxy-id|none>"
        description: "Assign or remove external proxy for specific user (v5.24+ feature)"
        category: "Proxy Assignment"
        feature_version: "v5.24+"

        parameters:
          - name: "username"
            type: "string"
            required: true
            description: "Username to configure"

          - name: "proxy-id"
            type: "string"
            required: true
            values: ["proxy-1", "proxy-2", "...", "none"]
            description: "Proxy ID from external_proxy.json or 'none' to remove"

        implementation:
          module: "lib/user_management.sh"
          function: "cmd_set_user_proxy()"

        workflow:
          - step: "Validate user exists"
            validation: "check_user_exists()"

          - step: "Validate proxy exists (if not 'none')"
            validation: "check_proxy_exists() in external_proxy.json"

          - step: "Update users.json external_proxy_id field"
            function: "update_user_proxy_id()"
            locking: "flock /var/lock/vless_users.lock"

          - step: "Update Xray routing rules"
            function: "update_xray_routing_for_user()"
            module: "lib/xray_routing_manager.sh"
            effect: "Add/remove user from routing.rules[].user[] array"

          - step: "Validate Xray config"
            validation: "xray test -c config.json"

          - step: "Reload Xray"
            function: "reload_xray()"
            method: "SIGHUP"

        affected_files:
          - path: "/opt/vless/data/users.json"
            operation: "update external_proxy_id field"
            before: "external_proxy_id: null"
            after: "external_proxy_id: 'proxy-1'"

          - path: "/opt/vless/config/xray_config.json"
            operation: "update routing.rules[].user[] array"
            section: "routing.rules[0] (external-proxy rule)"

        side_effects:
          - action: "reload_xray()"
            impact: "User traffic now routed via external proxy"
            downtime: "~0s"

        validation:
          pre_execution:
            - check: "User exists"
              error: "User not found"

            - check: "Proxy exists in external_proxy.json (if not 'none')"
              error: "Proxy not found"

            - check: "Proxy is enabled (proxies[].enabled == true)"
              error: "Proxy is disabled"

          post_execution:
            - check: "xray_config.json valid"
              error: "Configuration validation failed"

        output_format: |
          ✓ External proxy 'proxy-1' assigned to user 'alice'
          User traffic will now be routed via: US Proxy 1 (proxy.example.com:1080)
          Xray configuration reloaded successfully

        duration: "~2-4 seconds"

        example_usage: |
          sudo vless set-proxy alice proxy-1
          sudo vless set-proxy bob proxy-2
          sudo vless set-proxy alice none  # Remove proxy

      - name: "show-proxy"
        syntax: "vless show-proxy <username>"
        description: "Show external proxy assignment for specific user"
        category: "Proxy Assignment"
        feature_version: "v5.24+"

        parameters:
          - name: "username"
            type: "string"
            required: true
            description: "Username to check"

        implementation:
          module: "lib/user_management.sh"
          function: "cmd_show_user_proxy()"

        workflow:
          - step: "Read user data from users.json"
            field: "users[].external_proxy_id"

          - step: "If proxy assigned, read proxy details from external_proxy.json"
            conditional: "external_proxy_id != null"

          - step: "Display proxy information"

        affected_files:
          - path: "/opt/vless/data/users.json"
            operation: "read-only"

          - path: "/opt/vless/config/external_proxy.json"
            operation: "read-only (conditional)"

        output_format: |
          User: alice
          External Proxy: proxy-1 (US Proxy 1)
          Protocol: socks5s
          Address: proxy.example.com:1080
          Status: enabled

          Traffic flow: alice → VPN Server → US Proxy 1 → Internet

        output_format_no_proxy: |
          User: alice
          External Proxy: none
          Traffic flow: alice → VPN Server → Internet (direct)

        example_usage: |
          sudo vless show-proxy alice
          sudo vless show-proxy bob

      - name: "list-proxy-assignments"
        syntax: "vless list-proxy-assignments [--proxy-id=<id>]"
        description: "List all users and their external proxy assignments"
        category: "Proxy Assignment"
        feature_version: "v5.24+"

        options:
          - flag: "--proxy-id"
            type: "string"
            optional: true
            description: "Filter by specific proxy ID"
            example: "--proxy-id=proxy-1"

        implementation:
          module: "lib/user_management.sh"
          function: "cmd_list_proxy_assignments()"

        workflow:
          - step: "Read all users from users.json"

          - step: "Filter by proxy-id if specified"
            conditional: "--proxy-id flag present"

          - step: "Lookup proxy details from external_proxy.json"

          - step: "Display table"

        output_format: |
          USERNAME    PROXY       PROXY NAME    PROTOCOL  ADDRESS
          alice       proxy-1     US Proxy 1    socks5s   proxy.example.com:1080
          bob         proxy-2     EU Proxy 1    https     proxy2.example.com:8118
          charlie     none        -             -         -

        output_format_filtered: |
          # With --proxy-id=proxy-1
          USERNAME    PROXY       PROXY NAME    PROTOCOL  ADDRESS
          alice       proxy-1     US Proxy 1    socks5s   proxy.example.com:1080

        example_usage: |
          sudo vless list-proxy-assignments
          sudo vless list-proxy-assignments --proxy-id=proxy-1

      - name: "status"
        syntax: "vless status [--detailed]"
        description: "Show system status (containers, services, certificates)"
        category: "System Management"

        options:
          - flag: "--detailed"
            type: "boolean"
            optional: true
            description: "Show detailed container information"

        implementation:
          module: "lib/status_monitor.sh"
          function: "cmd_status()"

        workflow:
          - step: "Check Docker containers status"
            command: "docker ps -a --filter name=vless_"

          - step: "Check certificate expiration"
            source: "/etc/letsencrypt/live/${DOMAIN}/"
            check: "openssl x509 -enddate -noout -in fullchain.pem"

          - step: "Check HAProxy stats"
            source: "http://127.0.0.1:9000/stats"

          - step: "Check Xray health"
            command: "docker exec vless_xray xray version"

          - step: "Display formatted status"

        affected_files:
          - operation: "read-only system checks"

        output_format: |
          VLESS + Reality VPN Status
          ==========================

          Containers:
          ✓ vless_haproxy       (healthy)
          ✓ vless_xray          (healthy)
          ✓ vless_nginx_reverseproxy (healthy)
          ✓ vless_fake_site     (healthy)
          ⏸ vless_certbot_nginx (stopped, normal)

          Certificates:
          ✓ example.com         (expires: 2026-03-15, 68 days remaining)
          ✓ claude.example.com  (expires: 2026-03-20, 73 days remaining)

          Services:
          ✓ VLESS Reality       (port 443)
          ✓ SOCKS5 TLS          (port 1080)
          ✓ HTTP Proxy TLS      (port 8118)
          ✓ HAProxy Stats       (port 9000, localhost only)

          Reverse Proxy Domains:
          ✓ claude.example.com  → https://claude.ai

        example_usage: |
          sudo vless status
          sudo vless status --detailed

      - name: "logs"
        syntax: "vless logs <service> [--tail=N] [--follow]"
        description: "Show logs for specific service"
        category: "System Management"

        parameters:
          - name: "service"
            type: "string"
            required: true
            values: ["xray", "haproxy", "nginx", "fake-site", "certbot", "all"]
            description: "Service to show logs for"

        options:
          - flag: "--tail"
            type: "integer"
            default: 50
            description: "Number of lines to show"

          - flag: "--follow"
            type: "boolean"
            description: "Follow log output (like tail -f)"

        implementation:
          module: "lib/log_viewer.sh"
          function: "cmd_logs()"

        workflow:
          - step: "Map service name to container"
            mapping:
              xray: "vless_xray"
              haproxy: "vless_haproxy"
              nginx: "vless_nginx_reverseproxy"
              fake-site: "vless_fake_site"
              certbot: "vless_certbot_nginx"

          - step: "Execute docker logs command"
            command: "docker logs <container> --tail <N> [--follow]"

        example_usage: |
          sudo vless logs xray
          sudo vless logs haproxy --tail=100
          sudo vless logs xray --follow
          sudo vless logs all --tail=20

      - name: "test-security"
        syntax: "vless test-security [--quick]"
        description: "Run comprehensive security test suite"
        category: "Security & Testing"
        feature_version: "v5.22+"

        options:
          - flag: "--quick"
            type: "boolean"
            description: "Skip long-running tests (DPI, nmap)"

        implementation:
          module: "lib/security_tests.sh"
          function: "run_security_tests()"

        workflow:
          - step: "Test 1: Configuration Security"
            checks:
              - "File permissions (600 for sensitive files)"
              - "No world-readable secrets"
              - "TLS certificate validity"

          - step: "Test 2: Network Security"
            checks:
              - "Only required ports open (443, 1080, 8118)"
              - "Port 9000 localhost-only"
              - "UFW firewall active"

          - step: "Test 3: Container Security"
            checks:
              - "Containers running with minimal privileges"
              - "No unnecessary capabilities"
              - "Health checks active"

          - step: "Test 4: Protocol Security (if not --quick)"
            checks:
              - "Reality protocol DPI resistance"
              - "TLS 1.3 enforcement"
              - "Strong cipher suites"

          - step: "Test 5: Authentication Security"
            checks:
              - "UUID uniqueness"
              - "No default/weak credentials"
              - "Password entropy check"

        output_format: |
          VLESS Security Test Suite
          ==========================

          [✓] Configuration Security       (5/5 checks passed)
          [✓] Network Security             (4/4 checks passed)
          [✓] Container Security           (3/3 checks passed)
          [~] Protocol Security            (SKIPPED - use without --quick)
          [✓] Authentication Security      (3/3 checks passed)

          Overall: 15/15 checks passed (100%)
          Security Status: EXCELLENT

        duration: "~5-10 seconds (--quick) or ~30-60 seconds (full)"

        example_usage: |
          sudo vless test-security
          sudo vless test-security --quick

  - name: "vless-external-proxy"
    path: "/usr/local/bin/vless-external-proxy"
    symlink_target: "/opt/vless/scripts/vless-external-proxy"
    purpose: "External upstream proxy management (v5.24+ feature)"
    feature_version: "v5.24+"
    permission_required: "sudo (root access)"

    commands:
      - name: "add"
        syntax: "vless-external-proxy add"
        description: "Interactive wizard to add new external upstream proxy"
        category: "Proxy Management"

        implementation:
          module: "lib/external_proxy_manager.sh"
          function: "cmd_add_external_proxy()"

        workflow:
          - step: "Prompt for proxy details"
            inputs:
              - prompt: "Proxy name (human-readable)"
                example: "US Proxy 1"
                validation: "Non-empty string"

              - prompt: "Proxy protocol"
                options: ["socks5", "socks5s", "http", "https"]
                recommendation: "socks5s (SOCKS5 over TLS)"

              - prompt: "Proxy address (IP or domain)"
                example: "proxy.example.com"
                validation: "Valid hostname or IP"

              - prompt: "Proxy port"
                example: "1080"
                validation: "1-65535"

              - prompt: "Authentication username"
                example: "user123"

              - prompt: "Authentication password"
                input_mode: "hidden"

          - step: "Test proxy connectivity"
            test: "curl --proxy <protocol>://<user>:<pass>@<address>:<port> https://www.google.com"
            timeout: "10s"
            on_failure: "Ask user to retry or skip test"

          - step: "Generate proxy ID"
            format: "proxy-<N> (auto-increment from existing proxies)"

          - step: "Add to external_proxy.json"
            function: "add_proxy_to_json()"
            locking: "flock /var/lock/vless_external_proxy.lock"

          - step: "Regenerate Xray config"
            function: "generate_xray_config()"

          - step: "Restart Xray container"
            reason: "Outbound changes require full restart"
            command: "docker restart vless_xray"
            downtime: "~2-5s"

        affected_files:
          - path: "/opt/vless/config/external_proxy.json"
            operation: "append proxy object"
            fields_added:
              - "id (proxy-N)"
              - "name"
              - "protocol"
              - "address"
              - "port"
              - "username"
              - "password"
              - "enabled (true)"
              - "created_at"

          - path: "/opt/vless/config/xray_config.json"
            operation: "update outbounds[external-proxy]"

        side_effects:
          - action: "docker restart vless_xray"
            impact: "Brief VPN interruption (~2-5s)"
            note: "Existing connections dropped, users reconnect automatically"

        validation:
          connectivity_test:
            command: "curl --proxy ... https://www.google.com"
            success_criteria: "HTTP 200 response"
            on_failure: "Warning, user can skip"

        output_format: |
          Adding external proxy...

          Name: US Proxy 1
          Protocol: socks5s
          Address: proxy.example.com:1080
          Username: user123

          Testing connectivity... ✓ Success

          Proxy added successfully as 'proxy-1'
          Xray configuration updated
          Xray container restarted

          You can now assign this proxy to users with:
          sudo vless set-proxy <username> proxy-1

        duration: "~10-20 seconds (with connectivity test)"

        example_usage: |
          sudo vless-external-proxy add

      - name: "list"
        syntax: "vless-external-proxy list [--format=table|json]"
        description: "List all configured external proxies"
        category: "Proxy Management"

        options:
          - flag: "--format"
            type: "string"
            values: ["table", "json"]
            default: "table"

        implementation:
          module: "lib/external_proxy_manager.sh"
          function: "cmd_list_external_proxies()"

        workflow:
          - step: "Read external_proxy.json"
            source: "/opt/vless/config/external_proxy.json"

          - step: "Count users assigned to each proxy"
            source: "/opt/vless/data/users.json"
            field: "users[].external_proxy_id"

          - step: "Format output"

        output_format_table: |
          ID       NAME          PROTOCOL  ADDRESS                   STATUS   USERS
          proxy-1  US Proxy 1    socks5s   proxy.example.com:1080    enabled  2
          proxy-2  EU Proxy 1    https     proxy2.example.com:8118   enabled  1
          proxy-3  Test Proxy    socks5    test.proxy.com:1080       disabled 0

        example_usage: |
          sudo vless-external-proxy list
          sudo vless-external-proxy list --format=json

      - name: "remove"
        syntax: "vless-external-proxy remove <proxy-id>"
        description: "Remove external proxy (only if no users assigned)"
        category: "Proxy Management"

        parameters:
          - name: "proxy-id"
            type: "string"
            required: true
            example: "proxy-1"

        implementation:
          module: "lib/external_proxy_manager.sh"
          function: "cmd_remove_external_proxy()"

        workflow:
          - step: "Check if any users assigned to this proxy"
            validation: "count users where external_proxy_id == <proxy-id>"
            error_if: "count > 0"

          - step: "Remove from external_proxy.json"
            function: "remove_proxy_from_json()"

          - step: "Regenerate Xray config"

          - step: "Restart Xray container"

        validation:
          pre_execution:
            - check: "Proxy exists"
              error: "Proxy not found"

            - check: "No users assigned"
              error: "Cannot remove proxy with assigned users. First run: vless set-proxy <user> none"

        output_format: |
          ✓ External proxy 'proxy-1' removed successfully
          Xray configuration updated
          Xray container restarted

        example_usage: |
          sudo vless-external-proxy remove proxy-1

      - name: "enable"
        syntax: "vless-external-proxy enable <proxy-id>"
        description: "Enable previously disabled proxy"
        category: "Proxy Management"

        parameters:
          - name: "proxy-id"
            type: "string"
            required: true

        implementation:
          module: "lib/external_proxy_manager.sh"
          function: "cmd_toggle_external_proxy()"

        workflow:
          - step: "Update external_proxy.json"
            field: "proxies[id].enabled = true"

          - step: "Regenerate Xray config"

          - step: "Restart Xray container"

        output_format: |
          ✓ Proxy 'proxy-1' enabled
          Users assigned to this proxy can now route traffic through it

        example_usage: |
          sudo vless-external-proxy enable proxy-1

      - name: "disable"
        syntax: "vless-external-proxy disable <proxy-id>"
        description: "Disable proxy (users will use direct connection)"
        category: "Proxy Management"

        parameters:
          - name: "proxy-id"
            type: "string"
            required: true

        implementation:
          module: "lib/external_proxy_manager.sh"
          function: "cmd_toggle_external_proxy()"

        workflow:
          - step: "Update external_proxy.json"
            field: "proxies[id].enabled = false"

          - step: "Regenerate Xray config"

          - step: "Restart Xray container"
            effect: "Users assigned to this proxy will now use direct connection"

        output_format: |
          ✓ Proxy 'proxy-1' disabled
          Users assigned to this proxy will now use direct connection

          To re-enable: sudo vless-external-proxy enable proxy-1

        example_usage: |
          sudo vless-external-proxy disable proxy-1

      - name: "test"
        syntax: "vless-external-proxy test <proxy-id>"
        description: "Test connectivity to external proxy"
        category: "Proxy Management"

        parameters:
          - name: "proxy-id"
            type: "string"
            required: true

        implementation:
          module: "lib/external_proxy_manager.sh"
          function: "cmd_test_external_proxy()"

        workflow:
          - step: "Read proxy details from external_proxy.json"

          - step: "Test connectivity"
            tests:
              - test: "HTTP test"
                command: "curl --proxy ... http://www.google.com"
                timeout: "10s"

              - test: "HTTPS test"
                command: "curl --proxy ... https://www.anthropic.com"
                timeout: "10s"

          - step: "Measure latency"
            command: "time curl --proxy ... https://www.google.com > /dev/null"

          - step: "Display results"

        output_format: |
          Testing proxy 'proxy-1' (US Proxy 1)...

          ✓ HTTP connectivity  (200 OK)
          ✓ HTTPS connectivity (200 OK)
          ✓ Latency: 85ms

          Proxy is working correctly

        example_usage: |
          sudo vless-external-proxy test proxy-1

      - name: "status"
        syntax: "vless-external-proxy status"
        description: "Show overview of all proxies and their usage"
        category: "Proxy Management"

        implementation:
          module: "lib/external_proxy_manager.sh"
          function: "cmd_external_proxy_status()"

        workflow:
          - step: "Read all proxies from external_proxy.json"

          - step: "Count users per proxy"

          - step: "Test connectivity for enabled proxies"
            optional: "Can be skipped with --no-test flag"

          - step: "Display summary"

        output_format: |
          External Proxy Status
          =====================

          Total Proxies: 3
          Enabled: 2
          Disabled: 1

          Active Assignments:
          - proxy-1: 2 users
          - proxy-2: 1 user

          Connectivity Tests:
          ✓ proxy-1 (US Proxy 1)    - OK (85ms)
          ✓ proxy-2 (EU Proxy 1)    - OK (120ms)
          ⏸ proxy-3 (Test Proxy)    - Disabled

        example_usage: |
          sudo vless-external-proxy status

  - name: "vless-proxy"
    path: "/usr/local/bin/vless-proxy"
    symlink_target: "/opt/vless/scripts/vless-proxy"
    purpose: "Reverse proxy domain management (subdomain-based, no port)"
    feature_version: "v4.3+"
    permission_required: "sudo (root access)"

    commands:
      - name: "add"
        syntax: "vless-proxy add"
        description: "Interactive wizard to add reverse proxy domain"
        category: "Reverse Proxy"

        implementation:
          module: "lib/reverseproxy_db.sh"
          function: "add_reverse_proxy_domain()"

        workflow:
          - step: "Prompt for domain name"
            input: "Subdomain (e.g., claude.example.com)"
            validation:
              - "Valid FQDN format"
              - "Domain not already configured"
              - "DNS points to server IP"

          - step: "Prompt for target URL"
            input: "Target URL (e.g., https://claude.ai)"
            validation:
              - "Valid URL format"
              - "Target reachable (HTTP 200 or 30x)"

          - step: "Prompt for advanced options"
            inputs:
              - option: "Rate limit (requests/second)"
                default: "100"

              - option: "WebSocket support"
                default: "auto-detect"

              - option: "OAuth2 authentication"
                default: "disabled"

              - option: "Content-Security-Policy"
                default: "none"

          - step: "Allocate port from pool"
            pool: "9443-9452 (10 slots)"
            method: "Find first available port"
            error_if: "All slots occupied (max 10 domains)"

          - step: "Obtain Let's Encrypt certificate"
            method: "certbot certonly --webroot"
            challenge: "HTTP-01 via vless_nginx_reverseproxy:80"
            duration: "~30-60 seconds"

          - step: "Generate Nginx config"
            output: "/opt/vless/config/reverse-proxy/<domain>.conf"
            template: "Standard reverse proxy template"

          - step: "Add rate limit zone to http_context.conf"
            format: "limit_req_zone ... zone=reverseproxy_<sanitized_domain>:10m rate=<rate>r/s;"
            critical: "Missing zone causes Nginx crash"

          - step: "Reload Nginx"
            command: "docker exec vless_nginx_reverseproxy nginx -s reload"

          - step: "Generate HAProxy ACL"
            function: "add_haproxy_acl_for_domain()"
            output: "Dynamic section in haproxy.cfg"

          - step: "Reload HAProxy"
            command: "docker exec vless_haproxy haproxy -sf <old_pid>"

        affected_files:
          - path: "/opt/vless/config/reverse-proxy/<domain>.conf"
            operation: "create Nginx server block"

          - path: "/opt/vless/config/reverse-proxy/http_context.conf"
            operation: "append rate limit zone"

          - path: "/opt/vless/config/haproxy.cfg"
            operation: "insert ACL + backend in dynamic section"

          - path: "/etc/letsencrypt/live/<domain>/"
            operation: "obtain certificate via certbot"

        side_effects:
          - action: "nginx reload"
            downtime: "~0s"

          - action: "haproxy reload"
            downtime: "~0s"

        validation:
          pre_execution:
            - check: "Domain DNS validation"
              command: "dig +short <domain> | grep <server_ip>"
              error: "Domain DNS does not point to this server"

            - check: "Port availability"
              error: "Maximum 10 reverse proxy domains reached"

          during_execution:
            - check: "Target reachability"
              command: "curl -I <target_url>"
              warning: "Target may be unreachable"

          post_execution:
            - check: "Certificate obtained"
              path: "/etc/letsencrypt/live/<domain>/fullchain.pem"

            - check: "Nginx config valid"
              command: "nginx -t"

            - check: "HAProxy config valid"
              command: "haproxy -c -f haproxy.cfg"

        output_format: |
          Adding reverse proxy domain...

          Domain: claude.example.com
          Target: https://claude.ai
          Port: 9443
          Rate Limit: 100 req/s

          Validating DNS... ✓ OK
          Allocating port... ✓ 9443
          Obtaining SSL certificate... ✓ OK (30s)
          Generating Nginx config... ✓ OK
          Adding rate limit zone... ✓ OK
          Reloading Nginx... ✓ OK
          Updating HAProxy ACL... ✓ OK
          Reloading HAProxy... ✓ OK

          Reverse proxy configured successfully!

          Access your service at: https://claude.example.com
          (No port number needed!)

        duration: "~60-90 seconds (with cert acquisition)"

        example_usage: |
          sudo vless-proxy add

      - name: "remove"
        syntax: "vless-proxy remove <domain>"
        description: "Remove reverse proxy domain configuration"
        category: "Reverse Proxy"

        parameters:
          - name: "domain"
            type: "string"
            required: true
            example: "claude.example.com"

        implementation:
          module: "lib/reverseproxy_db.sh"
          function: "remove_reverse_proxy_domain()"

        workflow:
          - step: "Validate domain exists"

          - step: "Delete Nginx config"
            file: "/opt/vless/config/reverse-proxy/<domain>.conf"

          - step: "Remove rate limit zone from http_context.conf"

          - step: "Reload Nginx"

          - step: "Remove HAProxy ACL and backend"
            function: "remove_haproxy_acl_for_domain()"

          - step: "Reload HAProxy"

          - step: "Free allocated port"
            action: "Port becomes available for new domains"

        affected_files:
          - path: "/opt/vless/config/reverse-proxy/<domain>.conf"
            operation: "delete"

          - path: "/opt/vless/config/reverse-proxy/http_context.conf"
            operation: "remove rate limit zone line"

          - path: "/opt/vless/config/haproxy.cfg"
            operation: "remove ACL + backend from dynamic section"

        output_format: |
          ✓ Reverse proxy for 'claude.example.com' removed successfully
          Port 9443 is now available for new domains

          Note: SSL certificate remains in /etc/letsencrypt/ (manual cleanup if needed)

        example_usage: |
          sudo vless-proxy remove claude.example.com

      - name: "list"
        syntax: "vless-proxy list"
        description: "List all configured reverse proxy domains"
        category: "Reverse Proxy"

        implementation:
          module: "lib/reverseproxy_db.sh"
          function: "list_reverse_proxy_domains()"

        workflow:
          - step: "Read all *.conf files in reverse-proxy/ directory"

          - step: "Extract domain, port, target from each config"

          - step: "Display table"

        output_format: |
          DOMAIN                 PORT   TARGET                  RATE LIMIT
          claude.example.com     9443   https://claude.ai       100 req/s
          github.example.com     9444   https://github.com      200 req/s

          Total: 2/10 slots used

        example_usage: |
          sudo vless-proxy list

      - name: "test"
        syntax: "vless-proxy test <domain>"
        description: "Test reverse proxy domain connectivity"
        category: "Reverse Proxy"

        parameters:
          - name: "domain"
            type: "string"
            required: true

        implementation:
          module: "lib/reverseproxy_db.sh"
          function: "test_reverse_proxy_domain()"

        workflow:
          - step: "Test HTTPS connectivity"
            command: "curl -I https://<domain>"
            expected: "HTTP 200 or 30x"

          - step: "Test SSL certificate"
            command: "openssl s_client -connect <domain>:443 -servername <domain>"
            check: "Certificate valid and matches domain"

          - step: "Test target reachability (from server)"
            command: "curl -I <target_url>"

          - step: "Display results"

        output_format: |
          Testing reverse proxy 'claude.example.com'...

          ✓ HTTPS connectivity    (200 OK)
          ✓ SSL certificate       (valid, expires 2026-03-15)
          ✓ Target reachability   (200 OK)
          ✓ Response time         (250ms)

          Reverse proxy is working correctly

        example_usage: |
          sudo vless-proxy test claude.example.com

  - name: "mtproxy"
    path: "/usr/local/bin/mtproxy"
    symlink_target: "/opt/vless/scripts/mtproxy"
    purpose: "MTProxy Telegram server management (v6.0+ planned)"
    feature_version: "v6.0+ (planned implementation)"
    implementation_status: "PLANNED (not yet implemented)"
    permission_required: "sudo (root access)"

    commands_v6_0:
      - name: "add-secret"
        syntax: "mtproxy add-secret [--with-padding]"
        description: "Generate new MTProxy secret (v6.0 single-user mode)"
        category: "Secret Management"
        feature_version: "v6.0"

        options:
          - flag: "--with-padding"
            type: "boolean"
            description: "Generate secret with random padding (32 hex chars)"

        implementation:
          module: "lib/mtproxy_secret_manager.sh"
          function: "generate_mtproxy_secret()"

        workflow:
          - step: "Generate random 32-byte hex secret"
            method: "openssl rand -hex 16 (32 hex chars)"
            prefix: "dd (standard secret)"

          - step: "Append to proxy-secret file"
            file: "/opt/vless/config/mtproxy/proxy-secret"
            format: "One secret per line"

          - step: "Restart MTProxy container"
            command: "docker restart vless_mtproxy"
            downtime: "~2-5s"
            reason: "MTProxy requires restart to load new secrets"

          - step: "Generate client config"
            output: "Deep link + QR code"

        affected_files:
          - path: "/opt/vless/config/mtproxy/proxy-secret"
            operation: "append secret"

        output_format: |
          ✓ MTProxy secret generated successfully

          Secret: dd1234567890abcdef1234567890abcdef

          Client Configuration:
          tg://proxy?server=<ip>&port=8443&secret=dd1234567890abcdef1234567890abcdef

          [QR CODE]

          MTProxy container restarted

        example_usage: |
          sudo mtproxy add-secret
          sudo mtproxy add-secret --with-padding

      - name: "list-secrets"
        syntax: "mtproxy list-secrets"
        description: "List all MTProxy secrets (v6.0)"
        category: "Secret Management"
        feature_version: "v6.0"

        implementation:
          module: "lib/mtproxy_secret_manager.sh"
          function: "list_mtproxy_secrets()"

        output_format: |
          MTProxy Secrets:
          1. dd1234567890abcdef1234567890abcdef
          2. dd2345678901bcdef2345678901abcdef

          Total: 2 secrets

        example_usage: |
          sudo mtproxy list-secrets

      - name: "remove-secret"
        syntax: "mtproxy remove-secret <secret>"
        description: "Remove MTProxy secret (v6.0)"
        category: "Secret Management"
        feature_version: "v6.0"

        parameters:
          - name: "secret"
            type: "string"
            required: true
            format: "32 hex chars"

        workflow:
          - step: "Remove secret from proxy-secret file"

          - step: "Restart MTProxy container"

        output_format: |
          ✓ Secret removed successfully
          MTProxy container restarted

          Warning: Clients using this secret can no longer connect

        example_usage: |
          sudo mtproxy remove-secret dd1234567890abcdef1234567890abcdef

      - name: "show-config"
        syntax: "mtproxy show-config [<secret>]"
        description: "Show MTProxy client configuration (deep link + QR)"
        category: "Configuration"
        feature_version: "v6.0"

        parameters:
          - name: "secret"
            type: "string"
            optional: true
            description: "Specific secret to show (defaults to first secret)"

        output_format: |
          MTProxy Client Configuration:

          Deep Link:
          tg://proxy?server=<ip>&port=8443&secret=dd1234567890abcdef1234567890abcdef

          [QR CODE]

          Manual Configuration:
          Server: <server_ip>
          Port: 8443
          Secret: dd1234567890abcdef1234567890abcdef

        example_usage: |
          sudo mtproxy show-config
          sudo mtproxy show-config dd1234567890abcdef1234567890abcdef

      - name: "stats"
        syntax: "mtproxy stats [--live]"
        description: "Show MTProxy statistics"
        category: "Monitoring"
        feature_version: "v6.0"

        options:
          - flag: "--live"
            type: "boolean"
            description: "Live stats (refresh every 5s, Ctrl+C to exit)"

        implementation:
          module: "lib/mtproxy_manager.sh"
          function: "get_mtproxy_stats()"

        workflow:
          - step: "Fetch stats from MTProxy endpoint"
            source: "http://localhost:8443/stats"

          - step: "Parse and display"

        output_format: |
          MTProxy Statistics:

          Connections:
            Active: 42
            Total: 1,234

          Traffic:
            Inbound: 1.2 GB
            Outbound: 3.4 GB

          Uptime: 7 days, 3 hours

        example_usage: |
          sudo mtproxy stats
          sudo mtproxy stats --live

    commands_v6_1:
      - name: "add-user"
        syntax: "mtproxy add-user <username> [--fake-tls <domain>]"
        description: "Add user with unique MTProxy secret (v6.1 multi-user)"
        category: "User Management"
        feature_version: "v6.1+ (future enhancement)"

        parameters:
          - name: "username"
            type: "string"
            required: true
            description: "Existing VPN username"

        options:
          - flag: "--fake-tls"
            type: "string"
            description: "Enable fake-TLS for additional stealth (ee prefix)"
            example: "--fake-tls www.microsoft.com"

        implementation:
          module: "lib/mtproxy_manager.sh"
          function: "add_mtproxy_user()"

        workflow:
          - step: "Validate user exists in users.json"

          - step: "Generate unique 40-char MTProxy secret"
            format: "dd<38 hex> or ee<38 hex> (if --fake-tls)"

          - step: "Add to users.json"
            field: "users[].mtproxy_secret"

          - step: "Append to proxy-secret file"

          - step: "Generate client config"
            output: "/opt/vless/data/clients/<username>/mtproxy_config.txt"

          - step: "Restart MTProxy container"

        affected_files:
          - path: "/opt/vless/data/users.json"
            operation: "update mtproxy_secret field"

          - path: "/opt/vless/config/mtproxy/proxy-secret"
            operation: "append secret"

          - path: "/opt/vless/data/clients/<username>/mtproxy_config.txt"
            operation: "create config file"

        output_format: |
          ✓ MTProxy secret assigned to user 'alice'

          Secret: ee1234567890abcdef1234567890abcdef12345678 (fake-TLS enabled)

          Client config saved to:
          /opt/vless/data/clients/alice/mtproxy_config.txt

          Deep Link:
          tg://proxy?server=<ip>&port=8443&secret=ee1234567890abcdef1234567890abcdef12345678

          [QR CODE]

        example_usage: |
          sudo mtproxy add-user alice
          sudo mtproxy add-user bob --fake-tls www.google.com

      - name: "remove-user"
        syntax: "mtproxy remove-user <username>"
        description: "Remove user MTProxy secret (v6.1)"
        category: "User Management"
        feature_version: "v6.1+"

        parameters:
          - name: "username"
            type: "string"
            required: true

        workflow:
          - step: "Read user's mtproxy_secret from users.json"

          - step: "Remove from proxy-secret file"

          - step: "Update users.json (set mtproxy_secret = null)"

          - step: "Delete client config"

          - step: "Restart MTProxy container"

        output_format: |
          ✓ MTProxy secret removed for user 'alice'
          Secret revoked, user can no longer connect via MTProxy
          Client config deleted

        example_usage: |
          sudo mtproxy remove-user alice

      - name: "list-users"
        syntax: "mtproxy list-users"
        description: "List all users with MTProxy secrets (v6.1)"
        category: "User Management"
        feature_version: "v6.1+"

        output_format: |
          USERNAME    SECRET                                      TYPE        CREATED
          alice       ee123...5678 (fake-TLS)                     fake-tls    2025-11-23
          bob         dd234...6789 (standard)                     standard    2025-11-24

          Total: 2 users with MTProxy access

        example_usage: |
          sudo mtproxy list-users

      - name: "show-user-config"
        syntax: "mtproxy show-user-config <username>"
        description: "Show user MTProxy client configuration (v6.1)"
        category: "Configuration"
        feature_version: "v6.1+"

        parameters:
          - name: "username"
            type: "string"
            required: true

        output_format: |
          MTProxy Configuration for 'alice':

          Secret: ee1234567890abcdef1234567890abcdef12345678
          Type: fake-TLS (additional stealth)

          Deep Link:
          tg://proxy?server=<ip>&port=8443&secret=ee1234567890abcdef1234567890abcdef12345678

          [QR CODE]

        example_usage: |
          sudo mtproxy show-user-config alice

      - name: "set-promoted-channel"
        syntax: "mtproxy set-promoted-channel <channel_id>"
        description: "Set promoted Telegram channel (v6.1, requires @MTProxybot)"
        category: "Configuration"
        feature_version: "v6.1+"

        parameters:
          - name: "channel_id"
            type: "string"
            required: true
            description: "Telegram channel ID (from @MTProxybot)"

        note: "Requires registration with @MTProxybot first"

        example_usage: |
          sudo mtproxy set-promoted-channel -1001234567890

    configuration_commands:
      - name: "set-port"
        syntax: "mtproxy set-port <port>"
        description: "Change MTProxy port (default: 8443)"
        category: "Configuration"

        parameters:
          - name: "port"
            type: "integer"
            range: "1-65535"
            note: "Avoid conflict with Xray 8443 (127.0.0.1 binding)"

        example_usage: |
          sudo mtproxy set-port 8444

      - name: "set-workers"
        syntax: "mtproxy set-workers <count>"
        description: "Set number of MTProxy worker processes"
        category: "Configuration"

        parameters:
          - name: "count"
            type: "integer"
            default: 2
            recommended: "2-4 (depends on CPU cores)"

        example_usage: |
          sudo mtproxy set-workers 4

command_groups:
  user_management:
    description: "VPN user lifecycle operations"
    commands:
      - "vless add-user"
      - "vless remove-user"
      - "vless list-users"
      - "vless show-user"

  proxy_assignment:
    description: "Per-user external proxy routing (v5.24+)"
    feature_version: "v5.24+"
    commands:
      - "vless set-proxy"
      - "vless show-proxy"
      - "vless list-proxy-assignments"

  external_proxy_management:
    description: "Upstream proxy server configuration"
    feature_version: "v5.24+"
    commands:
      - "vless-external-proxy add"
      - "vless-external-proxy list"
      - "vless-external-proxy remove"
      - "vless-external-proxy enable"
      - "vless-external-proxy disable"
      - "vless-external-proxy test"
      - "vless-external-proxy status"

  reverse_proxy_management:
    description: "Subdomain-based reverse proxy (no port)"
    feature_version: "v4.3+"
    commands:
      - "vless-proxy add"
      - "vless-proxy remove"
      - "vless-proxy list"
      - "vless-proxy test"

  system_management:
    description: "System status, logs, and monitoring"
    commands:
      - "vless status"
      - "vless logs"

  security_testing:
    description: "Security validation and testing"
    feature_version: "v5.22+"
    commands:
      - "vless test-security"

  mtproxy_management_v6_0:
    description: "MTProxy single-user mode (v6.0 planned)"
    feature_version: "v6.0 (planned)"
    commands:
      - "mtproxy add-secret"
      - "mtproxy list-secrets"
      - "mtproxy remove-secret"
      - "mtproxy regenerate-secret"
      - "mtproxy show-config"
      - "mtproxy stats"

  mtproxy_management_v6_1:
    description: "MTProxy multi-user mode (v6.1 future)"
    feature_version: "v6.1+ (future enhancement)"
    commands:
      - "mtproxy add-user"
      - "mtproxy remove-user"
      - "mtproxy list-users"
      - "mtproxy show-user-config"
      - "mtproxy set-promoted-channel"
      - "mtproxy remove-promoted-channel"

common_patterns:
  atomic_operations:
    description: "All file modifications use atomic writes with file locking"
    implementation:
      - "Acquire lock: flock /var/lock/<resource>.lock"
      - "Read current state"
      - "Modify in-memory"
      - "Write to temporary file"
      - "Validate (JSON syntax, config syntax)"
      - "Atomic rename: mv temp target"
      - "Release lock"

  graceful_reloads:
    description: "Service reloads preserve existing connections"
    methods:
      xray: "kill -HUP <pid> (SIGHUP signal)"
      haproxy: "haproxy -sf <old_pid> (graceful reload)"
      nginx: "nginx -s reload (graceful reload)"
      mtproxy: "docker restart (full restart, ~2-5s downtime)"

  configuration_validation:
    description: "All configs validated before applying"
    validators:
      json: "jq . <file> > /dev/null"
      xray: "xray test -c <config>"
      haproxy: "haproxy -c -f <config>"
      nginx: "nginx -t"

  error_handling:
    description: "Consistent error handling across all commands"
    on_error:
      - "Log error message to syslog"
      - "Display user-friendly error to terminal"
      - "Abort operation (do not apply partial changes)"
      - "Suggest remediation steps"

references:
  implementation:
    - "scripts/vless - Main CLI entry point"
    - "scripts/vless-external-proxy - External proxy CLI"
    - "scripts/vless-proxy - Reverse proxy CLI"
    - "scripts/mtproxy - MTProxy CLI (v6.0+, planned)"
    - "lib/user_management.sh - User operations"
    - "lib/external_proxy_manager.sh - Proxy operations"
    - "lib/reverseproxy_db.sh - Reverse proxy operations"
    - "lib/mtproxy_manager.sh - MTProxy operations (v6.0+)"

  documentation:
    - "docs/prd/02_functional_requirements.md - CLI requirements"
    - "docs/architecture/yaml/config.yaml - Configuration architecture"
    - "docs/architecture/yaml/data-flows.yaml - Data flow patterns"
    - "CLAUDE.md - Project memory and quick reference"

notes:
  - "All CLI tools require sudo (root access)"
  - "Symlinks created during installation to /usr/local/bin/"
  - "Interactive wizards for complex operations (add, proxy setup)"
  - "JSON output format available for scripting"
  - "Graceful reloads preferred (zero downtime)"
  - "MTProxy commands are v6.0+ (planned, not yet implemented)"
  - "All operations use atomic writes and validation"
  - "Comprehensive error messages with remediation suggestions"
