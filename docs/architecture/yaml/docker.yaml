version: "1.0"
documentation_version: "v5.26"
last_updated: "2026-01-07"

project:
  name: "familyTraffic VPN"
  version: "v5.26"
  description: "Production-ready VPN with DPI-resistant Reality protocol, dual proxy support, and subdomain-based reverse proxy"
  target_scale: "10-50 concurrent users"
  deployment_platforms:
    - "Ubuntu 20.04+"
    - "Debian 10+"
  technology_stack:
    - "Docker"
    - "Xray-core"
    - "VLESS Protocol"
    - "Reality Protocol"
    - "HAProxy 2.8+"
    - "Nginx"
    - "Certbot (Let's Encrypt)"
    - "MTProxy (v6.0+ planned)"

architecture_overview:
  container_count: 6
  network_mode: "bridge"
  orchestration: "docker-compose"
  installation_path: "/opt/familytraffic/"
  config_path: "/opt/familytraffic/config/"
  data_path: "/opt/familytraffic/data/"
  logs_path: "/opt/familytraffic/logs/"

containers:
  - name: "familytraffic-haproxy"
    image: "haproxy:2.8-alpine"
    purpose: "Unified TLS termination & SNI-based routing for all traffic types"
    architecture_role: "Frontend proxy and traffic router"
    version: "2.8-alpine"
    network_mode: "host"
    restart_policy: "unless-stopped"

    ports:
      - public: 443
        internal: 443
        protocol: "tcp"
        description: "HTTPS/TLS - SNI Router (VLESS Reality + Reverse Proxy)"
        traffic_types:
          - "VLESS Reality (passthrough to Xray:8443)"
          - "Reverse proxy subdomains (to Nginx:9443-9452)"
          - "Unknown SNI (fallback to fake site)"
        tls_handling: "Passthrough for VLESS, termination for reverse proxy"
        binding: "0.0.0.0:443"

      - public: 1080
        internal: 1080
        protocol: "tcp"
        description: "SOCKS5 over TLS - TLS termination proxy"
        traffic_flow: "Client TLS → HAProxy decrypt → Xray plaintext SOCKS5:10800"
        tls_handling: "TLS termination (Let's Encrypt certificate)"
        authentication: "username + password (validated by Xray)"
        binding: "0.0.0.0:1080"

      - public: 8118
        internal: 8118
        protocol: "tcp"
        description: "HTTP proxy over TLS - TLS termination proxy"
        traffic_flow: "Client TLS → HAProxy decrypt → Xray plaintext HTTP:18118"
        tls_handling: "TLS termination (Let's Encrypt certificate)"
        authentication: "username + password (validated by Xray)"
        binding: "0.0.0.0:8118"

      - public: 9000
        internal: 9000
        protocol: "tcp"
        description: "HAProxy stats endpoint (localhost only)"
        access: "localhost only (not exposed to internet)"
        url: "http://127.0.0.1:9000/stats"
        binding: "127.0.0.1:9000"
        authentication: "none (localhost only)"

    volumes:
      - host: "/opt/familytraffic/config/haproxy.cfg"
        container: "/usr/local/etc/haproxy/haproxy.cfg"
        mode: "ro"
        description: "HAProxy main configuration file"
        purpose: "Defines frontends, backends, ACLs, routing rules"
        critical: true

      - host: "/etc/letsencrypt/live/${DOMAIN}/combined.pem"
        container: "/etc/letsencrypt/live/${DOMAIN}/combined.pem"
        mode: "ro"
        description: "Let's Encrypt combined certificate (fullchain + privkey)"
        purpose: "TLS certificate for SOCKS5/HTTP proxy termination"
        critical: true
        auto_renewal: "certbot cron job + HAProxy graceful reload"

      - host: "/opt/familytraffic/logs/haproxy/"
        container: "/var/log/haproxy/"
        mode: "rw"
        description: "HAProxy access and error logs"
        purpose: "Traffic logging, troubleshooting"
        critical: false

    depends_on:
      - "familytraffic"
      - "familytraffic-nginx"
      - "familytraffic-fake-site"

    healthcheck:
      test: "haproxy -c -f /usr/local/etc/haproxy/haproxy.cfg || exit 1"
      interval: "30s"
      timeout: "10s"
      retries: 3
      description: "Validates HAProxy configuration syntax"

    environment:
      - name: "DOMAIN"
        value: "${DOMAIN}"
        description: "Primary domain for TLS certificate path resolution"
        required: true

    configuration:
      config_file: "/opt/familytraffic/config/haproxy.cfg"
      reload_method: "graceful"
      reload_command: "docker exec familytraffic-haproxy haproxy -sf $(docker exec familytraffic-haproxy cat /var/run/haproxy.pid)"
      reload_downtime: "~0s (seamless)"

    frontends:
      - name: "https_sni_router"
        bind: "*:443"
        mode: "tcp"
        purpose: "SNI-based routing without TLS decryption"
        routing_logic:
          static_acls:
            - name: "is_vless"
              condition: "req_ssl_sni -i ${VLESS_DOMAIN}"
              backend: "xray_vless"
              action: "Passthrough to Xray:8443"
          dynamic_acls:
            marker: "# DYNAMIC_REVERSE_PROXY_ROUTES"
            purpose: "Runtime-added reverse proxy subdomains"
            generator: "lib/haproxy_config_manager.sh::add_haproxy_acl_for_domain()"
            example:
              - name: "is_claude"
                condition: "req.ssl_sni -i claude.example.com"
                backend: "nginx_claude"
                action: "Route to Nginx reverse proxy"
          fallback:
            condition: "default"
            backend: "fake_site_fallback"
            action: "Unknown SNI → Fake nginx site"

      - name: "socks5_tls_frontend"
        bind: "*:1080"
        mode: "tcp"
        purpose: "SOCKS5 over TLS termination"
        tls_action: "Decrypt TLS, forward plaintext to Xray:10800"
        backend: "xray_socks5_plaintext"

      - name: "http_tls_frontend"
        bind: "*:8118"
        mode: "tcp"
        purpose: "HTTP proxy over TLS termination"
        tls_action: "Decrypt TLS, forward plaintext to Xray:18118"
        backend: "xray_http_plaintext"

      - name: "stats_frontend"
        bind: "127.0.0.1:9000"
        mode: "http"
        purpose: "HAProxy statistics and monitoring"
        stats_enable: true
        stats_uri: "/stats"
        stats_refresh: "30s"

    backends:
      - name: "xray_vless"
        mode: "tcp"
        target: "127.0.0.1:8443"
        purpose: "VLESS Reality backend (TLS passthrough)"
        connection_type: "direct TCP passthrough"

      - name: "xray_socks5_plaintext"
        mode: "tcp"
        target: "127.0.0.1:10800"
        purpose: "Plaintext SOCKS5 backend (after TLS termination)"
        connection_type: "plaintext TCP"

      - name: "xray_http_plaintext"
        mode: "tcp"
        target: "127.0.0.1:18118"
        purpose: "Plaintext HTTP proxy backend (after TLS termination)"
        connection_type: "plaintext TCP"

      - name: "nginx_*"
        mode: "tcp"
        target_range: "127.0.0.1:9443-9452"
        purpose: "Reverse proxy backends (dynamic, per subdomain)"
        connection_type: "HTTPS (to Nginx reverse proxy)"
        note: "One backend per reverse proxy domain, created dynamically"

      - name: "fake_site_fallback"
        mode: "tcp"
        target: "familytraffic-fake-site:80"
        purpose: "Fallback for unknown SNI"
        connection_type: "HTTP to fake nginx site"

    features:
      - "SNI-based routing without TLS decryption (VLESS Reality)"
      - "TLS termination for SOCKS5 and HTTP proxies"
      - "Dynamic ACL updates for reverse proxy subdomains"
      - "Graceful configuration reloads (zero downtime)"
      - "Connection logging and statistics"
      - "Automatic fallback to fake site for unknown SNI"

    critical_notes:
      - "HAProxy runs in 'host' network mode for direct port binding"
      - "All public ports (443, 1080, 8118) bind to 0.0.0.0"
      - "Stats port 9000 binds to 127.0.0.1 only (localhost access)"
      - "TLS passthrough for VLESS (no decryption, preserves Reality protocol)"
      - "TLS termination for SOCKS5/HTTP (decrypts, forwards plaintext to Xray)"

  - name: "familytraffic"
    image: "teddysun/xray:24.11.30"
    purpose: "VLESS Reality server + SOCKS5/HTTP proxy handler"
    architecture_role: "Core VPN and proxy engine"
    version: "24.11.30"
    network_mode: "host"
    restart_policy: "unless-stopped"

    ports:
      - public: 8443
        internal: 8443
        protocol: "tcp"
        description: "VLESS Reality internal port (Docker network only)"
        traffic_flow: "HAProxy passthrough → Xray VLESS → Reality handshake → UUID validation"
        access: "Docker network only (NOT exposed to host 0.0.0.0)"
        binding: "127.0.0.1:8443"
        note: "Different from MTProxy 8443 - no conflict (different binding interfaces)"

      - public: 10800
        internal: 10800
        protocol: "tcp"
        description: "Plaintext SOCKS5 internal port"
        traffic_flow: "HAProxy decrypted → Xray SOCKS5 authentication → routing"
        access: "Docker network only"
        binding: "127.0.0.1:10800"
        authentication: "username + password (from xray_config.json clients[])"

      - public: 18118
        internal: 18118
        protocol: "tcp"
        description: "Plaintext HTTP proxy internal port"
        traffic_flow: "HAProxy decrypted → Xray HTTP authentication → routing"
        access: "Docker network only"
        binding: "127.0.0.1:18118"
        authentication: "username + password (from xray_config.json clients[])"

    volumes:
      - host: "/opt/familytraffic/config/xray_config.json"
        container: "/etc/xray/config.json"
        mode: "ro"
        description: "Xray-core runtime configuration"
        purpose: "Defines inbounds, outbounds, routing rules, user clients"
        critical: true

      - host: "/opt/familytraffic/data/users.json"
        container: "/opt/familytraffic/data/users.json"
        mode: "ro"
        description: "User database (read by config generators)"
        purpose: "Source of truth for user UUIDs, credentials, proxy assignments"
        critical: true
        note: "Not directly used by Xray, but read during config generation"

      - host: "/opt/familytraffic/config/external_proxy.json"
        container: "/opt/familytraffic/config/external_proxy.json"
        mode: "ro"
        description: "External proxy configuration (v5.24+ per-user proxy)"
        purpose: "Upstream proxy server definitions for routing"
        critical: false
        feature_version: "v5.24+"

      - host: "/opt/familytraffic/logs/xray/"
        container: "/var/log/xray/"
        mode: "rw"
        description: "Xray access and error logs"
        purpose: "Connection logging, debug information"
        critical: false

    depends_on: []

    healthcheck:
      test: "xray version || exit 1"
      interval: "30s"
      timeout: "10s"
      retries: 3
      description: "Validates Xray binary availability"

    configuration:
      config_file: "/opt/familytraffic/config/xray_config.json"
      reload_method: "SIGHUP signal"
      reload_command: "docker exec familytraffic kill -HUP $(docker exec familytraffic pgrep xray)"
      reload_downtime: "~0s (graceful reload)"
      generator_module: "lib/orchestrator.sh::generate_xray_config()"

    inbounds:
      - protocol: "vless"
        port: 8443
        listen: "127.0.0.1"
        purpose: "VLESS Reality protocol handler"
        settings:
          clients:
            source: "/opt/familytraffic/data/users.json"
            mapping: "users[].uuid → clients[].id"
            mapping_script: "lib/orchestrator.sh::generate_xray_config()"
          decryption: "none"
          fallbacks:
            - dest: "familytraffic-fake-site:80"
              xver: 0
              description: "Fallback for invalid UUID or handshake failure"
        streamSettings:
          network: "tcp"
          security: "reality"
          realitySettings:
            show: false
            dest: "www.microsoft.com:443"
            serverNames:
              - "www.microsoft.com"
            privateKey: "${REALITY_PRIVATE_KEY}"
            shortIds:
              - ""
              - "0123456789abcdef"
        sniffing:
          enabled: true
          destOverride:
            - "http"
            - "tls"

      - protocol: "socks"
        port: 10800
        listen: "127.0.0.1"
        purpose: "Plaintext SOCKS5 (after HAProxy TLS termination)"
        settings:
          auth: "password"
          accounts:
            source: "/opt/familytraffic/data/users.json"
            mapping: "users[].username → accounts[].user, users[].uuid → accounts[].pass"
          udp: true
        sniffing:
          enabled: true
          destOverride:
            - "http"
            - "tls"

      - protocol: "http"
        port: 18118
        listen: "127.0.0.1"
        purpose: "Plaintext HTTP proxy (after HAProxy TLS termination)"
        settings:
          auth: "password"
          accounts:
            source: "/opt/familytraffic/data/users.json"
            mapping: "users[].username → accounts[].user, users[].uuid → accounts[].pass"
        sniffing:
          enabled: true
          destOverride:
            - "http"
            - "tls"

    outbounds:
      - tag: "direct"
        protocol: "freedom"
        purpose: "Direct internet access (default)"
        settings:
          domainStrategy: "UseIP"

      - tag: "external-proxy"
        protocol: "socks"
        purpose: "External upstream proxy (v5.24+ per-user routing)"
        settings:
          servers:
            source: "/opt/familytraffic/config/external_proxy.json"
            mapping: "proxies[] → servers[]"
            dynamic: true
        feature_version: "v5.24+"
        note: "Only active if users.json has external_proxy_id assignments"

      - tag: "block"
        protocol: "blackhole"
        purpose: "Block specific traffic (optional)"
        settings:
          response:
            type: "http"

    routing:
      domainStrategy: "IPIfNonMatch"
      rules:
        - type: "field"
          description: "Per-user external proxy routing (v5.24+)"
          condition: "users[].external_proxy_id != null"
          outboundTag: "external-proxy"
          inboundTag:
            - "vless-in"
            - "socks-in"
            - "http-in"
          user:
            source: "users.json"
            field: "users[].email (for VLESS) or users[].username (for SOCKS5/HTTP)"
          generator: "lib/xray_routing_manager.sh::update_xray_routing_for_user()"
          feature_version: "v5.24+"

        - type: "field"
          description: "Default routing to direct internet"
          condition: "default"
          outboundTag: "direct"

    features:
      - "VLESS Reality protocol (TLS 1.3 masquerading)"
      - "DPI-resistant traffic obfuscation"
      - "UUID-based authentication"
      - "Dual proxy support (SOCKS5 + HTTP)"
      - "Per-user external proxy routing (v5.24+)"
      - "Fallback to fake site on authentication failure"
      - "Traffic sniffing and routing optimization"
      - "Graceful configuration reload (SIGHUP)"

    critical_notes:
      - "Xray port 8443 binds to 127.0.0.1 (Docker network), NOT 0.0.0.0"
      - "This avoids conflict with MTProxy 8443 (which binds to 0.0.0.0)"
      - "SOCKS5/HTTP inbounds receive plaintext traffic from HAProxy"
      - "Configuration reload via SIGHUP preserves existing connections"
      - "User routing rules regenerated on every config change (add-user, set-proxy)"

  - name: "familytraffic-nginx"
    image: "nginx:alpine"
    purpose: "Reverse proxy for subdomains (https://domain without port)"
    architecture_role: "Backend reverse proxy handler"
    version: "alpine (latest stable)"
    network_mode: "host"
    restart_policy: "unless-stopped"

    ports:
      - port_range: "9443-9452"
        protocol: "tcp"
        description: "HTTPS backends for reverse proxy subdomains (10 slots)"
        traffic_flow: "HAProxy SNI routing → Nginx HTTPS → Upstream target"
        access: "localhost only (127.0.0.1)"
        binding: "127.0.0.1:9443-9452"
        slots: 10
        allocation: "One port per reverse proxy domain"

      - public: 80
        internal: 80
        protocol: "tcp"
        description: "HTTP-01 ACME challenge endpoint (certbot)"
        purpose: "Let's Encrypt certificate validation for reverse proxy domains"
        access: "Public (0.0.0.0) during cert renewal only"
        binding: "0.0.0.0:80"

    volumes:
      - host: "/opt/familytraffic/config/reverse-proxy/"
        container: "/etc/nginx/conf.d/"
        mode: "ro"
        description: "Nginx reverse proxy configurations (per-domain)"
        purpose: "Each subdomain has its own .conf file"
        critical: true

      - host: "/opt/familytraffic/config/reverse-proxy/http_context.conf"
        container: "/etc/nginx/http_context.conf"
        mode: "ro"
        description: "Nginx HTTP context includes (rate limiting zones)"
        purpose: "Shared rate limit zone definitions for all domains"
        critical: true

      - host: "/etc/letsencrypt/"
        container: "/etc/letsencrypt/"
        mode: "ro"
        description: "Let's Encrypt certificates directory"
        purpose: "SSL certificates for reverse proxy domains"
        critical: true

      - host: "/opt/familytraffic/logs/nginx-reverseproxy/"
        container: "/var/log/nginx/"
        mode: "rw"
        description: "Nginx reverse proxy access and error logs"
        purpose: "Per-domain traffic logging"
        critical: false

    depends_on: []

    healthcheck:
      test: "nginx -t || exit 1"
      interval: "30s"
      timeout: "10s"
      retries: 3
      description: "Validates Nginx configuration syntax"

    configuration:
      config_directory: "/opt/familytraffic/config/reverse-proxy/"
      config_pattern: "<domain>.conf"
      reload_method: "SIGHUP signal"
      reload_command: "docker exec familytraffic-nginx nginx -s reload"
      reload_downtime: "~0s (graceful reload)"
      generator_module: "lib/reverseproxy_db.sh::add_reverse_proxy_domain()"

    per_domain_config:
      example: "claude.example.com.conf"
      structure:
        server_block:
          listen: "9443 ssl http2"
          server_name: "claude.example.com"
          ssl_certificate: "/etc/letsencrypt/live/claude.example.com/fullchain.pem"
          ssl_certificate_key: "/etc/letsencrypt/live/claude.example.com/privkey.pem"
          location_proxy:
            target: "https://claude.ai"
            proxy_headers:
              - "Host: claude.ai"
              - "X-Real-IP: $remote_addr"
              - "X-Forwarded-For: $proxy_add_x_forwarded_for"
              - "X-Forwarded-Proto: https"
          rate_limiting:
            zone: "reverseproxy_claude_example_com"
            rate: "100r/s"
            burst: 20
          advanced_features:
            - "OAuth2 integration (optional)"
            - "WebSocket support (optional)"
            - "Content-Security-Policy headers (optional)"
            - "Custom error pages (optional)"

    http_context_includes:
      file: "http_context.conf"
      purpose: "Rate limit zone definitions for all reverse proxy domains"
      example: |
        limit_req_zone $binary_remote_addr zone=reverseproxy_claude_example_com:10m rate=100r/s;
        limit_req_zone $binary_remote_addr zone=reverseproxy_github_example_com:10m rate=100r/s;
      note: "Must be defined in HTTP context, not server blocks"
      generator: "lib/reverseproxy_db.sh::add_rate_limit_zone()"

    features:
      - "Subdomain-based reverse proxy without port numbers"
      - "Let's Encrypt SSL certificates per domain"
      - "Per-domain rate limiting (configurable)"
      - "WebSocket support (optional per domain)"
      - "OAuth2 integration (optional per domain)"
      - "Custom headers and CSP policies"
      - "Graceful configuration reload"

    critical_notes:
      - "Each reverse proxy domain gets unique port (9443-9452 range)"
      - "Maximum 10 concurrent reverse proxy domains"
      - "Rate limit zones MUST be defined in http_context.conf"
      - "Missing rate limit zone causes Nginx crash loop"
      - "Port 80 only used for ACME HTTP-01 challenges (certbot)"

  - name: "familytraffic-certbot"
    image: "nginx:alpine"
    purpose: "Temporary HTTP server for ACME HTTP-01 certificate challenges"
    architecture_role: "Certificate validation server"
    version: "alpine (latest stable)"
    network_mode: "host"
    restart_policy: "no"

    ports:
      - public: 80
        internal: 80
        protocol: "tcp"
        description: "HTTP-01 ACME challenge endpoint"
        purpose: "Let's Encrypt certificate validation"
        access: "Public (0.0.0.0) during cert acquisition only"
        binding: "0.0.0.0:80"
        usage: "On-demand (started only during certbot run)"

    volumes:
      - host: "/opt/familytraffic/config/certbot_nginx.conf"
        container: "/etc/nginx/nginx.conf"
        mode: "ro"
        description: "Certbot Nginx configuration"
        purpose: "Serves .well-known/acme-challenge/ directory"
        critical: true

      - host: "/var/www/certbot/"
        container: "/var/www/certbot/"
        mode: "ro"
        description: "ACME challenge files directory"
        purpose: "Certbot places challenge files here"
        critical: true

    depends_on: []

    lifecycle:
      startup: "Manual (only during certificate acquisition)"
      shutdown: "Automatic (stopped after cert acquisition)"
      frequency: "Initial installation + renewals (every 60 days)"
      duration: "~30-60 seconds per run"

    configuration:
      config_file: "/opt/familytraffic/config/certbot_nginx.conf"
      purpose: "Simple HTTP server for ACME challenges"
      content: |
        server {
          listen 80;
          server_name _;
          location /.well-known/acme-challenge/ {
            root /var/www/certbot;
          }
        }

    features:
      - "Temporary HTTP server for certificate validation"
      - "No persistence (stopped after cert acquisition)"
      - "Minimal configuration (single purpose)"

    critical_notes:
      - "Only runs during certbot certificate acquisition"
      - "Automatically stopped after successful challenge"
      - "Does NOT conflict with familytraffic-nginx port 80"
      - "Managed by lib/letsencrypt_integration.sh"

  - name: "familytraffic-fake-site"
    image: "nginx:alpine"
    purpose: "Fallback website for unknown SNI or failed authentication"
    architecture_role: "Camouflage layer (anti-detection)"
    version: "alpine (latest stable)"
    network_mode: "bridge"
    restart_policy: "unless-stopped"

    ports:
      - container_port: 80
        protocol: "tcp"
        description: "HTTP fallback site (Docker network only)"
        access: "Docker network only (not exposed to host)"
        traffic_flow: "HAProxy unknown SNI → familytraffic-fake-site:80 OR Xray invalid UUID → familytraffic-fake-site:80"

    volumes:
      - host: "/opt/familytraffic/fake-site/"
        container: "/usr/share/nginx/html/"
        mode: "ro"
        description: "Static HTML files for fake website"
        purpose: "Presents innocuous website to probing/scanning"
        critical: false

      - host: "/opt/familytraffic/config/fake_site_nginx.conf"
        container: "/etc/nginx/nginx.conf"
        mode: "ro"
        description: "Nginx configuration for fake site"
        purpose: "Simple static file serving"
        critical: false

    depends_on: []

    healthcheck:
      test: "wget --spider http://localhost/ || exit 1"
      interval: "30s"
      timeout: "10s"
      retries: 3
      description: "Validates fake site is serving content"

    configuration:
      content_type: "Static HTML website"
      default_content: "Generic corporate/portfolio website"
      customization: "User can replace with custom HTML/CSS/JS"

    fallback_scenarios:
      - trigger: "HAProxy receives unknown SNI"
        action: "Route to familytraffic-fake-site:80"
        purpose: "Hide VPN infrastructure from probing"

      - trigger: "Xray receives invalid UUID or Reality handshake fails"
        action: "Fallback to familytraffic-fake-site:80"
        purpose: "Prevent authentication probing"

      - trigger: "Direct IP access without SNI"
        action: "Route to familytraffic-fake-site:80"
        purpose: "Present innocuous content to scanners"

    features:
      - "Anti-detection camouflage layer"
      - "Serves static HTML content"
      - "No logs retention (privacy)"
      - "Customizable content"

    critical_notes:
      - "Essential for OPSEC - makes server appear as normal website"
      - "Helps prevent VPN detection by GFW/DPI systems"
      - "Content should be believable and non-suspicious"
      - "Only accessible via Docker network (not directly from internet)"

  - name: "familytraffic-mtproxy"
    image: "custom-build"
    dockerfile_path: "./docker/mtproxy/Dockerfile"
    purpose: "Telegram MTProxy server (v6.0+ planned feature)"
    architecture_role: "Telegram-specific proxy"
    version: "v6.0 (planned), v6.1 (future enhancement)"
    network_mode: "host"
    restart_policy: "unless-stopped"
    implementation_status: "PLANNED (not yet implemented)"

    ports:
      - public: 8443
        internal: 8443
        protocol: "tcp"
        description: "MTProxy Telegram traffic (DIFFERENT from Xray 8443)"
        traffic_flow: "Client → MTProxy:8443 → Telegram DCs"
        binding: "0.0.0.0:8443 (public)"
        note: "NO CONFLICT with Xray 8443 - different binding interfaces"
        conflict_resolution:
          xray_binding: "127.0.0.1:8443 (Docker network only)"
          mtproxy_binding: "0.0.0.0:8443 (public)"
          explanation: "Both use port 8443 but different network interfaces"
          docker_compose_xray: |
            expose:
              - "8443"  # Docker network only, NOT 0.0.0.0:8443
          docker_compose_mtproxy: |
            ports:
              - "8443:8443"  # Maps to 0.0.0.0:8443 on host

      - public: 8443
        internal: 8443
        protocol: "http"
        path: "/stats"
        description: "MTProxy statistics endpoint"
        url: "http://localhost:8443/stats"
        access: "localhost only"
        binding: "127.0.0.1:8443"

    volumes:
      - host: "/opt/familytraffic/config/mtproxy/"
        container: "/etc/mtproxy/"
        mode: "ro"
        description: "MTProxy configuration directory"
        files:
          - "mtproxy_config.json"
          - "proxy-secret (v6.0: single secret, v6.1: multi-user secrets)"
          - "proxy-multi.conf (Telegram DC addresses)"
        critical: true

      - host: "/opt/familytraffic/logs/mtproxy/"
        container: "/var/log/mtproxy/"
        mode: "rw"
        description: "MTProxy access and error logs"
        purpose: "Connection logging, statistics"
        critical: false

    depends_on: []

    healthcheck:
      test: "curl http://localhost:8443/stats || exit 1"
      interval: "30s"
      timeout: "10s"
      retries: 3
      description: "Validates MTProxy stats endpoint availability"

    environment:
      - name: "MTPROXY_PORT"
        value: "8443"
        description: "Public port for MTProxy traffic"

      - name: "MTPROXY_WORKERS"
        value: "2"
        description: "Number of worker processes"

      - name: "MTPROXY_SECRET"
        value_source: "/opt/familytraffic/config/mtproxy/proxy-secret"
        description: "MTProxy secret(s) for client authentication"

    configuration:
      config_file: "/opt/familytraffic/config/mtproxy/mtproxy_config.json"
      reload_method: "docker restart"
      reload_command: "docker restart familytraffic-mtproxy"
      reload_downtime: "~2-5 seconds (full restart required)"
      generator_module: "lib/mtproxy_manager.sh::generate_mtproxy_config()"

    features_v6_0:
      - "Single-user mode (basic secret management)"
      - "Transport obfuscation (AES-256-CTR)"
      - "Random padding for packet size masking"
      - "One-tap connection (tg://proxy deep links)"
      - "QR code generation for client configuration"
      - "Basic statistics endpoint (/stats)"
      - "fail2ban integration"
      - "UFW firewall rules"

    features_v6_1:
      - "Multi-user support (up to 50 users)"
      - "Per-user unique secrets"
      - "Fake-TLS support (ee prefix secrets)"
      - "Promoted channel integration (@MTProxybot)"
      - "Advanced analytics (HAProxy logging)"
      - "Per-user secret management CLI"
      - "Graceful secret rotation"

    protocol_constraints:
      - constraint: "HAProxy SNI routing not possible"
        reason: "MTProto does not use SNI"
        workaround: "Direct public port binding (8443)"

      - constraint: "Per-secret statistics not supported"
        reason: "MTProxy only provides server-level stats"
        workaround: "HAProxy logging for per-user analytics (v6.1)"

      - constraint: "Live secret reload impossible"
        reason: "MTProxy requires restart to load new secrets"
        workaround: "Graceful restart with minimal downtime"

      - constraint: "Maximum 50 users recommended"
        reason: "Stability and performance considerations"
        technical_limit: "100 users maximum"

    cli_commands_v6_0:
      - "mtproxy add-secret [--with-padding]"
      - "mtproxy list-secrets"
      - "mtproxy remove-secret <secret>"
      - "mtproxy regenerate-secret <old-secret>"
      - "mtproxy show-config [<secret>]"
      - "mtproxy set-port <port>"
      - "mtproxy set-workers <count>"
      - "mtproxy stats [--live]"

    cli_commands_v6_1:
      - "mtproxy add-user <username> [--fake-tls <domain>]"
      - "mtproxy remove-user <username>"
      - "mtproxy list-users"
      - "mtproxy show-user-config <username>"
      - "mtproxy set-promoted-channel <channel_id>"
      - "mtproxy remove-promoted-channel"

    integration_with_users_json:
      version: "v6.1+"
      field_added: "users[].mtproxy_secret"
      type: "string (40 hex chars)"
      example: "ee1234567890abcdef1234567890abcdef1234567890ab"
      optional: true
      mapping: "users[].mtproxy_secret → /opt/familytraffic/config/mtproxy/proxy-secret"
      trigger: "mtproxy add-user, mtproxy remove-user"

    critical_notes:
      - "MTProxy v6.0 is PLANNED (implementation in progress)"
      - "v6.1 multi-user features are FUTURE ENHANCEMENTS"
      - "Port 8443 binding DIFFERENT from Xray (public vs Docker network)"
      - "No HAProxy integration possible (MTProto doesn't use SNI)"
      - "Secret rotation requires container restart (brief downtime)"
      - "Promoted channels require registration with @MTProxybot"

networks:
  familytraffic_net:
    driver: "bridge"
    subnet: "172.20.0.0/16"
    gateway: "172.20.0.1"
    ipam:
      driver: "default"
      config:
        - subnet: "172.20.0.0/16"
          gateway: "172.20.0.1"
    attachable: false
    internal: false
    enable_ipv6: false

    purpose: "Isolated Docker network for container communication"

    containers_attached:
      - "familytraffic-haproxy (host mode, but communicates with bridge containers)"
      - "familytraffic (host mode, but communicates with bridge containers)"
      - "familytraffic-nginx (host mode, but communicates with bridge containers)"
      - "familytraffic-fake-site (bridge mode)"
      - "familytraffic-mtproxy (host mode, planned)"

    note: "Most containers use 'host' network mode but can still communicate with bridge containers"

volumes:
  letsencrypt_certs:
    driver: "local"
    driver_opts:
      type: "none"
      o: "bind"
      device: "/etc/letsencrypt"
    purpose: "Let's Encrypt SSL certificates storage"
    critical: true
    backup_required: true

  familytraffic_configs:
    driver: "local"
    driver_opts:
      type: "none"
      o: "bind"
      device: "/opt/familytraffic/config"
    purpose: "All service configuration files"
    critical: true
    backup_required: true

  familytraffic_data:
    driver: "local"
    driver_opts:
      type: "none"
      o: "bind"
      device: "/opt/familytraffic/data"
    purpose: "User database and client configurations"
    critical: true
    backup_required: true

  familytraffic_logs:
    driver: "local"
    driver_opts:
      type: "none"
      o: "bind"
      device: "/opt/familytraffic/logs"
    purpose: "Service logs (HAProxy, Xray, Nginx, MTProxy)"
    critical: false
    backup_required: false

deployment_topology:
  host_server:
    os: "Ubuntu 20.04+ or Debian 10+"
    required_ports:
      - "443/tcp (HTTPS/TLS)"
      - "1080/tcp (SOCKS5)"
      - "8118/tcp (HTTP proxy)"
      - "8443/tcp (MTProxy, v6.0+)"

  docker_setup:
    compose_version: "v2+"
    compose_file: "/opt/familytraffic/docker-compose.yml"
    install_command: "sudo ./install.sh"

  network_flow:
    internet: "Internet"
    entry_point: "HAProxy (0.0.0.0:443, 1080, 8118)"
    sni_routing:
      - "VLESS domain → Xray:8443 (passthrough)"
      - "Reverse proxy subdomain → Nginx:9443-9452 (TLS termination)"
      - "Unknown SNI → Fake Site:80 (fallback)"
    tls_termination:
      - "SOCKS5:1080 → HAProxy decrypt → Xray:10800 (plaintext)"
      - "HTTP:8118 → HAProxy decrypt → Xray:18118 (plaintext)"
    proxy_routing:
      - "User without external_proxy_id → Direct to internet"
      - "User with external_proxy_id → External SOCKS5/HTTPS proxy → Internet"
    mtproxy_flow:
      - "Client → MTProxy:8443 (public) → Telegram DCs (v6.0+)"

port_allocation:
  public_ports:
    - port: 443
      service: "HAProxy"
      purpose: "HTTPS/TLS (VLESS + Reverse Proxy)"
      binding: "0.0.0.0"

    - port: 1080
      service: "HAProxy"
      purpose: "SOCKS5 over TLS"
      binding: "0.0.0.0"

    - port: 8118
      service: "HAProxy"
      purpose: "HTTP proxy over TLS"
      binding: "0.0.0.0"

    - port: 8443
      service: "MTProxy"
      purpose: "Telegram MTProxy traffic (v6.0+)"
      binding: "0.0.0.0"
      note: "Different from Xray 8443 (which binds to 127.0.0.1)"

    - port: 80
      service: "Certbot Nginx / Nginx Reverse Proxy"
      purpose: "ACME HTTP-01 challenges"
      binding: "0.0.0.0"
      usage: "On-demand (during cert acquisition/renewal)"

  internal_ports:
    - port: 8443
      service: "Xray"
      purpose: "VLESS Reality (internal)"
      binding: "127.0.0.1"
      access: "Docker network only"

    - port: 10800
      service: "Xray"
      purpose: "Plaintext SOCKS5 (internal)"
      binding: "127.0.0.1"
      access: "Docker network only"

    - port: 18118
      service: "Xray"
      purpose: "Plaintext HTTP proxy (internal)"
      binding: "127.0.0.1"
      access: "Docker network only"

    - port: 9000
      service: "HAProxy"
      purpose: "Stats endpoint"
      binding: "127.0.0.1"
      access: "Localhost only"

    - port_range: "9443-9452"
      service: "Nginx Reverse Proxy"
      purpose: "Reverse proxy backends (10 slots)"
      binding: "127.0.0.1"
      access: "HAProxy only"

critical_relationships:
  haproxy_xray:
    description: "HAProxy routes traffic to Xray based on protocol and SNI"
    connections:
      - "HAProxy:443 (VLESS SNI) → Xray:8443 (passthrough)"
      - "HAProxy:1080 (decrypted SOCKS5) → Xray:10800 (plaintext)"
      - "HAProxy:8118 (decrypted HTTP) → Xray:18118 (plaintext)"

  haproxy_nginx:
    description: "HAProxy routes reverse proxy subdomains to Nginx backends"
    connections:
      - "HAProxy:443 (subdomain SNI) → Nginx:9443-9452 (HTTPS)"
    dynamic: true

  xray_fake_site:
    description: "Xray fallback to fake site on authentication failure"
    connections:
      - "Xray:8443 (invalid UUID) → Fake Site:80 (HTTP)"

  haproxy_fake_site:
    description: "HAProxy fallback to fake site on unknown SNI"
    connections:
      - "HAProxy:443 (unknown SNI) → Fake Site:80 (HTTP)"

  certbot_haproxy:
    description: "Certbot renews certificates, HAProxy reloads gracefully"
    workflow:
      - "Certbot requests cert via ACME HTTP-01"
      - "Certbot Nginx serves challenge on port 80"
      - "Certbot obtains cert → /etc/letsencrypt/"
      - "Certbot combines fullchain + privkey → combined.pem"
      - "HAProxy graceful reload (haproxy -sf <pid>)"
    frequency: "Every 60 days (automated cron job)"

  users_json_xray_config:
    description: "users.json is source of truth, xray_config.json is generated"
    mapping:
      - "users[].uuid → xray_config.json clients[].id"
      - "users[].username → xray_config.json accounts[].user"
      - "users[].external_proxy_id → xray_config.json routing.rules[]"
    trigger: "add-user, remove-user, set-proxy commands"
    propagation: "Xray SIGHUP reload"

  users_json_mtproxy_secrets:
    description: "v6.1: users.json stores per-user MTProxy secrets"
    mapping:
      - "users[].mtproxy_secret → /opt/familytraffic/config/mtproxy/proxy-secret"
    trigger: "mtproxy add-user, mtproxy remove-user (v6.1+)"
    propagation: "MTProxy container restart"
    version: "v6.1+ (future enhancement)"

operational_notes:
  installation:
    method: "Interactive installer (sudo ./install.sh)"
    duration: "< 5 minutes (fresh Ubuntu 22.04)"
    steps:
      - "Detect OS version"
      - "Install dependencies (docker, jq, certbot, etc.)"
      - "Collect installation parameters (domain, email, DNS)"
      - "Validate DNS points to server IP"
      - "Obtain Let's Encrypt certificate"
      - "Generate Docker Compose file"
      - "Generate HAProxy, Xray, Nginx configurations"
      - "Start Docker containers"
      - "Add first user"
      - "Display QR codes and client configs"

  configuration_management:
    source_of_truth: "/opt/familytraffic/data/users.json"
    config_generators:
      - "lib/orchestrator.sh::generate_xray_config()"
      - "lib/haproxy_config_manager.sh::generate_haproxy_config()"
      - "lib/reverseproxy_db.sh::add_reverse_proxy_domain()"
      - "lib/mtproxy_manager.sh::generate_mtproxy_config() (v6.0+)"
    atomic_operations: "flock /var/lock/familytraffic_users.lock"

  zero_downtime_updates:
    haproxy_reload: "haproxy -sf <old_pid> (seamless)"
    xray_reload: "kill -HUP <xray_pid> (graceful)"
    nginx_reload: "nginx -s reload (graceful)"
    mtproxy_reload: "docker restart familytraffic-mtproxy (~2-5s downtime, v6.0+)"

  monitoring:
    haproxy_stats: "http://127.0.0.1:9000/stats"
    xray_logs: "docker logs familytraffic"
    container_health: "docker ps (health status)"
    cli_status: "sudo familytraffic status"

  backup_requirements:
    critical_files:
      - "/opt/familytraffic/data/users.json"
      - "/opt/familytraffic/config/"
      - "/etc/letsencrypt/"
    backup_frequency: "Daily (automated cron job recommended)"
    restore_procedure: "Documented in docs/prd/06_appendix.md"

version_history:
  current_version: "v5.26"
  mtproxy_versions:
    v6_0:
      status: "PLANNED (implementation in progress)"
      features:
        - "MTProxy Docker container"
        - "Single-user mode (basic secret management)"
        - "fail2ban integration"
        - "UFW firewall rules"
        - "Basic statistics endpoint"
        - "CLI commands (add-secret, list-secrets, stats)"
      timeline: "ETA: +6 weeks from approval"

    v6_1:
      status: "FUTURE ENHANCEMENT"
      features:
        - "Multi-user support (up to 50 users)"
        - "Per-user unique secrets"
        - "Fake-TLS support (ee prefix)"
        - "Promoted channel integration"
        - "Advanced analytics (HAProxy logging)"
        - "Per-user secret management"
      timeline: "ETA: +9 weeks from approval"
      dependencies: "Requires v6.0 base implementation"

references:
  documentation:
    - "docs/prd/00_summary.md - Executive summary"
    - "docs/prd/04_architecture.md - Detailed architecture (1524 lines)"
    - "docs/mtproxy/README.md - MTProxy integration plan"
    - "docs/mtproxy/00_mtproxy_integration_plan.md - Base implementation v6.0"
    - "docs/mtproxy/01_advanced_features.md - Advanced features v6.1+"
    - "CHANGELOG.md - Version history"
    - "CLAUDE.md - Project memory"

  official_sources:
    - "Xray-core: https://github.com/XTLS/Xray-core"
    - "VLESS Protocol: https://github.com/XTLS/Xray-core/discussions/716"
    - "Reality Protocol: https://github.com/XTLS/REALITY"
    - "HAProxy: https://www.haproxy.org/"
    - "MTProxy: https://github.com/TelegramMessenger/MTProxy"
    - "MTProto Protocol: https://core.telegram.org/mtproto"
