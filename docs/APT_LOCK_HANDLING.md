# APT Lock Handling - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞–º–∏ –ø–∞–∫–µ—Ç–Ω–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞

## –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ VLESS –≤–∫–ª—é—á–∞–µ—Ç –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ APT/dpkg —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤.

## –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –±–ª–æ–∫–∏—Ä—É—é—â–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤

### üü¢ SAFE (–ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ)

–ü—Ä–æ—Ü–µ—Å—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ –∑–∞–≤–µ—Ä—à–∏—Ç—å –±–µ–∑ —Ä–∏—Å–∫–∞ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã:

- `apt update` / `apt-get update` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ –ø–∞–∫–µ—Ç–æ–≤
- `apt-cache` - –ø–æ–∏—Å–∫ –∏ –ø—Ä–æ—Å–º–æ—Ç—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–∞–∫–µ—Ç–∞—Ö
- `unattended-upgrades` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–µ—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω—ã –º–µ–Ω–µ–µ 5 –º–∏–Ω—É—Ç –Ω–∞–∑–∞–¥)

**–ü—Ä–∏—á–∏–Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:** –≠—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å—ã —Ç–æ–ª—å–∫–æ —á–∏—Ç–∞—é—Ç –¥–∞–Ω–Ω—ã–µ –∏ –Ω–µ –∏–∑–º–µ–Ω—è—é—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã.

### üü° CAUTION (–û—Å—Ç–æ—Ä–æ–∂–Ω–æ - —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)

–ü—Ä–æ—Ü–µ—Å—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –∏–∑–º–µ–Ω—è—Ç—å —Å–∏—Å—Ç–µ–º—É, –Ω–æ –æ–±—ã—á–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω—ã –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:

- `apt install` / `apt-get install` - —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞–∫–µ—Ç–æ–≤ (–º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–∞ —ç—Ç–∞–ø–µ –∑–∞–≥—Ä—É–∑–∫–∏)
- `dpkg --configure -a` - –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ —Å–±–æ—è

**–ü—Ä–∏—á–∏–Ω–∞ –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç–∏:** –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞, –Ω–æ –Ω–µ –ø–æ–≤—Ä–µ–¥–∏—Ç —Å–∏—Å—Ç–µ–º—É.

### üî¥ DANGER (–û–ø–∞—Å–Ω—ã–µ - –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –∑–∞–≤–µ—Ä—à–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)

–ü—Ä–æ—Ü–µ—Å—Å—ã, –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∫–æ—Ç–æ—Ä—ã—Ö –º–æ–∂–µ—Ç –ø–æ–≤—Ä–µ–¥–∏—Ç—å —Å–∏—Å—Ç–µ–º—É:

- `dpkg` —Å —Ñ–ª–∞–≥–∞–º–∏ `--install`, `--unpack`, `--configure`, `--remove`

**–ü—Ä–∏—á–∏–Ω–∞ –æ–ø–∞—Å–Ω–æ—Å—Ç–∏:** –ü—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ –º–æ–∂–µ—Ç –æ—Å—Ç–∞–≤–∏—Ç—å –ø–∞–∫–µ—Ç—ã –≤ –Ω–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏, —Ç—Ä–µ–±—É—é—â–µ–º —Ä—É—á–Ω–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è.

## –†–µ–∂–∏–º—ã —Ä–∞–±–æ—Ç—ã

### 1. –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)

–ü—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ APT –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç—Å—è –≤—ã–±–æ—Ä:

```
APT is locked. Choose an action:
  [w] Wait 30s and retry (attempt 1/5)
  [a] Auto-kill SAFE processes only (recommended)
  [k] Kill ALL blocking processes (CAUTION)
  [c] Cancel installation

Your choice [w/a/k/c] (default=wait, 60s timeout):
```

#### –û–ø—Ü–∏—è [a] - Auto-kill SAFE (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
- –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∫–∞–∂–¥—ã–π –±–ª–æ–∫–∏—Ä—É—é—â–∏–π –ø—Ä–æ—Ü–µ—Å—Å
- –ó–∞–≤–µ—Ä—à–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–æ—Ü–µ—Å—Å—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ SAFE
- –ü—Ä–æ–ø—É—Å–∫–∞–µ—Ç CAUTION –∏ DANGER –ø—Ä–æ—Ü–µ—Å—Å—ã
- –ë–µ–∑–æ–ø–∞—Å–Ω–æ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏

#### –û–ø—Ü–∏—è [k] - Kill ALL (—Ç—Ä–µ–±—É–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è)
- **–í–ù–ò–ú–ê–ù–ò–ï:** –ú–æ–∂–µ—Ç –ø–æ–≤—Ä–µ–¥–∏—Ç—å —Å–∏—Å—Ç–µ–º—É!
- –ó–∞–≤–µ—Ä—à–∞–µ—Ç –í–°–ï –±–ª–æ–∫–∏—Ä—É—é—â–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –≤–∫–ª—é—á–∞—è dpkg
- –¢—Ä–µ–±—É–µ—Ç —è–≤–Ω–æ–≥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è `yes`
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –≤ –∫—Ä–∞–π–Ω–µ–º —Å–ª—É—á–∞–µ

### 2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–∂–∏–º (–¥–ª—è CI/CD –∏ —Å–∫—Ä–∏–ø—Ç–æ–≤)

–ê–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:

```bash
# –ë–∞–∑–æ–≤—ã–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–∂–∏–º
export VLESS_AUTO_INSTALL_DEPS=yes
sudo ./install.sh

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–∂–∏–º —Å –±–µ–∑–æ–ø–∞—Å–Ω—ã–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
export VLESS_AUTO_INSTALL_DEPS=yes
export VLESS_AUTO_KILL_SAFE_LOCKS=yes
sudo ./install.sh
```

**–ü–æ–≤–µ–¥–µ–Ω–∏–µ:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≤–µ—Ä—à–∞–µ—Ç SAFE –ø—Ä–æ—Ü–µ—Å—Å—ã
- –ï—Å–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è CAUTION/DANGER –ø—Ä–æ—Ü–µ—Å—Å—ã - –≤—ã—Ö–æ–¥–∏—Ç —Å –æ—à–∏–±–∫–æ–π
- –ù–µ —Ç—Ä–µ–±—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –≤–≤–æ–¥–∞
- –ú–∞–∫—Å–∏–º—É–º 5 –ø–æ–ø—ã—Ç–æ–∫ —Å retry

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

### VLESS_AUTO_INSTALL_DEPS
- **–¢–∏–ø:** Boolean (yes/no)
- **–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é:** –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ (–∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º)
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü—Ä–æ–ø—É—Å–∫–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

**–ü—Ä–∏–º–µ—Ä:**
```bash
export VLESS_AUTO_INSTALL_DEPS=yes
sudo ./install.sh
```

### VLESS_AUTO_KILL_SAFE_LOCKS
- **–¢–∏–ø:** Boolean (yes/no)
- **–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é:** –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ (—Ç—Ä–µ–±—É–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è)
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≤–µ—Ä—à–∞–µ—Ç SAFE –±–ª–æ–∫–∏—Ä—É—é—â–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã

**–ü—Ä–∏–º–µ—Ä:**
```bash
export VLESS_AUTO_INSTALL_DEPS=yes
export VLESS_AUTO_KILL_SAFE_LOCKS=yes
sudo ./install.sh
```

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü—Ä–∏–º–µ—Ä 1: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞ —á–∏—Å—Ç–æ–º —Å–µ—Ä–≤–µ—Ä–µ (–∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ)

```bash
sudo ./install.sh
```

–ï—Å–ª–∏ APT –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω `unattended-upgrades`:
1. –°–∏—Å—Ç–µ–º–∞ –æ–±–Ω–∞—Ä—É–∂–∏—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫—É
2. –ü–æ–∫–∞–∂–µ—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É —Å –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–µ–π
3. –ü—Ä–µ–¥–ª–æ–∂–∏—Ç –æ–ø—Ü–∏–∏: wait/auto-kill/force-kill/cancel
4. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –≤—ã–±—Ä–∞—Ç—å `[a]` –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ auto-kill

### –ü—Ä–∏–º–µ—Ä 2: –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤ CI/CD

```bash
#!/bin/bash
# deploy.sh

export VLESS_AUTO_INSTALL_DEPS=yes
export VLESS_AUTO_KILL_SAFE_LOCKS=yes

sudo ./install.sh

if [ $? -eq 0 ]; then
    echo "Installation successful"
else
    echo "Installation failed - check for DANGER/CAUTION locks"
    exit 1
fi
```

### –ü—Ä–∏–º–µ—Ä 3: Ansible/Terraform –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

```yaml
# Ansible playbook
- name: Install VLESS with auto-kill
  shell: |
    export VLESS_AUTO_INSTALL_DEPS=yes
    export VLESS_AUTO_KILL_SAFE_LOCKS=yes
    sudo ./install.sh
  args:
    chdir: /path/to/vless
  environment:
    VLESS_AUTO_INSTALL_DEPS: "yes"
    VLESS_AUTO_KILL_SAFE_LOCKS: "yes"
```

### –ü—Ä–∏–º–µ—Ä 4: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –≤—Ä—É—á–Ω—É—é

–ï—Å–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –Ω–µ –ø–æ–º–æ–≥–ª–æ:

```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–ª–æ–∫–∏—Ä—É—é—â–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
ps aux | grep -E 'apt|dpkg'

# 2. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∏–ø –ø—Ä–æ—Ü–µ—Å—Å–∞
ps -p <PID> -o args=

# 3. –ï—Å–ª–∏ —ç—Ç–æ dpkg --configure - –¥–æ–∂–¥–∞—Ç—å—Å—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
# 4. –ï—Å–ª–∏ —ç—Ç–æ dpkg --install - –ù–ï –∑–∞–≤–µ—Ä—à–∞—Ç—å!
# 5. –ï—Å–ª–∏ —ç—Ç–æ apt update - –±–µ–∑–æ–ø–∞—Å–Ω–æ –∑–∞–≤–µ—Ä—à–∏—Ç—å:
sudo kill <PID>

# 6. –û—á–∏—Å—Ç–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ dpkg –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
sudo dpkg --configure -a

# 7. –ü–æ–≤—Ç–æ—Ä–∏—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫—É
sudo ./install.sh
```

## –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### –ü—Ä–æ—Å–º–æ—Ç—Ä —Ç–µ–∫—É—â–∏—Ö –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å lock —Ñ–∞–π–ª—ã
fuser /var/lib/dpkg/lock
fuser /var/lib/apt/lists/lock
fuser /var/cache/apt/archives/lock

# –ü–æ–∫–∞–∑–∞—Ç—å –±–ª–æ–∫–∏—Ä—É—é—â–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã —Å –¥–µ—Ç–∞–ª—è–º–∏
ps aux | grep -E 'apt|dpkg|unattended'

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–æ–∑—Ä–∞—Å—Ç –ø—Ä–æ—Ü–µ—Å—Å–∞
ps -p <PID> -o etime=,cmd=
```

### –õ–æ–≥–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å unattended-upgrades
sudo systemctl status unattended-upgrades

# –õ–æ–≥–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
sudo tail -f /var/log/unattended-upgrades/unattended-upgrades.log
```

### –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ —Å–±–æ—è dpkg

```bash
# –ï—Å–ª–∏ dpkg –æ—Å—Ç–∞–≤–∏–ª —Å–∏—Å—Ç–µ–º—É –≤ –Ω–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏
sudo dpkg --configure -a
sudo apt-get install -f
```

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ß—Ç–æ –ù–ï –¥–µ–ª–∞–µ—Ç —Å–∏—Å—Ç–µ–º–∞:

‚ùå –ù–ï –∑–∞–≤–µ—Ä—à–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å—ã dpkg –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
‚ùå –ù–ï —É–¥–∞–ª—è–µ—Ç lock —Ñ–∞–π–ª—ã –Ω–∞–ø—Ä—è–º—É—é (—Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ kill –ø—Ä–æ—Ü–µ—Å—Å–æ–≤)
‚ùå –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `rm -f /var/lib/dpkg/lock*` (–æ–ø–∞—Å–Ω–æ!)
‚ùå –ù–ï –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç DANGER –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—é

### –ß—Ç–æ –¥–µ–ª–∞–µ—Ç —Å–∏—Å—Ç–µ–º–∞:

‚úÖ –ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å—ã –ø–æ —É—Ä–æ–≤–Ω—é —Ä–∏—Å–∫–∞
‚úÖ –ó–∞–≤–µ—Ä—à–∞–µ—Ç —Ç–æ–ª—å–∫–æ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
‚úÖ –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–ª—è –æ–ø–∞—Å–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
‚úÖ –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ dpkg –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è (`dpkg --configure -a`)
‚úÖ –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É

## –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ —Ç–∏–ø–∏—á–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º

### –ü—Ä–æ–±–ª–µ–º–∞: unattended-upgrades –±–ª–æ–∫–∏—Ä—É–µ—Ç APT

**–†–µ—à–µ–Ω–∏–µ 1 (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏):**
```bash
export VLESS_AUTO_KILL_SAFE_LOCKS=yes
sudo ./install.sh
```

**–†–µ—à–µ–Ω–∏–µ 2 (–≤—Ä—É—á–Ω—É—é):**
```bash
# –î–æ–∂–¥–∞—Ç—å—Å—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
sudo systemctl status unattended-upgrades

# –ò–õ–ò –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–ª—É–∂–±—É
sudo systemctl stop unattended-upgrades
sudo ./install.sh
sudo systemctl start unattended-upgrades
```

### –ü—Ä–æ–±–ª–µ–º–∞: dpkg –±–ª–æ–∫–∏—Ä—É–µ—Ç –ø–æ—Å–ª–µ —Å–±–æ—è

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å—ã dpkg
ps aux | grep dpkg

# –ï—Å–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –Ω–µ—Ç, –Ω–æ lock –µ—Å—Ç—å - –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
sudo dpkg --configure -a
sudo apt-get install -f

# –ü–æ–≤—Ç–æ—Ä–∏—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫—É
sudo ./install.sh
```

### –ü—Ä–æ–±–ª–µ–º–∞: –û—Å—Ç–∞–ª—Å—è lock –±–µ–∑ –ø—Ä–æ—Ü–µ—Å—Å–∞ (stale lock)

**–ù–ï –¥–µ–ª–∞—Ç—å:** `sudo rm /var/lib/dpkg/lock*` ‚ùå

**–ü—Ä–∞–≤–∏–ª—å–Ω–æ:**
```bash
# 1. –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –Ω–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
ps aux | grep -E 'apt|dpkg'
fuser /var/lib/dpkg/lock

# 2. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ dpkg
sudo dpkg --configure -a

# 3. –ï—Å–ª–∏ –≤—Å–µ —Ä–∞–≤–Ω–æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å systemd
sudo systemctl status apt-daily.service
sudo systemctl status apt-daily-upgrade.service

# 4. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–ª—É–∂–±—ã –≤—Ä–µ–º–µ–Ω–Ω–æ
sudo systemctl stop apt-daily.timer
sudo systemctl stop apt-daily-upgrade.timer

# 5. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å VLESS
sudo ./install.sh

# 6. –í–∫–ª—é—á–∏—Ç—å –æ–±—Ä–∞—Ç–Ω–æ
sudo systemctl start apt-daily.timer
sudo systemctl start apt-daily-upgrade.timer
```

## FAQ

**Q: –ë–µ–∑–æ–ø–∞—Å–Ω–æ –ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å VLESS_AUTO_KILL_SAFE_LOCKS=yes –≤ production?**
A: –î–∞, –±–µ–∑–æ–ø–∞—Å–Ω–æ. –°–∏—Å—Ç–µ–º–∞ –∑–∞–≤–µ—Ä—à–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–æ—Ü–µ—Å—Å—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ SAFE (apt update, apt-cache), –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –∏–∑–º–µ–Ω—è—é—Ç —Å–∏—Å—Ç–µ–º—É.

**Q: –ß—Ç–æ –¥–µ–ª–∞—Ç—å –µ—Å–ª–∏ DANGER –ø—Ä–æ—Ü–µ—Å—Å –±–ª–æ–∫–∏—Ä—É–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∫—É?**
A: –î–æ–∂–¥–∞—Ç—å—Å—è –µ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è. –ù–ï –∑–∞–≤–µ—Ä—à–∞–π—Ç–µ dpkg –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ - —ç—Ç–æ –º–æ–∂–µ—Ç –ø–æ–≤—Ä–µ–¥–∏—Ç—å —Å–∏—Å—Ç–µ–º—É.

**Q: –ú–æ–∂–Ω–æ –ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Ansible/Terraform?**
A: –î–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–±–µ ENV –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –ø–æ–ª–Ω–æ–π –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏.

**Q: –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤?**
A: –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç `dpkg --configure -a` –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏ –ø–∞–∫–µ—Ç–æ–≤.

**Q: –°–∫–æ–ª—å–∫–æ –ø–æ–ø—ã—Ç–æ–∫ –¥–µ–ª–∞–µ—Ç —Å–∏—Å—Ç–µ–º–∞ –ø–µ—Ä–µ–¥ –æ—à–∏–±–∫–æ–π?**
A: 5 –ø–æ–ø—ã—Ç–æ–∫ —Å –æ–∂–∏–¥–∞–Ω–∏–µ–º 30 —Å–µ–∫—É–Ω–¥ –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏ (–≤—Å–µ–≥–æ ~2.5 –º–∏–Ω—É—Ç—ã).

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

### –ê–ª–≥–æ—Ä–∏—Ç–º –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤

```bash
classify_apt_process() {
    # SAFE: apt update, apt-cache, –º–æ–ª–æ–¥—ã–µ unattended-upgrades
    # CAUTION: apt install, dpkg --configure -a
    # DANGER: dpkg --install/--unpack/--remove
}
```

### Workflow –æ–±—Ä–∞–±–æ—Ç–∫–∏ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫

```
1. apt update fails
   ‚Üì
2. check_apt_locks()
   ‚Üì
3. Classify each process (SAFE/CAUTION/DANGER)
   ‚Üì
4a. If VLESS_AUTO_KILL_SAFE_LOCKS=yes:
    ‚Üí kill_safe_apt_processes()
    ‚Üí retry apt update

4b. Else:
    ‚Üí Show interactive menu
    ‚Üí User chooses action
   ‚Üì
5. If success ‚Üí continue
   If failure ‚Üí diagnose and exit
```

## –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

**v3.3 (2025-10-08):**
- ‚ú® –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ (SAFE/CAUTION/DANGER)
- ‚ú® –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ SAFE –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
- ‚ú® ENV –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è VLESS_AUTO_KILL_SAFE_LOCKS
- ‚ú® –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –æ–ø—Ü–∏—è [a] –¥–ª—è safe auto-kill
- üîí –ó–∞—â–∏—Ç–∞ –æ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è DANGER –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
- üìù –ü–æ–¥—Ä–æ–±–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–µ–π

**v3.2 (2025-10-07):**
- –ë–∞–∑–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ APT locks —Å retry –º–µ—Ö–∞–Ω–∏–∑–º–æ–º
- –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –≤—ã–±–æ—Ä wait/kill/cancel

---

**–ê–≤—Ç–æ—Ä:** VLESS Reality VPN Team
**–õ–∏—Ü–µ–Ω–∑–∏—è:** MIT
**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** https://github.com/your-repo/vless
