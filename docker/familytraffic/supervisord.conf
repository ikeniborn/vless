; supervisord.conf — familytraffic single container
; Manages: xray (priority=1), nginx (priority=2), certbot-cron (priority=3)
; Note: depends_on does NOT exist in supervisord INI — order via priority only

[supervisord]
nodaemon=true
loglevel=info
pidfile=/var/run/supervisord.pid
logfile=/dev/null
logfile_maxbytes=0

[unix_http_server]
file=/var/run/supervisor.sock
chmod=0700

[supervisorctl]
serverurl=unix:///var/run/supervisor.sock

[rpcinterface:supervisor]
supervisor.rpcinterface_factory=supervisor.rpcinterface:make_main_rpcinterface

; =============================================================================
; xray — familyTraffic Reality core (starts first)
; =============================================================================
[program:xray]
command=/usr/bin/xray run -c /etc/xray/config.json
priority=1
autorestart=true
startsecs=3
startretries=5
stdout_logfile=/dev/fd/1
stdout_logfile_maxbytes=0
stderr_logfile=/dev/fd/2
stderr_logfile_maxbytes=0

; =============================================================================
; nginx — stream (SNI routing) + http (Tier 2) (starts after xray)
; =============================================================================
[program:nginx]
command=nginx -g 'daemon off;'
priority=2
autorestart=true
startsecs=5
startretries=5
stdout_logfile=/dev/fd/1
stdout_logfile_maxbytes=0
stderr_logfile=/dev/fd/2
stderr_logfile_maxbytes=0

; =============================================================================
; certbot-cron — renewal loop every 12 hours (non-critical)
; =============================================================================
[program:certbot-cron]
command=/etc/familytraffic/certbot-renew.sh
priority=3
autorestart=false
startretries=1
stdout_logfile=/dev/fd/1
stdout_logfile_maxbytes=0
stderr_logfile=/dev/fd/2
stderr_logfile_maxbytes=0
