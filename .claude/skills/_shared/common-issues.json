{
  "version": "1.0.0",
  "description": "Known failure patterns with diagnostics and fixes for VLESS + Reality VPN",
  "last_updated": "2026-01-08",

  "issues": [
    {
      "id": "container_unhealthy",
      "title": "Container Unhealthy - Xray Wrong Port",
      "category": "container",
      "severity": "CRITICAL",
      "symptoms": [
        "docker ps shows (unhealthy) for vless_xray",
        "Health check failing repeatedly",
        "HAProxy logs show 'Connection refused' to Xray"
      ],
      "diagnostics": [
        {
          "command": "docker inspect vless_xray | jq '.[0].State.Health'",
          "expected": "\"healthy\"",
          "description": "Check container health status"
        },
        {
          "command": "docker logs vless_xray --tail 50",
          "grep_pattern": "listening on|port",
          "description": "Find which port Xray is listening on"
        },
        {
          "command": "jq '.inbounds[] | select(.protocol==\"vless\") | .port' /opt/vless/config/xray_config.json",
          "expected": "8443",
          "description": "Verify Xray configured port"
        }
      ],
      "common_causes": [
        {
          "cause": "Xray listening on port 443 instead of 8443",
          "explanation": "v4.3+ requires Xray on internal port 8443, HAProxy forwards from public 443",
          "fix": {
            "commands": [
              "sudo sed -i 's/\"port\": 443,/\"port\": 8443,/' /opt/vless/config/xray_config.json",
              "docker restart vless_xray",
              "docker ps | grep vless_xray"
            ],
            "validation": "docker ps should show (healthy) after 10 seconds"
          }
        },
        {
          "cause": "Wrong fallback destination in Xray config",
          "explanation": "Fallback must point to vless_fake_site:80, not vless_nginx:80",
          "fix": {
            "commands": [
              "sudo sed -i 's/\"dest\": \"vless_nginx:80\"/\"dest\": \"vless_fake_site:80\"/' /opt/vless/config/xray_config.json",
              "docker restart vless_xray"
            ],
            "validation": "curl http://vless_fake_site should return fallback page"
          }
        }
      ],
      "prevention": [
        "Always use vless CLI commands to modify configuration",
        "Run 'xray test -c config.json' before restart",
        "Check HAProxy routing rules match Xray port"
      ]
    },

    {
      "id": "port_conflict",
      "title": "Port Already Allocated - Port Conflict",
      "category": "networking",
      "severity": "CRITICAL",
      "symptoms": [
        "Installation fails with 'port is already allocated'",
        "Error: 'bind: address already in use'",
        "docker-compose up fails to start HAProxy"
      ],
      "diagnostics": [
        {
          "command": "sudo ss -tulnp | grep :443",
          "description": "Find process using port 443"
        },
        {
          "command": "sudo ss -tulnp | grep -E ':(1080|8118|8443)'",
          "description": "Check all VLESS ports for conflicts"
        },
        {
          "command": "sudo lsof -i :443",
          "description": "Alternative method to find port owner"
        }
      ],
      "common_causes": [
        {
          "cause": "Existing web server (nginx, apache) on port 443",
          "explanation": "System web server conflicts with HAProxy",
          "fix": {
            "commands": [
              "sudo systemctl stop nginx",
              "sudo systemctl disable nginx",
              "sudo systemctl stop apache2",
              "sudo systemctl disable apache2"
            ],
            "validation": "sudo ss -tulnp | grep :443 should return empty"
          }
        },
        {
          "cause": "Previous VLESS installation not cleaned up",
          "explanation": "Old docker containers still running",
          "fix": {
            "commands": [
              "docker ps -a | grep vless",
              "docker stop $(docker ps -q --filter 'name=vless')",
              "docker rm $(docker ps -aq --filter 'name=vless')"
            ],
            "validation": "docker ps should not show any vless_* containers"
          }
        }
      ],
      "prevention": [
        "Run installation script which auto-detects port conflicts",
        "Use alternative ports if 443 unavailable (8443, 2053)",
        "Check port availability before installation: ss -tulnp | grep :443"
      ]
    },

    {
      "id": "cert_renewal_failed",
      "title": "Certificate Renewal Failed - Let's Encrypt",
      "category": "certificates",
      "severity": "HIGH",
      "symptoms": [
        "Certbot cron job failing",
        "Certificate expired warnings in browser",
        "/var/log/letsencrypt/letsencrypt.log shows errors"
      ],
      "diagnostics": [
        {
          "command": "sudo certbot renew --dry-run",
          "description": "Test certificate renewal process"
        },
        {
          "command": "sudo tail -50 /var/log/letsencrypt/letsencrypt.log",
          "grep_pattern": "error|fail",
          "description": "Check certbot logs for errors"
        },
        {
          "command": "openssl x509 -in /etc/letsencrypt/live/YOUR_DOMAIN/cert.pem -noout -dates",
          "description": "Check certificate expiration date"
        },
        {
          "command": "dig +short YOUR_DOMAIN",
          "description": "Verify DNS points to this server"
        }
      ],
      "common_causes": [
        {
          "cause": "Port 80 blocked - certbot can't validate",
          "explanation": "Let's Encrypt HTTP-01 challenge requires port 80 open",
          "fix": {
            "commands": [
              "sudo ufw allow 80/tcp",
              "sudo ss -tulnp | grep :80",
              "docker ps | grep vless_certbot_nginx"
            ],
            "validation": "curl http://YOUR_DOMAIN/.well-known/acme-challenge/test should return 404"
          }
        },
        {
          "cause": "DNS changed - domain no longer points to server",
          "explanation": "DNS A record must point to server IP",
          "fix": {
            "commands": [
              "dig +short YOUR_DOMAIN",
              "curl -4 ifconfig.me"
            ],
            "validation": "Both commands should return the same IP"
          }
        }
      ],
      "prevention": [
        "Monitor certbot cron job: grep CRON /var/log/syslog | grep certbot",
        "Set up alerting for certificate expiration (< 30 days)",
        "Keep DNS records stable"
      ]
    },

    {
      "id": "routing_broken",
      "title": "Routing Broken - HAProxy Not Routing",
      "category": "routing",
      "severity": "HIGH",
      "symptoms": [
        "503 Service Unavailable for subdomain",
        "HAProxy stats show backend down",
        "Reverse proxy domains not accessible"
      ],
      "diagnostics": [
        {
          "command": "curl http://127.0.0.1:9000/stats",
          "grep_pattern": "DOWN|UP",
          "description": "Check HAProxy backend status"
        },
        {
          "command": "docker logs vless_haproxy --tail 50",
          "grep_pattern": "error|refused|timeout",
          "description": "Check HAProxy logs for routing errors"
        },
        {
          "command": "grep 'DYNAMIC_REVERSE_PROXY_ROUTES' /opt/vless/config/haproxy.cfg",
          "description": "Verify dynamic ACL section exists"
        }
      ],
      "common_causes": [
        {
          "cause": "HAProxy config not reloaded after adding domain",
          "explanation": "Dynamic ACLs require HAProxy reload",
          "fix": {
            "commands": [
              "docker exec vless_haproxy haproxy -c -f /usr/local/etc/haproxy/haproxy.cfg",
              "docker exec vless_haproxy kill -HUP $(docker exec vless_haproxy cat /var/run/haproxy.pid)"
            ],
            "validation": "curl -I https://YOUR_DOMAIN should return 200 or 301"
          }
        },
        {
          "cause": "Nginx backend not running",
          "explanation": "vless_nginx_reverseproxy container unhealthy",
          "fix": {
            "commands": [
              "docker ps | grep vless_nginx_reverseproxy",
              "docker logs vless_nginx_reverseproxy --tail 30",
              "docker restart vless_nginx_reverseproxy"
            ],
            "validation": "curl http://127.0.0.1:9443 should return nginx response"
          }
        }
      ],
      "prevention": [
        "Always use 'vless-proxy add' command to add domains",
        "Monitor HAProxy stats endpoint regularly",
        "Set up health checks for all backends"
      ]
    },

    {
      "id": "ufw_blocks_docker",
      "title": "UFW Blocks Docker Traffic - No Internet in Containers",
      "category": "networking",
      "severity": "MEDIUM",
      "symptoms": [
        "Containers run but no Internet access inside",
        "docker exec vless_xray ping 8.8.8.8 fails",
        "apt update inside container fails"
      ],
      "diagnostics": [
        {
          "command": "docker exec vless_xray ping -c 1 8.8.8.8",
          "description": "Test Internet connectivity from container"
        },
        {
          "command": "grep 'DOCKER-USER' /etc/ufw/after.rules",
          "description": "Check if Docker UFW chains exist"
        },
        {
          "command": "sudo ufw status verbose",
          "description": "Check UFW status and rules"
        }
      ],
      "common_causes": [
        {
          "cause": "UFW blocking Docker bridge traffic",
          "explanation": "UFW default rules don't allow Docker networking",
          "fix": {
            "commands": [
              "sudo bash -c 'cat >> /etc/ufw/after.rules << EOF\n*filter\n:DOCKER-USER - [0:0]\n-A DOCKER-USER -j RETURN\nCOMMIT\nEOF'",
              "sudo ufw reload",
              "docker exec vless_xray ping -c 1 8.8.8.8"
            ],
            "validation": "Ping should succeed"
          }
        }
      ],
      "prevention": [
        "Configure UFW before installing Docker",
        "Use installation script which auto-configures UFW"
      ]
    },

    {
      "id": "nginx_reverseproxy_crash",
      "title": "Nginx Reverse Proxy Crash Loop - Missing limit_req_zone",
      "category": "container",
      "severity": "MEDIUM",
      "symptoms": [
        "vless_nginx_reverseproxy shows 'Restarting'",
        "docker logs show 'nginx: configuration file test failed'",
        "Reverse proxy domains inaccessible"
      ],
      "diagnostics": [
        {
          "command": "docker logs vless_nginx_reverseproxy --tail 30",
          "grep_pattern": "limit_req_zone|emerg|error",
          "description": "Check nginx error logs"
        },
        {
          "command": "grep 'limit_req_zone' /opt/vless/config/reverse-proxy/http_context.conf",
          "description": "Verify rate limit zone configuration"
        }
      ],
      "common_causes": [
        {
          "cause": "Missing limit_req_zone directive for domain",
          "explanation": "Each reverse proxy domain needs its own rate limit zone",
          "fix": {
            "commands": [
              "DOMAIN='your-domain.com'",
              "ZONE_NAME=\"reverseproxy_${DOMAIN//[.-]/_}\"",
              "sudo bash -c \"cat >> /opt/vless/config/reverse-proxy/http_context.conf << EOF\n\n# Rate limit zone for: ${DOMAIN}\nlimit_req_zone \\$binary_remote_addr zone=${ZONE_NAME}:10m rate=100r/s;\nEOF\"",
              "docker restart vless_nginx_reverseproxy"
            ],
            "validation": "docker ps should show (healthy) after restart"
          }
        }
      ],
      "prevention": [
        "Use 'vless-proxy add' command which auto-generates rate limit zones",
        "Validate nginx config before restart: nginx -t"
      ]
    }
  ],

  "diagnostic_workflow": {
    "description": "Standard diagnostic workflow for troubleshooting",
    "steps": [
      {
        "step": 1,
        "action": "Check system status",
        "command": "sudo vless status"
      },
      {
        "step": 2,
        "action": "Check container health",
        "command": "docker ps"
      },
      {
        "step": 3,
        "action": "Check port bindings",
        "command": "sudo ss -tulnp | grep -E ':(443|1080|8118|8443|9000)'"
      },
      {
        "step": 4,
        "action": "Check logs for errors",
        "command": "sudo vless logs xray"
      },
      {
        "step": 5,
        "action": "Validate configurations",
        "command": "xray test -c /opt/vless/config/xray_config.json && haproxy -c -f /opt/vless/config/haproxy.cfg"
      }
    ]
  }
}
