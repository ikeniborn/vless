# docker-compose.yml
# familyTraffic VPN — base service definition (version-controlled)
#
# Dynamic values come from /opt/familytraffic/.env:
#   GHCR_IMAGE   — e.g. ghcr.io/owner/familytraffic  (set during install)
#   VERSION      — image tag: test | sha-abc1234 | latest (updated by CI/CD)
#   DOMAIN       — your domain name                   (set during install)
#
# This file is synced to /opt/familytraffic/docker-compose.yml by CI/CD (rsync).
# MTProxy section is managed separately by: sudo familytraffic-mtproxy-setup
# If MTProxy is enabled it appends its service block — do not edit that section manually.
#
# Usage:
#   cd /opt/familytraffic && docker compose pull && docker compose up -d

services:
  # ==========================================================================
  # familytraffic — single container (nginx + xray + certbot + supervisord)
  # v5.33: replaces multi-container architecture
  # network_mode: host — all processes share host network stack
  # ==========================================================================
  familytraffic:
    image: ${GHCR_IMAGE:-ghcr.io/OWNER/familytraffic}:${VERSION:-latest}
    container_name: familytraffic
    network_mode: host
    restart: unless-stopped
    volumes:
      # nginx config (generated by lib/nginx_stream_generator.sh)
      - /opt/familytraffic/config/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      # xray config — exact file path (do NOT mount the data/ directory)
      - /opt/familytraffic/config/xray_config.json:/etc/xray/config.json:ro
      # users db (live-reloadable via xray SIGHUP)
      - /opt/familytraffic/data/users.json:/etc/xray/users.json:ro
      # Let's Encrypt certificates (read-write: certbot renew writes new certs)
      - /etc/letsencrypt:/etc/letsencrypt
      # ACME webroot for certbot --webroot renewal
      - /var/www/html:/var/www/html
    env_file:
      - /opt/familytraffic/.env
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      # Check all critical processes via supervisorctl + verify xray accepts TCP on 8443.
      # supervisorctl connects to unix:///var/run/supervisor.sock (configured in supervisord.conf).
      # certbot-cron is non-critical (autorestart=false) and excluded from the check.
      test: ["CMD", "sh", "-c",
        "timeout 5 supervisorctl status xray | grep -q RUNNING && timeout 5 supervisorctl status nginx | grep -q RUNNING && nc -z -w 3 127.0.0.1 8443"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

# MTProxy service block is appended here by familytraffic-mtproxy-setup
# Do not add anything below this line manually
