<?xml version="1.0" encoding="UTF-8"?>
<analysis>
    <project>
        <name>VLESS+Reality VPN Service</name>
        <stage>Stage 5: Service Functions</stage>
        <timestamp>2025-01-25T14:30:00Z</timestamp>
    </project>

    <current_state>
        <completed_stages>
            <stage id="1" name="Basic Infrastructure" status="completed"/>
            <stage id="2" name="Configuration Generation" status="completed"/>
            <stage id="3" name="User Management" status="completed"/>
            <stage id="4" name="Docker Integration" status="completed"/>
        </completed_stages>

        <stage_5_status>
            <function name="status" status="implemented" command="check_service_status"/>
            <function name="restart" status="implemented" command="restart_service"/>
            <function name="logs" status="implemented" command="view_logs"/>
            <function name="uninstall" status="not_implemented"/>
            <function name="help" status="not_implemented"/>
        </stage_5_status>
    </current_state>

    <requirements>
        <requirement id="1">
            <name>uninstall_service</name>
            <description>Complete removal of VPN service</description>
            <actions>
                <action>Stop and remove Docker container</action>
                <action>Remove Docker image</action>
                <action>Delete configuration files</action>
                <action>Delete user database</action>
                <action>Remove project directories</action>
                <action>Optional backup before deletion</action>
            </actions>
        </requirement>

        <requirement id="2">
            <name>show_help</name>
            <description>Display available commands and usage</description>
            <actions>
                <action>Show command categories</action>
                <action>Display command descriptions</action>
                <action>Provide usage examples</action>
                <action>Indicate required privileges</action>
            </actions>
        </requirement>

        <requirement id="3">
            <name>backup_service</name>
            <description>Create backup archive before uninstall</description>
            <actions>
                <action>Archive configuration files</action>
                <action>Backup user database</action>
                <action>Save encryption keys</action>
                <action>Include environment variables</action>
                <action>Create timestamped archive</action>
            </actions>
        </requirement>
    </requirements>

    <implementation_approach>
        <principle>Follow existing code patterns and conventions</principle>
        <principle>Maintain consistent error handling</principle>
        <principle>Use colored output for better UX</principle>
        <principle>Implement comprehensive logging</principle>
        <principle>Ensure operations are safe and reversible where possible</principle>
    </implementation_approach>

    <technical_details>
        <uninstall_function>
            <confirmation>Interactive confirmation with clear warning</confirmation>
            <backup_option>Offer optional backup before deletion</backup_option>
            <cleanup_scope>
                <item>Docker container: xray</item>
                <item>Docker image: teddysun/xray:latest</item>
                <item>Directories: config/, data/, logs/</item>
                <item>Files: .env, docker-compose.yml</item>
            </cleanup_scope>
            <error_handling>Continue cleanup even if some components missing</error_handling>
        </uninstall_function>

        <help_function>
            <categories>
                <category name="System Commands">
                    <command>help - Show this help message</command>
                    <command>install - Install VPN service</command>
                    <command>uninstall - Remove VPN service</command>
                </category>
                <category name="User Management">
                    <command>add-user - Add new VPN user</command>
                    <command>remove-user - Remove existing user</command>
                    <command>list-users - List all users</command>
                    <command>show-user - Show user details</command>
                </category>
                <category name="Service Control">
                    <command>start - Start VPN service</command>
                    <command>stop - Stop VPN service</command>
                    <command>restart - Restart VPN service</command>
                    <command>status - Check service status</command>
                    <command>logs - View service logs</command>
                </category>
            </categories>
        </help_function>

        <backup_function>
            <archive_format>tar.gz</archive_format>
            <naming_convention>vless_backup_YYYYMMDD_HHMMSS.tar.gz</naming_convention>
            <content>
                <directory>config/</directory>
                <directory>data/</directory>
                <file>.env</file>
                <file>docker-compose.yml</file>
            </content>
            <location>Current directory or /tmp/</location>
        </backup_function>
    </technical_details>

    <testing_requirements>
        <test_file>test_service_functions.sh</test_file>
        <test_cases>
            <test>Test help command output</test>
            <test>Test backup creation</test>
            <test>Test uninstall with confirmation</test>
            <test>Test uninstall without backup</test>
            <test>Test uninstall with backup</test>
            <test>Test cleanup of all components</test>
        </test_cases>
    </testing_requirements>

    <risks_and_mitigations>
        <risk>
            <description>Accidental data loss during uninstall</description>
            <mitigation>Mandatory confirmation prompt and optional backup</mitigation>
        </risk>
        <risk>
            <description>Incomplete cleanup leaving orphaned resources</description>
            <mitigation>Comprehensive cleanup with error tolerance</mitigation>
        </risk>
    </risks_and_mitigations>

    <success_criteria>
        <criterion>All service functions working correctly</criterion>
        <criterion>Help command provides clear guidance</criterion>
        <criterion>Uninstall removes all components cleanly</criterion>
        <criterion>Backup preserves all critical data</criterion>
        <criterion>Tests pass successfully</criterion>
        <criterion>Documentation updated</criterion>
    </success_criteria>
</analysis>