<?xml version="1.0" encoding="UTF-8"?>
<prd_workflow version="2.1">
    
    <!-- МЕТАДАННЫЕ КОНФИГУРАЦИИ -->
    <metadata>
        <title>Optimized Workflow for PRD Development</title>
        <version>2.1</version>
        <created>2025-10-01</created>
        <purpose>Создание Product Requirements Document с глубоким анализом и вовлечением пользователя</purpose>
    </metadata>

    <!-- КОНФИГУРАЦИЯ ВЫПОЛНЕНИЯ -->
    <execution_config>
        <mode>strict_sequential_with_validation</mode>
        <thinking>
            <enabled>true</enabled>
            <mode>interleaved</mode>
            <max_length>16000</max_length>
            <mandatory_before_phase>true</mandatory_before_phase>
            <mandatory_after_validation>true</mandatory_after_validation>
        </thinking>
        <user_interaction>
            <enabled>true</enabled>
            <validation_points>mandatory</validation_points>
            <clarification_mode>interactive</clarification_mode>
        </user_interaction>
        <validation>
            <type>checkpoint_and_user_approval</type>
            <auto_proceed>false</auto_proceed>
        </validation>
        <error_handling>
            <strategy>stop_and_rollback</strategy>
            <allow_phase_restart>true</allow_phase_restart>
        </error_handling>
        <output_format>
            <all_artifacts>xml</all_artifacts>
            <encoding>UTF-8</encoding>
        </output_format>
    </execution_config>

    <!-- ВНЕШНИЕ ПАРАМЕТРЫ -->
    <external_inputs>
        <role>
            Вы - опытный Product Manager и Technical Architect, специализирующийся на создании 
            детальной технической документации для VPN и сетевых решений.
            Экспертиза: Bash, Docker, Docker Compose, Xray, VLESS, Reality протокол, 
            сетевая архитектура, безопасность, документирование.
        </role>
        
        <technical_context>
            <primary_source>https://deepwiki.com/XTLS/Xray-examples/2.3-vless-+-tcp-+-reality</primary_source>
            <docker_image>teddysun/xray:24.11.30</docker_image>
            <target_protocol>VLESS + Reality</target_protocol>
            <deployment_path>/opt/vless</deployment_path>
        </technical_context>
        
        <core_requirements>
            <requirement id="req_001" priority="critical">
                Разработать PRD для VPN сервера VLESS + Reality на базе указанного контекста
            </requirement>
            <requirement id="req_002" priority="critical">
                Сохранить итоговый документ в PRD.md
            </requirement>
            <requirement id="req_003" priority="high">
                Использовать Docker образ teddysun/xray:24.11.30
            </requirement>
            <requirement id="req_004" priority="high">
                Учесть особенности маршрутизации трафика в контейнере и использование UFW
            </requirement>
            <requirement id="req_005" priority="high">
                Реализовать систему управления пользователями (создание, удаление, управление)
            </requirement>
            <requirement id="req_006" priority="medium">
                Размещать сервис в /opt/vless при установке
            </requirement>
            <requirement id="req_007" priority="medium">
                При переустановке удалять старые файлы из /opt/vless
            </requirement>
            <requirement id="req_008" priority="medium">
                Добавить функционал fake-site
            </requirement>
            <requirement id="req_009" priority="high">
                Реализовать в отдельной подсети Docker с учетом других VPN протоколов
            </requirement>
            <requirement id="req_010" priority="high">
                Все параметры задаются в терминале в процессе установки
            </requirement>
        </core_requirements>
        
        <constraints>
            <constraint id="const_001">Строго опираться на документацию XTLS/Xray-examples</constraint>
            <constraint id="const_002">Обеспечить совместимость с существующими VPN на сервере</constraint>
            <constraint id="const_003">Использовать только проверенные и безопасные практики</constraint>
        </constraints>
    </external_inputs>

    <!-- WORKFLOW: ПОСЛЕДОВАТЕЛЬНОСТЬ ФАЗ -->
    <workflow>
        
        <!-- ГЛОБАЛЬНЫЕ ДИРЕКТИВЫ -->
        <directives>
            <directive priority="CRITICAL" id="dir_001">
                СТРОГО последовательное выполнение фаз по order. ЗАПРЕЩЕНО пропускать фазы.
            </directive>
            <directive priority="CRITICAL" id="dir_002">
                НЕ переходить к следующей фазе без прохождения всех checkpoints и user_validation.
            </directive>
            <directive priority="CRITICAL" id="dir_003">
                ОБЯЗАТЕЛЬНО использовать &lt;thinking&gt; перед каждой фазой и после получения данных.
            </directive>
            <directive priority="HIGH" id="dir_004">
                При неясностях - ВСЕГДА задавать вопросы пользователю. НЕ делать предположений.
            </directive>
            <directive priority="HIGH" id="dir_005">
                Все промежуточные файлы ТОЛЬКО в XML формате с четкой структурой.
            </directive>
            <directive priority="MEDIUM" id="dir_006">
                Сохранять контекст между фазами через knowledge_base.xml.
            </directive>
        </directives>

        <!-- ФАЗА 0: ИНИЦИАЛИЗАЦИЯ -->
        <phase order="0" id="initialization" type="setup">
            <name>Инициализация и подготовка окружения</name>
            <objective>Создание структуры проекта и базовой инфраструктуры для работы</objective>
            
            <thinking_prompt>
                Перед началом работы обдумайте:
                1. Какая структура папок нужна для организации процесса?
                2. Какие базовые файлы необходимы для хранения промежуточных результатов?
                3. Как организовать knowledge base для накопления информации?
                4. Какие метаданные нужно зафиксировать на старте?
            </thinking_prompt>
            
            <actions>
                <action seq="1" type="create">
                    <description>Создать структуру директорий workflow/</description>
                    <output>Структура папок готова</output>
                </action>
                <action seq="2" type="create">
                    <description>Инициализировать knowledge_base.xml</description>
                    <output>workflow/knowledge_base.xml</output>
                </action>
                <action seq="3" type="create">
                    <description>Создать session_metadata.xml</description>
                    <output>workflow/session_metadata.xml</output>
                </action>
                <action seq="4" type="log">
                    <description>Зафиксировать начальные параметры</description>
                    <output>Запись в session_metadata.xml</output>
                </action>
            </actions>
            
            <outputs>
                <file path="workflow/session_metadata.xml" format="xml">
                    <structure>
                        <session_id/>
                        <start_timestamp/>
                        <inputs_received/>
                        <context_loaded/>
                    </structure>
                </file>
                <file path="workflow/knowledge_base.xml" format="xml">
                    <structure>
                        <accumulated_knowledge>
                            <technical_facts/>
                            <requirements_understanding/>
                            <decisions_made/>
                            <questions_answered/>
                        </accumulated_knowledge>
                    </structure>
                </file>
            </outputs>
            
            <checkpoints>
                <checkpoint id="cp_0_1">✓ Структура директорий создана</checkpoint>
                <checkpoint id="cp_0_2">✓ Базовые XML файлы инициализированы</checkpoint>
                <checkpoint id="cp_0_3">✓ Метаданные сессии зафиксированы</checkpoint>
            </checkpoints>
            
            <validation type="auto">
                <check>Все файлы существуют и валидны</check>
            </validation>
        </phase>

        <!-- ФАЗА 1: ГЛУБОКИЙ АНАЛИЗ ТЕХНИЧЕСКОГО КОНТЕКСТА -->
        <phase order="1" id="context_analysis" type="research">
            <name>Анализ технической документации и контекста</name>
            <dependency>phase[order=0].validation.passed</dependency>
            <objective>Извлечь и структурировать всю техническую информацию из источников</objective>
            
            <thinking_prompt>
                Критически проанализируйте:
                1. Что именно описывает документация VLESS + Reality?
                2. Какие технические детали являются ключевыми?
                3. Какие компоненты и зависимости присутствуют?
                4. Какие потенциальные проблемы могут возникнуть?
                5. Что не описано явно, но подразумевается?
                6. Какие вопросы нужно задать пользователю для уточнения?
            </thinking_prompt>
            
            <actions>
                <action seq="1" type="fetch">
                    <description>Получить содержимое технической документации</description>
                    <tool>web_fetch</tool>
                    <target>https://deepwiki.com/XTLS/Xray-examples/2.3-vless-+-tcp-+-reality</target>
                </action>
                <action seq="2" type="analyze">
                    <description>Извлечь ключевые технические компоненты</description>
                    <focus>
                        - Архитектура VLESS + Reality
                        - Конфигурация Xray
                        - Требования к инфраструктуре
                        - Параметры безопасности
                    </focus>
                </action>
                <action seq="3" type="structure">
                    <description>Структурировать извлеченную информацию</description>
                    <output>workflow/phase1_technical_analysis.xml</output>
                </action>
                <action seq="4" type="identify">
                    <description>Выявить gaps и необходимые уточнения</description>
                    <output>Список вопросов для пользователя</output>
                </action>
            </actions>
            
            <outputs>
                <file path="workflow/phase1_technical_analysis.xml" format="xml">
                    <structure>
                        <technical_components>
                            <xray_configuration/>
                            <vless_protocol/>
                            <reality_protocol/>
                            <docker_setup/>
                            <networking/>
                        </technical_components>
                        <infrastructure_requirements>
                            <ports/>
                            <volumes/>
                            <networks/>
                            <firewall_rules/>
                        </infrastructure_requirements>
                        <security_considerations>
                            <tls_certificates/>
                            <reality_config/>
                            <user_authentication/>
                        </security_considerations>
                        <identified_gaps>
                            <gap id="" description="" priority=""/>
                        </identified_gaps>
                        <questions_for_user>
                            <question id="" category="" text=""/>
                        </questions_for_user>
                    </structure>
                </file>
            </outputs>
            
            <checkpoints>
                <checkpoint id="cp_1_1">✓ Техническая документация получена и проанализирована</checkpoint>
                <checkpoint id="cp_1_2">✓ Ключевые компоненты идентифицированы</checkpoint>
                <checkpoint id="cp_1_3">✓ Gaps и вопросы сформулированы</checkpoint>
                <checkpoint id="cp_1_4">✓ Результаты структурированы в XML</checkpoint>
            </checkpoints>
            
            <user_validation required="true">
                <prompt>
                    Анализ технической документации завершен. Выявлены следующие ключевые компоненты и вопросы.
                    Пожалуйста, подтвердите понимание и ответьте на уточняющие вопросы.
                </prompt>
                <display>
                    - Краткое резюме технических компонентов
                    - Список выявленных вопросов
                    - Запрос на уточнения
                </display>
            </user_validation>
        </phase>

        <!-- ФАЗА 2: ИНТЕРАКТИВНЫЙ СБОР ТРЕБОВАНИЙ -->
        <phase order="2" id="requirements_gathering" type="interactive">
            <name>Детальный сбор и уточнение требований</name>
            <dependency>phase[order=1].user_validation.approved</dependency>
            <objective>Собрать полные и недвусмысленные требования через диалог с пользователем</objective>
            
            <thinking_prompt>
                Продумайте стратегию сбора требований:
                1. Какие требования уже ясны из external_inputs?
                2. Какие требования нуждаются в детализации?
                3. Какие параметры должны быть настраиваемыми?
                4. Какие сценарии использования нужно покрыть?
                5. Какие edge cases могут возникнуть?
                6. Как структурировать вопросы для максимальной эффективности?
            </thinking_prompt>
            
            <actions>
                <action seq="1" type="load">
                    <description>Загрузить результаты Phase 1 и базовые требования</description>
                    <sources>
                        - workflow/phase1_technical_analysis.xml
                        - external_inputs/core_requirements
                    </sources>
                </action>
                <action seq="2" type="analyze">
                    <description>Проанализировать требования на полноту и непротиворечивость</description>
                    <output>Матрица требований</output>
                </action>
                <action seq="3" type="formulate">
                    <description>Сформулировать категоризированные вопросы</description>
                    <categories>
                        - Функциональные требования
                        - Нефункциональные требования
                        - Технические параметры
                        - Пользовательский опыт
                        - Безопасность
                        - Операционные аспекты
                    </categories>
                </action>
                <action seq="4" type="interact">
                    <description>Провести интерактивный сбор информации</description>
                    <mode>question_and_answer</mode>
                </action>
                <action seq="5" type="document">
                    <description>Зафиксировать все собранные требования</description>
                    <output>workflow/phase2_requirements_specification.xml</output>
                </action>
            </actions>
            
            <question_framework>
                <category name="Функциональные требования">
                    <topic>Управление пользователями</topic>
                    <topic>Конфигурация сервера</topic>
                    <topic>Мониторинг и логирование</topic>
                    <topic>Backup и восстановление</topic>
                </category>
                <category name="Технические параметры">
                    <topic>Сетевая конфигурация</topic>
                    <topic>Параметры производительности</topic>
                    <topic>Ограничения ресурсов</topic>
                    <topic>Интеграция с UFW</topic>
                </category>
                <category name="Операционные аспекты">
                    <topic>Процесс установки</topic>
                    <topic>Процесс обновления</topic>
                    <topic>Процесс удаления</topic>
                    <topic>Диагностика проблем</topic>
                </category>
            </question_framework>
            
            <outputs>
                <file path="workflow/phase2_requirements_specification.xml" format="xml">
                    <structure>
                        <functional_requirements>
                            <requirement id="" priority="" category="" description="" acceptance_criteria=""/>
                        </functional_requirements>
                        <non_functional_requirements>
                            <requirement id="" type="" description="" metrics=""/>
                        </non_functional_requirements>
                        <technical_parameters>
                            <parameter name="" type="" default="" configurable="" validation=""/>
                        </technical_parameters>
                        <user_stories>
                            <story id="" as="" i_want="" so_that="" acceptance_criteria=""/>
                        </user_stories>
                        <constraints>
                            <constraint id="" description="" impact=""/>
                        </constraints>
                        <assumptions>
                            <assumption id="" description="" risk_if_invalid=""/>
                        </assumptions>
                        <out_of_scope>
                            <item description="" rationale=""/>
                        </out_of_scope>
                    </structure>
                </file>
                <file path="workflow/phase2_qa_log.xml" format="xml">
                    <structure>
                        <conversation_log>
                            <exchange timestamp="" question="" answer="" clarifications=""/>
                        </conversation_log>
                    </structure>
                </file>
            </outputs>
            
            <checkpoints>
                <checkpoint id="cp_2_1">✓ Все категории требований проанализированы</checkpoint>
                <checkpoint id="cp_2_2">✓ Вопросы заданы и ответы получены</checkpoint>
                <checkpoint id="cp_2_3">✓ Требования задокументированы в структурированном виде</checkpoint>
                <checkpoint id="cp_2_4">✓ Противоречия выявлены и разрешены</checkpoint>
            </checkpoints>
            
            <user_validation required="true">
                <prompt>
                    Завершен сбор требований. Пожалуйста, проверьте полноту и корректность:
                    - Все ли аспекты учтены?
                    - Корректно ли интерпретированы ваши ответы?
                    - Нужны ли дополнительные уточнения?
                </prompt>
            </user_validation>
        </phase>

        <!-- ФАЗА 3: СИНТЕЗ И ВАЛИДАЦИЯ ПОНИМАНИЯ -->
        <phase order="3" id="understanding_synthesis" type="analysis">
            <name>Синтез полного понимания задачи</name>
            <dependency>phase[order=2].user_validation.approved</dependency>
            <objective>Объединить технический контекст и требования в единую модель понимания</objective>
            
            <thinking_prompt>
                Проведите глубокий синтез:
                1. Как технический контекст соотносится с требованиями?
                2. Все ли требования реализуемы с учетом технических ограничений?
                3. Какие компромиссы могут потребоваться?
                4. Какие риски существуют?
                5. Какие зависимости между компонентами?
                6. Какова полная картина решения?
            </thinking_prompt>
            
            <actions>
                <action seq="1" type="merge">
                    <description>Объединить данные из Phase 1 и Phase 2</description>
                    <sources>
                        - workflow/phase1_technical_analysis.xml
                        - workflow/phase2_requirements_specification.xml
                    </sources>
                </action>
                <action seq="2" type="validate">
                    <description>Проверить согласованность технологий и требований</description>
                    <checks>
                        - Технологическая реализуемость
                        - Отсутствие конфликтов
                        - Полнота покрытия
                    </checks>
                </action>
                <action seq="3" type="identify_risks">
                    <description>Выявить риски и проблемные зоны</description>
                    <output>Реестр рисков</output>
                </action>
                <action seq="4" type="create_model">
                    <description>Создать унифицированную модель понимания</description>
                    <output>workflow/phase3_unified_understanding.xml</output>
                </action>
                <action seq="5" type="prepare_presentation">
                    <description>Подготовить презентацию для пользователя</description>
                    <format>Структурированное резюме</format>
                </action>
            </actions>
            
            <outputs>
                <file path="workflow/phase3_unified_understanding.xml" format="xml">
                    <structure>
                        <executive_summary>
                            <what_we_build/>
                            <why_it_matters/>
                            <key_challenges/>
                        </executive_summary>
                        <system_architecture>
                            <components/>
                            <interactions/>
                            <data_flow/>
                        </system_architecture>
                        <requirements_mapping>
                            <requirement id="" mapped_to_component="" implementation_approach=""/>
                        </requirements_mapping>
                        <risk_register>
                            <risk id="" category="" description="" probability="" impact="" mitigation=""/>
                        </risk_register>
                        <assumptions_validated>
                            <assumption id="" status="" notes=""/>
                        </assumptions_validated>
                        <constraints_impact>
                            <constraint id="" affected_components="" workaround=""/>
                        </constraints_impact>
                        <success_criteria>
                            <criterion id="" description="" measurement=""/>
                        </success_criteria>
                    </structure>
                </file>
            </outputs>
            
            <checkpoints>
                <checkpoint id="cp_3_1">✓ Технический контекст и требования объединены</checkpoint>
                <checkpoint id="cp_3_2">✓ Согласованность проверена</checkpoint>
                <checkpoint id="cp_3_3">✓ Риски идентифицированы</checkpoint>
                <checkpoint id="cp_3_4">✓ Унифицированная модель создана</checkpoint>
            </checkpoints>
            
            <user_validation required="true">
                <prompt>
                    Синтез завершен. Представляю полное понимание задачи:
                    
                    [Executive Summary]
                    [Архитектура системы]
                    [Ключевые риски]
                    [Критерии успеха]
                    
                    Подтверждаете ли вы, что понимание корректно?
                    Есть ли аспекты, требующие корректировки?
                </prompt>
            </user_validation>
        </phase>

        <!-- ФАЗА 4: АРХИТЕКТУРНОЕ ПРОЕКТИРОВАНИЕ PRD -->
        <phase order="4" id="prd_architecture" type="design">
            <name>Проектирование структуры PRD документа</name>
            <dependency>phase[order=3].user_validation.approved</dependency>
            <objective>Определить оптимальную структуру и содержание PRD документа</objective>
            
            <thinking_prompt>
                Спроектируйте структуру PRD:
                1. Какие секции необходимы для полного описания?
                2. Как логически организовать информацию?
                3. Какой уровень детализации оптимален для каждой секции?
                4. Как обеспечить читаемость и навигацию?
                5. Какие диаграммы и схемы нужны?
                6. Как организовать приложения и дополнительные материалы?
            </thinking_prompt>
            
            <actions>
                <action seq="1" type="research">
                    <description>Изучить best practices структуры PRD</description>
                    <focus>Технические PRD для инфраструктурных решений</focus>
                </action>
                <action seq="2" type="design">
                    <description>Разработать структуру документа</description>
                    <considerations>
                        - Логическая последовательность
                        - Полнота информации
                        - Удобство для разных ролей (разработчик, DevOps, пользователь)
                        - Возможность поддержки и обновления
                    </considerations>
                </action>
                <action seq="3" type="map_content">
                    <description>Сопоставить содержимое с секциями</description>
                    <source>workflow/phase3_unified_understanding.xml</source>
                </action>
                <action seq="4" type="define_templates">
                    <description>Определить шаблоны для каждой секции</description>
                    <output>Структура с метаданными</output>
                </action>
                <action seq="5" type="document">
                    <description>Создать архитектурный план PRD</description>
                    <output>workflow/phase4_prd_architecture.xml</output>
                </action>
            </actions>
            
            <outputs>
                <file path="workflow/phase4_prd_architecture.xml" format="xml">
                    <structure>
                        <document_metadata>
                            <title/>
                            <version/>
                            <target_audience/>
                            <document_purpose/>
                        </document_metadata>
                        <table_of_contents>
                            <section level="1" id="" title="" purpose="" estimated_length=""/>
                        </table_of_contents>
                        <section_specifications>
                            <section id="">
                                <title/>
                                <objective/>
                                <content_sources/>
                                <required_diagrams/>
                                <subsections/>
                                <dependencies/>
                                <acceptance_criteria/>
                            </section>
                        </section_specifications>
                        <cross_references>
                            <reference from_section="" to_section="" type=""/>
                        </cross_references>
                        <appendices>
                            <appendix id="" title="" content_type=""/>
                        </appendices>
                    </structure>
                </file>
            </outputs>
            
            <checkpoints>
                <checkpoint id="cp_4_1">✓ Структура PRD разработана</checkpoint>
                <checkpoint id="cp_4_2">✓ Все секции определены с четкими целями</checkpoint>
                <checkpoint id="cp_4_3">✓ Содержимое сопоставлено с секциями</checkpoint>
                <checkpoint id="cp_4_4">✓ Шаблоны секций подготовлены</checkpoint>
            </checkpoints>
            
            <user_validation required="true">
                <prompt>
                    Структура PRD документа разработана. Предлагаемые секции:
                    
                    [Список секций с описанием]
                    
                    Соответствует ли структура вашим ожиданиям?
                    Нужны ли дополнительные секции или изменения?
                </prompt>
            </user_validation>
        </phase>

        <!-- ФАЗА 5: ДЕТАЛЬНОЕ ПЛАНИРОВАНИЕ СОДЕРЖИМОГО -->
        <phase order="5" id="content_planning" type="planning">
            <name>Детальное планирование содержимого каждой секции</name>
            <dependency>phase[order=4].user_validation.approved</dependency>
            <objective>Разработать детальный контент-план для каждой секции PRD</objective>
            
            <thinking_prompt>
                Для каждой секции продумайте:
                1. Какая конкретная информация должна быть представлена?
                2. В каком формате лучше представить (текст, таблица, код, диаграмма)?
                3. Какой уровень технической детализации оптимален?
                4. Как обеспечить логическую связность?
                5. Какие примеры или иллюстрации нужны?
                6. Какие источники данных использовать?
            </thinking_prompt>
            
            <actions>
                <action seq="1" type="load">
                    <description>Загрузить архитектуру PRD и накопленные знания</description>
                    <sources>
                        - workflow/phase4_prd_architecture.xml
                        - workflow/knowledge_base.xml
                    </sources>
                </action>
                <action seq="2" type="plan_section_by_section">
                    <description>Для КАЖДОЙ секции создать детальный план</description>
                    <process>
                        - Определить ключевые пункты
                        - Выбрать формат представления
                        - Подготовить структуру данных
                        - Определить источники
                    </process>
                </action>
                <action seq="3" type="prepare_artifacts">
                    <description>Подготовить черновики диаграмм и таблиц</description>
                    <output>Specs для визуальных элементов</output>
                </action>
                <action seq="4" type="validate_completeness">
                    <description>Проверить полноту покрытия всех требований</description>
                    <checklist>Каждое требование отражено в контент-плане</checklist>
                </action>
                <action seq="5" type="document">
                    <description>Зафиксировать детальный контент-план</description>
                    <output>workflow/phase5_content_plan.xml</output>
                </action>
            </actions>
            
            <outputs>
                <file path="workflow/phase5_content_plan.xml" format="xml">
                    <structure>
                        <content_plan>
                            <section id="" reference_to_architecture="">
                                <key_points>
                                    <point id="" text="" source_data="" priority=""/>
                                </key_points>
                                <content_blocks>
                                    <block type="text|code|table|diagram" order="">
                                        <purpose/>
                                        <content_outline/>
                                        <source_reference/>
                                    </block>
                                </content_blocks>
                                <diagrams>
                                    <diagram type="" description="" tool="" elements=""/>
                                </diagrams>
                                <code_examples>
                                    <example language="" purpose="" outline=""/>
                                </code_examples>
                                <tables>
                                    <table purpose="" columns="" data_source=""/>
                                </tables>
                                <requirements_covered>
                                    <requirement_id/>
                                </requirements_covered>
                            </section>
                        </content_plan>
                        <coverage_matrix>
                            <requirement id="" covered_in_sections="" coverage_quality=""/>
                        </coverage_matrix>
                        <dependencies>
                            <dependency from_section="" to_section="" type=""/>
                        </dependencies>
                    </structure>
                </file>
            </outputs>
            
            <checkpoints>
                <checkpoint id="cp_5_1">✓ План для каждой секции разработан</checkpoint>
                <checkpoint id="cp_5_2">✓ Все требования покрыты</checkpoint>
                <checkpoint id="cp_5_3">✓ Форматы представления определены</checkpoint>
                <checkpoint id="cp_5_4">✓ Источники данных идентифицированы</checkpoint>
            </checkpoints>
            
            <user_validation required="false">
                <prompt>
                    Контент-план готов. Краткий обзор:
                    - Количество секций: X
                    - Количество диаграмм: Y
                    - Количество примеров кода: Z
                    
                    Желаете ли просмотреть детальный план перед генерацией?
                </prompt>
            </user_validation>
        </phase>

        <!-- ФАЗА 6: PRE-ГЕНЕРАЦИЯ ВАЛИДАЦИЯ -->
        <phase order="6" id="pre_generation_validation" type="validation">
            <name>Финальная валидация перед генерацией PRD</name>
            <dependency>phase[order=5].checkpoints.passed</dependency>
            <objective>Убедиться в готовности к генерации финального документа</objective>
            
            <thinking_prompt>
                Критически оцените готовность:
                1. Вся ли необходимая информация собрана?
                2. Нет ли пробелов в контент-плане?
                3. Достаточно ли технических деталей?
                4. Корректны ли все предположения?
                5. Нет ли противоречий в планируемом содержимом?
                6. Готовы ли все необходимые данные?
            </thinking_prompt>
            
            <actions>
                <action seq="1" type="comprehensive_review">
                    <description>Провести полный обзор всех артефактов</description>
                    <scope>Все файлы workflow/phase*.xml</scope>
                </action>
                <action seq="2" type="validate_coverage">
                    <description>Проверить покрытие всех requirements</description>
                    <method>Coverage matrix analysis</method>
                </action>
                <action seq="3" type="check_consistency">
                    <description>Проверить согласованность данных</description>
                    <focus>Cross-references, dependencies, technical specs</focus>
                </action>
                <action seq="4" type="prepare_checklist">
                    <description>Подготовить pre-flight checklist</description>
                    <output>workflow/phase6_preflight_checklist.xml</output>
                </action>
                <action seq="5" type="prepare_summary">
                    <description>Подготовить executive summary для пользователя</description>
                    <format>Структурированное резюме</format>
                </action>
            </actions>
            
            <outputs>
                <file path="workflow/phase6_preflight_checklist.xml" format="xml">
                    <structure>
                        <readiness_assessment>
                            <category name="">
                                <item check="" status="ready|pending|blocked" notes=""/>
                            </category>
                        </readiness_assessment>
                        <data_completeness>
                            <section id="" data_ready="" confidence_level=""/>
                        </data_completeness>
                        <risk_assessment>
                            <risk id="" status="" mitigation_ready=""/>
                        </risk_assessment>
                        <go_no_go_decision>
                            <recommendation/>
                            <blockers/>
                            <warnings/>
                        </go_no_go_decision>
                    </structure>
                </file>
            </outputs>
            
            <checkpoints>
                <checkpoint id="cp_6_1">✓ Все данные проверены на полноту</checkpoint>
                <checkpoint id="cp_6_2">✓ Требования покрыты на 100%</checkpoint>
                <checkpoint id="cp_6_3">✓ Противоречия отсутствуют</checkpoint>
                <checkpoint id="cp_6_4">✓ Готовность подтверждена</checkpoint>
            </checkpoints>
            
            <user_validation required="true">
                <prompt>
                    ФИНАЛЬНАЯ ВАЛИДАЦИЯ перед генерацией PRD:
                    
                    Готовность: [%]
                    Покрытие требований: [%]
                    Выявленные риски: [список]
                    
                    ✅ Все системы готовы к генерации
                    
                    Подтвердите начало генерации PRD документа.
                    Это последний момент для внесения изменений.
                </prompt>
            </user_validation>
        </phase>

        <!-- ФАЗА 7: ГЕНЕРАЦИЯ PRD ДОКУМЕНТА -->
        <phase order="7" id="prd_generation" type="execution">
            <name>Генерация финального PRD документа</name>
            <dependency>phase[order=6].user_validation.approved</dependency>
            <objective>Создать полный и качественный PRD документ</objective>
            
            <thinking_prompt>
                При генерации каждой секции:
                1. Соответствует ли содержимое контент-плану?
                2. Достаточна ли техническая детализация?
                3. Ясен ли язык для целевой аудитории?
                4. Логично ли структурировано содержимое?
                5. Есть ли необходимые примеры и иллюстрации?
                6. Корректны ли cross-references?
            </thinking_prompt>
            
            <actions>
                <action seq="1" type="initialize">
                    <description>Инициализировать документ с метаданными</description>
                    <output>PRD.md (header)</output>
                </action>
                <action seq="2" type="generate_sections">
                    <description>Последовательно генерировать каждую секцию</description>
                    <process>
                        FOR EACH section IN content_plan:
                            - Load section plan
                            - Generate content
                            - Apply formatting
                            - Add diagrams/tables/code
                            - Validate quality
                            - Append to document
                    </process>
                </action>
                <action seq="3" type="add_diagrams">
                    <description>Создать и встроить диаграммы</description>
                    <formats>Mermaid, ASCII art, embedded images</formats>
                </action>
                <action seq="4" type="finalize_references">
                    <description>Добавить оглавление и ссылки</description>
                    <elements>TOC, cross-refs, appendices</elements>
                </action>
                <action seq="5" type="quality_check">
                    <description>Провести финальную проверку качества</description>
                    <checks>
                        - Форматирование
                        - Полнота
                        - Согласованность
                        - Читаемость
                    </checks>
                </action>
            </actions>
            
            <quality_criteria>
                <criterion id="qc_1">Все секции из архитектуры присутствуют</criterion>
                <criterion id="qc_2">Все требования отражены в документе</criterion>
                <criterion id="qc_3">Технические детали точны и полны</criterion>
                <criterion id="qc_4">Код-примеры рабочие и корректные</criterion>
                <criterion id="qc_5">Диаграммы информативны и понятны</criterion>
                <criterion id="qc_6">Форматирование единообразно</criterion>
                <criterion id="qc_7">Навигация удобна (TOC, ссылки)</criterion>
                <criterion id="qc_8">Язык ясен для целевой аудитории</criterion>
            </quality_criteria>
            
            <outputs>
                <file path="PRD.md" format="markdown">
                    <description>Финальный Product Requirements Document</description>
                </file>
                <file path="workflow/phase7_generation_log.xml" format="xml">
                    <structure>
                        <generation_log>
                            <section id="" timestamp="" status="" quality_score="" issues=""/>
                        </generation_log>
                        <quality_assessment>
                            <criterion id="" met="" notes=""/>
                        </quality_assessment>
                    </structure>
                </file>
            </outputs>
            
            <checkpoints>
                <checkpoint id="cp_7_1">✓ Все секции сгенерированы</checkpoint>
                <checkpoint id="cp_7_2">✓ Диаграммы и примеры добавлены</checkpoint>
                <checkpoint id="cp_7_3">✓ Качество соответствует критериям</checkpoint>
                <checkpoint id="cp_7_4">✓ PRD.md создан и валиден</checkpoint>
            </checkpoints>
            
            <user_validation required="false">
                <prompt>
                    PRD документ сгенерирован!
                    Переходим к финальной проверке...
                </prompt>
            </user_validation>
        </phase>

        <!-- ФАЗА 8: ФИНАЛЬНАЯ ВАЛИДАЦИЯ И УТВЕРЖДЕНИЕ -->
        <phase order="8" id="final_validation" type="review">
            <name>Финальная проверка и утверждение PRD</name>
            <dependency>phase[order=7].checkpoints.passed</dependency>
            <objective>Получить финальное утверждение PRD от пользователя</objective>
            
            <thinking_prompt>
                Подготовьте презентацию результата:
                1. Какие ключевые аспекты PRD выделить?
                2. Как продемонстрировать полноту покрытия?
                3. Какие моменты могут требовать пояснений?
                4. Как структурировать обратную связь?
                5. Что делать при запросе на изменения?
            </thinking_prompt>
            
            <actions>
                <action seq="1" type="prepare_presentation">
                    <description>Подготовить executive summary PRD</description>
                    <highlights>
                        - Объем документа
                        - Ключевые секции
                        - Покрытие требований
                        - Технические highlights
                    </highlights>
                </action>
                <action seq="2" type="self_review">
                    <description>Провести финальный self-review</description>
                    <checklist>Quality criteria compliance</checklist>
                </action>
                <action seq="3" type="prepare_navigation">
                    <description>Создать quick navigation guide</description>
                    <output>Как использовать PRD</output>
                </action>
                <action seq="4" type="present_to_user">
                    <description>Представить PRD пользователю для review</description>
                    <format>Структурированная презентация</format>
                </action>
                <action seq="5" type="collect_feedback">
                    <description>Собрать обратную связь</description>
                    <output>workflow/phase8_feedback.xml</output>
                </action>
            </actions>
            
            <outputs>
                <file path="workflow/phase8_final_review.xml" format="xml">
                    <structure>
                        <document_statistics>
                            <sections_count/>
                            <pages_estimate/>
                            <diagrams_count/>
                            <code_examples_count/>
                            <requirements_covered/>
                        </document_statistics>
                        <quality_assessment>
                            <criterion id="" status="" notes=""/>
                        </quality_assessment>
                        <user_feedback>
                            <feedback_item timestamp="" category="" comment="" action_required=""/>
                        </user_feedback>
                        <approval_status>
                            <status/>
                            <timestamp/>
                            <conditions/>
                        </approval_status>
                    </structure>
                </file>
            </outputs>
            
            <checkpoints>
                <checkpoint id="cp_8_1">✓ Self-review завершен</checkpoint>
                <checkpoint id="cp_8_2">✓ PRD представлен пользователю</checkpoint>
                <checkpoint id="cp_8_3">✓ Обратная связь собрана</checkpoint>
                <checkpoint id="cp_8_4">✓ Финальный статус определен</checkpoint>
            </checkpoints>
            
            <user_validation required="true">
                <prompt>
                    ФИНАЛЬНАЯ ПРОВЕРКА PRD ДОКУМЕНТА
                    
                    📊 Статистика:
                    - Секций: X
                    - Страниц (оценка): ~Y
                    - Диаграмм: Z
                    - Примеров кода: N
                    - Покрытие требований: 100%
                    
                    📋 Ключевые секции:
                    [список основных секций]
                    
                    ✅ Готово к использованию
                    
                    Пожалуйста, ознакомьтесь с PRD.md и предоставьте обратную связь:
                    - Утвердить как есть
                    - Запросить изменения (укажите что именно)
                    - Требуется дополнительная проработка (укажите область)
                </prompt>
                <options>
                    <option value="approve">Утверждаю PRD</option>
                    <option value="revisions">Требуются изменения</option>
                    <option value="major_rework">Требуется значительная доработка</option>
                </options>
            </user_validation>
        </phase>

        <!-- ФАЗА 9: ФИНАЛИЗАЦИЯ И ДОКУМЕНТИРОВАНИЕ -->
        <phase order="9" id="finalization" type="closure">
            <name>Финализация и архивирование</name>
            <dependency>phase[order=8].user_validation.approved</dependency>
            <objective>Завершить процесс и подготовить финальные артефакты</objective>
            
            <actions>
                <action seq="1" type="update_knowledge_base">
                    <description>Обновить knowledge base финальными данными</description>
                    <output>workflow/knowledge_base.xml (final)</output>
                </action>
                <action seq="2" type="create_summary">
                    <description>Создать итоговый summary проделанной работы</description>
                    <output>workflow/execution_summary.xml</output>
                </action>
                <action seq="3" type="archive_artifacts">
                    <description>Организовать все артефакты</description>
                    <structure>
                        - PRD.md (main deliverable)
                        - workflow/ (all phase artifacts)
                    </structure>
                </action>
                <action seq="4" type="prepare_handoff">
                    <description>Подготовить материалы для передачи</description>
                    <contents>
                        - README для workflow/
                        - Quick start guide
                        - Maintenance notes
                    </contents>
                </action>
            </actions>
            
            <outputs>
                <file path="workflow/execution_summary.xml" format="xml">
                    <structure>
                        <execution_metadata>
                            <start_time/>
                            <end_time/>
                            <duration/>
                            <phases_completed/>
                        </execution_metadata>
                        <deliverables>
                            <primary>
                                <file path="PRD.md" description=""/>
                            </primary>
                            <supporting>
                                <file path="" description=""/>
                            </supporting>
                        </deliverables>
                        <statistics>
                            <thinking_blocks_used/>
                            <user_interactions/>
                            <validations_performed/>
                            <revisions_made/>
                        </statistics>
                        <lessons_learned>
                            <lesson category="" description=""/>
                        </lessons_learned>
                        <recommendations>
                            <next_steps/>
                            <improvements/>
                        </recommendations>
                    </structure>
                </file>
                <file path="workflow/README.xml" format="xml">
                    <structure>
                        <overview/>
                        <directory_structure/>
                        <file_descriptions/>
                        <how_to_use/>
                    </structure>
                </file>
            </outputs>
            
            <checkpoints>
                <checkpoint id="cp_9_1">✓ Knowledge base обновлен</checkpoint>
                <checkpoint id="cp_9_2">✓ Summary создан</checkpoint>
                <checkpoint id="cp_9_3">✓ Артефакты организованы</checkpoint>
                <checkpoint id="cp_9_4">✓ Handoff материалы готовы</checkpoint>
            </checkpoints>
            
            <completion_message>
                🎉 WORKFLOW ЗАВЕРШЕН УСПЕШНО
                
                ✅ PRD документ создан: PRD.md
                ✅ Все требования покрыты: 100%
                ✅ Артефакты сохранены: workflow/
                ✅ Качество подтверждено
                
                Спасибо за сотрудничество!
                Документ готов к использованию.
            </completion_message>
        </phase>

    </workflow>

    <!-- ОБРАБОТКА ОШИБОК И EDGE CASES -->
    <error_handling>
        <strategies>
            <strategy type="checkpoint_failure">
                <action>STOP_IMMEDIATELY</action>
                <notification>❌ Checkpoint не пройден в Phase [N]</notification>
                <required_action>
                    1. Использовать &lt;thinking&gt; для анализа причины
                    2. Идентифицировать проблему
                    3. Предложить план исправления
                    4. Получить одобрение от пользователя
                    5. Исправить и повторить checkpoint
                </required_action>
            </strategy>
            
            <strategy type="user_validation_failed">
                <action>PAUSE_AND_COLLECT_FEEDBACK</action>
                <notification>⚠️ Требуются изменения по результатам валидации</notification>
                <process>
                    1. Собрать детальную обратную связь
                    2. Категоризировать изменения (minor/major)
                    3. Определить затронутые фазы
                    4. Спланировать корректировки
                    5. Выполнить изменения
                    6. Повторить валидацию
                </process>
            </strategy>
            
            <strategy type="dependency_not_met">
                <action>BLOCK_PHASE_EXECUTION</action>
                <notification>🚫 Невозможно начать Phase [N]: зависимости не удовлетворены</notification>
                <resolution>Вернуться к предыдущей фазе и завершить её корректно</resolution>
            </strategy>
            
            <strategy type="data_inconsistency">
                <action>FLAG_AND_RESOLVE</action>
                <notification>⚠️ Обнаружена несогласованность данных</notification>
                <process>
                    1. Идентифицировать источники конфликтующих данных
                    2. Проанализировать причину несогласованности
                    3. Определить корректные данные (возможно с пользователем)
                    4. Обновить все затронутые артефакты
                    5. Валидировать исправление
                </process>
            </strategy>
            
            <strategy type="user_confusion">
                <action>CLARIFY_AND_EDUCATE</action>
                <approach>
                    - Упростить терминологию
                    - Предоставить примеры
                    - Задать уточняющие вопросы
                    - Предложить альтернативные формулировки
                </approach>
            </strategy>
        </strategies>
        
        <rollback_mechanism>
            <description>
                При критических ошибках возможен откат к предыдущей успешной фазе
            </description>
            <process>
                1. Сохранить текущее состояние
                2. Загрузить checkpoint предыдущей фазы
                3. Восстановить контекст
                4. Информировать пользователя
                5. Спланировать повторное выполнение
            </process>
        </rollback_mechanism>
    </error_handling>

    <!-- ПРАВИЛА ВЫПОЛНЕНИЯ -->
    <execution_rules>
        <rule id="rule_001" priority="CRITICAL" enforcement="MANDATORY">
            Фазы выполняются СТРОГО последовательно по order (0→1→2→...→9)
        </rule>
        
        <rule id="rule_002" priority="CRITICAL" enforcement="MANDATORY">
            Переход к Phase[N+1] ТОЛЬКО после:
            - Завершения всех actions Phase[N]
            - Прохождения всех checkpoints Phase[N]
            - Получения user_validation (если required=true) Phase[N]
        </rule>
        
        <rule id="rule_003" priority="CRITICAL" enforcement="MANDATORY">
            &lt;thinking&gt; блок ОБЯЗАТЕЛЕН:
            - Перед началом каждой фазы
            - После получения данных от tools
            - После user_validation
            - При возникновении неопределенности
        </rule>
        
        <rule id="rule_004" priority="HIGH" enforcement="MANDATORY">
            Все выходные файлы ТОЛЬКО в XML формате (кроме финального PRD.md)
        </rule>
        
        <rule id="rule_005" priority="HIGH" enforcement="MANDATORY">
            При неясностях - ВСЕГДА задавать вопросы пользователю.
            НЕ делать предположений о требованиях, технических деталях, приоритетах.
        </rule>
        
        <rule id="rule_006" priority="HIGH" enforcement="RECOMMENDED">
            Накапливать знания в knowledge_base.xml на протяжении всего workflow
        </rule>
        
        <rule id="rule_007" priority="MEDIUM" enforcement="RECOMMENDED">
            User_validation: предоставлять контекст и конкретные варианты ответов
        </rule>
        
        <rule id="rule_008" priority="MEDIUM" enforcement="RECOMMENDED">
            При обнаружении ошибок - немедленно сообщать и предлагать решения
        </rule>
        
        <rule id="rule_009" priority="LOW" enforcement="OPTIONAL">
            Оптимизировать длину thinking блоков под сложность задачи
        </rule>
    </execution_rules>

    <!-- КАЧЕСТВО И КРИТЕРИИ УСПЕХА -->
    <success_criteria>
        <criterion id="sc_001" weight="30%">
            PRD документ полностью покрывает все указанные требования
        </criterion>
        <criterion id="sc_002" weight="25%">
            Техническая точность и детализация соответствуют уровню задачи
        </criterion>
        <criterion id="sc_003" weight="20%">
            Структура документа логична и удобна для использования
        </criterion>
        <criterion id="sc_004" weight="15%">
            Процесс включал активное взаимодействие с пользователем
        </criterion>
        <criterion id="sc_005" weight="10%">
            Все промежуточные артефакты созданы и структурированы
        </criterion>
    </success_criteria>

    <!-- МЕТРИКИ ВЫПОЛНЕНИЯ -->
    <metrics>
        <metric name="phases_completed" type="counter"/>
        <metric name="checkpoints_passed" type="counter"/>
        <metric name="user_validations_performed" type="counter"/>
        <metric name="thinking_blocks_used" type="counter"/>
        <metric name="questions_asked" type="counter"/>
        <metric name="revisions_requested" type="counter"/>
        <metric name="total_execution_time" type="duration"/>
        <metric name="requirements_coverage" type="percentage"/>
    </metrics>

</prd_workflow>