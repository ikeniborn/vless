<?xml version="1.0" encoding="UTF-8"?>
<analysis>
    <problem>
        <description>Скрипты vless-users, vless-logs и vless-backup не могли найти библиотечные файлы при вызове через символические ссылки</description>
        <error_messages>
            <error>/usr/local/bin/vless-users: line 10: /usr/local/bin/lib/colors.sh: No such file or directory</error>
            <error>/usr/local/bin/vless-logs: line 10: /usr/local/bin/lib/colors.sh: No such file or directory</error>
            <error>/usr/local/bin/vless-backup: line 11: /usr/local/bin/lib/colors.sh: No such file or directory</error>
        </error_messages>
    </problem>

    <root_cause>
        <finding>
            <id>1</id>
            <description>Скрипты создают символические ссылки в /usr/local/bin/, которые указывают на файлы в /opt/vless/scripts/</description>
            <location>scripts/install.sh:372-375</location>
        </finding>

        <finding>
            <id>2</id>
            <description>При вызове через символическую ссылку, SCRIPT_DIR определялся как /usr/local/bin вместо /opt/vless/scripts</description>
            <code>SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" &amp;&amp; pwd)"</code>
            <issue>Этот код не разрешает символические ссылки и возвращает директорию симлинка</issue>
        </finding>

        <finding>
            <id>3</id>
            <description>Скрипты пытались загрузить библиотеки из $SCRIPT_DIR/lib/, что приводило к неверному пути /usr/local/bin/lib/</description>
            <affected_files>
                <file>scripts/user-manager.sh</file>
                <file>scripts/logs.sh</file>
                <file>scripts/backup.sh</file>
                <file>scripts/update.sh</file>
            </affected_files>
        </finding>
    </root_cause>

    <solution>
        <step>
            <id>1</id>
            <action>Изменить определение SCRIPT_DIR для корректного разрешения символических ссылок</action>
            <old_code>SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" &amp;&amp; pwd)"</old_code>
            <new_code>SCRIPT_DIR="$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")"</new_code>
            <explanation>readlink -f разрешает все символические ссылки и возвращает абсолютный путь к реальному файлу</explanation>
        </step>

        <step>
            <id>2</id>
            <action>Применить исправление ко всем затронутым скриптам</action>
            <files_updated>
                <file>scripts/user-manager.sh</file>
                <file>scripts/logs.sh</file>
                <file>scripts/backup.sh</file>
                <file>scripts/update.sh</file>
            </files_updated>
        </step>
    </solution>

    <validation>
        <test>
            <description>Проверка синтаксиса всех исправленных скриптов</description>
            <result>PASSED</result>
            <command>bash -n [script_name]</command>
        </test>

        <test>
            <description>После применения исправлений скрипты будут корректно находить библиотеки при вызове через символические ссылки</description>
            <expected_behavior>SCRIPT_DIR будет указывать на /opt/vless/scripts независимо от способа вызова скрипта</expected_behavior>
        </test>
    </validation>

    <impact>
        <positive>
            <item>Устранены ошибки при вызове команд vless-users, vless-logs, vless-backup, vless-update</item>
            <item>Скрипты теперь корректно работают при вызове через символические ссылки</item>
            <item>Улучшена надежность системы управления VLESS</item>
        </positive>

        <requirements>
            <item>Система должна поддерживать команду readlink с флагом -f (стандарт для Linux)</item>
        </requirements>
    </impact>
</analysis>