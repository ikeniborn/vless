<?xml version="1.0" encoding="UTF-8"?>
<analysis>
    <issue>
        <description>Ошибка sed при создании конфигурации Xray во время установки</description>
        <error_message>sed: -e expression #1, char 19: unterminated `s' command</error_message>
        <location>scripts/lib/config.sh:167</location>
    </issue>

    <root_cause>
        <description>
            В функции apply_template использовалась сложная sed команда с несколькими заменами,
            разделенными точкой с запятой внутри одной строки. Это вызывало проблемы с парсингом
            на некоторых системах из-за особенностей экранирования обратных слэшей.
        </description>
        <problematic_code><![CDATA[
value=$(echo "$value" | sed 's/\\/\\\\/g; s/\//\\\//g; s/&/\\&/g')
        ]]></problematic_code>
    </root_cause>

    <solution>
        <description>
            Разделение сложной sed команды на три отдельные команды в пайпе,
            что устраняет проблемы с парсингом и делает код более читаемым.
        </description>
        <fixed_code><![CDATA[
value=$(echo "$value" | sed 's/\\/\\\\/g' | sed 's/\//\\\//g' | sed 's/&/\\&/g')
        ]]></fixed_code>
    </solution>

    <testing>
        <test name="syntax_validation">
            <status>PASSED</status>
            <description>Все bash скрипты прошли проверку синтаксиса</description>
        </test>
        <test name="template_application">
            <status>PASSED</status>
            <description>Функция apply_template успешно применяет шаблоны</description>
        </test>
        <test name="special_characters">
            <status>PASSED</status>
            <description>Корректная обработка специальных символов (/, \, &)</description>
        </test>
    </testing>

    <impact>
        <severity>HIGH</severity>
        <affected_component>Installation Process</affected_component>
        <description>
            Ошибка блокировала процесс установки на этапе создания конфигурации,
            делая невозможным развертывание VPN сервиса.
        </description>
    </impact>
</analysis>
