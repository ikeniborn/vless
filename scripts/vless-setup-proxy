#!/bin/bash
# cli/vless-setup-proxy
#
# VLESS v5.15 - Interactive Reverse Proxy Setup Wizard
# Guides user through complete reverse proxy configuration
#
# Features:
# - Domain validation (DNS mandatory via validate_dns_for_domain)
# - Certificate acquisition (unified workflow via acquire_certificate_for_domain)
# - Nginx config generation (security-hardened, localhost-only)
# - fail2ban multi-port protection
# - HAProxy SNI routing (NO UFW port opening required)
# - Subdomain-based access: https://domain (NO port number!)
# - v5.10: Advanced options wizard (OAuth2, WebSocket, CSP)
# - v5.11: Enhanced security headers (COOP, COEP, CORP, Expect-CT)
# - v5.14: Comprehensive pre-flight checks (CRITICAL BEFORE INSTALLATION)
#   * Docker containers status (HAProxy, Nginx)
#   * Disk space validation (100MB minimum)
#   * Proxy limit enforcement (10 slots max)
#   * Port availability (database, nginx, docker-compose, system)
#   * Domain uniqueness verification
#   * Cloudflare Bot Management detection (4 methods)
#   * Target site reachability check
# - v5.15: Enhanced pre-flight checks (4 NEW CHECKS)
#   * DNS pre-validation (A/AAAA records, IP verification)
#   * fail2ban status check (brute-force protection awareness)
#   * Rate limit zone validation (nginx crash loop prevention + auto-fix)
#   * HAProxy config syntax validation (prevent startup failures)
#
# Version: 5.15.0
# Author: VLESS Development Team
# Date: 2025-10-21

set -euo pipefail

# =============================================================================
# Configuration
# =============================================================================

INSTALL_PATH="/opt/vless"
LIB_PATH="${INSTALL_PATH}/lib"

# =============================================================================
# Colors & Formatting (defined BEFORE sourcing to avoid readonly conflicts)
# =============================================================================

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'
BOLD='\033[1m'

# Source library files
source "${LIB_PATH}/certificate_manager.sh"     # v4.3: DNS validation + unified cert acquisition
source "${LIB_PATH}/haproxy_config_manager.sh"  # v4.3: HAProxy dynamic routing
source "${LIB_PATH}/nginx_config_generator.sh"
# source "${LIB_PATH}/xray_http_inbound.sh"  # v5.3: Deprecated - nginx proxies directly to target
source "${LIB_PATH}/letsencrypt_integration.sh"
source "${LIB_PATH}/fail2ban_config.sh"
source "${LIB_PATH}/reverseproxy_db.sh"
source "${LIB_PATH}/docker_compose_manager.sh"

# Icons
ICON_INFO="‚ÑπÔ∏è"
ICON_SUCCESS="‚úÖ"
ICON_WARNING="‚ö†Ô∏è"
ICON_ERROR="‚ùå"
ICON_ROCKET="üöÄ"
ICON_LOCK="üîí"
ICON_GLOBE="üåê"
ICON_KEY="üîë"

# =============================================================================
# Helper Functions
# =============================================================================

print_header() {
    echo "" >&2
    echo -e "${CYAN}${BOLD}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}" >&2
    echo -e "${CYAN}${BOLD}  $1${NC}" >&2
    echo -e "${CYAN}${BOLD}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}" >&2
    echo "" >&2
}

print_step() {
    echo -e "${BLUE}${BOLD}‚ñ∂ $1${NC}" >&2
}

print_success() {
    echo -e "${GREEN}${ICON_SUCCESS} $1${NC}" >&2
}

print_error() {
    echo -e "${RED}${ICON_ERROR} $1${NC}" >&2
}

print_warning() {
    echo -e "${YELLOW}${ICON_WARNING} $1${NC}" >&2
}

print_info() {
    echo -e "${CYAN}${ICON_INFO} $1${NC}" >&2
}

# =============================================================================
# Validation Functions
# =============================================================================

validate_domain() {
    local domain="$1"

    # Basic regex validation
    if ! [[ "$domain" =~ ^[a-zA-Z0-9][a-zA-Z0-9.-]+[a-zA-Z0-9]$ ]]; then
        return 1
    fi

    # Length check
    if [ ${#domain} -lt 4 ] || [ ${#domain} -gt 253 ]; then
        return 1
    fi

    return 0
}

check_dns_resolution() {
    local domain="$1"
    local server_ip

    print_step "–ü—Ä–æ–≤–µ—Ä–∫–∞ DNS —Ä–µ–∑–æ–ª—é—Ü–∏–∏ –¥–ª—è $domain..."

    # Get server's public IP
    server_ip=$(curl -s https://api.ipify.org 2>/dev/null || curl -s https://ifconfig.me 2>/dev/null || echo "")

    if [[ -z "$server_ip" ]]; then
        print_error "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—É–±–ª–∏—á–Ω—ã–π IP —Å–µ—Ä–≤–µ—Ä–∞"
        return 1
    fi

    print_info "–ü—É–±–ª–∏—á–Ω—ã–π IP —Å–µ—Ä–≤–µ—Ä–∞: $server_ip"

    # Resolve domain
    local domain_ip
    domain_ip=$(dig +short "$domain" @8.8.8.8 2>/dev/null | tail -1)

    if [[ -z "$domain_ip" ]]; then
        print_error "–î–æ–º–µ–Ω $domain –Ω–µ —Ä–µ–∑–æ–ª–≤–∏—Ç—Å—è"
        print_warning "–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–æ–∑–¥–∞–Ω–∞ A-–∑–∞–ø–∏—Å—å, —É–∫–∞–∑—ã–≤–∞—é—â–∞—è –Ω–∞ $server_ip"
        return 1
    fi

    print_info "–î–æ–º–µ–Ω —Ä–µ–∑–æ–ª–≤–∏—Ç—Å—è –≤: $domain_ip"

    # Check if IPs match
    if [[ "$domain_ip" != "$server_ip" ]]; then
        print_error "DNS –∑–∞–ø–∏—Å—å –Ω–µ —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ —ç—Ç–æ—Ç —Å–µ—Ä–≤–µ—Ä"
        print_error "  –û–∂–∏–¥–∞–µ—Ç—Å—è: $server_ip"
        print_error "  –ü–æ–ª—É—á–µ–Ω–æ:  $domain_ip"
        print_warning "–û–±–Ω–æ–≤–∏—Ç–µ A-–∑–∞–ø–∏—Å—å –¥–ª—è $domain ‚Üí $server_ip"
        return 1
    fi

    print_success "DNS —Ä–µ–∑–æ–ª—é—Ü–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞"
    return 0
}

validate_target_site() {
    local target="$1"

    print_step "–í–∞–ª–∏–¥–∞—Ü–∏—è —Ü–µ–ª–µ–≤–æ–≥–æ —Å–∞–π—Ç–∞: $target..."

    # Check reachability
    if ! curl -s -I --max-time 10 "https://${target}" > /dev/null 2>&1; then
        print_error "–¶–µ–ª–µ–≤–æ–π —Å–∞–π—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: https://${target}"
        return 1
    fi

    # Check TLS 1.3 support
    if ! curl -sI --tlsv1.3 --tls-max 1.3 --max-time 10 "https://${target}" > /dev/null 2>&1; then
        print_warning "–¶–µ–ª–µ–≤–æ–π —Å–∞–π—Ç –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç TLS 1.3"
        print_warning "–≠—Ç–æ –º–æ–∂–µ—Ç —Å–Ω–∏–∑–∏—Ç—å —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å, –Ω–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ"
    fi

    print_success "–¶–µ–ª–µ–≤–æ–π —Å–∞–π—Ç –≤–∞–ª–∏–¥–µ–Ω –∏ –¥–æ—Å—Ç—É–ø–µ–Ω"
    return 0
}

check_port_available() {
    local port="$1"

    if sudo ss -tulnp | grep -q ":${port} "; then
        print_error "–ü–æ—Ä—Ç $port —É–∂–µ –∑–∞–Ω—è—Ç"
        sudo ss -tulnp | grep ":${port} "
        return 1
    fi

    print_success "–ü–æ—Ä—Ç $port –¥–æ—Å—Ç—É–ø–µ–Ω"
    return 0
}

# =============================================================================
# Interactive Input Functions
# =============================================================================

prompt_domain() {
    local domain

    print_header "–®–∞–≥ 1: –î–æ–º–µ–Ω –¥–ª—è Reverse Proxy"

    echo -e "${CYAN}–í–≤–µ–¥–∏—Ç–µ –¥–æ–º–µ–Ω –¥–ª—è reverse proxy (–Ω–∞–ø—Ä–∏–º–µ—Ä, proxy.example.com):${NC}" >&2
    echo -e "${YELLOW}–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:${NC}" >&2
    echo "  - –î–æ–º–µ–Ω –¥–æ–ª–∂–µ–Ω —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ IP —ç—Ç–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ (A-–∑–∞–ø–∏—Å—å)" >&2
    echo "  - –ë—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–µ–Ω Let's Encrypt —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç" >&2
    echo "" >&2

    while true; do
        read -p "–î–æ–º–µ–Ω: " domain

        if ! validate_domain "$domain"; then
            print_error "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–æ–º–µ–Ω–∞"
            continue
        fi

        # Check if domain already exists
        if get_proxy "$domain" > /dev/null 2>&1; then
            print_error "Reverse proxy –¥–ª—è –¥–æ–º–µ–Ω–∞ $domain —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
            echo "" >&2
            read -p "–•–æ—Ç–∏—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é? [y/N]: " -n 1 -r
            echo
            if [[ $REPLY =~ ^[Yy]$ ]]; then
                sudo vless-proxy show "$domain"
            fi
            continue
        fi

        # Check DNS
        if ! check_dns_resolution "$domain"; then
            echo "" >&2
            read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ DNS –æ—à–∏–±–∫—É? [y/N]: " -n 1 -r
            echo
            if [[ ! $REPLY =~ ^[Yy]$ ]]; then
                continue
            fi
        fi

        break
    done

    echo "$domain"
}

prompt_target_site() {
    local target

    print_header "–®–∞–≥ 2: –¶–µ–ª–µ–≤–æ–π –°–∞–π—Ç (–ü—Ä–æ–∫—Å–∏—Ä—É–µ–º—ã–π)"

    echo -e "${CYAN}–í–≤–µ–¥–∏—Ç–µ —Ü–µ–ª–µ–≤–æ–π —Å–∞–π—Ç –¥–ª—è –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, blocked-site.com):${NC}" >&2
    echo -e "${YELLOW}–ß—Ç–æ —ç—Ç–æ:${NC}" >&2
    echo "  - –°–∞–π—Ç, –∫ –∫–æ—Ç–æ—Ä–æ–º—É –Ω—É–∂–µ–Ω –¥–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏" >&2
    echo "  - –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –±—É–¥—É—Ç –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ —ç—Ç–æ—Ç –¥–æ–º–µ–Ω" >&2
    echo "  - –ó–∞–ø—Ä–æ—Å—ã –Ω–∞ –¥—Ä—É–≥–∏–µ –¥–æ–º–µ–Ω—ã –±—É–¥—É—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã (–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)" >&2
    echo "" >&2

    while true; do
        read -p "–¶–µ–ª–µ–≤–æ–π —Å–∞–π—Ç: " target

        if ! validate_domain "$target"; then
            print_error "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–æ–º–µ–Ω–∞"
            continue
        fi

        if ! validate_target_site "$target"; then
            echo "" >&2
            read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –æ—à–∏–±–∫—É –≤–∞–ª–∏–¥–∞—Ü–∏–∏? [y/N]: " -n 1 -r
            echo
            if [[ ! $REPLY =~ ^[Yy]$ ]]; then
                continue
            fi
        fi

        break
    done

    echo "$target"
}

prompt_port() {
    local port
    local proxy_count

    print_header "–®–∞–≥ 3: Nginx Backend Port (localhost-only)"

    proxy_count=$(get_proxy_count)

    echo -e "${CYAN}–í—ã–±–µ—Ä–∏—Ç–µ localhost-only –ø–æ—Ä—Ç –¥–ª—è nginx backend:${NC}" >&2
    echo -e "${YELLOW}–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–æ—Ä—Ç—ã: 9443-9452 (–≤—Å–µ–≥–æ 10 —Å–ª–æ—Ç–æ–≤)${NC}" >&2
    echo "  –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ: $proxy_count/10" >&2
    echo "" >&2
    echo -e "${CYAN}${ICON_INFO} v4.3 HAProxy Architecture:${NC}" >&2
    echo "  - Nginx —Å–ª—É—à–∞–µ—Ç –Ω–∞ 127.0.0.1:<port> (localhost-only)" >&2
    echo "  - HAProxy –º–∞—Ä—à—Ä—É—Ç–∏–∑–∏—Ä—É–µ—Ç –ø–æ SNI —Å –ø–æ—Ä—Ç–∞ 443" >&2
    echo "  - –ü—É–±–ª–∏—á–Ω—ã–π –¥–æ—Å—Ç—É–ø: https://<domain> (–ë–ï–ó –Ω–æ–º–µ—Ä–∞ –ø–æ—Ä—Ç–∞!)" >&2
    echo "" >&2

    # Auto-suggest next available port (v4.3)
    local suggested_port
    if suggested_port=$(get_next_available_port 2>/dev/null); then
        echo -e "${GREEN}–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è (–∞–≤—Ç–æ-–≤—ã–±–æ—Ä): $suggested_port${NC}" >&2
    else
        # Fallback if get_next_available_port fails
        suggested_port=$((9443 + proxy_count))
        echo -e "${YELLOW}–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è: $suggested_port${NC}" >&2
    fi

    echo "" >&2

    while true; do
        read -p "–ü–æ—Ä—Ç [$suggested_port]: " port
        port=${port:-$suggested_port}

        # Validate port range (v4.3: 9443-9452)
        if [ "$port" -lt 9443 ] || [ "$port" -gt 9452 ]; then
            print_error "–ü–æ—Ä—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ 9443-9452"
            continue
        fi

        # Check if port is already occupied (database + nginx configs)
        # v5.8: Enhanced port detection - checks both DB and nginx configs to prevent conflicts
        local config_dir="/opt/vless/config/reverse-proxy"
        local db_file="/opt/vless/config/reverse_proxies.json"

        # Collect used ports from database
        local db_ports=""
        if [[ -f "$db_file" ]]; then
            db_ports=$(jq -r '.proxies[].port' "$db_file" 2>/dev/null | sort -n)
        fi

        # Collect used ports from nginx configs
        local nginx_ports=""
        if [[ -d "$config_dir" ]]; then
            nginx_ports=$(grep -h "listen.*:" "$config_dir"/*.conf 2>/dev/null | \
                          grep -oP 'listen\s+[\d.]+:\K\d+' | \
                          sort -n | uniq)
        fi

        # Merge both lists
        local all_ports=$(echo -e "${db_ports}\n${nginx_ports}" | sort -n | uniq | grep -v '^$')

        # Check if port is occupied
        if echo "$all_ports" | grep -q "^${port}$"; then
            print_error "–ü–æ—Ä—Ç $port —É–∂–µ –∑–∞–Ω—è—Ç –¥—Ä—É–≥–∏–º reverse proxy"
            print_info "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É: sudo vless-proxy list"
            continue
        fi

        break
    done

    echo "$port"
}

prompt_letsencrypt_email() {
    local email

    print_header "–®–∞–≥ 4: Let's Encrypt Email"

    echo -e "${CYAN}–í–≤–µ–¥–∏—Ç–µ email –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π Let's Encrypt:${NC}" >&2
    echo -e "${YELLOW}–î–ª—è —á–µ–≥–æ:${NC}" >&2
    echo "  - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –∏—Å—Ç–µ—á–µ–Ω–∏–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞" >&2
    echo "  - –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è" >&2
    echo "  - Email –ù–ï –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è, –æ—Å—Ç–∞—ë—Ç—Å—è –ø—Ä–∏–≤–∞—Ç–Ω—ã–º" >&2
    echo "" >&2

    while true; do
        read -p "Email: " email

        # Basic email validation
        if ! [[ "$email" =~ ^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$ ]]; then
            print_error "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email"
            continue
        fi

        break
    done

    echo "$email"
}

prompt_advanced_options() {
    print_header "–®–∞–≥ 5: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –û–ø—Ü–∏–∏ (v5.11)"

    echo -e "${CYAN}–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≤–∞—à–µ–≥–æ reverse proxy:${NC}" >&2
    echo "" >&2

    # OAuth2 Support
    echo -e "${YELLOW}1. OAuth2 / Large Cookie Support${NC}" >&2
    echo "   –î–ª—è —Å–∞–π—Ç–æ–≤ —Å OAuth2, Google Auth, –∏–ª–∏ –±–æ–ª—å—à–∏–º–∏ cookies (>4kb)" >&2
    echo "   –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –±—É—Ñ–µ—Ä—ã: 32k/16x32k/64k" >&2
    read -p "   –í–∫–ª—é—á–∏—Ç—å OAuth2 support? [Y/n]: " -n 1 -r oauth2_choice
    echo
    if [[ $oauth2_choice =~ ^[Nn]$ ]]; then
        export OAUTH2_SUPPORT="false"
    else
        export OAUTH2_SUPPORT="true"
    fi
    echo "" >&2

    # WebSocket Support
    echo -e "${YELLOW}2. WebSocket Support${NC}" >&2
    echo "   –î–ª—è real-time –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π (chat, dashboards, collaborative editing)" >&2
    echo "   –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç timeouts: 3600s (1 hour)" >&2
    read -p "   –í–∫–ª—é—á–∏—Ç—å WebSocket support? [Y/n]: " -n 1 -r websocket_choice
    echo
    if [[ $websocket_choice =~ ^[Nn]$ ]]; then
        export ENABLE_WEBSOCKET="false"
    else
        export ENABLE_WEBSOCKET="true"
    fi
    echo "" >&2

    # CSP Header Handling
    echo -e "${YELLOW}3. Content Security Policy (CSP) Headers${NC}" >&2
    echo "   CSP –æ—Ç —Ü–µ–ª–µ–≤–æ–≥–æ —Å–∞–π—Ç–∞ –º–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Ä–µ—Å—É—Ä—Å—ã —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏-–¥–æ–º–µ–Ω" >&2
    echo "   –û–ø—Ü–∏–∏:" >&2
    echo "     - Strip (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è): –£–¥–∞–ª–∏—Ç—å CSP headers –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏" >&2
    echo "     - Keep: –°–æ—Ö—Ä–∞–Ω–∏—Ç—å CSP (–º–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –Ω–µ–∫–æ—Ç–æ—Ä—ã–º–∏ —Å–∞–π—Ç–∞–º–∏)" >&2
    read -p "   Strip CSP headers? [Y/n]: " -n 1 -r csp_choice
    echo
    if [[ $csp_choice =~ ^[Nn]$ ]]; then
        export STRIP_CSP="false"
    else
        export STRIP_CSP="true"
    fi
    echo "" >&2

    # Enhanced Security Headers (v5.11)
    echo -e "${YELLOW}4. Enhanced Security Headers (v5.11)${NC}" >&2
    echo "   –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (COOP, COEP, CORP, Expect-CT)" >&2
    echo "   –£–ª—É—á—à–∞—é—Ç browser isolation –∏ –∑–∞—â–∏—Ç—É –æ—Ç –∞—Ç–∞–∫" >&2
    echo "   ${RED}–í–ù–ò–ú–ê–ù–ò–ï:${NC} –ú–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å —Å —Å–∞–π—Ç–∞–º–∏, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–º–∏ cross-origin —Ä–µ—Å—É—Ä—Å—ã" >&2
    echo "   –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è: OFF –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ —Å–∞–π—Ç–æ–≤" >&2
    read -p "   –í–∫–ª—é—á–∏—Ç—å Enhanced Security Headers? [y/N]: " -n 1 -r security_choice
    echo
    if [[ $security_choice =~ ^[Yy]$ ]]; then
        export ENHANCED_SECURITY_HEADERS="true"
    else
        export ENHANCED_SECURITY_HEADERS="false"
    fi
    echo "" >&2

    # Custom User-Agent (v5.13)
    echo -e "${YELLOW}5. Custom User-Agent (v5.13)${NC}" >&2
    echo "   –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Å–∞–π—Ç—ã –±–ª–æ–∫–∏—Ä—É—é—Ç –ø—Ä–æ–∫—Å–∏ –∑–∞–ø—Ä–æ—Å—ã (Cloudflare –∑–∞—â–∏—Ç–∞)" >&2
    echo "   –ü—Ä–∏–º–µ—Ä: claude.ai, chatgpt.com —Ç—Ä–µ–±—É—é—Ç —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π User-Agent" >&2
    echo "   –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: Mozilla/5.0 Chrome (—Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –±—Ä–∞—É–∑–µ—Ä)" >&2
    echo -e "   ${YELLOW}–ü–†–ò–ú–ï–ß–ê–ù–ò–ï:${NC} –î–ª—è —Å–∞–π—Ç–æ–≤ —Å Cloudflare Bot Management –º–æ–∂–µ—Ç –Ω–µ –ø–æ–º–æ—á—å" >&2
    read -p "   –ò–∑–º–µ–Ω–∏—Ç—å User-Agent? [y/N]: " -n 1 -r ua_choice
    echo
    if [[ $ua_choice =~ ^[Yy]$ ]]; then
        echo -n "   –í–≤–µ–¥–∏—Ç–µ User-Agent (–∏–ª–∏ Enter –¥–ª—è default): " >&2
        read -r custom_ua
        if [[ -n "$custom_ua" ]]; then
            export CUSTOM_USER_AGENT="$custom_ua"
        else
            export CUSTOM_USER_AGENT="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
        fi
    else
        export CUSTOM_USER_AGENT="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
    fi
    echo "" >&2

    # Summary
    print_info "–í—ã–±—Ä–∞–Ω–Ω—ã–µ –æ–ø—Ü–∏–∏:"
    echo "  OAuth2 Support:          ${OAUTH2_SUPPORT}" >&2
    echo "  WebSocket Support:       ${ENABLE_WEBSOCKET}" >&2
    echo "  Strip CSP:               ${STRIP_CSP}" >&2
    echo "  Enhanced Security (NEW): ${ENHANCED_SECURITY_HEADERS}" >&2
    echo "  Custom User-Agent:       ${CUSTOM_USER_AGENT:0:50}..." >&2
    echo "" >&2
}

# =============================================================================
# Pre-flight Checks (v5.14)
# =============================================================================

check_proxy_limitations() {
    local domain="$1"
    local target="$2"
    local port="$3"

    local has_limitations=false
    local limitation_messages=()
    local warnings=()

    print_header "–ü—Ä–æ–≤–µ—Ä–∫–∞ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π (v5.14)"

    # Check 0: Docker containers status
    print_step "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."

    local haproxy_status
    haproxy_status=$(docker ps --filter "name=vless_haproxy" --format "{{.Status}}" 2>/dev/null)

    if [ -z "$haproxy_status" ]; then
        limitation_messages+=("‚ùå –ö–†–ò–¢–ò–ß–ù–û: HAProxy –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω")
        limitation_messages+=("   –ó–∞–ø—É—Å—Ç–∏—Ç–µ VPN —Å–µ—Ä–≤–µ—Ä: cd /opt/vless && docker compose up -d")
        has_limitations=true
    elif ! echo "$haproxy_status" | grep -q "Up"; then
        limitation_messages+=("‚ùå –ö–†–ò–¢–ò–ß–ù–û: HAProxy –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç (—Å—Ç–∞—Ç—É—Å: $haproxy_status)")
        limitation_messages+=("   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: docker logs vless_haproxy --tail 50")
        has_limitations=true
    else
        print_success "HAProxy –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç"
    fi

    local nginx_status
    nginx_status=$(docker ps --filter "name=vless_nginx_reverseproxy" --format "{{.Status}}" 2>/dev/null)

    if [ -z "$nginx_status" ]; then
        limitation_messages+=("‚ùå –ö–†–ò–¢–ò–ß–ù–û: Nginx Reverse Proxy –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω")
        limitation_messages+=("   –ó–∞–ø—É—Å—Ç–∏—Ç–µ VPN —Å–µ—Ä–≤–µ—Ä: cd /opt/vless && docker compose up -d")
        has_limitations=true
    elif ! echo "$nginx_status" | grep -q "Up"; then
        limitation_messages+=("‚ùå –ö–†–ò–¢–ò–ß–ù–û: Nginx –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç (—Å—Ç–∞—Ç—É—Å: $nginx_status)")
        limitation_messages+=("   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: docker logs vless_nginx_reverseproxy --tail 50")
        has_limitations=true
    else
        print_success "Nginx Reverse Proxy –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç"
    fi

    # Check 1: Disk space
    print_step "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞..."

    local disk_free_mb
    disk_free_mb=$(df -BM /opt/vless | tail -1 | awk '{print $4}' | sed 's/M//')

    if [ "$disk_free_mb" -lt 100 ]; then
        limitation_messages+=("‚ùå –ö–†–ò–¢–ò–ß–ù–û: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–µ—Å—Ç–∞ –Ω–∞ –¥–∏—Å–∫–µ (/opt/vless: ${disk_free_mb}MB)")
        limitation_messages+=("   –¢—Ä–µ–±—É–µ—Ç—Å—è –º–∏–Ω–∏–º—É–º 100MB –¥–ª—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ –∏ –ª–æ–≥–æ–≤")
        has_limitations=true
    elif [ "$disk_free_mb" -lt 500 ]; then
        warnings+=("‚ö†Ô∏è  –ú–∞–ª–æ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞: ${disk_free_mb}MB (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è >500MB)")
    else
        print_success "–°–≤–æ–±–æ–¥–Ω–æ: ${disk_free_mb}MB"
    fi

    # Check 2: Maximum proxy limit (10 slots)
    print_step "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ –ø—Ä–æ–∫—Å–∏..."

    local proxy_count
    proxy_count=$(get_proxy_count 2>/dev/null || echo "0")

    if [ "$proxy_count" -ge 10 ]; then
        limitation_messages+=("‚ùå –ö–†–ò–¢–ò–ß–ù–û: –î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –ø—Ä–æ–∫—Å–∏ (10/10)")
        limitation_messages+=("   –ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–¥–∞–ª–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø—Ä–æ–∫—Å–∏ –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ")
        limitation_messages+=("   –ö–æ–º–∞–Ω–¥–∞: sudo vless-proxy list")
        has_limitations=true
    elif [ "$proxy_count" -ge 8 ]; then
        warnings+=("‚ö†Ô∏è  –û—Å—Ç–∞–ª–æ—Å—å —Å–ª–æ—Ç–æ–≤: $((10 - proxy_count))/10")
    else
        print_success "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ —Å–ª–æ—Ç–æ–≤: $proxy_count/10"
    fi

    # Check 3: Port availability (comprehensive check)
    print_step "–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ø–æ—Ä—Ç–∞ $port..."

    local port_check_failed=false
    local port_check_details=()

    # Validate port range
    if [ "$port" -lt 9443 ] || [ "$port" -gt 9452 ]; then
        limitation_messages+=("‚ùå –ö–†–ò–¢–ò–ß–ù–û: –ü–æ—Ä—Ç $port –≤–Ω–µ –¥–æ–ø—É—Å—Ç–∏–º–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞")
        limitation_messages+=("   –î–æ–ø—É—Å—Ç–∏–º—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω: 9443-9452")
        has_limitations=true
        port_check_failed=true
    fi

    if [ "$port_check_failed" = false ]; then
        # Check in database
        if [ -f "/opt/vless/config/reverse_proxies.json" ]; then
            local db_ports
            db_ports=$(jq -r '.proxies[].port' /opt/vless/config/reverse_proxies.json 2>/dev/null | grep "^${port}$")
            if [ -n "$db_ports" ]; then
                port_check_failed=true
                local domain_using_port
                domain_using_port=$(jq -r ".proxies[] | select(.port == $port) | .domain" /opt/vless/config/reverse_proxies.json 2>/dev/null)
                port_check_details+=("   - –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: –ø–æ—Ä—Ç –∑–∞–Ω—è—Ç –¥–æ–º–µ–Ω–æ–º $domain_using_port")
            fi
        fi

        # Check in nginx configs
        if [ -d "/opt/vless/config/reverse-proxy" ]; then
            local nginx_config_with_port
            nginx_config_with_port=$(grep -l "listen.*:${port}" /opt/vless/config/reverse-proxy/*.conf 2>/dev/null | head -1)
            if [ -n "$nginx_config_with_port" ]; then
                port_check_failed=true
                port_check_details+=("   - Nginx config: –ø–æ—Ä—Ç –∑–∞–Ω—è—Ç –≤ $(basename "$nginx_config_with_port")")
            fi
        fi

        # Check in docker-compose.yml
        if [ -f "/opt/vless/docker-compose.yml" ]; then
            local docker_ports
            docker_ports=$(grep ":${port}" /opt/vless/docker-compose.yml 2>/dev/null)
            if [ -n "$docker_ports" ]; then
                port_check_failed=true
                port_check_details+=("   - Docker Compose: –ø–æ—Ä—Ç —É–∂–µ –ø—Ä–æ–±—Ä–æ—à–µ–Ω")
            fi
        fi

        # Check if port is actually listening (netstat/ss)
        if command -v ss >/dev/null 2>&1; then
            local listening_port
            listening_port=$(ss -tuln | grep ":${port} " 2>/dev/null)
            if [ -n "$listening_port" ]; then
                port_check_failed=true
                port_check_details+=("   - –°–∏—Å—Ç–µ–º–∞: –ø–æ—Ä—Ç —É–∂–µ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–µ—Ç—Å—è")
            fi
        fi
    fi

    if [ "$port_check_failed" = true ]; then
        limitation_messages+=("‚ùå –ö–†–ò–¢–ò–ß–ù–û: –ü–æ—Ä—Ç $port –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω")
        for detail in "${port_check_details[@]}"; do
            limitation_messages+=("$detail")
        done
        limitation_messages+=("   –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥—Ä—É–≥–æ–π –ø–æ—Ä—Ç –∏–∑ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ 9443-9452")
        limitation_messages+=("   –°–≤–æ–±–æ–¥–Ω—ã–µ –ø–æ—Ä—Ç—ã –º–æ–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å: sudo vless-proxy list")
        has_limitations=true
    else
        print_success "–ü–æ—Ä—Ç $port –¥–æ—Å—Ç—É–ø–µ–Ω"
    fi

    # Check 4: Domain already exists
    print_step "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –¥–æ–º–µ–Ω–∞ –≤ –ë–î..."

    if proxy_exists "$domain" 2>/dev/null; then
        limitation_messages+=("‚ùå –ö–†–ò–¢–ò–ß–ù–û: –î–æ–º–µ–Ω $domain —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –ë–î")
        limitation_messages+=("   –£–¥–∞–ª–∏—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø—Ä–æ–∫—Å–∏: sudo vless-proxy remove $domain")
        has_limitations=true
    else
        print_success "–î–æ–º–µ–Ω $domain –¥–æ—Å—Ç—É–ø–µ–Ω"
    fi

    # Check 5: Cloudflare Bot Management detection
    print_step "–ü—Ä–æ–≤–µ—Ä–∫–∞ Cloudflare –∑–∞—â–∏—Ç—ã –Ω–∞ $target..."

    local has_cloudflare=false
    local cloudflare_details=""
    local cf_detection_methods=()

    # Method 1: Check HTTP headers
    local cf_headers
    cf_headers=$(timeout 10 curl -sI --max-time 10 "https://$target" 2>/dev/null | grep -iE "cf-|cloudflare|server: cloudflare")

    if [ -n "$cf_headers" ]; then
        has_cloudflare=true
        cf_detection_methods+=("HTTP headers")
    fi

    # Method 2: Check for Cloudflare challenge page
    local cf_challenge
    cf_challenge=$(timeout 10 curl -sL --max-time 10 "https://$target" 2>/dev/null | grep -i "checking your browser\|cloudflare" | head -1)

    if [ -n "$cf_challenge" ]; then
        has_cloudflare=true
        cf_detection_methods+=("Challenge page detected")
    fi

    # Method 3: DNS resolution check (Cloudflare IP ranges)
    if command -v dig >/dev/null 2>&1; then
        local target_ip
        target_ip=$(dig +short "$target" 2>/dev/null | grep -E '^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$' | head -1)

        if [ -n "$target_ip" ]; then
            # Check if IP is in Cloudflare ranges (simplified check for common ranges)
            if echo "$target_ip" | grep -qE '^(104\.1[6-9]\.|104\.2[0-9]\.|104\.3[0-1]\.|172\.6[4-7]\.|173\.245\.|188\.114\.|190\.93\.|197\.234\.|198\.41\.|162\.158\.|104\.244\.)'; then
                has_cloudflare=true
                cf_detection_methods+=("IP in Cloudflare range: $target_ip")
            fi
        fi
    fi

    # Method 4: Try simple request with curl (403 Forbidden check)
    local http_code
    http_code=$(timeout 10 curl -s -o /dev/null -w "%{http_code}" --max-time 10 "https://$target" 2>/dev/null)

    if [ "$http_code" = "403" ]; then
        has_cloudflare=true
        cf_detection_methods+=("403 Forbidden response")
    fi

    if [ "$has_cloudflare" = true ]; then
        cloudflare_details="–ú–µ—Ç–æ–¥—ã –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è: ${cf_detection_methods[*]}"

        warnings+=("")
        warnings+=("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê")
        warnings+=("‚ö†Ô∏è  ${BOLD}–û–ë–ù–ê–†–£–ñ–ï–ù–ê CLOUDFLARE –ó–ê–©–ò–¢–ê${NC}")
        warnings+=("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê")
        warnings+=("")
        warnings+=("   –¶–µ–ª–µ–≤–æ–π —Å–∞–π—Ç: ${BOLD}$target${NC}")
        warnings+=("   $cloudflare_details")
        warnings+=("")
        warnings+=("   ${RED}${BOLD}–í–ê–ñ–ù–û:${NC} Reverse proxy ${RED}–ù–ï –ë–£–î–ï–¢ –†–ê–ë–û–¢–ê–¢–¨${NC} –¥–ª—è —ç—Ç–æ–≥–æ —Å–∞–π—Ç–∞!")
        warnings+=("   Cloudflare Bot Management –±–ª–æ–∫–∏—Ä—É–µ—Ç –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã.")
        warnings+=("")
        warnings+=("   ${YELLOW}–ü—Ä–∏–º–µ—Ä—ã —Å–∞–π—Ç–æ–≤ —Å Cloudflare –∑–∞—â–∏—Ç–æ–π:${NC}")
        warnings+=("   - claude.ai")
        warnings+=("   - chatgpt.com")
        warnings+=("   - notion.so")
        warnings+=("   - discord.com")
        warnings+=("")
        warnings+=("   ${GREEN}${BOLD}–†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ VLESS SOCKS5/HTTP –ø—Ä–æ–∫—Å–∏${NC}")
        warnings+=("   SOCKS5/HTTP –ø—Ä–æ–∫—Å–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∏ –ù–ï –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è Cloudflare")
        warnings+=("")
        warnings+=("   ${CYAN}${BOLD}1. –ü–æ–ª—É—á–∏—Ç–µ credentials:${NC}")
        warnings+=("      $ sudo vless-status")
        warnings+=("")
        warnings+=("   ${CYAN}${BOLD}2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø—Ä–æ–∫—Å–∏ –≤ –±—Ä–∞—É–∑–µ—Ä–µ:${NC}")
        warnings+=("")
        warnings+=("      ${BOLD}Chrome/Chromium/Brave:${NC}")
        warnings+=("      - Settings ‚Üí System ‚Üí Open proxy settings")
        warnings+=("      - Manual proxy: SOCKS5, localhost:1080")
        warnings+=("      - –†–∞—Å—à–∏—Ä–µ–Ω–∏—è: SwitchyOmega, FoxyProxy")
        warnings+=("")
        warnings+=("      ${BOLD}Firefox:${NC}")
        warnings+=("      - Settings ‚Üí Network Settings ‚Üí Manual proxy")
        warnings+=("      - SOCKS Host: localhost, Port: 1080, SOCKS v5")
        warnings+=("      - ‚úì Proxy DNS when using SOCKS v5")
        warnings+=("")
        warnings+=("      ${BOLD}Safari (macOS):${NC}")
        warnings+=("      - System Preferences ‚Üí Network ‚Üí Advanced ‚Üí Proxies")
        warnings+=("      - SOCKS Proxy: localhost:1080")
        warnings+=("")
        warnings+=("      ${BOLD}Edge:${NC}")
        warnings+=("      - Settings ‚Üí System ‚Üí Open proxy settings")
        warnings+=("      - Manual proxy: SOCKS5, localhost:1080")
        warnings+=("")
        warnings+=("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê")
        warnings+=("")
    else
        print_success "Cloudflare –∑–∞—â–∏—Ç–∞ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞"
    fi

    # Check 6: Target site reachability
    print_step "–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ $target..."

    local target_reachable=false
    local target_http_code
    target_http_code=$(timeout 10 curl -s -o /dev/null -w "%{http_code}" --max-time 10 "https://$target" 2>/dev/null)

    if [ -n "$target_http_code" ] && [ "$target_http_code" != "000" ]; then
        if [ "$target_http_code" -ge 200 ] && [ "$target_http_code" -lt 400 ]; then
            target_reachable=true
            print_success "–¶–µ–ª–µ–≤–æ–π —Å–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω (HTTP $target_http_code)"
        elif [ "$target_http_code" -eq 403 ]; then
            warnings+=("‚ö†Ô∏è  –°–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω, –Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 403 Forbidden")
            warnings+=("   –í–æ–∑–º–æ–∂–Ω–∞ –∑–∞—â–∏—Ç–∞ –æ—Ç –±–æ—Ç–æ–≤ –∏–ª–∏ –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è")
        else
            warnings+=("‚ö†Ô∏è  –°–∞–π—Ç –≤–µ—Ä–Ω—É–ª HTTP $target_http_code")
        fi
    else
        warnings+=("‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ $target")
        warnings+=("   –°–∞–π—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∏–ª–∏ —Ç—Ä–µ–±—É–µ—Ç VPN")
    fi

    # Check 7: DNS Pre-validation (v5.15 - Critical)
    print_step "–ü—Ä–æ–≤–µ—Ä–∫–∞ DNS –∑–∞–ø–∏—Å–µ–π –¥–ª—è $domain..."

    local dns_check_passed=false
    local a_record=""
    local aaaa_record=""

    # Method 1: dig command
    if command -v dig >/dev/null 2>&1; then
        a_record=$(dig +short A "$domain" 2>/dev/null | grep -E '^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$' | head -1)
        aaaa_record=$(dig +short AAAA "$domain" 2>/dev/null | grep -E '^[0-9a-f:]+$' | head -1)
    fi

    # Method 2: nslookup fallback (if dig not available)
    if [ -z "$a_record" ] && [ -z "$aaaa_record" ]; then
        if command -v nslookup >/dev/null 2>&1; then
            a_record=$(nslookup "$domain" 2>/dev/null | grep -A1 "Name:" | grep "Address:" | awk '{print $2}' | grep -v ':' | head -1)
        fi
    fi

    if [ -n "$a_record" ] || [ -n "$aaaa_record" ]; then
        # DNS records found
        dns_check_passed=true

        # Get current server IP
        local server_ip
        server_ip=$(timeout 5 curl -s ifconfig.me 2>/dev/null || timeout 5 curl -s icanhazip.com 2>/dev/null || echo "unknown")

        if [ -n "$a_record" ]; then
            if [ "$a_record" = "$server_ip" ]; then
                print_success "DNS A-–∑–∞–ø–∏—Å—å —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ —ç—Ç–æ—Ç —Å–µ—Ä–≤–µ—Ä ($a_record)"
            else
                warnings+=("‚ö†Ô∏è  DNS A-–∑–∞–ø–∏—Å—å —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –¥—Ä—É–≥–æ–π IP")
                warnings+=("   DNS –∑–∞–ø–∏—Å—å: $a_record")
                warnings+=("   –≠—Ç–æ—Ç —Å–µ—Ä–≤–µ—Ä: $server_ip")
                warnings+=("")
                warnings+=("   ${YELLOW}Let's Encrypt –±—É–¥–µ—Ç –ø—Ä–æ–≤–µ—Ä—è—Ç—å $a_record!${NC}")
                warnings+=("   –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ —ç—Ç–æ—Ç —Å–µ—Ä–≤–µ—Ä, —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –ù–ï –ë–£–î–ï–¢ –ø–æ–ª—É—á–µ–Ω.")
            fi
        fi

        if [ -n "$aaaa_record" ]; then
            print_success "DNS AAAA-–∑–∞–ø–∏—Å—å –Ω–∞–π–¥–µ–Ω–∞ ($aaaa_record)"
        fi
    else
        # No DNS records found - CRITICAL ERROR
        limitation_messages+=("‚ùå –ö–†–ò–¢–ò–ß–ù–û: DNS –∑–∞–ø–∏—Å–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –¥–ª—è $domain")
        limitation_messages+=("")
        limitation_messages+=("   ${BOLD}–¢—Ä–µ–±—É–µ–º—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:${NC}")
        limitation_messages+=("   1. –î–æ–±–∞–≤—å—Ç–µ A-–∑–∞–ø–∏—Å—å –≤ DNS –ø—Ä–æ–≤–∞–π–¥–µ—Ä–µ:")
        limitation_messages+=("      Type: A")
        limitation_messages+=("      Name: $domain")
        limitation_messages+=("      Value: \$(curl -s ifconfig.me)  # IP —ç—Ç–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞")
        limitation_messages+=("      TTL: 300 (–∏–ª–∏ –∞–≤—Ç–æ)")
        limitation_messages+=("")
        limitation_messages+=("   2. –î–æ–∂–¥–∏—Ç–µ—Å—å —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è DNS (5-60 –º–∏–Ω—É—Ç):")
        limitation_messages+=("      $ dig +short $domain")
        limitation_messages+=("      # –î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å IP —ç—Ç–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞")
        limitation_messages+=("")
        limitation_messages+=("   3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ wizard —Å–Ω–æ–≤–∞ –ø–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ DNS")
        has_limitations=true
    fi

    # Check 8: fail2ban Status (v5.15 - Warning)
    print_step "–ü—Ä–æ–≤–µ—Ä–∫–∞ fail2ban –∑–∞—â–∏—Ç—ã..."

    local fail2ban_ok=false

    if systemctl is-active --quiet fail2ban 2>/dev/null; then
        # fail2ban is running
        if sudo fail2ban-client status vless-reverseproxy >/dev/null 2>&1; then
            # Jail is configured
            local jail_info
            jail_info=$(sudo fail2ban-client status vless-reverseproxy 2>/dev/null)
            local banned_count
            banned_count=$(echo "$jail_info" | grep "Currently banned:" | awk '{print $NF}')

            print_success "fail2ban –∞–∫—Ç–∏–≤–µ–Ω (–∑–∞—â–∏—Ç–∞ –æ—Ç brute-force)"
            print_info "  Jail: vless-reverseproxy | –ó–∞–±–∞–Ω–µ–Ω–æ IP: ${banned_count:-0}"
            fail2ban_ok=true
        else
            warnings+=("‚ö†Ô∏è  fail2ban –∑–∞–ø—É—â–µ–Ω, –Ω–æ jail vless-reverseproxy –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω")
            warnings+=("   Reverse proxy –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –ë–ï–ó –∑–∞—â–∏—Ç—ã –æ—Ç brute-force –∞—Ç–∞–∫")
        fi
    else
        warnings+=("‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: fail2ban –Ω–µ –∑–∞–ø—É—â–µ–Ω")
        warnings+=("")
        warnings+=("   Reverse proxy –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å, –Ω–æ –ë–ï–ó –∑–∞—â–∏—Ç—ã –æ—Ç brute-force!")
        warnings+=("")
        warnings+=("   ${CYAN}–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:${NC}")
        warnings+=("   1. –ó–∞–ø—É—Å—Ç–∏—Ç—å fail2ban:")
        warnings+=("      $ sudo systemctl start fail2ban")
        warnings+=("      $ sudo systemctl enable fail2ban")
        warnings+=("")
        warnings+=("   2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å:")
        warnings+=("      $ sudo fail2ban-client status vless-reverseproxy")
    fi

    # Check 9: Rate Limit Zone (v5.15 - Critical with auto-fix)
    print_step "–ü—Ä–æ–≤–µ—Ä–∫–∞ rate limit zone –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."

    local zone_name="reverseproxy_${domain//[.-]/_}"
    local http_context="/opt/vless/config/reverse-proxy/http_context.conf"

    if [ -f "$http_context" ]; then
        if grep -q "limit_req_zone.*zone=${zone_name}" "$http_context" 2>/dev/null; then
            print_success "Rate limit zone —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
        else
            print_warning "Rate limit zone –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –≤—ã–ø–æ–ª–Ω—è–µ–º auto-fix..."

            # Auto-fix: Add rate limit zone
            sudo bash -c "cat >> $http_context << EOF

# Rate limit zone for: ${domain} (v5.15 auto-added)
limit_req_zone \\\$binary_remote_addr zone=${zone_name}:10m rate=100r/s;
EOF"

            if grep -q "limit_req_zone.*zone=${zone_name}" "$http_context" 2>/dev/null; then
                print_success "Rate limit zone –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏"
            else
                limitation_messages+=("‚ùå –ö–†–ò–¢–ò–ß–ù–û: –ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å rate limit zone")
                limitation_messages+=("   Nginx –º–æ–∂–µ—Ç –Ω–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è –∏–∑-–∑–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–µ–π –∑–æ–Ω—ã")
                limitation_messages+=("   –¢—Ä–µ–±—É–µ—Ç—Å—è —Ä—É—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞: $http_context")
                has_limitations=true
            fi
        fi
    else
        warnings+=("‚ö†Ô∏è  –§–∞–π–ª http_context.conf –Ω–µ –Ω–∞–π–¥–µ–Ω")
        warnings+=("   –°–æ–∑–¥–∞—Å—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏")
    fi

    # Check 10: HAProxy Config Syntax (v5.15 - Critical)
    print_step "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ HAProxy –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."

    local haproxy_config="/opt/vless/config/haproxy.cfg"

    if [ -f "$haproxy_config" ]; then
        # Validate syntax using running HAProxy container (has access to certificates)
        # v5.16: Changed from 'docker run' to 'docker exec' to access mounted certificates
        local validation_output
        validation_output=$(docker exec vless_haproxy haproxy -c -f /usr/local/etc/haproxy/haproxy.cfg 2>&1)
        local validation_exit=$?

        if [ $validation_exit -eq 0 ]; then
            print_success "HAProxy –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤–∞–ª–∏–¥–Ω–∞"

            # Check if certificate exists
            if [ -f "/opt/vless/certs/combined.pem" ]; then
                print_success "HAProxy —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –Ω–∞–π–¥–µ–Ω"
            else
                warnings+=("‚ö†Ô∏è  HAProxy —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç")
                warnings+=("   –ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ Let's Encrypt —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞")
            fi
        else
            limitation_messages+=("‚ùå –ö–†–ò–¢–ò–ß–ù–û: HAProxy –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–æ–¥–µ—Ä–∂–∏—Ç –æ—à–∏–±–∫–∏")
            limitation_messages+=("")
            limitation_messages+=("   ${BOLD}–í—ã–≤–æ–¥ –ø—Ä–æ–≤–µ—Ä–∫–∏:${NC}")
            echo "$validation_output" | head -10 | while read line; do
                limitation_messages+=("   $line")
            done
            limitation_messages+=("")
            limitation_messages+=("   ${BOLD}–¢—Ä–µ–±—É–µ–º—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:${NC}")
            limitation_messages+=("   1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –≤—Ä—É—á–Ω—É—é:")
            limitation_messages+=("      $ docker exec vless_haproxy haproxy -c -f /usr/local/etc/haproxy/haproxy.cfg")
            limitation_messages+=("")
            limitation_messages+=("   2. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∏–∑ –±—ç–∫–∞–ø–∞ (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω):")
            limitation_messages+=("      $ sudo cp /opt/vless/config/haproxy.cfg.bak /opt/vless/config/haproxy.cfg")
            limitation_messages+=("")
            limitation_messages+=("   3. –ù–ï –ø—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–∫—É –¥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è!")
            has_limitations=true
        fi
    else
        limitation_messages+=("‚ùå –ö–†–ò–¢–ò–ß–ù–û: HAProxy –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
        limitation_messages+=("   –§–∞–π–ª –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç: $haproxy_config")
        limitation_messages+=("   –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–∞ VLESS VPN —Å–µ—Ä–≤–µ—Ä–∞")
        has_limitations=true
    fi

    # Display results
    echo "" >&2
    echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê" >&2

    # Show critical limitations
    if [ "$has_limitations" = true ]; then
        echo -e "${RED}${BOLD}–û–ë–ù–ê–†–£–ñ–ï–ù–´ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø:${NC}" >&2
        echo "" >&2
        for msg in "${limitation_messages[@]}"; do
            echo -e "${RED}$msg${NC}" >&2
        done
        echo "" >&2
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê" >&2
        echo "" >&2

        print_error "–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫—É –∏–∑-–∑–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π"
        print_info "–ò—Å–ø—Ä–∞–≤—å—Ç–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ wizard —Å–Ω–æ–≤–∞"

        return 1  # Block installation
    fi

    # Show warnings (non-blocking)
    if [ ${#warnings[@]} -gt 0 ]; then
        echo -e "${YELLOW}${BOLD}–ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–Ø:${NC}" >&2
        echo "" >&2
        for msg in "${warnings[@]}"; do
            echo -e "${YELLOW}$msg${NC}" >&2
        done
        echo "" >&2
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê" >&2
        echo "" >&2

        # Ask for confirmation
        echo -e "${YELLOW}${BOLD}–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã.${NC}" >&2
        echo "" >&2
        read -p "–í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å? [y/N]: " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            print_warning "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º"
            return 1
        fi

        echo "" >&2
    else
        echo -e "${GREEN}${BOLD}‚úÖ –í–°–ï –ü–†–û–í–ï–†–ö–ò –ü–†–û–ô–î–ï–ù–´${NC}" >&2
        echo "" >&2
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê" >&2
        echo "" >&2
    fi

    return 0
}

prompt_confirmation() {
    local domain="$1"
    local target="$2"
    local port="$3"
    local email="$4"

    print_header "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"

    echo -e "${CYAN}${BOLD}–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:${NC}" >&2
    echo "" >&2
    echo -e "  ${BOLD}–î–æ–º–µ–Ω:${NC}           $domain" >&2
    echo -e "  ${BOLD}–¶–µ–ª–µ–≤–æ–π —Å–∞–π—Ç:${NC}    $target" >&2
    echo -e "  ${BOLD}Backend –ø–æ—Ä—Ç:${NC}    $port (localhost-only)" >&2
    echo -e "  ${BOLD}Email:${NC}           $email" >&2
    echo "" >&2
    echo -e "  ${BOLD}–ü—É–±–ª–∏—á–Ω—ã–π URL:${NC}   ${GREEN}https://${domain}${NC}  ${YELLOW}(–ë–ï–ó –Ω–æ–º–µ—Ä–∞ –ø–æ—Ä—Ç–∞!)${NC}" >&2
    echo "" >&2
    echo -e "${CYAN}${BOLD}–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ü–∏–∏ (v5.13):${NC}" >&2
    echo -e "  ${BOLD}OAuth2 Support:${NC}          ${OAUTH2_SUPPORT:-true}" >&2
    echo -e "  ${BOLD}WebSocket Support:${NC}       ${ENABLE_WEBSOCKET:-true}" >&2
    echo -e "  ${BOLD}Strip CSP Headers:${NC}       ${STRIP_CSP:-true}" >&2
    echo -e "  ${BOLD}Enhanced Security:${NC}       ${ENHANCED_SECURITY_HEADERS:-false}" >&2
    echo -e "  ${BOLD}Custom User-Agent:${NC}       ${CUSTOM_USER_AGENT:0:60}..." >&2
    echo "" >&2
    echo -e "${YELLOW}${BOLD}–ß—Ç–æ –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–æ (v4.3):${NC}" >&2
    echo "  1. DNS validation (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!)" >&2
    echo "  2. –ü–æ–ª—É—á–µ–Ω–∏–µ Let's Encrypt —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –¥–ª—è $domain" >&2
    echo "  3. –°–æ–∑–¥–∞–Ω–∏–µ HAProxy combined.pem (fullchain + privkey)" >&2
    echo "  4. –°–æ–∑–¥–∞–Ω–∏–µ Nginx reverse proxy –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (localhost:$port)" >&2
    echo "  5. –°–æ–∑–¥–∞–Ω–∏–µ Xray HTTP inbound (localhost:10080+)" >&2
    echo "  6. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ HAProxy SNI route: $domain ‚Üí nginx:$port" >&2
    echo "  7. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ fail2ban –∑–∞—â–∏—Ç—ã" >&2
    echo "  8. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è HTTP Basic Auth –∫—Ä–µ–¥–µ–Ω—à–µ–ª–æ–≤" >&2
    echo "" >&2
    echo -e "${CYAN}${ICON_INFO} v4.3 Architecture:${NC}" >&2
    echo "  - HAProxy (port 443) –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –≤—Å–µ HTTPS —Ç—Ä–∞—Ñ–∏–∫" >&2
    echo "  - SNI routing –ø–æ –∏–º–µ–Ω–∏ –¥–æ–º–µ–Ω–∞ (TLS passthrough –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)" >&2
    echo "  - Nginx backend —Å–ª—É—à–∞–µ—Ç –¢–û–õ–¨–ö–û –Ω–∞ 127.0.0.1:$port" >&2
    echo "  - UFW –ø–æ—Ä—Ç –ù–ï –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è (–Ω–µ –Ω—É–∂–µ–Ω, HAProxy —É–∂–µ –Ω–∞ 443)" >&2
    echo "" >&2

    read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫—É? [y/N]: " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        print_warning "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º"
        exit 0
    fi
}

# =============================================================================
# Installation Functions
# =============================================================================

setup_reverse_proxy() {
    local domain="$1"
    local target="$2"
    local port="$3"
    local email="$4"

    print_header "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ Reverse Proxy"

    # Step 1: Unified Certificate Acquisition (v4.3)
    # Includes: DNS validation + certbot + HAProxy combined.pem + reload
    print_step "–ü–æ–ª—É—á–µ–Ω–∏–µ Let's Encrypt —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ (v4.3 unified workflow)..."
    if ! acquire_certificate_for_domain "$domain" "$email"; then
        print_error "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç"
        print_error "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ DNS: dig +short $domain"
        return 1
    fi

    # Step 2: Xray HTTP inbound (DEPRECATED in v5.3)
    # v5.3: Nginx proxies directly to target site via HTTPS (IPv4-only)
    # Xray inbound no longer needed for reverse proxy
    local xray_tag="N/A"
    local xray_port="N/A"

    # Step 3: Generate HTTP Basic Auth credentials
    print_step "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫—Ä–µ–¥–µ–Ω—à–µ–ª–æ–≤..."
    local username="user_$(openssl rand -hex 4)"
    local password=$(openssl rand -hex 16)
    local password_hash
    password_hash=$(htpasswd -nbB "$username" "$password" | cut -d: -f2)

    print_success "Username: $username"
    print_success "Password: $password"

    # Step 4: Generate Nginx configuration
    print_step "–°–æ–∑–¥–∞–Ω–∏–µ Nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."
    if ! generate_reverseproxy_nginx_config "$domain" "$target" "$port" "$username" "$password_hash"; then
        print_error "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å Nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é"
        return 1
    fi

    # Step 4.5: Add rate limit zone (CRITICAL FIX v5.13)
    # This MUST be called after generate_reverseproxy_nginx_config
    # to add limit_req_zone directive to http_context.conf
    print_step "–î–æ–±–∞–≤–ª–µ–Ω–∏–µ rate limit zone..."
    if ! add_rate_limit_zone "$domain"; then
        print_error "–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å rate limit zone"
        return 1
    fi

    # Step 5: Add entry to database
    print_step "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –≤ –ë–î..."
    local cert_expires
    cert_expires="$(date -u -d '+90 days' +"%Y-%m-%dT%H:%M:%SZ")"
    local notes="Created via vless-setup-proxy wizard"

    # add_proxy: domain, target_site, port, username, password, xray_port, xray_tag, cert_expires, target_ipv4, notes
    # target_ipv4 is resolved automatically inside add_proxy() if empty
    if ! add_proxy "$domain" "$target" "$port" "$username" "$password" "$xray_port" "$xray_tag" "$cert_expires" "" "$notes"; then
        print_error "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –≤ –ë–î"
        return 1
    fi

    # Step 6: Add port to fail2ban
    print_step "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ fail2ban –∑–∞—â–∏—Ç—ã..."
    if ! add_port_to_jail "$port"; then
        print_warning "–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –ø–æ—Ä—Ç –≤ fail2ban (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)"
    else
        reload_fail2ban
    fi

    # Step 7: Add port to docker-compose.yml (nginx localhost binding)
    print_step "–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Ä—Ç–∞ –≤ docker-compose.yml..."
    if ! add_nginx_port "$port"; then
        print_error "–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –ø–æ—Ä—Ç –≤ docker-compose.yml"
        print_warning "–ü–æ—Ä—Ç –ø—Ä–∏–¥—ë—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å –≤—Ä—É—á–Ω—É—é"
    else
        print_success "–ü–æ—Ä—Ç $port –¥–æ–±–∞–≤–ª–µ–Ω –≤ docker-compose.yml"
    fi

    # Step 8: Add HAProxy SNI route (v4.3)
    print_step "–î–æ–±–∞–≤–ª–µ–Ω–∏–µ HAProxy SNI route..."
    if ! add_reverse_proxy_route "$domain" "$port"; then
        print_error "–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å HAProxy route"
        print_warning "–ú–∞—Ä—à—Ä—É—Ç –ø—Ä–∏–¥—ë—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å –≤—Ä—É—á–Ω—É—é"
    else
        print_success "HAProxy route –¥–æ–±–∞–≤–ª–µ–Ω: $domain ‚Üí nginx:$port"
    fi

    # Step 9: Reload services
    print_step "–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤..."
    reload_nginx_container  # Docker compose restart with new port
    # Note: reload_xray() not needed (v5.3+: nginx proxies directly to target, no Xray HTTP inbound)

    # Step 10: Display success message
    print_header "${ICON_SUCCESS} Reverse Proxy –£—Å–ø–µ—à–Ω–æ –ù–∞—Å—Ç—Ä–æ–µ–Ω!"

    echo "" >&2
    echo -e "${GREEN}${BOLD}Reverse Proxy –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!${NC}" >&2
    echo "" >&2
    echo -e "${CYAN}${BOLD}–î–µ—Ç–∞–ª–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (v4.3):${NC}" >&2
    echo -e "  ${BOLD}URL:${NC}      ${GREEN}https://${domain}${NC}  ${YELLOW}(–ë–ï–ó –Ω–æ–º–µ—Ä–∞ –ø–æ—Ä—Ç–∞!)${NC}" >&2
    echo -e "  ${BOLD}Backend:${NC}  127.0.0.1:${port} (localhost-only)" >&2
    echo -e "  ${BOLD}Username:${NC} $username" >&2
    echo -e "  ${BOLD}Password:${NC} $password" >&2
    echo "" >&2
    echo -e "${YELLOW}${BOLD}–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:${NC}" >&2
    echo "  1. –û—Ç–∫—Ä–æ–π—Ç–µ –±—Ä–∞—É–∑–µ—Ä" >&2
    echo "  2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ –∞–¥—Ä–µ—Å—É: ${GREEN}${BOLD}https://${domain}${NC}" >&2
    echo "  3. –í–≤–µ–¥–∏—Ç–µ username/password –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ" >&2
    echo "  4. –í—ã –±—É–¥–µ—Ç–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ ${target}" >&2
    echo "" >&2
    echo -e "${CYAN}${ICON_INFO} v4.3 HAProxy Routing:${NC}" >&2
    echo "  - HAProxy –ø—Ä–∏–Ω–∏–º–∞–µ—Ç HTTPS –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –ø–æ—Ä—Ç—É 443" >&2
    echo "  - SNI-based routing: –ø–æ –∏–º–µ–Ω–∏ –¥–æ–º–µ–Ω–∞ ($domain)" >&2
    echo "  - Nginx backend —Å–ª—É—à–∞–µ—Ç —Ç–æ–ª—å–∫–æ localhost (–Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑–≤–Ω–µ)" >&2
    echo "" >&2
    echo -e "${CYAN}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:${NC}" >&2
    echo "  sudo vless-proxy show ${domain}        # –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏" >&2
    echo "  sudo vless-proxy remove ${domain}      # –£–¥–∞–ª–∏—Ç—å" >&2
    echo "  sudo vless-proxy renew-cert ${domain}  # –û–±–Ω–æ–≤–∏—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç" >&2
    echo "" >&2

    return 0
}

# =============================================================================
# Main Execution
# =============================================================================

main() {
    # Check if running as root
    if [ "$EUID" -ne 0 ]; then
        print_error "–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω —Å sudo"
        exit 1
    fi

    # Check if VLESS is installed
    if [ ! -d "$INSTALL_PATH" ]; then
        print_error "VLESS –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–∫—É."
        exit 1
    fi

    # Initialize database if not exists
    init_database

    # Print welcome banner
    clear
    print_header "${ICON_ROCKET} VLESS v4.3 - Reverse Proxy Setup Wizard (HAProxy Unified)"

    echo -e "${CYAN}–≠—Ç–æ—Ç wizard –ø–æ–º–æ–∂–µ—Ç –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å reverse proxy –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–º —Å–∞–π—Ç–∞–º.${NC}" >&2
    echo -e "${YELLOW}v4.3: Unified HAProxy architecture - subdomain access –±–µ–∑ –Ω–æ–º–µ—Ä–∞ –ø–æ—Ä—Ç–∞!${NC}" >&2
    echo "" >&2

    # Collect parameters
    domain=$(prompt_domain)
    target=$(prompt_target_site)
    port=$(prompt_port)
    email=$(prompt_letsencrypt_email)

    # v5.10: Advanced options (OAuth2, WebSocket, CSP)
    prompt_advanced_options

    # v5.14: Pre-flight checks (blocking if critical issues found)
    if ! check_proxy_limitations "$domain" "$target" "$port"; then
        print_error "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–µ—Ä–≤–∞–Ω–∞ –∏–∑-–∑–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π"
        exit 1
    fi

    # Confirmation
    prompt_confirmation "$domain" "$target" "$port" "$email"

    # Execute setup (success message printed inside function)
    if ! setup_reverse_proxy "$domain" "$target" "$port" "$email"; then
        print_error "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–∞–º–∏"
        exit 1
    fi
}

# Run main function
main "$@"
