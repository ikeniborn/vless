#!/bin/bash
#==============================================================================
# Certificate Renewal Deploy Hook
# Part of VLESS + Reality VPN v4.3
#
# This script is called by certbot after successful certificate renewal.
# Handles certificate updates for HAProxy, Xray, and Reverse Proxy.
#
# v4.3 Features:
# - Creates HAProxy combined.pem (fullchain + privkey)
# - Gracefully reloads HAProxy (zero downtime)
# - Restarts Xray container (VLESS Reality)
# - Reloads Nginx reverse proxy
# - Updates reverse_proxies.json database
# - Supports multiple renewed domains
#
# Usage: Called automatically by certbot via --deploy-hook
# Location: /usr/local/bin/vless-cert-renew
#==============================================================================

set -euo pipefail

# Constants
readonly VLESS_DIR="/opt/vless"
readonly LOG_FILE="$VLESS_DIR/logs/certbot-renew.log"
readonly DB_SCRIPT="$VLESS_DIR/lib/reverseproxy_db.sh"
readonly CERT_MANAGER="$VLESS_DIR/lib/certificate_manager.sh"
readonly TIMESTAMP="$(date '+%Y-%m-%d %H:%M:%S')"

# Source certificate manager module (v4.3)
if [[ -f "$CERT_MANAGER" ]]; then
    source "$CERT_MANAGER"
fi

# Ensure log directory exists
mkdir -p "$VLESS_DIR/logs" 2>/dev/null

# Log function
log_message() {
    echo "[$TIMESTAMP] $1" | tee -a "$LOG_FILE"
}

log_error() {
    echo "[$TIMESTAMP] ERROR: $1" | tee -a "$LOG_FILE" >&2
}

#==============================================================================
# v4.2: Reverse Proxy Support
#==============================================================================

reload_nginx_reverseproxy() {
    log_message "Reloading Nginx reverse proxy..."

    # Check if nginx reverse proxy container exists
    if ! docker ps -a --format '{{.Names}}' | grep -q "vless_nginx_reverseproxy"; then
        log_message "â„¹ï¸  Nginx reverse proxy not configured, skipping"
        return 0
    fi

    # Check if container is running
    if ! docker ps --format '{{.Names}}' | grep -q "vless_nginx_reverseproxy"; then
        log_message "âš ï¸  Nginx reverse proxy container not running"
        return 1
    fi

    # Reload nginx
    if docker exec vless_nginx_reverseproxy nginx -s reload 2>&1 >> "$LOG_FILE"; then
        log_message "âœ… Nginx reverse proxy reloaded successfully"
        return 0
    else
        log_error "Failed to reload Nginx reverse proxy"
        return 1
    fi
}

update_database_cert_info() {
    local domain="$1"

    # Check if database script exists
    if [ ! -f "$DB_SCRIPT" ]; then
        log_message "â„¹ï¸  Database script not found, skipping database update"
        return 0
    fi

    # Source database functions
    source "$DB_SCRIPT"

    # Check if this is a reverse proxy domain
    if ! get_proxy "$domain" &>/dev/null; then
        log_message "â„¹ï¸  $domain is not a reverse proxy, skipping database update"
        return 0
    fi

    log_message "Updating database for $domain..."

    # Calculate new expiry (Let's Encrypt: 90 days)
    local new_expiry
    new_expiry=$(date -u -d '+90 days' +'%Y-%m-%dT%H:%M:%SZ')

    local renewed_at
    renewed_at=$(date -u +'%Y-%m-%dT%H:%M:%SZ')

    # Update database
    if update_certificate_info "$domain" "$new_expiry" "$renewed_at" 2>&1 >> "$LOG_FILE"; then
        log_message "âœ… Database updated for $domain (expires: $new_expiry)"
        return 0
    else
        log_error "Failed to update database for $domain"
        return 1
    fi
}

#==============================================================================
# Main execution
#==============================================================================

main() {
    log_message "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    log_message "ğŸ”„ Certificate Renewal Deploy Hook (v4.3)"
    log_message "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

    # Get renewed domains from certbot environment variable
    local renewed_domains="${RENEWED_DOMAINS:-}"

    if [ -z "$renewed_domains" ]; then
        log_error "RENEWED_DOMAINS environment variable not set"
        log_message "This script should be called by certbot --deploy-hook"
        exit 1
    fi

    log_message "Renewed domains: $renewed_domains"

    # Change to VLESS directory
    if ! cd "$VLESS_DIR"; then
        log_error "Cannot access $VLESS_DIR"
        exit 1
    fi

    local success=true

    # 1. Create HAProxy combined.pem for each renewed domain (v4.3)
    log_message ""
    log_message "Step 1: Creating HAProxy combined.pem..."

    for domain in $renewed_domains; do
        log_message "  Processing: $domain"

        if command -v create_haproxy_combined_cert &>/dev/null; then
            if create_haproxy_combined_cert "$domain" >> "$LOG_FILE" 2>&1; then
                log_message "  âœ… Combined.pem created for $domain"
            else
                log_error "  Failed to create combined.pem for $domain"
                success=false
            fi
        else
            log_error "  Certificate manager module not found"
            success=false
        fi
    done

    # 2. Gracefully reload HAProxy (v4.3)
    log_message ""
    log_message "Step 2: Reloading HAProxy..."

    if command -v reload_haproxy_after_cert_update &>/dev/null; then
        if reload_haproxy_after_cert_update >> "$LOG_FILE" 2>&1; then
            log_message "âœ… HAProxy reloaded successfully"
        else
            log_error "Failed to reload HAProxy"
            success=false
        fi
    else
        log_error "Certificate manager module not found"
        success=false
    fi

    # 3. Restart Xray container (VLESS Reality)
    log_message ""
    log_message "Step 3: Restarting Xray container..."

    if docker-compose restart xray >> "$LOG_FILE" 2>&1; then
        sleep 2

        if docker ps | grep -q "vless.*Up"; then
            log_message "âœ… Xray restarted successfully"
        else
            log_error "Xray container failed to start"
            success=false
        fi
    else
        log_error "Failed to restart Xray container"
        success=false
    fi

    # 4. Reload Nginx reverse proxy
    log_message ""
    log_message "Step 4: Reloading Nginx reverse proxy..."

    if ! reload_nginx_reverseproxy; then
        success=false
    fi

    # 5. Update database for each renewed domain
    log_message ""
    log_message "Step 5: Updating database..."

    for domain in $renewed_domains; do
        if ! update_database_cert_info "$domain"; then
            success=false
        fi
    done

    # Summary
    log_message ""
    log_message "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

    if [ "$success" = true ]; then
        log_message "âœ… Deploy hook completed successfully"
        log_message "All services reloaded with new certificates"
        exit 0
    else
        log_error "Deploy hook completed with errors"
        log_message "Check logs: $LOG_FILE"
        exit 1
    fi
}

main "$@"
