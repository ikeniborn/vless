#!/bin/bash
#
# VLESS Reality VPN - Main CLI Interface
# Version: 5.33.0
#
# Usage: vless <command> [arguments]
#
# This is the main CLI wrapper that provides user-friendly commands
# for managing the VLESS Reality VPN server.
#
# Architecture (v5.30+):
# - Nginx stream+http replaces HAProxy (SNI routing port 443, TLS ports 1080/8118)
# - Tier 2 transports: WebSocket (8444), XHTTP (8445), gRPC (8446)
# - Subdomain-based reverse proxy access (https://domain without port)
#

set -euo pipefail

# Installation paths
readonly INSTALL_ROOT="/opt/vless"
readonly LIB_DIR="${INSTALL_ROOT}/lib"
readonly CONFIG_DIR="${INSTALL_ROOT}/config"
readonly DATA_DIR="${INSTALL_ROOT}/data"

# Color codes
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly CYAN='\033[0;36m'
readonly NC='\033[0m' # No Color

# Check if running as root
check_root() {
    if [[ $EUID -ne 0 ]]; then
        echo -e "${RED}Error: This command must be run as root${NC}" >&2
        echo "Please use: sudo vless $*" >&2
        exit 1
    fi
}

# Show usage information
show_usage() {
    cat << EOF
${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}
${BLUE}â•‘          VLESS Reality VPN - CLI Management Tool            â•‘${NC}
${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}

${CYAN}Usage:${NC}
  vless <command> [arguments]

${CYAN}User Management:${NC}
  add-user <username>       Create a new VPN user
  remove-user <username>    Remove an existing user
  list-users                List all users
  show-user <username>      Show user details and connection info
  regenerate <username>     Regenerate config files (v3.3 migration)

${CYAN}External Proxy (v5.24 - Per-User):${NC}
  set-proxy <user> <id|none>    Set external proxy for user
  show-proxy <username>         Show user's proxy assignment
  list-proxy-assignments        List all proxy assignments

${CYAN}Proxy IP Whitelist (v3.6 - Server-Level):${NC}
  show-proxy-ips                    Show allowed IPs for proxy access
  set-proxy-ips <ips>               Set allowed IPs (comma-separated)
  add-proxy-ip <ip>                 Add IP to proxy whitelist
  remove-proxy-ip <ip>              Remove IP from proxy whitelist
  reset-proxy-ips                   Reset to localhost only

${CYAN}UFW Firewall Rules (v4.0 - Host-Level):${NC}
  show-ufw-ips                      Show UFW proxy whitelist rules
  add-ufw-ip <ip>                   Add IP to UFW whitelist
  remove-ufw-ip <ip>                Remove IP from UFW whitelist
  reset-ufw-ips                     Remove all UFW proxy rules

${CYAN}Service Operations:${NC}
  status                    Show service status
  start                     Start VLESS services
  stop                      Stop VLESS services
  restart                   Restart VLESS services
  logs [service]            Show logs (service: xray|nginx|all)

${CYAN}Maintenance:${NC}
  update                    Update VLESS to latest version
  backup                    Create backup of configuration
  test                      Test Xray configuration

${CYAN}Security Testing:${NC}
  test-security [options]   Run encryption & security tests
    --quick                 Skip long-running tests
    --skip-pcap             Skip packet capture tests
    --verbose               Show detailed output
    --dev-mode              Development mode (skip installation checks)

${CYAN}Information:${NC}
  info                      Show server information
  help                      Show this help message

${CYAN}Examples:${NC}
  sudo vless add-user alice
  sudo vless list-users
  sudo vless set-proxy alice corporate-proxy-123
  sudo vless show-proxy alice
  sudo vless list-proxy-assignments
  sudo vless show-proxy-ips
  sudo vless set-proxy-ips 127.0.0.1,10.0.0.0/24
  sudo vless status
  sudo vless logs xray
  sudo vless test-security --quick

${YELLOW}Note:${NC} All commands require root privileges (use sudo)

EOF
}

# Source lib modules
source_modules() {
    local modules=(
        "user_management.sh"
        "qr_generator.sh"
        "proxy_whitelist.sh"
        "ufw_whitelist.sh"
    )

    for module in "${modules[@]}"; do
        if [[ -f "${LIB_DIR}/${module}" ]]; then
            source "${LIB_DIR}/${module}"
        fi
    done
}

# Main command router
main() {
    # Show help if no arguments
    if [[ $# -eq 0 ]]; then
        show_usage
        exit 0
    fi

    local command="$1"
    shift

    case "$command" in
        add-user|adduser)
            check_root
            if [[ $# -eq 0 ]]; then
                echo -e "${RED}Error: Username required${NC}" >&2
                echo "Usage: vless add-user <username>" >&2
                exit 1
            fi
            source_modules
            create_user "$1"
            ;;

        remove-user|rmuser|deleteuser)
            check_root
            if [[ $# -eq 0 ]]; then
                echo -e "${RED}Error: Username required${NC}" >&2
                echo "Usage: vless remove-user <username>" >&2
                exit 1
            fi
            source_modules
            remove_user "$1"
            ;;

        list-users|ls|users)
            check_root
            source_modules
            list_users
            ;;

        show-user|show|user)
            check_root
            if [[ $# -eq 0 ]]; then
                echo -e "${RED}Error: Username required${NC}" >&2
                echo "Usage: vless show-user <username>" >&2
                exit 1
            fi
            source_modules
            get_user_info "$1"
            ;;

        regenerate|regen)
            check_root
            if [[ $# -eq 0 ]]; then
                echo -e "${RED}Error: Username required${NC}" >&2
                echo "Usage: vless regenerate <username>" >&2
                exit 1
            fi
            source_modules
            regenerate_configs "$1"
            ;;

        set-proxy)
            check_root
            if [[ $# -lt 2 ]]; then
                echo -e "${RED}Error: Username and proxy ID required${NC}" >&2
                echo "Usage: vless set-proxy <username> <proxy-id|none>" >&2
                echo "Example: vless set-proxy alice corporate-proxy-123" >&2
                echo "         vless set-proxy alice none" >&2
                exit 1
            fi
            source_modules
            cmd_set_user_proxy "$1" "$2"
            ;;

        show-proxy)
            check_root
            if [[ $# -eq 0 ]]; then
                echo -e "${RED}Error: Username required${NC}" >&2
                echo "Usage: vless show-proxy <username>" >&2
                exit 1
            fi
            source_modules
            cmd_show_user_proxy "$1"
            ;;

        list-proxy-assignments)
            check_root
            source_modules
            cmd_list_proxy_assignments
            ;;

        show-proxy-ips)
            check_root
            source_modules
            show_proxy_allowed_ips
            ;;

        set-proxy-ips)
            check_root
            if [[ $# -eq 0 ]]; then
                echo -e "${RED}Error: IP list required${NC}" >&2
                echo "Usage: vless set-proxy-ips <ip1,ip2,...>" >&2
                echo "Example: vless set-proxy-ips 127.0.0.1,10.0.0.0/24,192.168.1.5" >&2
                exit 1
            fi
            source_modules
            set_proxy_allowed_ips "$1"
            ;;

        add-proxy-ip)
            check_root
            if [[ $# -eq 0 ]]; then
                echo -e "${RED}Error: IP address required${NC}" >&2
                echo "Usage: vless add-proxy-ip <ip>" >&2
                echo "Example: vless add-proxy-ip 192.168.1.5" >&2
                exit 1
            fi
            source_modules
            add_proxy_allowed_ip "$1"
            ;;

        remove-proxy-ip)
            check_root
            if [[ $# -eq 0 ]]; then
                echo -e "${RED}Error: IP address required${NC}" >&2
                echo "Usage: vless remove-proxy-ip <ip>" >&2
                echo "Example: vless remove-proxy-ip 192.168.1.5" >&2
                exit 1
            fi
            source_modules
            remove_proxy_allowed_ip "$1"
            ;;

        reset-proxy-ips)
            check_root
            source_modules
            reset_proxy_allowed_ips
            ;;

        show-ufw-ips)
            check_root
            source_modules
            show_ufw_proxy_ips
            ;;

        add-ufw-ip)
            check_root
            if [[ $# -eq 0 ]]; then
                echo -e "${RED}Error: IP address required${NC}" >&2
                echo "Usage: vless add-ufw-ip <ip>" >&2
                echo "Example: vless add-ufw-ip 192.168.1.100" >&2
                exit 1
            fi
            source_modules
            add_ufw_proxy_rule "$1"
            ;;

        remove-ufw-ip)
            check_root
            if [[ $# -eq 0 ]]; then
                echo -e "${RED}Error: IP address required${NC}" >&2
                echo "Usage: vless remove-ufw-ip <ip>" >&2
                echo "Example: vless remove-ufw-ip 192.168.1.100" >&2
                exit 1
            fi
            source_modules
            remove_ufw_proxy_rule "$1"
            ;;

        reset-ufw-ips)
            check_root
            source_modules
            reset_ufw_proxy_ips
            ;;

        status)
            check_root
            echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
            echo -e "${BLUE}â•‘          VLESS v4.3 - Service Status (HAProxy Unified)      â•‘${NC}"
            echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
            echo ""

            # Container status
            echo -e "${CYAN}Container Status:${NC}"
            docker ps --filter "name=vless" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
            echo ""

            # HAProxy Status (v4.3)
            echo -e "${CYAN}HAProxy v4.3 Status:${NC}"
            if docker ps --filter "name=vless-haproxy" --format "{{.Names}}" | grep -q "vless-haproxy"; then
                echo -e "  ${GREEN}âœ“ HAProxy Running${NC}"

                # Show frontends
                echo ""
                echo -e "${CYAN}HAProxy Frontends:${NC}"
                echo "  1. vless-reality    â†’ TCP port 443 (VLESS Reality passthrough)"
                echo "  2. socks5-tls       â†’ TCP port 1080 (SOCKS5 + TLS termination)"
                echo "  3. http-tls         â†’ TCP port 8118 (HTTP + TLS termination)"

                # Show active reverse proxy routes
                echo ""
                echo -e "${CYAN}Reverse Proxy Routes (SNI):${NC}"
                if [[ -f "${INSTALL_ROOT}/config/haproxy.cfg" ]]; then
                    local route_count=$(grep -c "use_backend nginx_" "${INSTALL_ROOT}/config/haproxy.cfg" 2>/dev/null || echo "0")
                    if [ "$route_count" -gt 0 ]; then
                        echo -e "  ${GREEN}Active Routes: $route_count${NC}"
                        grep "acl is_" "${INSTALL_ROOT}/config/haproxy.cfg" | grep -v "#" | while read -r line; do
                            local domain=$(echo "$line" | awk '{print $NF}')
                            echo "    â†’ https://$domain"
                        done
                    else
                        echo "  ${YELLOW}No reverse proxy routes configured${NC}"
                    fi
                else
                    echo "  ${YELLOW}HAProxy config not found${NC}"
                fi
            else
                echo -e "  ${RED}âœ— HAProxy Not Running${NC}"
            fi

            # External Proxy Status (v5.23)
            echo ""
            echo -e "${CYAN}External Proxy Status (v5.23):${NC}"
            if [[ -f "${INSTALL_ROOT}/config/external_proxy.json" ]]; then
                local ext_proxy_enabled=$(jq -r '.enabled' "${INSTALL_ROOT}/config/external_proxy.json" 2>/dev/null || echo "false")
                local proxy_count=$(jq -r '.proxies | length' "${INSTALL_ROOT}/config/external_proxy.json" 2>/dev/null || echo "0")

                if [[ "$ext_proxy_enabled" == "true" ]]; then
                    echo -e "  ${GREEN}âœ“ External Proxy ENABLED${NC}"

                    # Get active proxy info
                    local active_proxy_id=$(jq -r '.proxies[] | select(.active == true) | .id' \
                        "${INSTALL_ROOT}/config/external_proxy.json" 2>/dev/null || echo "")

                    if [[ -n "$active_proxy_id" ]]; then
                        local proxy_type=$(jq -r --arg id "$active_proxy_id" \
                            '.proxies[] | select(.id == $id) | .type' \
                            "${INSTALL_ROOT}/config/external_proxy.json" 2>/dev/null)
                        local proxy_address=$(jq -r --arg id "$active_proxy_id" \
                            '.proxies[] | select(.id == $id) | .address' \
                            "${INSTALL_ROOT}/config/external_proxy.json" 2>/dev/null)
                        local proxy_port=$(jq -r --arg id "$active_proxy_id" \
                            '.proxies[] | select(.id == $id) | .port' \
                            "${INSTALL_ROOT}/config/external_proxy.json" 2>/dev/null)
                        local test_status=$(jq -r --arg id "$active_proxy_id" \
                            '.proxies[] | select(.id == $id) | .metadata.test_result.status // "never tested"' \
                            "${INSTALL_ROOT}/config/external_proxy.json" 2>/dev/null)

                        echo "  Active Proxy: $active_proxy_id"
                        echo "    Type: $proxy_type"
                        echo "    Address: $proxy_address:$proxy_port"
                        echo "    Last Test: $test_status"

                        if [[ "$test_status" == "success" ]]; then
                            local latency=$(jq -r --arg id "$active_proxy_id" \
                                '.proxies[] | select(.id == $id) | .metadata.test_result.latency_ms' \
                                "${INSTALL_ROOT}/config/external_proxy.json" 2>/dev/null)
                            echo "    Latency: ${latency}ms"
                        fi
                    else
                        echo -e "  ${YELLOW}âš ï¸  No active proxy (enabled but no proxy selected)${NC}"
                    fi

                    # Show routing mode
                    local routing_mode=$(jq -r '.routing.mode' "${INSTALL_ROOT}/config/external_proxy.json" 2>/dev/null || echo "unknown")
                    echo "  Routing Mode: $routing_mode"
                    echo "  Total Proxies: $proxy_count"
                elif [[ "$proxy_count" -gt 0 ]]; then
                    echo -e "  ${YELLOW}âœ— External Proxy DISABLED${NC}"
                    echo "  Total Proxies: $proxy_count (configured but not active)"
                    echo "  Hint: vless-external-proxy enable"
                else
                    echo "  ${YELLOW}Not configured${NC} (no external proxies added)"
                    echo "  Hint: vless-external-proxy add"
                fi
            else
                echo "  ${YELLOW}Not available${NC} (database not found)"
            fi

            # Per-User Proxy Assignments (v5.24)
            echo ""
            echo -e "${CYAN}Per-User Proxy Assignments (v5.24):${NC}"
            if [[ -f "${DATA_DIR}/users.json" ]]; then
                local total_users=$(jq -r '.users | length' "${DATA_DIR}/users.json" 2>/dev/null || echo "0")

                if [[ "$total_users" -eq 0 ]]; then
                    echo "  ${YELLOW}No users configured${NC}"
                else
                    # Count users by routing type
                    local direct_count=0
                    local proxied_count=0

                    # Count users with direct routing (external_proxy_id is null or missing)
                    direct_count=$(jq -r '[.users[] | select(.external_proxy_id == null or .external_proxy_id == "")] | length' \
                        "${DATA_DIR}/users.json" 2>/dev/null || echo "0")

                    # Count users with external proxy
                    proxied_count=$(jq -r '[.users[] | select(.external_proxy_id != null and .external_proxy_id != "")] | length' \
                        "${DATA_DIR}/users.json" 2>/dev/null || echo "0")

                    echo "  Total Users: $total_users"
                    echo "    Direct Routing: ${direct_count} users"
                    echo "    Via External Proxy: ${proxied_count} users"

                    # Show top proxies if any users are using external proxy
                    if [[ "$proxied_count" -gt 0 ]]; then
                        echo ""
                        echo "  Top Proxies by User Count:"

                        # Group users by proxy_id and count
                        local proxy_stats
                        proxy_stats=$(jq -r '[.users[] | select(.external_proxy_id != null and .external_proxy_id != "") | .external_proxy_id] | group_by(.) | map({proxy: .[0], count: length}) | sort_by(-.count) | .[:3]' \
                            "${DATA_DIR}/users.json" 2>/dev/null)

                        if [[ -n "$proxy_stats" ]] && [[ "$proxy_stats" != "[]" ]]; then
                            # Display top 3 proxies
                            echo "$proxy_stats" | jq -r '.[] | "    â€¢ \(.proxy): \(.count) user(s)"' 2>/dev/null

                            echo ""
                            echo "  Hint: vless list-proxy-assignments (detailed view)"
                        fi
                    fi
                fi
            else
                echo "  ${YELLOW}Users database not found${NC}"
            fi

            echo ""
            ;;

        start)
            check_root
            echo "Starting VLESS services..."
            (cd "${INSTALL_ROOT}" && docker compose up -d)
            ;;

        stop)
            check_root
            echo "Stopping VLESS services..."
            (cd "${INSTALL_ROOT}" && docker compose down)
            ;;

        restart)
            check_root
            echo "Restarting VLESS services..."
            (cd "${INSTALL_ROOT}" && docker compose restart)
            ;;

        logs)
            check_root
            local service="${1:-}"
            if [[ -z "$service" ]] || [[ "$service" == "all" ]]; then
                (cd "${INSTALL_ROOT}" && docker compose logs -f --tail=100)
            else
                (cd "${INSTALL_ROOT}" && docker compose logs -f --tail=100 "$service")
            fi
            ;;

        test)
            check_root
            echo "Testing Xray configuration..."
            docker exec vless_xray xray -test -config=/etc/xray/xray_config.json
            ;;

        test-security|security-test|security)
            check_root

            # Check if security test module exists
            if [[ ! -f "${LIB_DIR}/security_tests.sh" ]]; then
                echo -e "${RED}Error: Security test module not found${NC}" >&2
                echo "Expected location: ${LIB_DIR}/security_tests.sh" >&2
                exit 1
            fi

            # Run security tests with all arguments passed through
            bash "${LIB_DIR}/security_tests.sh" "$@"
            ;;

        update|upgrade)
            check_root
            # Detect current version
            local current_version=""
            if [[ -f "${INSTALL_ROOT}/.version" ]]; then
                current_version=$(cat "${INSTALL_ROOT}/.version")
            elif grep -q "ENABLE_PUBLIC_PROXY" "${INSTALL_ROOT}/.env" 2>/dev/null; then
                current_version="3.2"
            else
                current_version="3.1"
            fi

            echo ""
            echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
            echo -e "${BLUE}â•‘            VLESS Reality VPN - Update Check                â•‘${NC}"
            echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
            echo ""
            echo -e "Current Version: ${YELLOW}${current_version:-unknown}${NC}"
            echo -e "Target Version:  ${GREEN}3.3${NC}"
            echo ""

            # Show breaking change warning for v3.2 â†’ v3.3 migration
            if [[ "$current_version" == "3.2" ]]; then
                echo -e "${RED}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
                echo -e "${RED}â•‘   âš ï¸  CRITICAL: BREAKING CHANGES IN v3.3                   â•‘${NC}"
                echo -e "${RED}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
                echo ""
                echo -e "${YELLOW}v3.2 â†’ v3.3 Migration includes breaking changes:${NC}"
                echo ""
                echo "1. ${RED}Proxy URIs Changed:${NC}"
                echo "   v3.2: socks5://user:pass@IP:1080 (plaintext)"
                echo "   v3.3: socks5s://user:pass@DOMAIN:1080 (TLS encrypted)"
                echo ""
                echo "2. ${RED}Domain Required:${NC}"
                echo "   v3.3 requires a domain name for TLS certificates"
                echo "   IP-based configs will NOT work"
                echo ""
                echo "3. ${RED}Client Config Migration:${NC}"
                echo "   All client proxy configs must be regenerated"
                echo "   Use: sudo vless regenerate <username>"
                echo ""
                echo "4. ${RED}Security Critical:${NC}"
                echo "   v3.2 transmitted credentials in PLAINTEXT"
                echo "   v3.3 enforces TLS 1.3 encryption"
                echo ""
                echo -e "${CYAN}ğŸ“– Migration Guide:${NC}"
                echo "   ${INSTALL_ROOT}/docs/MIGRATION_v3.2_to_v3.3.md"
                echo ""
                echo -e "${YELLOW}Required Actions Before Update:${NC}"
                echo "  1. Read migration guide: less ${INSTALL_ROOT}/docs/MIGRATION_v3.2_to_v3.3.md"
                echo "  2. Prepare domain name (DNS A record pointing to server)"
                echo "  3. Backup configs: sudo vless backup"
                echo "  4. Test on staging environment first (recommended)"
                echo ""
                echo -e "${RED}âš ï¸  DO NOT proceed without reading migration guide${NC}"
                echo ""
                echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
                echo ""
                read -p "Have you read the migration guide and are ready to proceed? (yes/no): " confirm

                if [[ "$confirm" != "yes" ]]; then
                    echo ""
                    echo -e "${YELLOW}Update cancelled. Please read migration guide first.${NC}"
                    echo ""
                    exit 0
                fi
            fi

            echo ""
            echo -e "${YELLOW}Update functionality not yet implemented.${NC}"
            echo ""
            echo "To update manually:"
            echo "  1. Backup: sudo vless backup"
            echo "  2. Pull latest: git pull origin master"
            echo "  3. Re-run installer: sudo bash install.sh"
            echo ""
            echo "For v3.2 â†’ v3.3 migration:"
            echo "  1. Follow: ${INSTALL_ROOT}/docs/MIGRATION_v3.2_to_v3.3.md"
            echo "  2. Regenerate configs: sudo vless regenerate <username>"
            echo ""
            ;;

        backup)
            check_root
            local backup_dir="${INSTALL_ROOT}/backup"
            local backup_file="${backup_dir}/vless_backup_$(date +%Y%m%d_%H%M%S).tar.gz"

            mkdir -p "$backup_dir"

            echo "Creating backup..."
            tar -czf "$backup_file" \
                -C "${INSTALL_ROOT}" \
                config/ data/ .env docker-compose.yml 2>/dev/null

            echo -e "${GREEN}âœ“ Backup created: ${backup_file}${NC}"
            ;;

        info)
            check_root
            echo -e "${CYAN}VLESS Reality VPN Server Information${NC}"
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            echo "Installation: ${INSTALL_ROOT}"
            echo "Network: $(docker network inspect vless_reality_net -f '{{(index .IPAM.Config 0).Subnet}}' 2>/dev/null || echo 'N/A')"
            echo "Port: $(jq -r '.inbounds[0].port' ${CONFIG_DIR}/xray_config.json 2>/dev/null || echo 'N/A')"
            echo "Destination: $(jq -r '.inbounds[0].streamSettings.realitySettings.dest' ${CONFIG_DIR}/xray_config.json 2>/dev/null || echo 'N/A')"
            echo "Users: $(jq -r '.users | length' ${DATA_DIR}/users.json 2>/dev/null || echo '0')"
            ;;

        help|--help|-h)
            show_usage
            ;;

        # v5.25: XTLS Vision migration safety-net
        migrate-vision|migrate_vision)
            check_root
            source_modules
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "  XTLS Vision Migration (v5.25)"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            migrate_xtls_vision
            ;;

        # v5.33: Tier 2 Transport Management CLI
        add-transport|addtransport)
            check_root
            if [[ $# -lt 2 ]]; then
                echo -e "${RED}Error: transport type and subdomain required${NC}" >&2
                echo "Usage: vless add-transport <type> <subdomain>" >&2
                echo "Types: ws, xhttp, grpc" >&2
                echo "Example: vless add-transport ws ws.example.com" >&2
                exit 1
            fi
            source_modules
            source "${LIB_DIR}/transport_manager.sh"
            add_transport "$1" "$2"
            ;;

        list-transports|listtransports)
            check_root
            source_modules
            source "${LIB_DIR}/transport_manager.sh"
            list_transports
            ;;

        remove-transport|removetransport)
            check_root
            if [[ $# -lt 1 ]]; then
                echo -e "${RED}Error: transport type required${NC}" >&2
                echo "Usage: vless remove-transport <type>" >&2
                echo "Types: ws, xhttp, grpc" >&2
                exit 1
            fi
            source_modules
            source "${LIB_DIR}/transport_manager.sh"
            remove_transport "$1"
            ;;

        *)
            echo -e "${RED}Error: Unknown command '${command}'${NC}" >&2
            echo "Run 'vless help' to see available commands" >&2
            exit 1
            ;;
    esac
}

# Run main function
main "$@"
